<!doctype html>
<html lang="he">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gantt – Ghana Energy CERT (Drag & Drop) + Import/Export + GitHub</title>
<style>
  /* ===== Version 21 (fixed) ===== */
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    margin:0;background:#f6f7fb;color:#111827;
    overflow:auto;
  }

  /* Always show scrollbars when possible */
  *{ scrollbar-gutter: stable both-edges; }
  ::-webkit-scrollbar{ width:12px; height:12px; }
  ::-webkit-scrollbar-thumb{ background:#cbd5e1; border-radius:999px; border:3px solid #f6f7fb; }
  ::-webkit-scrollbar-track{ background:#f6f7fb; }

  header{padding:16px 20px;background:#111827;color:#fff}
  header h1{margin:0;font-size:18px;font-weight:900;direction:rtl;text-align:right}
  header .meta{margin-top:6px;font-size:13px;opacity:.9;direction:rtl;text-align:right;line-height:1.35}
  .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#1f2a6b;font-size:12px}

  .wrap{padding:16px 20px; overflow:auto;}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  .controls input,.controls select,.controls button{
    padding:10px 12px;border-radius:10px;border:1px solid #d1d5db;background:#fff;font-size:14px
  }
  .controls button{cursor:pointer}
  .controls .btn-primary{background:#111827;color:#fff;border-color:#111827}
  .controls .btn-ghost{background:#fff;color:#111827}
  .controls .btn-warn{background:#fff7ed;color:#9a3412;border-color:#fed7aa}
  .controls .btn-ok{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}

  .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.05)}

  /* Fixed work area to force internal scrollbars */
  .workArea{ height: min(62vh, 680px); }

  .grid{display:grid;grid-template-columns: 540px 1fr;}
  .left{border-right:1px solid #e5e7eb; overflow:auto; height:100%;}
  .right{overflow:auto; height:100%;}

  .row{display:flex;gap:10px;align-items:center;padding:8px 10px;border-bottom:1px solid #f1f5f9}
  .row:nth-child(odd){background:#fafafa}
  .row .title{flex:1;direction:rtl;text-align:right;font-size:13px;line-height:1.2}
  .row .meta{font-size:12px;color:#374151;white-space:nowrap}
  .row.clickable{cursor:pointer;}
  .row.clickable:hover{background:#eef2ff;}

  .dragDep{
    width:22px;height:22px;border-radius:8px;
    border:1px solid #d1d5db;background:#fff;
    display:flex;align-items:center;justify-content:center;
    font-size:14px; cursor:grab;
  }
  .dragDep:active{cursor:grabbing;}
  .dragDep:hover{background:#f8fafc;}

  .timeline{position:relative;min-height: 40px;border-bottom:1px solid #e5e7eb;background:#fff}
  .ticks{display:flex;position:sticky;top:0;background:#fff;z-index:2}
  .tick{border-right:1px solid #eef2f7;padding:8px 6px;font-size:12px;color:#374151;white-space:nowrap}

  .bar-area{position:relative; overflow:visible;}
  .bar-row{position:relative;height:34px;border-bottom:1px solid #f1f5f9}
  .bar{position:absolute;top:7px;height:20px;border-radius:10px;background:#2563eb;cursor:grab;box-shadow:0 1px 1px rgba(0,0,0,.08)}
  .bar.dragging{cursor:grabbing;opacity:.9}
  .bar .label{position:absolute;left:10px;right:10px;top:2px;font-size:10px;line-height:1;color:#fff;opacity:.95;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;pointer-events:none}
  .bar .deps{position:absolute;left:10px;right:10px;bottom:2px;font-size:10px;line-height:1;color:#fff;opacity:.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;pointer-events:none}
  .handle{position:absolute;top:0;width:10px;height:20px;opacity:.0;}
  .bar:hover .handle{opacity:.35;}
  .handle.left{left:0;border-top-left-radius:10px;border-bottom-left-radius:10px;background:#0b3ea8;cursor:ew-resize}
  .handle.right{right:0;border-top-right-radius:10px;border-bottom-right-radius:10px;background:#0b3ea8;cursor:ew-resize}

  .hint{padding:10px 12px;font-size:12px;color:#374151;direction:rtl;text-align:right}
  .dep-layer{position:absolute;left:0;top:0;pointer-events:none;overflow:visible}

  /* Charts */
  .dash{display:grid;grid-template-columns:repeat(3,minmax(220px,1fr));gap:12px;margin:12px 0}
  @media (max-width: 980px){
    .dash{grid-template-columns:1fr}
    .grid{grid-template-columns:1fr}
    .left{border-right:none;border-bottom:1px solid #e5e7eb}
    .workArea{height: min(70vh, 760px);}
  }
  .chart-card{padding:12px; position:relative;}
  .chart-title{font-weight:900;font-size:13px;margin:0 0 8px 0;direction:rtl;text-align:right}
  canvas{width:100%;height:160px;display:block}
  .chart-legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;direction:ltr}
  .chart-legend .it{display:flex;gap:6px;align-items:center;font-size:12px;color:#374151;max-width:100%}
  .chart-legend .it span:last-child{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%}
  .chart-legend .dot{width:10px;height:10px;border-radius:3px;display:inline-block}

  /* Tooltip for charts */
  #chartTip{
    position:fixed;
    z-index:9999;
    display:none;
    padding:10px 12px;
    background:#111827;
    color:#fff;
    border-radius:12px;
    font-size:12px;
    max-width:min(420px, 92vw);
    box-shadow:0 14px 40px rgba(0,0,0,.35);
    pointer-events:none;
    white-space:pre-wrap;
  }

  /* Modal (shared style) */
  .modal-backdrop{
    position:fixed; inset:0;
    background:rgba(17,24,39,.55);
    display:none; align-items:center; justify-content:center;
    padding:16px; z-index:50;
  }
  .modal{
    width:min(880px, 100%);
    background:#fff; border-radius:16px;
    border:1px solid #e5e7eb;
    box-shadow:0 20px 70px rgba(0,0,0,.25);
    overflow:auto;
    max-height:85vh;
  }
  .modal-hd{
    display:flex; align-items:center; justify-content:space-between;
    padding:14px 16px; border-bottom:1px solid #e5e7eb;
  }
  .modal-hd h2{margin:0;font-size:16px;font-weight:900}
  .modal-bd{padding:14px 16px}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .fg{display:flex;flex-direction:column;gap:6px}
  .fg label{font-size:12px;color:#374151; font-weight:700}
  .fg input, .fg select{
    padding:10px 12px;border:1px solid #d1d5e1;border-radius:10px;font-size:14px
  }
  .modal-ft{
    display:flex; gap:10px; flex-wrap:wrap;
    padding:14px 16px; border-top:1px solid #e5e7eb;
    justify-content:flex-end;
  }
  .statusBox{
    margin-top:10px;
    padding:10px 12px;
    border:1px solid #e5e7eb;
    border-radius:12px;
    background:#f8fafc;
    font-size:12px;
    white-space:pre-wrap;
    direction:ltr;
    text-align:left;
    overflow:auto;
    max-height:160px;
  }

  /* Dependencies UI */
  #depsDropZone{
    border:1px dashed #cbd5e1;
    border-radius:14px;
    padding:10px;
    background:#ffffff;
    overflow:auto;
  }
  #depsDropZone.dragover{
    border-color:#2563eb;
    box-shadow:0 0 0 3px rgba(37,99,235,.15);
    background:#f8fbff;
  }
  #te_deps_select{
    min-height:160px;
    overflow:auto;
  }
  #te_deps_select option{ padding:6px 6px; }

  .depsTop{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    margin-bottom:10px;
  }
  .depsTop select{ flex:1; min-width:240px; }
</style>
</head>
<body>
<header>
  <h1>
    AMIR DAVIDI TECHNOLOGIES – גאנט פרויקט Ghana Energy CERT (Drag & Drop)
    <span class="pill">Version 21</span>
  </h1>
  <div class="meta">
    ✅ עריכת משימה עם תאריכים (Date Picker) · ✅ Dependencies ב-Dropdown + Drag&Drop · ✅ Load/Save ל-GitHub (tasks.csv)
    <span class="pill">בלי מקרא צבעים למעלה</span>
  </div>
</header>

<div class="wrap">
  <div class="controls">
    <input id="q" placeholder="חיפוש (Task / Owner / Phase / ID)..." style="min-width:320px"/>
    <select id="ownerFilter"><option value="">כל ה-Owners</option></select>
    <select id="zoom">
      <option value="day">יום (Day)</option>
      <option value="week" selected>שבוע (Week)</option>
      <option value="month">חודש (Month)</option>
    </select>

    <button class="btn-primary" id="exportCsv">Export CSV</button>
    <button class="btn-ghost" id="settingsBtn">Settings (GitHub)</button>

    <button class="btn-ok" id="loadRepo" title="טען tasks.csv מה-GitHub (Public בלי טוקן דרך RAW; Private דרך API)">Load from GIT (tasks.csv)</button>
    <button class="btn-primary" id="saveRepo" title="שמור tasks.csv חזרה ל-GitHub (דורש Token עם הרשאות)">Save to GIT (tasks.csv)</button>
    <button class="btn-ghost" id="downloadTemplate" title="הורד תבנית CSV מלאה לייבוא">Download CSV Template</button>
    <button class="btn-warn" id="clearLocal" title="מוחק שינויים מקומיים ומחזיר למצב בסיס">Clear Local Cache</button>

    <div style="flex:1"></div>

    <div class="importBox" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <input id="importFile" type="file" accept=".csv,text/csv"/>
      <button class="btn-ghost" id="importBtn">Import CSV</button>
    </div>

    <button id="reset">איפוס</button>
  </div>

  <div class="dash">
    <div class="card chart-card">
      <p class="chart-title">משימות לפי קטגוריה (שם קצר + Hover לשם מלא)</p>
      <canvas id="chartCats" width="600" height="220"></canvas>
      <div class="chart-legend" id="lgCats"></div>
    </div>
    <div class="card chart-card">
      <p class="chart-title">משימות לפי Owner</p>
      <canvas id="chartOwners" width="600" height="220"></canvas>
      <div class="chart-legend" id="lgOwners"></div>
    </div>
    <div class="card chart-card">
      <p class="chart-title">מדדים מהירים</p>
      <canvas id="chartKPIs" width="600" height="220"></canvas>
      <div class="hint" style="padding:8px 0 0 0;text-align:right">
        KPI: כמות משימות · כמות Milestones · כמות תלויות · טווח תאריכים (ימים)
      </div>
    </div>
  </div>

  <div class="card">
    <div class="grid workArea">
      <div class="left" id="left"></div>
      <div class="right" id="rightPane">
        <div class="timeline" id="timeline"></div>
        <div class="bar-area" id="bars"></div>
      </div>
    </div>
    <div class="hint">
      איך להוסיף תלות בדרופ: גרור את כפתור ה-➕ ליד משימה מהרשימה השמאלית לתוך תיבת Dependencies בחלון העריכה.
    </div>
  </div>
</div>

<div id="chartTip"></div>

<!-- Settings Modal -->
<div class="modal-backdrop" id="modalBg" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal">
    <div class="modal-hd">
      <h2>GitHub Settings</h2>
      <button class="btn-ghost" id="closeSettings">סגור</button>
    </div>
    <div class="modal-bd">
      <div class="form-grid">
        <div class="fg">
          <label>Owner / Org</label>
          <input id="ghOwner" placeholder="amird1976"/>
        </div>
        <div class="fg">
          <label>Repository</label>
          <input id="ghRepo" placeholder="GANA_PM"/>
        </div>
        <div class="fg">
          <label>Branch</label>
          <input id="ghBranch" placeholder="main"/>
        </div>
        <div class="fg">
          <label>Path (CSV file)</label>
          <input id="ghPath" placeholder="tasks.csv"/>
        </div>
        <div class="fg" style="grid-column:1 / -1">
          <label>Personal Access Token – נשמר רק בדפדפן שלך (localStorage)</label>
          <input id="ghToken" placeholder="ghp_... / github_pat_..." autocomplete="off" spellcheck="false"/>
        </div>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <button class="btn-primary" id="saveSettings">שמור Settings</button>
        <button class="btn-ghost" id="testLoadRaw">Test RAW Load (Public)</button>
        <button class="btn-ghost" id="testApi">Test API (requires token)</button>
        <span class="pill" id="cfgHint">—</span>
      </div>

      <div class="statusBox" id="statusBox">Status log…</div>

      <div class="hint" style="margin-top:10px">
        הערה: Load ציבורי עובד גם בלי Token דרך raw.githubusercontent.com. Save תמיד דורש Token עם הרשאות כתיבה לקובץ.
      </div>
    </div>
    <div class="modal-ft">
      <button class="btn-warn" id="forgetToken">מחק Token מהמכשיר</button>
      <button class="btn-ghost" id="closeSettings2">סגור</button>
    </div>
  </div>
</div>

<!-- Task Editor Modal -->
<div class="modal-backdrop" id="taskModalBg" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal">
    <div class="modal-hd">
      <h2 id="taskModalTitle">עריכת משימה</h2>
      <button class="btn-ghost" id="closeTaskModal">סגור</button>
    </div>

    <div class="modal-bd">
      <div class="form-grid">
        <div class="fg">
          <label>Task ID</label>
          <input id="te_id" disabled />
        </div>

        <div class="fg">
          <label>Owner</label>
          <input id="te_owner" placeholder="Owner / אחראי" />
        </div>

        <div class="fg" style="grid-column:1 / -1">
          <label>שם משימה</label>
          <input id="te_name" placeholder="שם משימה" />
        </div>

        <div class="fg" style="grid-column:1 / -1">
          <label>קטגוריה / שלב (Phase)</label>
          <input id="te_phase" placeholder="לדוגמה: 6.1 Physical / שלב 5 – תתי-שלבים 5.1–5.17" />
        </div>

        <div class="fg">
          <label>Start Date (קל לבחור)</label>
          <input id="te_startDate" type="date" />
        </div>

        <div class="fg">
          <label>End Date (קל לבחור)</label>
          <input id="te_endDate" type="date" />
        </div>

        <div class="fg">
          <label>Start Offset (days)</label>
          <input id="te_startOffset" type="number" min="0" step="1" />
        </div>

        <div class="fg">
          <label>Duration (days)</label>
          <input id="te_duration" type="number" min="1" step="1" />
        </div>

        <div class="fg">
          <label>Milestone</label>
          <select id="te_milestone">
            <option value="0">לא</option>
            <option value="1">כן</option>
          </select>
        </div>

        <div class="fg" style="grid-column:1 / -1">
          <label>Dependencies (בחר משימות / הוסף / או גרור לכאן)</label>

          <div id="depsDropZone" title="אפשר לגרור לכאן משימה מהרשימה השמאלית (אייקון ➕)">
            <div class="depsTop">
              <select id="te_dep_add">
                <option value="">בחר משימה להוספה…</option>
              </select>
              <button class="btn-ghost" id="btnAddDep" type="button">הוסף תלות</button>
              <button class="btn-warn" id="btnClearDeps" type="button">נקה</button>
            </div>

            <select id="te_deps_select" multiple size="8"></select>

            <div style="font-size:12px;color:#6b7280;direction:rtl;text-align:right;margin-top:6px">
              נשמר אוטומטית כ-CSV IDs: <span class="pill" id="depsPreview">—</span>
            </div>
          </div>
        </div>

        <div class="fg" style="grid-column:1 / -1">
          <label>Notes / הערות</label>
          <input id="te_notes" placeholder="טקסט חופשי" />
        </div>
      </div>

      <div class="statusBox" id="taskStatusBox">Ready.</div>
    </div>

    <div class="modal-ft">
      <button class="btn-warn" id="deleteTaskBtn">מחק משימה</button>
      <button class="btn-ghost" id="duplicateTaskBtn">שכפל</button>
      <button class="btn-primary" id="saveTaskBtn">שמור</button>
    </div>
  </div>
</div>

<script>
/* =========================
   Version 21 (fixed)
   ========================= */

const MS_DAY = 86400000;
const MIN_START = new Date("2026-01-05");
const MAX_END   = new Date("2026-06-10");

/* Demo base; load from Git replaces it */
const BASE = [
  {"id":"1","phase":"1. Management","name":"פתיחת פרויקט וניהול (Phase 1)","owner":"צוות יעוץ","startOffset":0,"duration":30,"deps":"","milestone":false,"notes":""},
  {"id":"2","phase":"1.1 Admin","name":"פגישת קיק-אוף והתנעת צוות היגוי","owner":"צוות יעוץ","startOffset":0,"duration":2,"deps":"","milestone":true,"notes":"דוגמה: milestone=true"},
  {"id":"3","phase":"1.1 Admin","name":"הקמת משרד PMO פיזי באקרה (Ghana)","owner":"Local Ops","startOffset":2,"duration":14,"deps":"2","milestone":false,"notes":""},
  {"id":"4","phase":"2. Design","name":"CDR - תכנון הנדסי מפורט (Design Phase)","owner":"Engineering","startOffset":0,"duration":60,"deps":"","milestone":false,"notes":""}
];

let ALL = BASE.map(t => ({...t}));

/* Local storage keys */
const STORE_KEY      = "gantt_tasks_v21_edits";
const STORE_KEY_CSV  = "gantt_tasks_v21_csv_snapshot";
const STORE_GH_CFG   = "gantt_github_cfg_v21";

/* ---------- Helpers ---------- */
function daysBetween(a,b){ return Math.round((b-a)/MS_DAY); }
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
function fmt(d){
  const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}
function parseDateInput(val){
  if (!val) return null;
  const [y,m,d] = val.split("-").map(Number);
  if (!y || !m || !d) return null;
  return new Date(y, m-1, d);
}
function calcDatesFromOffsets(t){
  const s = new Date(MIN_START.getTime() + (Number(t.startOffset||0))*MS_DAY);
  const e = new Date(s.getTime() + Math.max(1,Number(t.duration||1))*MS_DAY);
  t.start = fmt(s); t.end = fmt(e);
}
function escapeHtml(s){
  s = String(s ?? "");
  return s.replace(/[&<>"']/g, (ch)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[ch]));
}

/* ---------- Category labeling ---------- */
function phaseInfo(phaseRaw){
  const p = String(phaseRaw||"").replace(/\s+/g," ").trim();
  if (!p) return {short:"Other", full:"Other", groupKey:"Other"};

  const heb = p.match(/שלב\s*([0-9]+)/);
  if (heb){
    const num = heb[1];
    const full = p;
    let hint = "";
    const afterDash = p.split(/[–-]/).slice(1).join(" ").trim();
    if (afterDash){
      hint = afterDash.length > 22 ? afterDash.slice(0,22)+"…" : afterDash;
      hint = " – " + hint;
    }
    return { short:`שלב ${num}${hint}`, full, groupKey:`P${num}` };
  }

  if (/^\d+(\.\d+)?$/.test(p)){
    const map = {
      "5.18":"Phase 5.18 – Final SSR Approvals",
      "7.18":"Phase 7.18 – Cutover / Go-Live Readiness",
      "7.19":"Phase 7.19 – Final Acceptance / Handover"
    };
    const full = map[p] ? map[p] : `Phase ${p}`;
    return { short:`${p}`, full, groupKey:`P${String(p).split(".")[0]}` };
  }

  const m = p.match(/^(\d+(?:\.\d+)?)\s*[\.\-]?\s*(.*)$/);
  if (m){
    const code = m[1];
    const rest = (m[2]||"").trim();
    const full = p;
    const short = rest ? `${code} – ${rest}` : `${code}`;
    return { short, full, groupKey:`P${String(code).split(".")[0]}` };
  }

  const full = p;
  const short = p.length > 26 ? (p.slice(0,26)+"…") : p;
  return { short, full, groupKey:"Other" };
}

function colorForCategoryKey(key){
  const palette = ["#2563eb","#16a34a","#f59e0b","#dc2626","#9333ea","#0891b2","#7c3aed","#0ea5e9","#22c55e","#ea580c","#be123c","#0f766e","#4f46e5","#a16207","#1d4ed8"];
  let h=0; for (let i=0;i<key.length;i++) h = (h*31 + key.charCodeAt(i)) >>> 0;
  return palette[h % palette.length];
}
function depsLabel(t){
  const d = (t.deps||"").trim();
  if (!d) return "";
  return d.length > 30 ? (d.slice(0,30) + "…") : d;
}

/* ---------- Local edits ---------- */
function loadEdits() {
  try { const raw = localStorage.getItem(STORE_KEY); return raw ? JSON.parse(raw) : null; } catch(e){ return null; }
}
function saveEdits(edits) { try { localStorage.setItem(STORE_KEY, JSON.stringify(edits)); } catch(e){} }
function persistOne(t){
  const edits = loadEdits() || {};
  edits[t.id] = {
    id:String(t.id),
    phase:t.phase||"",
    name:t.name||"",
    owner:t.owner||"",
    startOffset:Number(t.startOffset||0),
    duration:Number(t.duration||1),
    deps:t.deps||"",
    milestone: !!t.milestone,
    notes: t.notes||"",
    start:t.start, end:t.end
  };
  saveEdits(edits);
}
function findTask(id){ return ALL.find(x=>String(x.id)===String(id)); }

/* Apply stored edits */
(function applyLocal(){
  const edits = loadEdits(); if (!edits) return;
  ALL = ALL.map(t => edits[t.id] ? ({...t, ...edits[t.id]}) : t);
})();
ALL.forEach(calcDatesFromOffsets);

/* ---------- Owner filter ---------- */
const ownerSel = document.getElementById('ownerFilter');
function rebuildOwnerOptions(tasks){
  ownerSel.innerHTML = '<option value="">כל ה-Owners</option>';
  Array.from(new Set(tasks.map(t => (t.owner||'').trim()).filter(Boolean))).sort().forEach(o=>{
    const opt=document.createElement('option'); opt.value=o; opt.textContent=o; ownerSel.appendChild(opt);
  });
}
rebuildOwnerOptions(ALL);

/* ---------- Zoom / ticks ---------- */
function pxPerDayForZoom(){ const z=document.getElementById('zoom').value; return (z==='day')?18:(z==='week'?7:2.5); }
function buildTicks(pxPerDay){
  const tl=document.getElementById('timeline'); tl.innerHTML='';
  const ticks=document.createElement('div'); ticks.className='ticks';
  const totalDays=daysBetween(MIN_START, MAX_END);
  const zoom=document.getElementById('zoom').value;
  const step = zoom==='day'?1:(zoom==='week'?7:30);

  for (let i=0;i<=totalDays;i++){
    const d=new Date(MIN_START.getTime()+i*MS_DAY);
    const tick=document.createElement('div');
    tick.className='tick'; tick.style.width=pxPerDay+'px';
    tick.textContent = (i%step===0)?fmt(d):'';
    ticks.appendChild(tick);
  }
  ticks.style.width=((totalDays+1)*pxPerDay)+'px';
  tl.appendChild(ticks);
}

/* ---------- Drag (schedule) ---------- */
function attachDrag(barEl, pxPerDay){
  let mode="move", startX=0, origOffset=0, origDuration=0;

  function onPointerDown(e){
    const handle=e.target?.dataset?.handle;
    mode = handle==='left'?'resizeL':(handle==='right'?'resizeR':'move');
    barEl.setPointerCapture(e.pointerId);
    barEl.classList.add('dragging');
    startX=e.clientX;
    const t=findTask(barEl.dataset.id);
    origOffset=t.startOffset; origDuration=t.duration;
    e.preventDefault(); e.stopPropagation();
  }

  function onPointerMove(e){
    if (!barEl.classList.contains('dragging')) return;
    const dx=e.clientX-startX;
    const deltaDays=Math.round(dx/pxPerDay);
    const t=findTask(barEl.dataset.id); if (!t) return;

    if (mode==='move'){
      t.startOffset = clamp(origOffset+deltaDays,0,100000);
    } else if (mode==='resizeR'){
      t.duration = clamp(origDuration+deltaDays,1,100000);
    } else if (mode==='resizeL'){
      const newOffset=origOffset+deltaDays;
      const newDur=origDuration-deltaDays;
      if (newDur>=1){ t.startOffset=clamp(newOffset,0,100000); t.duration=newDur; }
    }

    calcDatesFromOffsets(t);
    barEl.style.left=(t.startOffset*pxPerDay)+'px';
    barEl.style.width=(Math.max(1,t.duration)*pxPerDay)+'px';
    updateCharts(); // live
  }

  function onPointerUp(e){
    if (!barEl.classList.contains('dragging')) return;
    barEl.classList.remove('dragging');
    const t=findTask(barEl.dataset.id);
    if (t) persistOne(t);
    try{ barEl.releasePointerCapture(e.pointerId);}catch(_){}
    render();
  }

  barEl.addEventListener('pointerdown', onPointerDown);
  barEl.addEventListener('pointermove', onPointerMove);
  barEl.addEventListener('pointerup', onPointerUp);
  barEl.addEventListener('pointercancel', onPointerUp);
}

/* ---------- Milestone look ---------- */
function applyMilestoneStyle(barEl, isMilestone){
  if (!isMilestone) { barEl.style.borderRadius="10px"; barEl.style.transform="none"; return; }
  barEl.style.borderRadius="4px";
  barEl.style.transform="rotate(45deg)";
}

/* ---------- Render ---------- */
function render(){
  const q=(document.getElementById('q').value||'').toLowerCase().trim();
  const ownerVal=(document.getElementById('ownerFilter').value||'').toLowerCase();
  const pxPerDay=pxPerDayForZoom();

  const baseList = !q ? ALL : ALL.filter(t =>
    (t.name||'').toLowerCase().includes(q) ||
    (t.owner||'').toLowerCase().includes(q) ||
    (t.phase||'').toLowerCase().includes(q) ||
    String(t.id||'').toLowerCase().includes(q)
  );
  const list = !ownerVal ? baseList : baseList.filter(t => (t.owner||'').toLowerCase()===ownerVal);

  // Left list
  const left=document.getElementById('left');
  left.innerHTML='';

  const h=document.createElement('div');
  h.className='row'; h.style.fontWeight='900';
  h.innerHTML = `<div class="meta">Dep</div><div class="meta">ID</div><div class="title">משימה</div><div class="meta">Owner</div>`;
  left.appendChild(h);

  list.forEach(t=>{
    const r=document.createElement('div'); r.className='row clickable';
    r.title = `Phase: ${phaseInfo(t.phase).full}`;

    const depBtn = document.createElement('div');
    depBtn.className = "dragDep";
    depBtn.title = "גרור כדי להוסיף כתלות (Dependency)";
    depBtn.textContent = "➕";
    depBtn.setAttribute("draggable","true");
    depBtn.addEventListener("dragstart", (e)=>{
      e.dataTransfer.setData("text/plain", String(t.id));
      e.dataTransfer.effectAllowed = "copy";
    });

    const idEl = document.createElement('div');
    idEl.className="meta";
    idEl.textContent = "#"+t.id;

    const titleEl = document.createElement('div');
    titleEl.className="title";
    titleEl.innerHTML = escapeHtml(t.name);

    const ownerEl = document.createElement('div');
    ownerEl.className="meta";
    ownerEl.textContent = t.owner || "";

    r.appendChild(depBtn);
    r.appendChild(idEl);
    r.appendChild(titleEl);
    r.appendChild(ownerEl);

    r.addEventListener('click', (ev)=>{
      if (ev.target && ev.target.classList && ev.target.classList.contains("dragDep")) return;
      openTaskModal(t.id);
    });

    left.appendChild(r);
  });

  buildTicks(pxPerDay);

  const bars=document.getElementById('bars');
  bars.innerHTML='';

  // Dependency overlay SVG
  const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.classList.add('dep-layer'); svg.setAttribute('aria-hidden','true');
  const defs=document.createElementNS('http://www.w3.org/2000/svg','defs');
  const marker=document.createElementNS('http://www.w3.org/2000/svg','marker');
  marker.setAttribute('id','arrow'); marker.setAttribute('markerWidth','10'); marker.setAttribute('markerHeight','10');
  marker.setAttribute('refX','8'); marker.setAttribute('refY','3'); marker.setAttribute('orient','auto');
  const ap=document.createElementNS('http://www.w3.org/2000/svg','path');
  ap.setAttribute('d','M0,0 L8,3 L0,6 Z'); ap.setAttribute('fill','#64748b');
  marker.appendChild(ap); defs.appendChild(marker); svg.appendChild(defs); bars.appendChild(svg);

  const totalDays=daysBetween(MIN_START, MAX_END);
  const width=((totalDays+1)*pxPerDay);

  list.forEach((t)=>{
    const row=document.createElement('div');
    row.className='bar-row';
    row.style.width=width+'px';

    const bar=document.createElement('div');
    bar.className='bar';
    bar.dataset.id=t.id;

    const isMs = !!t.milestone;
    const durPx = Math.max(1,Number(t.duration||1))*pxPerDay;
    const msSize = Math.max(10, Math.min(18, pxPerDay*2.2));
    bar.style.left=(Number(t.startOffset||0)*pxPerDay)+'px';
    bar.style.width = isMs ? (msSize+'px') : (durPx+'px');

    const info = phaseInfo(t.phase);
    bar.style.background = colorForCategoryKey(info.groupKey + "|" + info.short);

    bar.title = `#${t.id}\n${t.name}\nPhase: ${info.full}\nOwner: ${t.owner||""}\nStart: ${t.start}  End: ${t.end}\nDeps: ${t.deps||"-"}`;

    applyMilestoneStyle(bar, isMs);

    const lbl=document.createElement('div');
    lbl.className='label';
    lbl.textContent = isMs ? `#${t.id}` : `#${t.id} · ${t.name}`;

    const dep=depsLabel(t);
    const depEl=document.createElement('div');
    depEl.className='deps';
    depEl.textContent = dep ? `Deps: ${dep}` : '';

    if (isMs) { depEl.textContent=''; lbl.style.transform="rotate(-45deg)"; lbl.style.left="6px"; lbl.style.right="6px"; }

    bar.appendChild(lbl);
    bar.appendChild(depEl);

    const hL=document.createElement('div'); hL.className='handle left'; hL.dataset.handle='left';
    const hR=document.createElement('div'); hR.className='handle right'; hR.dataset.handle='right';
    if (!isMs){ bar.appendChild(hL); bar.appendChild(hR); }

    bar.addEventListener('click', (e)=>{
      if (bar.classList.contains('dragging')) return;
      openTaskModal(t.id);
      e.preventDefault();
      e.stopPropagation();
    });

    attachDrag(bar, pxPerDay);
    row.appendChild(bar);
    bars.appendChild(row);
  });

  // Draw dependency lines among visible
  const rowsCount=list.length;
  const svgHeight=rowsCount*34;
  svg.setAttribute('width', width);
  svg.setAttribute('height', svgHeight);
  svg.setAttribute('viewBox', `0 0 ${width} ${svgHeight}`);
  Array.from(svg.querySelectorAll('path.dep')).forEach(p=>p.remove());

  const centerY = (i)=>(i*34+17);
  const barEndX = (tt)=>((Number(tt.startOffset||0) + Math.max(1,Number(tt.duration||1)))*pxPerDay);
  const barStartX = (tt)=>((Number(tt.startOffset||0))*pxPerDay);
  const visibleById = new Map(list.map((tt,i)=>[String(tt.id), {t:tt,i}]));

  list.forEach((tt,i)=>{
    const deps = String(tt.deps||'').split(/[,\s]+/).map(x=>x.trim()).filter(Boolean);
    deps.forEach(did=>{
      if (!visibleById.has(did)) return;
      const from=visibleById.get(did);
      const x1=barEndX(from.t), y1=centerY(from.i);
      const x2=barStartX(tt), y2=centerY(i);
      const midX=(x1+x2)/2;
      const p=document.createElementNS('http://www.w3.org/2000/svg','path');
      p.classList.add('dep');
      p.setAttribute('d', `M ${x1} ${y1} L ${midX} ${y1} L ${midX} ${y2} L ${x2} ${y2}`);
      p.setAttribute('fill','none');
      p.setAttribute('stroke','#64748b');
      p.setAttribute('stroke-width','1.2');
      p.setAttribute('marker-end','url(#arrow)');
      svg.appendChild(p);
    });
  });

  updateCharts(list);
}

/* ---------- CSV Export/Import ---------- */
function exportCSVText(tasks){
  const header = ["id","phase","name","owner","startOffset","duration","start","end","deps","milestone","notes"];
  const rows = [header.join(",")];
  const esc = (v)=>{
    const s=String(v ?? "");
    if (s.includes('"')||s.includes(",")||s.includes("\n")||s.includes("\r")) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  };
  tasks.forEach(t=>{
    rows.push([
      esc(t.id),
      esc(t.phase),
      esc(t.name),
      esc(t.owner),
      esc(t.startOffset),
      esc(t.duration),
      esc(t.start||""),
      esc(t.end||""),
      esc(t.deps||""),
      esc(t.milestone?1:0),
      esc(t.notes||"")
    ].join(","));
  });
  const bom="\uFEFF";
  return bom + rows.join("\r\n");
}
function exportCSV(){
  ALL.forEach(calcDatesFromOffsets);
  const csvText = exportCSVText(ALL);
  const blob = new Blob([csvText], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url;
  a.download="gantt_full_export.csv";
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 5000);
  try{ localStorage.setItem(STORE_KEY_CSV, csvText);}catch(_){}
}

function downloadTemplate(){
  const sample = [
    {id:"1", phase:"1. Management", name:"Example task", owner:"Owner", startOffset:0, duration:7, deps:"", milestone:false, notes:""},
    {id:"2", phase:"שלב 5 – תתי-שלבים 5.1–5.17", name:"Hebrew phase example", owner:"Owner", startOffset:7, duration:1, deps:"1", milestone:true, notes:""}
  ];
  sample.forEach(calcDatesFromOffsets);
  const csvText = exportCSVText(sample);
  const blob = new Blob([csvText], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url;
  a.download="tasks_template.csv";
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 5000);
}

function parseCSV(text){
  const lines = text.replace(/^\uFEFF/,'').split(/\r\n|\n|\r/);
  const out = [];
  let headers = null;

  function splitLine(line){
    const res=[];
    let cur="", inQ=false;
    for (let i=0;i<line.length;i++){
      const ch=line[i];
      if (inQ){
        if (ch === '"'){
          if (line[i+1] === '"'){ cur+='"'; i++; }
          else inQ=false;
        } else cur+=ch;
      } else {
        if (ch === '"') inQ=true;
        else if (ch === ','){ res.push(cur); cur=""; }
        else cur+=ch;
      }
    }
    res.push(cur);
    return res;
  }

  for (let i=0;i<lines.length;i++){
    const line=lines[i];
    if (!line.trim()) continue;
    const cols=splitLine(line);
    if (!headers){
      headers = cols.map(h=>h.trim());
      continue;
    }
    const obj={};
    headers.forEach((h, idx)=> obj[h]= (cols[idx] ?? "").trim());
    out.push(obj);
  }
  return out;
}

function coerceTask(row){
  const pick = (...keys) => {
    for (const k of keys){
      if (k == null) continue;
      if (Object.prototype.hasOwnProperty.call(row, k)) {
        const v = row[k];
        if (v !== undefined && v !== null && String(v).trim() !== "") return v;
      }
    }
    return undefined;
  };

  const t = {};
  t.id    = String(pick("id","ID","מזהה") ?? "").trim();
  t.phase = String(pick("phase","Phase","Phase/Section","קטגוריה/שלב") ?? "").trim();
  t.name  = String(pick("name","Task","Task Name","שם משימה") ?? "").trim();
  t.owner = String(pick("owner","Owner","אחראי") ?? "").trim();

  t.deps  = String(pick("deps","Dependencies","תלויות") ?? "").trim();
  t.notes = String(pick("notes","Notes","הערות") ?? "").trim();

  const msRaw = pick("milestone","Milestone","אבן דרך","אבן_דרך");
  t.milestone = (String(msRaw ?? "").toLowerCase()==="true" || String(msRaw ?? "").toLowerCase()==="yes" || String(msRaw ?? "")==="1");

  const so = pick("startOffset","start_offset","Start Offset (days)","Start Offset","StartOffset","Start Offset (Days)");
  const du = pick("duration","Duration","Duration (days)","Duration Days","משך (ימים)");

  const startRaw = pick("start","Start","Start Date","תאריך התחלה");
  const endRaw   = pick("end","End","End Date","תאריך סיום");

  t.startOffset = (so !== undefined) ? Number(so) : 0;
  t.duration    = (du !== undefined) ? Number(du) : 1;

  if ((so === undefined || du === undefined) && startRaw && endRaw){
    const sd = parseDateInput(String(startRaw).trim());
    const ed = parseDateInput(String(endRaw).trim());
    if (sd && ed){
      const off = Math.max(0, daysBetween(MIN_START, sd));
      let dur = Math.max(1, daysBetween(sd, ed));
      t.startOffset = off;
      t.duration = dur;
    }
  }

  return t;
}

async function importCSVFromFile(file){
  const text = await file.text();
  await importCSVFromText(text, "FILE");
}

async function importCSVFromText(text, sourceLabel){
  const rows = parseCSV(text);
  const tasks = rows.map(coerceTask).filter(t=>t && t.id);

  if (!tasks.length){
    alert("טעינה הצליחה אבל לא נמצאו משימות ב-CSV (בדוק כותרות עמודות / פורמט).");
    return;
  }

  ALL = tasks.map(t=>({...t}));
  ALL.forEach(calcDatesFromOffsets);

  const edits = {};
  ALL.forEach(t=>{
    edits[t.id] = {
      id:String(t.id),
      phase:t.phase||"",
      name:t.name||"",
      owner:t.owner||"",
      startOffset:Number(t.startOffset||0),
      duration:Number(t.duration||1),
      deps:t.deps||"",
      milestone: !!t.milestone,
      notes: t.notes||"",
      start:t.start, end:t.end
    };
  });
  saveEdits(edits);
  rebuildOwnerOptions(ALL);
  document.getElementById('ownerFilter').value = "";
  render();
  updateCharts();
  logStatus(`✅ Imported ${ALL.length} tasks from ${sourceLabel}`);
  alert(`✅ נטענו ${ALL.length} משימות (${sourceLabel}).`);
}

/* ---------- Clear / Reset ---------- */
function clearLocalCache(){
  localStorage.removeItem(STORE_KEY);
  localStorage.removeItem(STORE_KEY_CSV);
  ALL = BASE.map(t=>({...t}));
  ALL.forEach(calcDatesFromOffsets);
  rebuildOwnerOptions(ALL);
  document.getElementById('q').value='';
  document.getElementById('ownerFilter').value='';
  render();
  updateCharts();
  alert("✅ נמחק Cache מקומי. חזרת למצב בסיס. עכשיו אפשר Load מה-GIT.");
}
function resetAll(){
  localStorage.removeItem(STORE_KEY);
  localStorage.removeItem(STORE_KEY_CSV);
  localStorage.removeItem(STORE_GH_CFG);
  ALL = BASE.map(t=>({...t}));
  ALL.forEach(calcDatesFromOffsets);
  rebuildOwnerOptions(ALL);
  document.getElementById('q').value='';
  document.getElementById('ownerFilter').value='';
  document.getElementById('zoom').value='week';
  render();
  updateCharts();
  alert("✅ איפוס מלא (כולל Settings).");
}

/* ---------- Mini chart engine + tooltips ---------- */
const chartTip = document.getElementById("chartTip");
function showTip(x,y,text){
  chartTip.textContent = text;
  chartTip.style.display = "block";
  const pad = 14;
  const w = chartTip.offsetWidth;
  const h = chartTip.offsetHeight;
  let left = x + pad;
  let top  = y + pad;
  if (left + w > window.innerWidth - 8) left = x - w - pad;
  if (top + h > window.innerHeight - 8) top = y - h - pad;
  chartTip.style.left = left + "px";
  chartTip.style.top  = top + "px";
}
function hideTip(){ chartTip.style.display = "none"; }
function clearCanvas(ctx){ ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height); }
if (!CanvasRenderingContext2D.prototype.roundRect){
  CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
    r = Math.min(r, w/2, h/2);
    this.beginPath();
    this.moveTo(x+r,y);
    this.arcTo(x+w,y,x+w,y+h,r);
    this.arcTo(x+w,y+h,x,y+h,r);
    this.arcTo(x,y+h,x,y,r);
    this.arcTo(x,y,x+w,y,r);
    this.closePath();
    return this;
  };
}
function drawBarChart(canvas, items, colorFn, legendEl, labelMode){
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  clearCanvas(ctx);

  const top = 16, bottom = 30, left = 8, right = 8;
  const plotW = W - left - right;
  const plotH = H - top - bottom;

  const maxV = Math.max(1, ...items.map(x=>x.v));
  const barCount = items.length || 1;
  const gap = 6;
  const barW = Math.max(10, Math.floor((plotW - gap*(barCount-1))/barCount));

  ctx.strokeStyle = "#e5e7eb";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(left, top+plotH);
  ctx.lineTo(left+plotW, top+plotH);
  ctx.stroke();

  const hit = [];
  items.forEach((it, i)=>{
    const h = Math.round((it.v/maxV) * (plotH-2));
    const x = left + i*(barW+gap);
    const y = top + (plotH - h);
    const col = colorFn(it.k, i);

    ctx.fillStyle = col;
    ctx.fillRect(x, y, barW, h);

    ctx.fillStyle = "#111827";
    ctx.font = "12px system-ui";
    ctx.textAlign = "center";
    ctx.fillText(String(it.v), x+barW/2, y-4);

    let lab = it.k;
    if (labelMode === "short") lab = it.short || it.k;
    const shown = lab.length > 18 ? (lab.slice(0,18)+"…") : lab;
    ctx.fillStyle = "#374151";
    ctx.font = "11px system-ui";
    ctx.fillText(shown, x+barW/2, top+plotH+18);

    hit.push({ x, y, w:barW, h, tooltip: it.tooltip || `${it.k}: ${it.v}` });
  });

  if (legendEl){
    legendEl.innerHTML = "";
    items.slice(0,12).forEach((it, i)=>{
      const div = document.createElement('div');
      div.className="it";
      div.title = it.full || it.k;
      const dot = document.createElement('span');
      dot.className="dot";
      dot.style.background = colorFn(it.k, i);
      const tx = document.createElement('span');
      const label = (it.short && it.full) ? `${it.short} · ${it.v}` : `${it.k}: ${it.v}`;
      tx.textContent = label;
      div.appendChild(dot); div.appendChild(tx);
      legendEl.appendChild(div);

      div.addEventListener("mousemove", (e)=>{
        const tip = (it.full ? it.full : it.k) + `\nCount: ${it.v}`;
        showTip(e.clientX, e.clientY, tip);
      });
      div.addEventListener("mouseleave", hideTip);
    });
  }

  canvas.onmousemove = (e)=>{
    const rect = canvas.getBoundingClientRect();
    const sx = (e.clientX - rect.left) * (canvas.width / rect.width);
    const sy = (e.clientY - rect.top)  * (canvas.height / rect.height);
    for (const hb of hit){
      if (sx >= hb.x && sx <= hb.x+hb.w && sy >= hb.y && sy <= hb.y+hb.h){
        showTip(e.clientX, e.clientY, hb.tooltip);
        return;
      }
    }
    hideTip();
  };
  canvas.onmouseleave = hideTip;
}

function drawKPI(canvas, kpis){
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  clearCanvas(ctx);

  const pad = 12;
  const cellW = (W - pad*3)/2;
  const cellH = (H - pad*3)/2;

  for (let i=0;i<kpis.length;i++){
    const r = Math.floor(i/2), c = i%2;
    const x = pad + c*(cellW+pad);
    const y = pad + r*(cellH+pad);

    ctx.fillStyle="#ffffff";
    ctx.strokeStyle="#e5e7eb";
    ctx.lineWidth=1;
    ctx.beginPath();
    ctx.roundRect(x,y,cellW,cellH,10);
    ctx.fill(); ctx.stroke();

    ctx.fillStyle="#374151";
    ctx.font="12px system-ui";
    ctx.textAlign="right";
    ctx.fillText(kpis[i].t, x+cellW-10, y+18);

    ctx.fillStyle="#111827";
    ctx.font="22px system-ui";
    ctx.textAlign="right";
    ctx.fillText(String(kpis[i].v), x+cellW-10, y+50);

    ctx.fillStyle="#6b7280";
    ctx.font="11px system-ui";
    ctx.textAlign="right";
    ctx.fillText(kpis[i].s||"", x+cellW-10, y+70);
  }
}

function updateCharts(listOverride){
  const list = listOverride || (()=>{
    const q=(document.getElementById('q').value||'').toLowerCase().trim();
    const ownerVal=(document.getElementById('ownerFilter').value||'').toLowerCase();
    const baseList = !q ? ALL : ALL.filter(t =>
      (t.name||'').toLowerCase().includes(q) ||
      (t.owner||'').toLowerCase().includes(q) ||
      (t.phase||'').toLowerCase().includes(q) ||
      String(t.id||'').toLowerCase().includes(q)
    );
    return !ownerVal ? baseList : baseList.filter(t => (t.owner||'').toLowerCase()===ownerVal);
  })();

  const catMap = new Map();
  list.forEach(t=>{
    const info = phaseInfo(t.phase);
    const key = info.short;
    const cur = catMap.get(key);
    if (!cur){
      catMap.set(key, {k:key, short:info.short, full:info.full, groupKey:info.groupKey, v:1});
    }else{
      cur.v++;
      if ((info.full||"").length > (cur.full||"").length) cur.full = info.full;
    }
  });
  const cats = Array.from(catMap.values()).sort((a,b)=>b.v-a.v).slice(0,10);

  const ownersMap = new Map();
  list.forEach(t=>{
    const k = (t.owner||"—");
    ownersMap.set(k, (ownersMap.get(k)||0)+1);
  });
  const owners = Array.from(ownersMap.entries()).map(([k,v])=>({k,v, tooltip:`Owner: ${k}\nTasks: ${v}`}))
    .sort((a,b)=>b.v-a.v).slice(0,10);

  drawBarChart(
    document.getElementById('chartCats'),
    cats.map(it=>({
      ...it,
      tooltip: `Category (FULL): ${it.full}\nCategory (SHORT): ${it.short}\nTasks: ${it.v}`
    })),
    (k)=>{
      const it = cats.find(x=>x.k===k) || {};
      return colorForCategoryKey((it.groupKey||"Other") + "|" + k);
    },
    document.getElementById('lgCats'),
    "short"
  );

  drawBarChart(
    document.getElementById('chartOwners'),
    owners,
    (k)=>{
      let h=0; for (let i=0;i<k.length;i++) h=(h*31+k.charCodeAt(i))>>>0;
      const pal=["#2563eb","#16a34a","#f59e0b","#dc2626","#9333ea","#0891b2","#7c3aed","#0ea5e9","#22c55e","#ea580c"];
      return pal[h%pal.length];
    },
    document.getElementById('lgOwners')
  );

  const milestones = list.filter(t=>!!t.milestone).length;
  const depsCount = list.reduce((acc,t)=> acc + (String(t.deps||'').split(/[,\s]+/).filter(Boolean).length), 0);

  const offs = list.map(t=>Number(t.startOffset||0));
  const ends = list.map(t=>Number(t.startOffset||0)+Math.max(1,Number(t.duration||1)));
  const minO = offs.length ? Math.min(...offs) : 0;
  const maxE = ends.length ? Math.max(...ends) : 0;
  const spanDays = Math.max(0, maxE - minO);

  drawKPI(document.getElementById('chartKPIs'), [
    {t:"כמות משימות", v:list.length, s:"בפילטר הנוכחי"},
    {t:"Milestones", v:milestones, s:"diamond"},
    {t:"כמות תלויות", v:depsCount, s:"edges"},
    {t:"טווח (ימים)", v:spanDays, s:"min..max"}
  ]);
}

/* ---------- GitHub Settings + API ---------- */
function ghDefaultCfg(){ return { owner:"", repo:"", branch:"main", path:"tasks.csv", token:"" }; }
function loadGhCfg(){
  try{
    const raw = localStorage.getItem(STORE_GH_CFG);
    return raw ? ({...ghDefaultCfg(), ...JSON.parse(raw)}) : ghDefaultCfg();
  }catch(_){ return ghDefaultCfg(); }
}
function saveGhCfg(cfg){ try{ localStorage.setItem(STORE_GH_CFG, JSON.stringify(cfg)); }catch(_){} }
function cfgSummary(cfg){
  const safeTok = cfg.token ? ("YES ("+cfg.token.slice(0,4)+"…"+cfg.token.slice(-4)+")") : "NO";
  return `${cfg.owner}/${cfg.repo} · branch=${cfg.branch} · path=${cfg.path} · token=${safeTok}`;
}
function setCfgHint(){
  const cfg = loadGhCfg();
  document.getElementById('cfgHint').textContent = cfg.owner && cfg.repo ? cfgSummary(cfg) : "⚠ הגדר Owner/Repo ב-Settings";
}
function logStatus(msg){
  const box = document.getElementById('statusBox');
  const ts = new Date().toLocaleTimeString();
  box.textContent = `[${ts}] ${msg}\n` + box.textContent;
}
function buildRawUrl(cfg){
  return `https://raw.githubusercontent.com/${encodeURIComponent(cfg.owner)}/${encodeURIComponent(cfg.repo)}/${encodeURIComponent(cfg.branch)}/${cfg.path.replace(/^\/+/,'')}`;
}
function buildApiUrl(cfg){
  const p = cfg.path.replace(/^\/+/,'');
  return `https://api.github.com/repos/${encodeURIComponent(cfg.owner)}/${encodeURIComponent(cfg.repo)}/contents/${p}?ref=${encodeURIComponent(cfg.branch)}`;
}
async function ghLoadTasks(){
  const cfg = loadGhCfg();
  if (!cfg.owner || !cfg.repo || !cfg.branch || !cfg.path){
    alert("חסרים פרטים ב-Settings (Owner/Repo/Branch/Path).");
    return;
  }

  const rawUrl = buildRawUrl(cfg);
  logStatus(`Load RAW: ${rawUrl}`);
  try{
    const r = await fetch(rawUrl, {cache:"no-store"});
    if (r.ok){
      const text = await r.text();
      await importCSVFromText(text, "RAW");
      return;
    }
    logStatus(`RAW failed: ${r.status}`);
  }catch(e){
    logStatus(`RAW error: ${e}`);
  }

  if (!cfg.token){
    alert("טעינה RAW נכשלה (אולי Repo פרטי). הוסף Token ב-Settings ואז נסה שוב.");
    return;
  }

  const apiUrl = buildApiUrl(cfg);
  logStatus(`Load API: ${apiUrl}`);
  const r2 = await fetch(apiUrl, {
    headers: {
      "Accept":"application/vnd.github+json",
      "Authorization": `Bearer ${cfg.token}`
    }
  });
  if (!r2.ok){
    const t = await r2.text().catch(()=> "");
    logStatus(`API load failed: ${r2.status} ${t}`);
    alert(`שגיאת API בטעינה: ${r2.status}. בדוק Token/הרשאות/נתיב קובץ.`);
    return;
  }
  const j = await r2.json();
  const content = j && j.content ? atob(j.content.replace(/\n/g,'')) : "";
  if (!content.trim()){
    alert("הקובץ נטען אבל ריק/לא תקין.");
    return;
  }
  await importCSVFromText(content, "API");
}
async function ghSaveTasks(){
  const cfg = loadGhCfg();
  if (!cfg.owner || !cfg.repo || !cfg.branch || !cfg.path){
    alert("חסרים פרטים ב-Settings (Owner/Repo/Branch/Path).");
    return;
  }
  if (!cfg.token){
    alert("כדי לשמור ל-Git צריך Token. היכנס ל-Settings והדבק Token עם הרשאות כתיבה.");
    return;
  }

  ALL.forEach(calcDatesFromOffsets);
  const csvText = exportCSVText(ALL).replace(/^\uFEFF/, "");
  const contentB64 = btoa(unescape(encodeURIComponent(csvText)));

  const apiUrl = buildApiUrl(cfg).replace(/(\?ref=).+$/,'') + `?ref=${encodeURIComponent(cfg.branch)}`;
  logStatus(`Fetch SHA: ${apiUrl}`);
  let sha = null;

  const r0 = await fetch(apiUrl, {
    headers: {
      "Accept":"application/vnd.github+json",
      "Authorization": `Bearer ${cfg.token}`
    }
  });

  if (r0.ok){
    const j0 = await r0.json();
    sha = j0.sha || null;
    logStatus(`Found existing SHA: ${sha ? sha.slice(0,7) : "none"}`);
  } else if (r0.status === 404){
    logStatus(`File not found – will create new file at ${cfg.path}`);
  } else {
    const tx = await r0.text().catch(()=> "");
    logStatus(`SHA fetch failed: ${r0.status} ${tx}`);
    alert(`לא הצלחתי לקרוא SHA מה-API (${r0.status}). בדוק Token והרשאות.`);
    return;
  }

  const putUrl = `https://api.github.com/repos/${encodeURIComponent(cfg.owner)}/${encodeURIComponent(cfg.repo)}/contents/${cfg.path.replace(/^\/+/,'')}`;
  const body = {
    message: `Update ${cfg.path} via Gantt v21`,
    content: contentB64,
    branch: cfg.branch
  };
  if (sha) body.sha = sha;

  logStatus(`PUT: ${putUrl}`);
  const r1 = await fetch(putUrl, {
    method:"PUT",
    headers:{
      "Accept":"application/vnd.github+json",
      "Authorization": `Bearer ${cfg.token}`,
      "Content-Type":"application/json"
    },
    body: JSON.stringify(body)
  });

  if (!r1.ok){
    const tx = await r1.text().catch(()=> "");
    logStatus(`PUT failed: ${r1.status} ${tx}`);
    alert(`שגיאה בשמירה ל-GitHub: ${r1.status}. בדוק הרשאות Token/Branch.`);
    return;
  }

  logStatus(`✅ Saved successfully.`);
  alert("✅ נשמר ל-GitHub בהצלחה.");
}

/* ---------- Settings modal wiring ---------- */
const modalBg = document.getElementById('modalBg');
function openSettings(){
  const cfg = loadGhCfg();
  document.getElementById('ghOwner').value  = cfg.owner || "";
  document.getElementById('ghRepo').value   = cfg.repo || "";
  document.getElementById('ghBranch').value = cfg.branch || "main";
  document.getElementById('ghPath').value   = cfg.path || "tasks.csv";
  document.getElementById('ghToken').value  = cfg.token || "";
  modalBg.style.display = "flex";
  modalBg.setAttribute("aria-hidden","false");
  setCfgHint();
  logStatus("Opened Settings");
}
function closeSettings(){
  modalBg.style.display = "none";
  modalBg.setAttribute("aria-hidden","true");
}
document.getElementById('settingsBtn').addEventListener('click', openSettings);
document.getElementById('closeSettings').addEventListener('click', closeSettings);
document.getElementById('closeSettings2').addEventListener('click', closeSettings);
modalBg.addEventListener('click', (e)=>{ if (e.target === modalBg) closeSettings(); });

document.getElementById('saveSettings').addEventListener('click', ()=>{
  const cfg = {
    owner:  document.getElementById('ghOwner').value.trim(),
    repo:   document.getElementById('ghRepo').value.trim(),
    branch: document.getElementById('ghBranch').value.trim() || "main",
    path:   document.getElementById('ghPath').value.trim() || "tasks.csv",
    token:  document.getElementById('ghToken').value.trim()
  };
  saveGhCfg(cfg);
  setCfgHint();
  logStatus("Saved Settings: " + cfgSummary(cfg));
  alert("✅ Settings נשמרו בדפדפן.");
});
document.getElementById('forgetToken').addEventListener('click', ()=>{
  const cfg = loadGhCfg();
  cfg.token = "";
  saveGhCfg(cfg);
  document.getElementById('ghToken').value = "";
  setCfgHint();
  logStatus("Token removed from localStorage");
  alert("✅ Token נמחק מהמכשיר.");
});
document.getElementById('testLoadRaw').addEventListener('click', async ()=>{
  const cfg = loadGhCfg();
  if (!cfg.owner || !cfg.repo){ alert("הכנס Owner/Repo קודם."); return; }
  const url = buildRawUrl(cfg);
  logStatus("Test RAW: " + url);
  try{
    const r = await fetch(url, {cache:"no-store"});
    logStatus("RAW status: " + r.status);
    alert("RAW status: " + r.status);
  }catch(e){
    logStatus("RAW error: " + e);
    alert("RAW error");
  }
});
document.getElementById('testApi').addEventListener('click', async ()=>{
  const cfg = loadGhCfg();
  if (!cfg.token){ alert("הכנס Token קודם."); return; }
  const url = buildApiUrl(cfg);
  logStatus("Test API: " + url);
  const r = await fetch(url, {headers:{
    "Accept":"application/vnd.github+json",
    "Authorization": `Bearer ${cfg.token}`
  }});
  logStatus("API status: " + r.status);
  alert("API status: " + r.status);
});

/* =========================
   Task Editor
   ========================= */
let CURRENT_EDIT_ID = null;
function tlog(msg){
  const box = document.getElementById('taskStatusBox');
  const ts = new Date().toLocaleTimeString();
  box.textContent = `[${ts}] ${msg}\n` + box.textContent;
}

/* Dependencies helpers */
function depsToArray(depsStr){
  return String(depsStr||"").split(/[,\s]+/).map(x=>x.trim()).filter(Boolean);
}
function depsToSet(depsStr){ return new Set(depsToArray(depsStr)); }

function buildDepAddOptions(currentTaskId){
  const sel = document.getElementById("te_dep_add");
  if (!sel) return;
  sel.innerHTML = `<option value="">בחר משימה להוספה…</option>`;

  const sorted = [...ALL].slice().sort((a,b)=>{
    const na = Number(String(a.id).replace(/[^\d.]/g,""));
    const nb = Number(String(b.id).replace(/[^\d.]/g,""));
    if (Number.isFinite(na) && Number.isFinite(nb)) return na-nb;
    return String(a.id).localeCompare(String(b.id));
  });

  sorted.forEach(t=>{
    if (String(t.id) === String(currentTaskId)) return;
    const opt = document.createElement("option");
    opt.value = String(t.id);
    opt.textContent = `#${t.id} · ${t.name}`;
    sel.appendChild(opt);
  });
}

function buildDepsMultiSelect(currentTaskId, selectedDepsStr){
  const sel = document.getElementById("te_deps_select");
  if (!sel) return;

  const selected = depsToSet(selectedDepsStr);
  sel.innerHTML = "";

  const sorted = [...ALL].slice().sort((a,b)=>{
    const na = Number(String(a.id).replace(/[^\d.]/g,""));
    const nb = Number(String(b.id).replace(/[^\d.]/g,""));
    if (Number.isFinite(na) && Number.isFinite(nb)) return na-nb;
    return String(a.id).localeCompare(String(b.id));
  });

  sorted.forEach(t=>{
    if (String(t.id) === String(currentTaskId)) return;
    const opt = document.createElement("option");
    opt.value = String(t.id);
    opt.textContent = `#${t.id} · ${t.name} · ${t.owner||""}`;
    opt.selected = selected.has(String(t.id));
    sel.appendChild(opt);
  });

  updateDepsPreview();
}

function updateDepsPreview(){
  const txt = readDepsFromSelect();
  document.getElementById("depsPreview").textContent = txt || "—";
}

function readDepsFromSelect(){
  const sel = document.getElementById("te_deps_select");
  if (!sel) return "";
  const vals = [...sel.selectedOptions].map(o=>o.value.trim()).filter(Boolean);
  return vals.join(",");
}

function addDependencyById(depId){
  if (!depId) return;
  const sel = document.getElementById("te_deps_select");
  if (!sel) return;
  const idStr = String(depId);

  for (const opt of sel.options){
    if (opt.value === idStr){
      opt.selected = true;
      break;
    }
  }
  updateDepsPreview();
  tlog("Dependency added: " + idStr);
}

/* Date sync helpers */
function setModalDatesFromTask(t){
  calcDatesFromOffsets(t);
  document.getElementById('te_startDate').value = t.start || "";
  document.getElementById('te_endDate').value   = t.end || "";
}
function setModalNumbersFromTask(t){
  document.getElementById('te_startOffset').value = Number(t.startOffset||0);
  document.getElementById('te_duration').value    = Number(t.duration||1);
}
function syncFromDatesToNumbers(){
  const sd = parseDateInput(document.getElementById('te_startDate').value);
  const ed = parseDateInput(document.getElementById('te_endDate').value);
  if (!sd || !ed) return;

  let off = daysBetween(MIN_START, sd);
  if (off < 0) off = 0;

  let dur = daysBetween(sd, ed);
  if (dur < 1){
    dur = 1;
    const fixedEnd = new Date(sd.getTime() + MS_DAY);
    document.getElementById('te_endDate').value = fmt(fixedEnd);
  }

  document.getElementById('te_startOffset').value = Math.round(off);
  document.getElementById('te_duration').value = Math.round(dur);
  updateTaskDatesPreviewInStatus();
}
function syncFromNumbersToDates(){
  const off = Number(document.getElementById('te_startOffset').value);
  const dur = Number(document.getElementById('te_duration').value);
  const o = Number.isFinite(off) ? Math.max(0, Math.round(off)) : 0;
  const d = Number.isFinite(dur) ? Math.max(1, Math.round(dur)) : 1;

  const sd = new Date(MIN_START.getTime() + o*MS_DAY);
  const ed = new Date(sd.getTime() + d*MS_DAY);

  document.getElementById('te_startDate').value = fmt(sd);
  document.getElementById('te_endDate').value   = fmt(ed);
  updateTaskDatesPreviewInStatus();
}
function updateTaskDatesPreviewInStatus(){
  const sd = document.getElementById('te_startDate').value;
  const ed = document.getElementById('te_endDate').value;
  const off = document.getElementById('te_startOffset').value;
  const dur = document.getElementById('te_duration').value;
  tlog(`Dates OK: start=${sd} end=${ed} | startOffset=${off} duration=${dur}`);
}

function openTaskModal(taskId){
  const t = findTask(taskId);
  if (!t){ alert("משימה לא נמצאה"); return; }

  CURRENT_EDIT_ID = String(taskId);

  document.getElementById('taskModalTitle').textContent = `עריכת משימה #${t.id}`;
  document.getElementById('te_id').value = t.id;
  document.getElementById('te_name').value = t.name || "";
  document.getElementById('te_phase').value = t.phase || "";
  document.getElementById('te_owner').value = t.owner || "";
  document.getElementById('te_milestone').value = t.milestone ? "1" : "0";
  document.getElementById('te_notes').value = t.notes || "";

  setModalNumbersFromTask(t);
  setModalDatesFromTask(t);

  buildDepAddOptions(t.id);
  buildDepsMultiSelect(t.id, t.deps || "");

  const bg = document.getElementById('taskModalBg');
  bg.style.display = "flex";
  bg.setAttribute("aria-hidden","false");
  tlog("Opened editor.");
  setTimeout(()=> document.getElementById('te_name').focus(), 50);
}

function closeTaskModal(){
  const bg = document.getElementById('taskModalBg');
  bg.style.display = "none";
  bg.setAttribute("aria-hidden","true");
  CURRENT_EDIT_ID = null;
}

function applyTaskEditsFromModal(){
  if (!CURRENT_EDIT_ID) return null;
  const t = findTask(CURRENT_EDIT_ID);
  if (!t) return null;

  const name = document.getElementById('te_name').value.trim();
  const phase = document.getElementById('te_phase').value.trim();
  const owner = document.getElementById('te_owner').value.trim();
  const notes = document.getElementById('te_notes').value.trim();
  const milestone = document.getElementById('te_milestone').value === "1";

  if (!name){ alert("שם משימה חובה"); return null; }

  const sd = parseDateInput(document.getElementById('te_startDate').value);
  const ed = parseDateInput(document.getElementById('te_endDate').value);
  if (!sd || !ed){
    alert("בחר Start Date ו-End Date");
    return null;
  }

  let off = daysBetween(MIN_START, sd);
  if (off < 0) off = 0;
  let dur = daysBetween(sd, ed);
  if (dur < 1) dur = 1;

  const deps = readDepsFromSelect();

  t.name = name;
  t.phase = phase;
  t.owner = owner;
  t.notes = notes;
  t.milestone = milestone;
  t.startOffset = Math.round(off);
  t.duration = Math.round(dur);
  t.deps = deps;

  calcDatesFromOffsets(t);
  persistOne(t);
  rebuildOwnerOptions(ALL);
  render();
  updateCharts();
  tlog("Saved and re-rendered.");
  return t;
}

function deleteCurrentTask(){
  if (!CURRENT_EDIT_ID) return;
  const t = findTask(CURRENT_EDIT_ID);
  if (!t) return;

  const ok = confirm(`למחוק את משימה #${t.id}?`);
  if (!ok) return;

  ALL = ALL.filter(x => String(x.id) !== String(CURRENT_EDIT_ID));
  try{
    const edits = loadEdits() || {};
    delete edits[CURRENT_EDIT_ID];
    saveEdits(edits);
  }catch(_){}

  rebuildOwnerOptions(ALL);
  render();
  updateCharts();
  tlog("Task deleted.");
  closeTaskModal();
}

function nextNumericId(){
  const nums = ALL.map(t=>Number(String(t.id).replace(/[^\d]/g,''))).filter(n=>Number.isFinite(n));
  const maxN = nums.length ? Math.max(...nums) : 0;
  return String(maxN + 1);
}
function duplicateCurrentTask(){
  if (!CURRENT_EDIT_ID) return;
  const t = findTask(CURRENT_EDIT_ID);
  if (!t) return;

  const newId = nextNumericId();
  const copy = {...t, id:newId, name: (t.name||"") + " (Copy)"};

  ALL.push(copy);
  calcDatesFromOffsets(copy);
  persistOne(copy);

  rebuildOwnerOptions(ALL);
  render();
  updateCharts();
  tlog(`Duplicated to #${newId}.`);
  openTaskModal(newId);
}

/* ---------- Dependencies UI wiring ---------- */
document.getElementById("btnAddDep").addEventListener("click", ()=>{
  const v = document.getElementById("te_dep_add").value;
  if (!v) return;
  addDependencyById(v);
});
document.getElementById("btnClearDeps").addEventListener("click", ()=>{
  const sel = document.getElementById("te_deps_select");
  if (!sel) return;
  for (const opt of sel.options) opt.selected = false;
  updateDepsPreview();
  tlog("Dependencies cleared");
});
document.getElementById("te_deps_select").addEventListener("change", updateDepsPreview);

const dropZone = document.getElementById("depsDropZone");
dropZone.addEventListener("dragover", (e)=>{
  e.preventDefault();
  dropZone.classList.add("dragover");
  e.dataTransfer.dropEffect = "copy";
});
dropZone.addEventListener("dragleave", ()=>{
  dropZone.classList.remove("dragover");
});
dropZone.addEventListener("drop", (e)=>{
  e.preventDefault();
  dropZone.classList.remove("dragover");
  const id = e.dataTransfer.getData("text/plain");
  if (!id) return;
  if (CURRENT_EDIT_ID && String(id) === String(CURRENT_EDIT_ID)){
    tlog("Cannot add self dependency.");
    return;
  }
  addDependencyById(id);
});

/* ---------- Date sync wiring ---------- */
document.getElementById("te_startDate").addEventListener("change", ()=>{ syncFromDatesToNumbers(); });
document.getElementById("te_endDate").addEventListener("change", ()=>{ syncFromDatesToNumbers(); });
document.getElementById("te_startOffset").addEventListener("change", ()=>{ syncFromNumbersToDates(); });
document.getElementById("te_duration").addEventListener("change", ()=>{ syncFromNumbersToDates(); });

/* ---------- Main buttons wiring ---------- */
document.getElementById('exportCsv').addEventListener('click', exportCSV);
document.getElementById('downloadTemplate').addEventListener('click', downloadTemplate);
document.getElementById('clearLocal').addEventListener('click', clearLocalCache);
document.getElementById('reset').addEventListener('click', resetAll);
document.getElementById('loadRepo').addEventListener('click', ghLoadTasks);
document.getElementById('saveRepo').addEventListener('click', ghSaveTasks);

document.getElementById('importBtn').addEventListener('click', async ()=>{
  const f = document.getElementById('importFile').files?.[0];
  if (!f){ alert("בחר קובץ CSV קודם."); return; }
  await importCSVFromFile(f);
});

document.getElementById('q').addEventListener('input', ()=>{ render(); });
document.getElementById('ownerFilter').addEventListener('change', ()=>{ render(); });
document.getElementById('zoom').addEventListener('change', ()=>{ render(); });

/* Task modal wiring */
const taskBg = document.getElementById('taskModalBg');
document.getElementById('closeTaskModal').addEventListener('click', closeTaskModal);
taskBg.addEventListener('click', (e)=>{ if (e.target === taskBg) closeTaskModal(); });
document.getElementById('saveTaskBtn').addEventListener('click', ()=> applyTaskEditsFromModal());
document.getElementById('deleteTaskBtn').addEventListener('click', deleteCurrentTask);
document.getElementById('duplicateTaskBtn').addEventListener('click', duplicateCurrentTask);

/* Keyboard shortcuts (FIXED) */
document.addEventListener('keydown', (e)=>{
  if (e.key === "Escape"){
    if (taskBg.style.display === "flex") closeTaskModal();
    if (modalBg.style.display === "flex") closeSettings();
    hideTip();
  }
  if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="s"){
    if (taskBg.style.display === "flex"){
      e.preventDefault();
      applyTaskEditsFromModal(); /* <-- FIXED HERE */
    }
  }
});

/* ---------- Initial ---------- */
setCfgHint();
render();
updateCharts();
</script>
</body>
</html>
