<!doctype html>
<html lang="he">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gantt – Ghana Energy CERT (Drag & Drop) + Import/Export + GitHub Sync + Charts</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f6f7fb;color:#111827}
  header{padding:16px 20px;background:#111827;color:#fff}
  header h1{margin:0;font-size:18px;font-weight:900;direction:rtl;text-align:right}
  header .meta{margin-top:6px;font-size:13px;opacity:.9;direction:rtl;text-align:right;line-height:1.35}
  .wrap{padding:16px 20px}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  .controls input,.controls select,.controls button{padding:10px 12px;border-radius:10px;border:1px solid #d1d5db;background:#fff;font-size:14px}
  .controls button{cursor:pointer}
  .controls .btn-primary{background:#111827;color:#fff;border-color:#111827}
  .controls .btn-ghost{background:#fff;color:#111827}
  .controls .btn-warn{background:#fff7ed;color:#9a3412;border-color:#fed7aa}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.05)}
  .grid{display:grid;grid-template-columns: 540px 1fr;}
  .left{border-right:1px solid #e5e7eb}
  .right{overflow:auto}
  .row{display:flex;gap:10px;align-items:center;padding:8px 10px;border-bottom:1px solid #f1f5f9}
  .row:nth-child(odd){background:#fafafa}
  .row .title{flex:1;direction:rtl;text-align:right;font-size:13px;line-height:1.2}
  .row .meta{font-size:12px;color:#374151;white-space:nowrap}
  .timeline{position:relative;min-height: 40px;border-bottom:1px solid #e5e7eb;background:#fff}
  .ticks{display:flex;position:sticky;top:0;background:#fff;z-index:2}
  .tick{border-right:1px solid #eef2f7;padding:8px 6px;font-size:12px;color:#374151;white-space:nowrap}
  .bar-area{position:relative}
  .bar-row{position:relative;height:34px;border-bottom:1px solid #f1f5f9}
  .bar{position:absolute;top:7px;height:20px;border-radius:10px;background:#2563eb;cursor:grab;box-shadow:0 1px 1px rgba(0,0,0,.08)}
  .bar.dragging{cursor:grabbing;opacity:.9}
  .bar .label{position:absolute;left:10px;right:10px;top:2px;font-size:10px;line-height:1;color:#fff;opacity:.95;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;pointer-events:none}
  .bar .deps{position:absolute;left:10px;right:10px;bottom:2px;font-size:10px;line-height:1;color:#fff;opacity:.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;pointer-events:none}

  .handle{position:absolute;top:0;width:10px;height:20px;opacity:.0;}
  .bar:hover .handle{opacity:.35;}
  .handle.left{left:0;border-top-left-radius:10px;border-bottom-left-radius:10px;background:#0b3ea8;cursor:ew-resize}
  .handle.right{right:0;border-top-right-radius:10px;border-bottom-right-radius:10px;background:#0b3ea8;cursor:ew-resize}
  .hint{padding:10px 12px;font-size:12px;color:#374151;direction:rtl;text-align:right}
  .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#1f2a6b;font-size:12px}

  #legend .lg-item{display:flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #e5e7eb;border-radius:999px;background:#fff;font-size:12px}
  #legend .sw{width:12px;height:12px;border-radius:4px}
  .dep-layer{position:absolute;left:0;top:0;pointer-events:none;overflow:visible}

  /* Charts */
  .dash{display:grid;grid-template-columns:repeat(3,minmax(220px,1fr));gap:12px;margin:12px 0}
  @media (max-width: 980px){ .dash{grid-template-columns:1fr} .grid{grid-template-columns:1fr} .left{border-right:none;border-bottom:1px solid #e5e7eb}}
  .chart-card{padding:12px}
  .chart-title{font-weight:900;font-size:13px;margin:0 0 8px 0;direction:rtl;text-align:right}
  canvas{width:100%;height:160px;display:block}
  .chart-legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;direction:ltr}
  .chart-legend .it{display:flex;gap:6px;align-items:center;font-size:12px;color:#374151}
  .chart-legend .dot{width:10px;height:10px;border-radius:3px;display:inline-block}
  .importBox{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .importBox input[type=file]{padding:8px 10px}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:999}
  .modal{width:min(720px,92vw);background:#fff;border-radius:16px;border:1px solid #e5e7eb;box-shadow:0 18px 60px rgba(0,0,0,.25);overflow:hidden}
  .modal header{background:#111827;color:#fff;padding:14px 16px}
  .modal header h2{margin:0;font-size:14px;font-weight:900;direction:rtl;text-align:right}
  .modal .body{padding:14px 16px;display:grid;gap:10px}
  .modal .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:720px){.modal .row2{grid-template-columns:1fr}}
  .modal label{font-size:12px;color:#374151;direction:rtl;text-align:right;display:block;margin-bottom:4px}
  .modal input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #d1d5db;font-size:14px}
  .modal .footer{display:flex;gap:10px;justify-content:flex-end;padding:12px 16px;border-top:1px solid #eef2f7;background:#fafafa}
  .smallnote{font-size:12px;color:#6b7280;direction:rtl;text-align:right;line-height:1.4}
  .log{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;max-height:140px;overflow:auto;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px}
  .log .ok{color:#065f46}
  .log .err{color:#991b1b}
  .log .info{color:#1f2937}
</style>
</head>
<body>
<header>
  <h1>AMIR DAVIDI TECHNOLOGIES – גאנט פרויקט Ghana Energy CERT (Drag & Drop) <span class="pill">Version 16</span></h1>
  <div class="meta">
    ✅ גרירה מזיזה משימה | ✅ גרירת קצוות משנה Duration | ✅ חצים לתלויות<br/>
    ✅ Export CSV (כולל כל שדות היצירה) | ✅ Import CSV משנה מיד את כל הנתונים | ✅ נשמר מקומית בדפדפן<br/>
    ✅ Load/Save ל-GitHub (API) עם Token + Settings
    <span class="pill">UTF-8 BOM לאקסל (עברית תקינה)</span>
  </div>
</header>

<div class="wrap">
  <div class="controls">
    <input id="q" placeholder="חיפוש (Task / Owner / Phase / ID)..." style="min-width:320px"/>
    <select id="ownerFilter"><option value="">כל ה-Owners</option></select>
    <select id="zoom">
      <option value="day">יום (Day)</option>
      <option value="week" selected>שבוע (Week)</option>
      <option value="month">חודש (Month)</option>
    </select>

    <div id="legend" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center"></div>

    <button class="btn-primary" id="exportCsv">Export CSV</button>

    <div class="importBox">
      <input id="importFile" type="file" accept=".csv,text/csv"/>
      <button class="btn-ghost" id="importBtn">Import CSV</button>
    </div>

    <button id="reset">איפוס</button>
    <button id="openSettings" class="btn-warn" title="הגדרות GitHub + Token">Settings (GitHub)</button>
  </div>

  <div class="dash">
    <div class="card chart-card">
      <p class="chart-title">משימות לפי קטגוריה</p>
      <canvas id="chartCats" width="600" height="220"></canvas>
      <div class="chart-legend" id="lgCats"></div>
    </div>
    <div class="card chart-card">
      <p class="chart-title">משימות לפי Owner</p>
      <canvas id="chartOwners" width="600" height="220"></canvas>
      <div class="chart-legend" id="lgOwners"></div>
    </div>
    <div class="card chart-card">
      <p class="chart-title">מדדים מהירים</p>
      <canvas id="chartKPIs" width="600" height="220"></canvas>
      <div class="hint" style="padding:8px 0 0 0;text-align:right">
        KPI: כמות משימות · כמות Milestones · כמות תלויות · טווח תאריכים (ימים)
      </div>
    </div>

    <label style="display:flex;align-items:center;gap:8px;padding:10px 12px;border:1px dashed #cbd5e1;border-radius:10px;background:#fff;cursor:pointer">
      <span style="font-size:13px">ייבוא CSV</span>
      <input type="file" id="importCsvFile" accept=".csv,text/csv" style="display:none"/>
    </label>

    <button id="loadRepo" title="טען tasks.csv מה-GitHub דרך API">Load from GIT (tasks.csv)</button>
    <button id="saveRepo" title="שמור tasks.csv ל-GitHub דרך API">Save to GIT (tasks.csv)</button>
    <button id="downloadTemplate" title="הורד תבנית CSV מלאה לייבוא">Download CSV Template</button>
    <button id="clearLocal" title="מוחק שינויים מקומיים ומחזיר לטעינה מה-GIT">Clear Local Cache</button>
  </div>

  <div class="card">
    <div class="grid">
      <div class="left" id="left"></div>
      <div class="right">
        <div class="timeline" id="timeline"></div>
        <div class="bar-area" id="bars"></div>
      </div>
    </div>
    <div class="hint">
      טיפ: לדיוק גבוה העבר ל-Zoom "יום". דאבל-קליק על בר מציג פרטים. לאחר Import/Drag אפשר Export CSV ולהדביק חזרה לאקסל.
    </div>
  </div>

  <div class="log" id="log"></div>
</div>

<!-- Settings Modal -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <header>
      <h2>הגדרות GitHub (Token + Repo)</h2>
    </header>
    <div class="body">
      <div class="smallnote">
        ⚠️ שמירת Token ב-localStorage היא נוחה אבל פחות מאובטחת. מומלץ Token עם הרשאות מינימליות (רק ל-Repo הזה).
      </div>

      <div>
        <label>GitHub Token (Classic: repo / Fine-grained: Contents RW)</label>
        <input id="ghToken" placeholder="ghp_... / github_pat_..." autocomplete="off"/>
      </div>

      <div class="row2">
        <div>
          <label>Repo Owner</label>
          <input id="ghOwner" placeholder="amird1976"/>
        </div>
        <div>
          <label>Repo Name</label>
          <input id="ghRepo" placeholder="GANA_PM"/>
        </div>
      </div>

      <div class="row2">
        <div>
          <label>Branch</label>
          <input id="ghBranch" placeholder="main"/>
        </div>
        <div>
          <label>File Path (ב-Repo)</label>
          <input id="ghPath" placeholder="tasks.csv"/>
        </div>
      </div>

      <div class="smallnote">
        טיפ: אם האתר הוא GitHub Pages של אותו repo, ברוב המקרים זה: Owner/Repo = כמו ה-URL, Branch=main, Path=tasks.csv.
      </div>
    </div>
    <div class="footer">
      <button class="btn-ghost" id="closeSettingsBtn">סגור</button>
      <button class="btn-primary" id="saveSettingsBtn">שמור הגדרות</button>
      <button class="btn-warn" id="clearTokenBtn" title="מוחק Token בלבד">מחק Token</button>
    </div>
  </div>
</div>

<script>
/* =========================
   Version 16 – GitHub Sync
   ========================= */

const MS_DAY = 86400000;
const MIN_START = new Date("2026-01-05");
const MAX_END = new Date("2026-06-10");

/*
  IMPORTANT:
  אם אין tasks.csv ב-Git, זה יעלה את BASE.
  אם יש tasks.csv ב-Git ואין Local Cache, זה יטען אותו אוטומטית.
*/
const BASE = [
  {"id":"1","phase":"1. Management","name":"פתיחת פרויקט וניהול (Phase 1)","owner":"צוות יעוץ","start":"2026-01-05","end":"2026-02-04","startOffset":0,"duration":30,"deps":"","milestone":false,"notes":""},
  {"id":"2","phase":"1.1 Admin","name":"פגישת קיק-אוף והתנעת צוות היגוי","owner":"צוות יעוץ","start":"2026-01-05","end":"2026-01-07","startOffset":0,"duration":2,"deps":"","milestone":true,"notes":"דוגמה: סמן milestone=true כדי לקבל יהלום"},
  {"id":"3","phase":"1.1 Admin","name":"הקמת משרד PMO פיזי באקרה (Ghana)","owner":"Local Ops","start":"2026-01-07","end":"2026-01-21","startOffset":2,"duration":14,"deps":"2","milestone":false,"notes":""},
  {"id":"4","phase":"2. Design","name":"CDR - תכנון הנדסי מפורט (Design Phase)","owner":"Engineering","start":"2026-01-05","end":"2026-03-06","startOffset":0,"duration":60,"deps":"","milestone":false,"notes":""}
];

let ALL = BASE.map(t => ({...t}));

/* ===== LocalStorage Keys (v16) ===== */
const STORE_KEY = "gantt_tasks_v16_edits";
const STORE_KEY_CSV = "gantt_tasks_v16_csv_snapshot";
const GH_CFG_KEY = "gantt_github_cfg_v16";
const GH_SHA_KEY = "gantt_github_last_sha_v16"; // stores sha of last loaded file

/* ===== Logger ===== */
const logEl = document.getElementById('log');
function logLine(msg, cls="info"){
  const t = new Date();
  const ts = String(t.toTimeString()).slice(0,8);
  const div = document.createElement('div');
  div.className = cls;
  div.textContent = `[${ts}] ${msg}`;
  logEl.appendChild(div);
  logEl.scrollTop = logEl.scrollHeight;
}
function logOk(m){ logLine(m,"ok"); }
function logErr(m){ logLine(m,"err"); }
function logInfo(m){ logLine(m,"info"); }

/* ===== GitHub Config ===== */
function defaultGitCfg(){
  // Best-effort infer owner/repo from URL:
  // https://OWNER.github.io/REPO/  => owner=OWNER, repo=REPO
  let owner="amird1976", repo="GANA_PM", branch="main", path="tasks.csv", token="";
  try{
    const host = location.hostname.toLowerCase();
    const parts = location.pathname.split('/').filter(Boolean);
    if (host.endsWith("github.io")){
      const inferredOwner = host.split(".github.io")[0];
      if (inferredOwner) owner = inferredOwner;
      if (parts[0]) repo = parts[0];
    }
  }catch(_){}
  return { owner, repo, branch, path, token };
}
function loadGitCfg(){
  try{
    const raw = localStorage.getItem(GH_CFG_KEY);
    if (!raw) return defaultGitCfg();
    const o = JSON.parse(raw);
    return {
      owner: o.owner || defaultGitCfg().owner,
      repo: o.repo || defaultGitCfg().repo,
      branch: o.branch || defaultGitCfg().branch,
      path: o.path || defaultGitCfg().path,
      token: o.token || ""
    };
  }catch(e){
    return defaultGitCfg();
  }
}
function saveGitCfg(cfg){
  try{ localStorage.setItem(GH_CFG_KEY, JSON.stringify(cfg)); }catch(_){}
}

/* ===== GitHub API Helpers ===== */
function b64ToUtf8(b64){
  // GitHub returns base64 with line breaks sometimes
  const clean = (b64||"").replace(/\s/g,'');
  const binStr = atob(clean);
  const bytes = new Uint8Array(binStr.length);
  for (let i=0;i<binStr.length;i++) bytes[i] = binStr.charCodeAt(i);
  return new TextDecoder("utf-8").decode(bytes);
}
function utf8ToB64(str){
  const bytes = new TextEncoder().encode(str);
  let bin = "";
  for (let i=0;i<bytes.length;i++) bin += String.fromCharCode(bytes[i]);
  return btoa(bin);
}
function ghHeaders(token){
  const h = {
    "Accept": "application/vnd.github+json"
  };
  if (token && token.trim()){
    h["Authorization"] = "Bearer " + token.trim();
  }
  return h;
}
function ghUrl(cfg){
  // Contents API
  const encPath = cfg.path.split('/').map(encodeURIComponent).join('/');
  return `https://api.github.com/repos/${encodeURIComponent(cfg.owner)}/${encodeURIComponent(cfg.repo)}/contents/${encPath}?ref=${encodeURIComponent(cfg.branch)}`;
}

async function ghLoadCsv(){
  const cfg = loadGitCfg();
  logInfo(`Load from GitHub: ${cfg.owner}/${cfg.repo}@${cfg.branch} → ${cfg.path}`);
  const url = ghUrl(cfg);

  const res = await fetch(url, { headers: ghHeaders(cfg.token) });
  const text = await res.text();
  if (!res.ok){
    // show body for debugging (but not too verbose)
    logErr(`GitHub load failed: HTTP ${res.status} ${res.statusText}`);
    try{ logErr(`Body: ${text.slice(0,260)}`); }catch(_){}
    throw new Error(`GitHub load failed (${res.status})`);
  }

  const js = JSON.parse(text);
  if (!js || !js.content){
    logErr("GitHub response missing content.");
    throw new Error("Missing content from GitHub API");
  }

  const csv = b64ToUtf8(js.content);
  const sha = js.sha || "";
  if (sha){
    try{ localStorage.setItem(GH_SHA_KEY, sha); }catch(_){}
    logOk(`Loaded tasks.csv (sha=${sha.slice(0,10)}...)`);
  } else {
    logOk("Loaded tasks.csv (sha missing?)");
  }
  return { csv, sha };
}

async function ghSaveCsv(csvText){
  const cfg = loadGitCfg();
  if (!cfg.token || !cfg.token.trim()){
    alert("אין Token בהגדרות. לחץ Settings והזן GitHub Token (עם הרשאות כתיבה ל-contents).");
    throw new Error("Missing token");
  }
  logInfo(`Save to GitHub: ${cfg.owner}/${cfg.repo}@${cfg.branch} → ${cfg.path}`);

  // Need sha of existing file (if exists). Use last sha if available, else try to fetch.
  let sha = "";
  try{ sha = localStorage.getItem(GH_SHA_KEY) || ""; }catch(_){}
  if (!sha){
    try{
      const loaded = await ghLoadCsv();
      sha = loaded.sha || "";
    }catch(e){
      // If file doesn't exist, we can create without sha (but repo must allow)
      logInfo("No existing sha found (file may not exist). Will try create new file.");
      sha = "";
    }
  }

  const urlBase = `https://api.github.com/repos/${encodeURIComponent(cfg.owner)}/${encodeURIComponent(cfg.repo)}/contents/${cfg.path.split('/').map(encodeURIComponent).join('/')}`;
  const url = `${urlBase}`; // PUT uses this URL without ?ref

  const payload = {
    message: `Update tasks.csv from Gantt UI (v16) - ${new Date().toISOString()}`,
    content: utf8ToB64(csvText),
    branch: cfg.branch
  };
  if (sha) payload.sha = sha;

  const res = await fetch(url, {
    method: "PUT",
    headers: {
      ...ghHeaders(cfg.token),
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  });

  const bodyText = await res.text();
  if (!res.ok){
    logErr(`GitHub save failed: HTTP ${res.status} ${res.statusText}`);
    try{ logErr(`Body: ${bodyText.slice(0,260)}`); }catch(_){}
    throw new Error(`GitHub save failed (${res.status})`);
  }

  const js = JSON.parse(bodyText);
  const newSha = js?.content?.sha || js?.commit?.sha || "";
  if (js?.content?.sha){
    try{ localStorage.setItem(GH_SHA_KEY, js.content.sha); }catch(_){}
    logOk(`Saved successfully (new sha=${js.content.sha.slice(0,10)}...)`);
  } else {
    logOk("Saved successfully (sha not returned clearly).");
  }

  return newSha;
}

/* ===== Category coloring ===== */
function categoryOf(t){
  const p = (t.phase||"").trim();
  if (!p) return "Other";
  if (p.toLowerCase().startsWith("atp")) return "ATP";
  if (p.toLowerCase() === "closure") return "Closure";
  const first = p.split(/\s+/)[0];
  const m = first.match(/^([0-9]+)(?:\.|$)/);
  if (m) return "Phase " + m[1];
  const m2 = first.match(/^([A-Z])\./i);
  if (m2) return "Group " + m2[1].toUpperCase();
  return first;
}
function colorForCategory(cat){
  const palette = ["#2563eb","#16a34a","#f59e0b","#dc2626","#9333ea","#0891b2","#7c3aed","#0ea5e9","#22c55e","#ea580c","#be123c","#0f766e","#4f46e5","#a16207","#1d4ed8"];
  let h=0; for (let i=0;i<cat.length;i++) h = (h*31 + cat.charCodeAt(i)) >>> 0;
  return palette[h % palette.length];
}
function depsLabel(t){
  const d = (t.deps||"").trim();
  if (!d) return "";
  return d.length > 30 ? (d.slice(0,30) + "…") : d;
}

function loadEdits() {
  try { const raw = localStorage.getItem(STORE_KEY); return raw ? JSON.parse(raw) : null; } catch(e){ return null; }
}
function saveEdits(edits) { try { localStorage.setItem(STORE_KEY, JSON.stringify(edits)); } catch(e){} }

function daysBetween(a,b){ return Math.round((b-a)/MS_DAY); }
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
function fmt(d){
  const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}
function calcDatesFromOffsets(t){
  const s = new Date(MIN_START.getTime() + (t.startOffset||0)*MS_DAY);
  const e = new Date(s.getTime() + Math.max(1,(t.duration||1))*MS_DAY);
  t.start = fmt(s); t.end = fmt(e);
}

/* ===== Apply local edits (if exist) ===== */
(function applyLocal(){
  const edits = loadEdits(); if (!edits) return;
  ALL = ALL.map(t => {
    const e = edits[t.id]; if (!e) return t;
    return {...t, ...e};
  });
})();
ALL.forEach(t => calcDatesFromOffsets(t));

/* ===== Owner filter init ===== */
const ownerSel = document.getElementById('ownerFilter');
function rebuildOwnerOptions(tasks){
  ownerSel.innerHTML = '<option value="">כל ה-Owners</option>';
  Array.from(new Set(tasks.map(t => (t.owner||'').trim()).filter(Boolean))).sort().forEach(o=>{
    const opt=document.createElement('option'); opt.value=o; opt.textContent=o; ownerSel.appendChild(opt);
  });
}
rebuildOwnerOptions(ALL);

/* ===== Zoom ===== */
function pxPerDayForZoom(){ const z=document.getElementById('zoom').value; return (z==='day')?18:(z==='week'?7:2.5); }
function buildTicks(pxPerDay){
  const tl=document.getElementById('timeline'); tl.innerHTML='';
  const ticks=document.createElement('div'); ticks.className='ticks';
  const totalDays=daysBetween(MIN_START, MAX_END);
  const zoom=document.getElementById('zoom').value;
  const step = zoom==='day'?1:(zoom==='week'?7:30);

  for (let i=0;i<=totalDays;i++){
    const d=new Date(MIN_START.getTime()+i*MS_DAY);
    const tick=document.createElement('div');
    tick.className='tick'; tick.style.width=pxPerDay+'px';
    tick.textContent = (i%step===0)?fmt(d):'';
    ticks.appendChild(tick);
  }
  ticks.style.width=((totalDays+1)*pxPerDay)+'px';
  tl.appendChild(ticks);
}

function persistOne(t){
  const edits = loadEdits() || {};
  edits[t.id] = {
    id:String(t.id),
    phase:t.phase||"",
    name:t.name||"",
    owner:t.owner||"",
    startOffset:Number(t.startOffset||0),
    duration:Number(t.duration||1),
    deps:t.deps||"",
    milestone: !!t.milestone,
    notes: t.notes||"",
    start:t.start, end:t.end
  };
  saveEdits(edits);
}
function findTask(id){ return ALL.find(x=>String(x.id)===String(id)); }

/* ===== Drag ===== */
function attachDrag(barEl, pxPerDay){
  let mode="move", startX=0, origOffset=0, origDuration=0;

  function onPointerDown(e){
    const handle=e.target?.dataset?.handle;
    mode = handle==='left'?'resizeL':(handle==='right'?'resizeR':'move');
    barEl.setPointerCapture(e.pointerId);
    barEl.classList.add('dragging');
    startX=e.clientX;
    const t=findTask(barEl.dataset.id);
    origOffset=t.startOffset; origDuration=t.duration;
    e.preventDefault(); e.stopPropagation();
  }

  function onPointerMove(e){
    if (!barEl.classList.contains('dragging')) return;
    const dx=e.clientX-startX;
    const deltaDays=Math.round(dx/pxPerDay);
    const t=findTask(barEl.dataset.id); if (!t) return;

    if (mode==='move'){
      t.startOffset = clamp(origOffset+deltaDays,0,100000);
    } else if (mode==='resizeR'){
      t.duration = clamp(origDuration+deltaDays,1,100000);
    } else if (mode==='resizeL'){
      const newOffset=origOffset+deltaDays;
      const newDur=origDuration-deltaDays;
      if (newDur>=1){ t.startOffset=clamp(newOffset,0,100000); t.duration=newDur; }
    }

    calcDatesFromOffsets(t);
    barEl.style.left=(t.startOffset*pxPerDay)+'px';
    barEl.style.width=(Math.max(1,t.duration)*pxPerDay)+'px';
    barEl.title=`${t.name} (Start: ${t.start}, End: ${t.end})`;
    updateCharts(); // live
  }

  function onPointerUp(e){
    if (!barEl.classList.contains('dragging')) return;
    barEl.classList.remove('dragging');
    const t=findTask(barEl.dataset.id);
    if (t) persistOne(t);
    try{ barEl.releasePointerCapture(e.pointerId);}catch(_){}
  }

  barEl.addEventListener('pointerdown', onPointerDown);
  barEl.addEventListener('pointermove', onPointerMove);
  barEl.addEventListener('pointerup', onPointerUp);
  barEl.addEventListener('pointercancel', onPointerUp);
}

/* ===== Milestone shape ===== */
function applyMilestoneStyle(barEl, isMilestone){
  if (!isMilestone) {
    barEl.style.borderRadius = "10px";
    barEl.style.transform = "none";
    return;
  }
  barEl.style.borderRadius = "4px";
  barEl.style.transform = "rotate(45deg)";
}

/* ===== Render ===== */
function render(){
  const q=(document.getElementById('q').value||'').toLowerCase().trim();
  const ownerVal=(document.getElementById('ownerFilter').value||'').toLowerCase();
  const pxPerDay=pxPerDayForZoom();

  const baseList = !q ? ALL : ALL.filter(t =>
    (t.name||'').toLowerCase().includes(q) ||
    (t.owner||'').toLowerCase().includes(q) ||
    (t.phase||'').toLowerCase().includes(q) ||
    String(t.id||'').toLowerCase().includes(q)
  );
  const list = !ownerVal ? baseList : baseList.filter(t => (t.owner||'').toLowerCase()===ownerVal);

  // Legend
  const legend=document.getElementById('legend');
  if (legend){
    const cats=Array.from(new Set(list.map(t=>categoryOf(t)))).sort();
    legend.innerHTML='';
    cats.forEach(cat=>{
      const item=document.createElement('div'); item.className='lg-item';
      const sw=document.createElement('div'); sw.className='sw'; sw.style.background=colorForCategory(cat);
      const tx=document.createElement('div'); tx.textContent=cat;
      item.appendChild(sw); item.appendChild(tx); legend.appendChild(item);
    });
  }

  const left=document.getElementById('left');
  left.innerHTML='';
  const h=document.createElement('div');
  h.className='row'; h.style.fontWeight='900';
  h.innerHTML = `<div class="meta">ID</div><div class="title">משימה</div><div class="meta">Owner</div>`;
  left.appendChild(h);
  list.forEach(t=>{
    const r=document.createElement('div'); r.className='row';
    r.innerHTML = `<div class="meta">#${t.id}</div><div class="title">${escapeHtml(t.name)}</div><div class="meta">${escapeHtml(t.owner||'')}</div>`;
    left.appendChild(r);
  });

  buildTicks(pxPerDay);

  const bars=document.getElementById('bars');
  bars.innerHTML='';

  // Dependency overlay SVG
  const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.classList.add('dep-layer'); svg.setAttribute('aria-hidden','true');
  const defs=document.createElementNS('http://www.w3.org/2000/svg','defs');
  const marker=document.createElementNS('http://www.w3.org/2000/svg','marker');
  marker.setAttribute('id','arrow'); marker.setAttribute('markerWidth','10'); marker.setAttribute('markerHeight','10');
  marker.setAttribute('refX','8'); marker.setAttribute('refY','3'); marker.setAttribute('orient','auto');
  const ap=document.createElementNS('http://www.w3.org/2000/svg','path');
  ap.setAttribute('d','M0,0 L8,3 L0,6 Z'); ap.setAttribute('fill','#64748b');
  marker.appendChild(ap); defs.appendChild(marker); svg.appendChild(defs); bars.appendChild(svg);

  const totalDays=daysBetween(MIN_START, MAX_END);
  const width=((totalDays+1)*pxPerDay);

  list.forEach((t, idx)=>{
    const row=document.createElement('div');
    row.className='bar-row';
    row.style.width=width+'px';

    const bar=document.createElement('div');
    bar.className='bar';
    bar.dataset.id=t.id;

    const isMs = !!t.milestone;
    const durPx = Math.max(1,t.duration)*pxPerDay;
    const msSize = Math.max(10, Math.min(18, pxPerDay*2.2)); // diamond size
    bar.style.left=(t.startOffset*pxPerDay)+'px';
    bar.style.width = isMs ? (msSize+'px') : (durPx+'px');

    const cat=categoryOf(t);
    const col=colorForCategory(cat);
    bar.style.background=col;

    bar.title=`${t.name} (Start: ${t.start}, End: ${t.end})`;
    applyMilestoneStyle(bar, isMs);

    const lbl=document.createElement('div');
    lbl.className='label';
    lbl.textContent = isMs ? `#${t.id}` : `#${t.id} · ${t.name}`;

    const dep=depsLabel(t);
    const depEl=document.createElement('div');
    depEl.className='deps';
    depEl.textContent = dep ? `Deps: ${dep}` : '';

    if (isMs) { depEl.textContent=''; lbl.style.transform="rotate(-45deg)"; lbl.style.left="6px"; lbl.style.right="6px"; }

    bar.appendChild(lbl);
    bar.appendChild(depEl);

    const hL=document.createElement('div'); hL.className='handle left'; hL.dataset.handle='left';
    const hR=document.createElement('div'); hR.className='handle right'; hR.dataset.handle='right';
    if (!isMs){ bar.appendChild(hL); bar.appendChild(hR); }

    bar.addEventListener('dblclick', ()=>{
      alert(`Task #${t.id}\n${t.name}\nPhase: ${t.phase}\nOwner: ${t.owner}\nStart: ${t.start}\nEnd: ${t.end}\nDuration: ${t.duration}d\nMilestone: ${t.milestone?'YES':'NO'}\nDeps: ${t.deps||'-'}\nNotes: ${t.notes||'-'}`);
    });

    attachDrag(bar, pxPerDay);
    row.appendChild(bar);
    bars.appendChild(row);
  });

  // Draw dependency lines among visible
  const rowsCount=list.length;
  const svgHeight=rowsCount*34;
  svg.setAttribute('width', width);
  svg.setAttribute('height', svgHeight);
  svg.setAttribute('viewBox', `0 0 ${width} ${svgHeight}`);
  Array.from(svg.querySelectorAll('path.dep')).forEach(p=>p.remove());

  const centerY = (i)=>(i*34+17);
  const barEndX = (tt)=>((tt.startOffset + Math.max(1,tt.duration))*pxPerDay);
  const barStartX = (tt)=>((tt.startOffset)*pxPerDay);
  const visibleById = new Map(list.map((tt,i)=>[String(tt.id), {t:tt,i}]));

  list.forEach((tt,i)=>{
    const deps = String(tt.deps||'').split(/[,\s]+/).map(x=>x.trim()).filter(Boolean);
    deps.forEach(did=>{
      if (!visibleById.has(did)) return;
      const from=visibleById.get(did);
      const x1=barEndX(from.t), y1=centerY(from.i);
      const x2=barStartX(tt), y2=centerY(i);
      const midX=(x1+x2)/2;
      const p=document.createElementNS('http://www.w3.org/2000/svg','path');
      p.classList.add('dep');
      p.setAttribute('d', `M ${x1} ${y1} L ${midX} ${y1} L ${midX} ${y2} L ${x2} ${y2}`);
      p.setAttribute('fill','none');
      p.setAttribute('stroke','#64748b');
      p.setAttribute('stroke-width','1.2');
      p.setAttribute('marker-end','url(#arrow)');
      svg.appendChild(p);
    });
  });

  updateCharts(list);
}

/* ===== CSV Export/Import ===== */
function exportCSVText(){
  const header = ["id","phase","name","owner","startOffset","duration","start","end","deps","milestone","notes"];
  const rows = [header.join(",")];
  const esc = (v)=>{
    const s=String(v ?? "");
    if (s.includes('"')||s.includes(",")||s.includes("\n")||s.includes("\r")) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  };
  ALL.forEach(t=>{
    rows.push([
      esc(t.id),
      esc(t.phase),
      esc(t.name),
      esc(t.owner),
      esc(t.startOffset),
      esc(t.duration),
      esc(t.start),
      esc(t.end),
      esc(t.deps||""),
      esc(t.milestone?1:0),
      esc(t.notes||"")
    ].join(","));
  });

  const bom="\uFEFF";
  const csvText = bom + rows.join("\r\n");
  try{ localStorage.setItem(STORE_KEY_CSV, csvText);}catch(_){}
  return csvText;
}

function exportCSV(){
  const csvText = exportCSVText();
  const blob = new Blob([csvText], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url;
  a.download="gantt_full_export.csv";
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 5000);
  logOk(`Export CSV: ${ALL.length} tasks`);
}

function parseCSV(text){
  const lines = text.replace(/^\uFEFF/,'').split(/\r\n|\n|\r/);
  const out = [];
  let headers = null;

  function splitLine(line){
    const res=[];
    let cur="", inQ=false;
    for (let i=0;i<line.length;i++){
      const ch=line[i];
      if (inQ){
        if (ch === '"'){
          if (line[i+1] === '"'){ cur+='"'; i++; }
          else inQ=false;
        } else cur+=ch;
      } else {
        if (ch === '"') inQ=true;
        else if (ch === ','){ res.push(cur); cur=""; }
        else cur+=ch;
      }
    }
    res.push(cur);
    return res;
  }

  for (let i=0;i<lines.length;i++){
    const line=lines[i];
    if (!line.trim()) continue;
    const cols=splitLine(line);
    if (!headers){
      headers = cols.map(h=>h.trim());
      continue;
    }
    const obj={};
    headers.forEach((h, idx)=> obj[h]= (cols[idx] ?? "").trim());
    out.push(obj);
  }
  return out;
}

function coerceTask(row){
  const pick = (...keys) => {
    for (const k of keys){
      if (k == null) continue;
      if (Object.prototype.hasOwnProperty.call(row, k)) {
        const v = row[k];
        if (v !== undefined && v !== null && String(v).trim() !== "") return v;
      }
    }
    return undefined;
  };

  const t = {};
  t.id    = String(pick("id","ID","מזהה") ?? "").trim();
  t.phase = String(pick("phase","Phase","Phase/Section","קטגוריה/שלב") ?? "").trim();
  t.name  = String(pick("name","Task","Task Name","שם משימה") ?? "").trim();
  t.owner = String(pick("owner","Owner","אחראי") ?? "").trim();

  t.deps  = String(pick("deps","Dependencies","תלויות") ?? "").trim();
  t.notes = String(pick("notes","Notes","הערות") ?? "").trim();
  const msRaw = pick("milestone","Milestone","אבן דרך","אבן_דרך");
  t.milestone = (String(msRaw ?? "").toLowerCase()==="true" || String(msRaw ?? "").toLowerCase()==="yes" || String(msRaw ?? "")==="1");

  const so = pick("startOffset","start_offset","Start Offset (days)","Start Offset","StartOffset","Start Offset (Days)");
  const du = pick("duration","Duration","Duration (days)","Duration Days","משך (ימים)");
  t.startOffset = Number(so ?? 0);
  t.duration = Number(du ?? 1);

  // dates optional; we recompute from offsets anyway
  return t;
}

async function importCSVText(text){
  const rows = parseCSV(text);
  const tasks = rows.map(coerceTask).filter(Boolean).filter(t=>t.id);

  if (!tasks.length){
    alert("לא נמצאו משימות ב-CSV. ודא שיש עמודות id/name/phase/owner/startOffset/duration וכו'.");
    return false;
  }

  ALL = tasks.map(t=>({...t}));
  ALL.forEach(t=>calcDatesFromOffsets(t));

  const edits = {};
  ALL.forEach(t=>{
    edits[t.id] = {
      id:String(t.id),
      phase:t.phase||"",
      name:t.name||"",
      owner:t.owner||"",
      startOffset:Number(t.startOffset||0),
      duration:Number(t.duration||1),
      deps:t.deps||"",
      milestone: !!t.milestone,
      notes: t.notes||"",
      start:t.start, end:t.end
    };
  });
  saveEdits(edits);
  rebuildOwnerOptions(ALL);
  document.getElementById('ownerFilter').value = "";
  render();
  logOk(`Import: loaded ${ALL.length} tasks`);
  return true;
}

async function importCSVFromFile(file){
  const text = await file.text();
  const ok = await importCSVText(text);
  if (ok) alert(`✅ Import הושלם: נטענו ${ALL.length} משימות והגאנט עודכן מיד.`);
}

/* ===== Reset/Clear ===== */
function resetAll(){
  localStorage.removeItem(STORE_KEY);
  localStorage.removeItem(STORE_KEY_CSV);
  ALL = BASE.map(t=>({...t}));
  ALL.forEach(t=>calcDatesFromOffsets(t));
  rebuildOwnerOptions(ALL);
  document.getElementById('q').value='';
  document.getElementById('ownerFilter').value='';
  document.getElementById('zoom').value='week';
  render();
  logInfo("Reset: back to BASE");
}
function clearLocalCache(){
  localStorage.removeItem(STORE_KEY);
  localStorage.removeItem(STORE_KEY_CSV);
  // do not remove github settings
  logInfo("Cleared local cache. Now load from Git if available.");
}

/* ===== Mini chart engine (no external libs) ===== */
function clearCanvas(ctx){ ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height); }
function drawBarChart(canvas, items, colorFn, legendEl){
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  clearCanvas(ctx);

  const top = 16, bottom = 26, left = 8, right = 8;
  const plotW = W - left - right;
  const plotH = H - top - bottom;

  const maxV = Math.max(1, ...items.map(x=>x.v));
  const barCount = items.length || 1;
  const gap = 6;
  const barW = Math.max(10, Math.floor((plotW - gap*(barCount-1))/barCount));

  ctx.globalAlpha = 1;
  ctx.strokeStyle = "#e5e7eb";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(left, top+plotH);
  ctx.lineTo(left+plotW, top+plotH);
  ctx.stroke();

  items.forEach((it, i)=>{
    const h = Math.round((it.v/maxV) * (plotH-2));
    const x = left + i*(barW+gap);
    const y = top + (plotH - h);
    ctx.fillStyle = colorFn(it.k, i);
    ctx.fillRect(x, y, barW, h);

    ctx.fillStyle = "#111827";
    ctx.font = "12px system-ui";
    ctx.textAlign = "center";
    ctx.fillText(String(it.v), x+barW/2, y-4);

    const lab = it.k.length > 10 ? (it.k.slice(0,10)+"…") : it.k;
    ctx.fillStyle = "#374151";
    ctx.font = "11px system-ui";
    ctx.fillText(lab, x+barW/2, top+plotH+16);
  });

  if (legendEl){
    legendEl.innerHTML = "";
    items.slice(0,12).forEach((it, i)=>{
      const div = document.createElement('div');
      div.className="it";
      const dot = document.createElement('span');
      dot.className="dot";
      dot.style.background = colorFn(it.k, i);
      const tx = document.createElement('span');
      tx.textContent = `${it.k}: ${it.v}`;
      div.appendChild(dot); div.appendChild(tx);
      legendEl.appendChild(div);
    });
  }
}
function drawKPI(canvas, kpis){
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  clearCanvas(ctx);

  const pad = 12;
  const cellW = (W - pad*3)/2;
  const cellH = (H - pad*3)/2;

  ctx.font="12px system-ui";
  for (let i=0;i<kpis.length;i++){
    const r = Math.floor(i/2), c = i%2;
    const x = pad + c*(cellW+pad);
    const y = pad + r*(cellH+pad);

    ctx.fillStyle="#ffffff";
    ctx.strokeStyle="#e5e7eb";
    ctx.lineWidth=1;
    ctx.beginPath();
    ctx.roundRect(x,y,cellW,cellH,10);
    ctx.fill();
    ctx.stroke();

    ctx.fillStyle="#374151";
    ctx.font="12px system-ui";
    ctx.textAlign="right";
    ctx.fillText(kpis[i].t, x+cellW-10, y+18);

    ctx.fillStyle="#111827";
    ctx.font="22px system-ui";
    ctx.textAlign="right";
    ctx.fillText(String(kpis[i].v), x+cellW-10, y+50);

    ctx.fillStyle="#6b7280";
    ctx.font="11px system-ui";
    ctx.textAlign="right";
    ctx.fillText(kpis[i].s||"", x+cellW-10, y+70);
  }
}
if (!CanvasRenderingContext2D.prototype.roundRect){
  CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
    r = Math.min(r, w/2, h/2);
    this.beginPath();
    this.moveTo(x+r,y);
    this.arcTo(x+w,y,x+w,y+h,r);
    this.arcTo(x+w,y+h,x,y+h,r);
    this.arcTo(x,y+h,x,y,r);
    this.arcTo(x,y,x+w,y,r);
    this.closePath();
    return this;
  };
}
function getCounts(list, keyFn){
  const m = new Map();
  list.forEach(t=>{
    const k = keyFn(t);
    m.set(k, (m.get(k)||0)+1);
  });
  return Array.from(m.entries()).map(([k,v])=>({k,v})).sort((a,b)=>b.v-a.v);
}
function updateCharts(listOverride){
  const list = listOverride || (()=>{
    const q=(document.getElementById('q').value||'').toLowerCase().trim();
    const ownerVal=(document.getElementById('ownerFilter').value||'').toLowerCase();
    const baseList = !q ? ALL : ALL.filter(t =>
      (t.name||'').toLowerCase().includes(q) ||
      (t.owner||'').toLowerCase().includes(q) ||
      (t.phase||'').toLowerCase().includes(q) ||
      String(t.id||'').toLowerCase().includes(q)
    );
    return !ownerVal ? baseList : baseList.filter(t => (t.owner||'').toLowerCase()===ownerVal);
  })();

  const cats = getCounts(list, t=>categoryOf(t)).slice(0,10);
  const owners = getCounts(list, t=>(t.owner||"—")).slice(0,10);

  drawBarChart(
    document.getElementById('chartCats'),
    cats,
    (k)=>colorForCategory(k),
    document.getElementById('lgCats')
  );

  drawBarChart(
    document.getElementById('chartOwners'),
    owners,
    (k)=>{
      let h=0; for (let i=0;i<k.length;i++) h=(h*31+k.charCodeAt(i))>>>0;
      const pal=["#2563eb","#16a34a","#f59e0b","#dc2626","#9333ea","#0891b2","#7c3aed","#0ea5e9","#22c55e","#ea580c"];
      return pal[h%pal.length];
    },
    document.getElementById('lgOwners')
  );

  const milestones = list.filter(t=>!!t.milestone).length;
  const depsCount = list.reduce((acc,t)=> acc + (String(t.deps||'').split(/[,\s]+/).filter(Boolean).length), 0);

  const offs = list.map(t=>Number(t.startOffset||0));
  const ends = list.map(t=>Number(t.startOffset||0)+Math.max(1,Number(t.duration||1)));
  const minO = offs.length ? Math.min(...offs) : 0;
  const maxE = ends.length ? Math.max(...ends) : 0;
  const spanDays = Math.max(0, maxE - minO);

  drawKPI(document.getElementById('chartKPIs'), [
    {t:"כמות משימות", v:list.length, s:"בפילטר הנוכחי"},
    {t:"Milestones", v:milestones, s:"diamond"},
    {t:"כמות תלויות", v:depsCount, s:"edges"},
    {t:"טווח (ימים)", v:spanDays, s:"min..max"}
  ]);
}

/* ===== Utilities ===== */
function escapeHtml(s){
  const str = String(s ?? "");
  return str
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");
}

/* ===== Template Download ===== */
function downloadTemplate(){
  const temp = exportCSVText();
  const blob = new Blob([temp], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url;
  a.download="tasks_template_full.csv";
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 5000);
  logOk("Downloaded CSV template");
}

/* ===== Wiring ===== */
document.getElementById('q').addEventListener('input', ()=>{ render(); });
document.getElementById('ownerFilter').addEventListener('change', ()=>{ render(); });
document.getElementById('zoom').addEventListener('change', ()=>{ render(); });
document.getElementById('exportCsv').addEventListener('click', exportCSV);
document.getElementById('reset').addEventListener('click', resetAll);

document.getElementById('importBtn').addEventListener('click', async ()=>{
  const f = document.getElementById('importFile').files?.[0];
  if (!f){ alert("בחר קובץ CSV קודם."); return; }
  await importCSVFromFile(f);
});
document.getElementById('importCsvFile').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0];
  if (!f) return;
  await importCSVFromFile(f);
  e.target.value = ""; // allow re-upload same file
});

document.getElementById('downloadTemplate').addEventListener('click', downloadTemplate);

document.getElementById('clearLocal').addEventListener('click', ()=>{
  clearLocalCache();
  alert("✅ נמחק cache מקומי. עכשיו לחץ 'Load from GIT' כדי לטעון מה-Repo.");
});

document.getElementById('loadRepo').addEventListener('click', async ()=>{
  try{
    const { csv } = await ghLoadCsv();
    const ok = await importCSVText(csv);
    if (ok) alert("✅ נטען tasks.csv מה-Git והגאנט עודכן.");
  }catch(e){
    alert("❌ טעינה מה-Git נכשלה. פתח Log למטה כדי לראות למה (וגם בדוק Settings/Token/Repo/Path).");
  }
});

document.getElementById('saveRepo').addEventListener('click', async ()=>{
  try{
    const csvText = exportCSVText();
    await ghSaveCsv(csvText);
    alert("✅ נשמר tasks.csv ל-GitHub בהצלחה.");
  }catch(e){
    alert("❌ שמירה ל-Git נכשלה. בדוק Log למטה + בדוק שה-Token עם הרשאות כתיבה ל-Repo.");
  }
});

/* ===== Settings Modal ===== */
const modalBackdrop = document.getElementById('modalBackdrop');
const openSettingsBtn = document.getElementById('openSettings');
const closeSettingsBtn = document.getElementById('closeSettingsBtn');
const saveSettingsBtn = document.getElementById('saveSettingsBtn');
const clearTokenBtn = document.getElementById('clearTokenBtn');

function openModal(){
  const cfg = loadGitCfg();
  document.getElementById('ghToken').value = cfg.token || "";
  document.getElementById('ghOwner').value = cfg.owner || "";
  document.getElementById('ghRepo').value = cfg.repo || "";
  document.getElementById('ghBranch').value = cfg.branch || "";
  document.getElementById('ghPath').value = cfg.path || "";
  modalBackdrop.style.display="flex";
  modalBackdrop.setAttribute("aria-hidden","false");
}
function closeModal(){
  modalBackdrop.style.display="none";
  modalBackdrop.setAttribute("aria-hidden","true");
}
openSettingsBtn.addEventListener('click', openModal);
closeSettingsBtn.addEventListener('click', closeModal);
modalBackdrop.addEventListener('click', (e)=>{ if (e.target === modalBackdrop) closeModal(); });

saveSettingsBtn.addEventListener('click', ()=>{
  const cfg = {
    token: document.getElementById('ghToken').value.trim(),
    owner: document.getElementById('ghOwner').value.trim(),
    repo: document.getElementById('ghRepo').value.trim(),
    branch: document.getElementById('ghBranch').value.trim() || "main",
    path: document.getElementById('ghPath').value.trim() || "tasks.csv"
  };
  if (!cfg.owner || !cfg.repo){
    alert("חייב למלא לפחות Owner ו-Repo.");
    return;
  }
  saveGitCfg(cfg);
  logOk(`Settings saved: ${cfg.owner}/${cfg.repo}@${cfg.branch} path=${cfg.path} token=${cfg.token? "YES":"NO"}`);
  closeModal();
  alert("✅ נשמרו הגדרות GitHub.");
});

clearTokenBtn.addEventListener('click', ()=>{
  const cfg = loadGitCfg();
  cfg.token = "";
  saveGitCfg(cfg);
  document.getElementById('ghToken').value = "";
  logInfo("Token cleared from settings.");
  alert("✅ Token נמחק (שאר ההגדרות נשמרו).");
});

/* ===== Auto-load from Git if no local edits ===== */
async function bootAutoLoad(){
  const localEdits = loadEdits();
  if (localEdits && Object.keys(localEdits).length){
    logInfo("Local cache detected → using local edits (not auto-loading from Git).");
    return;
  }
  // try load from Git
  try{
    const { csv } = await ghLoadCsv();
    const ok = await importCSVText(csv);
    if (ok){
      logOk("Auto-loaded from Git (because no local cache).");
    }
  }catch(e){
    logInfo("Auto-load from Git skipped/failed → using BASE.");
  }
}

/* ===== Initial render ===== */
render();
updateCharts();
bootAutoLoad();
</script>
</body>
</html>
