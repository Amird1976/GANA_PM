<!view lang="he" dir="rtl">
<html>
<head>
    <meta charset="utf-8">
    <title>Gantt Professional - GitHub Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gantt-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            height: calc(100vh - 200px);
        }
        .timeline-scroll { overflow-x: auto; position: relative; background: #f9fafb; }
        .task-bar {
            position: absolute; height: 30px; background: #3b82f6; 
            border-radius: 6px; color: white; font-size: 11px; 
            display: flex; align-items: center; padding: 0 8px;
            cursor: pointer; transition: transform 0.2s;
        }
        .task-bar:hover { transform: scaleY(1.1); filter: brightness(1.1); }
        .grid-line { border-right: 1px solid #e5e7eb; height: 100%; position: absolute; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

    <header class="bg-slate-900 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold">Gantt Pro 2.0</h1>
                <p class="text-xs text-slate-400"> 驻专拽 住专 GitHub</p>
            </div>
            <div class="flex gap-3 bg-slate-800 p-3 rounded-lg border border-slate-700">
                <input id="ghToken" type="password" placeholder="GitHub Token" class="bg-slate-700 text-xs p-2 rounded border border-slate-600 w-32">
                <input id="ghRepo" type="text" placeholder="user/repo" class="bg-slate-700 text-xs p-2 rounded border border-slate-600 w-32">
                <input id="ghPath" type="text" value="tasks.csv" class="bg-slate-700 text-xs p-2 rounded border border-slate-600 w-24">
                <button onclick="saveSettings()" class="text-xs bg-slate-600 hover:bg-slate-500 px-2 rounded">砖专 专转</button>
            </div>
        </div>
    </header>

    <div class="bg-white border-b p-4 flex gap-4 items-center shadow-sm">
        <button onclick="fetchFromGitHub()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md font-bold text-sm shadow-sm transition">
            注 -GitHub 锔
        </button>
        <button onclick="saveToGitHub()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-md font-bold text-sm shadow-sm transition">
            砖专 注 GIT 
        </button>
        <div class="h-8 w-px bg-gray-200 mx-2"></div>
        <select id="zoom" onchange="render()" class="border p-2 rounded text-sm">
            <option value="20">转爪 专 (砖转)</option>
            <option value="40">转爪 驻专转 (砖注转)</option>
        </select>
        <span id="status" class="text-xs font-medium text-gray-500 mr-auto">转 驻注...</span>
    </div>

    <div class="m-4 bg-white border rounded-xl shadow-inner overflow-hidden">
        <div class="gantt-grid">
            <div class="border-l bg-gray-50 overflow-y-auto" id="taskList">
                <div class="p-3 border-b font-bold text-sm bg-gray-100">砖转</div>
                </div>
            <div class="timeline-scroll" id="timeline">
                <div id="gridBackdrop" class="absolute inset-0 pointer-events-none"></div>
                <div id="barsContainer" class="relative h-full"></div>
            </div>
        </div>
    </div>

    <div id="editModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-96 border">
            <h3 class="text-lg font-bold mb-4 border-b pb-2">注专转 砖</h3>
            <input type="hidden" id="editId">
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-gray-500 mb-1">砖 砖</label>
                    <input type="text" id="editName" class="w-full border p-2 rounded-lg outline-blue-500">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">专</label>
                        <input type="text" id="editOwner" class="w-full border p-2 rounded-lg outline-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">砖 ()</label>
                        <input type="number" id="editDuration" class="w-full border p-2 rounded-lg outline-blue-500">
                    </div>
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="applyEdit()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold">注</button>
                <button onclick="closeModal()" class="flex-1 bg-gray-100 text-gray-600 py-2 rounded-lg"></button>
            </div>
        </div>
    </div>

    <script>
        let ALL_TASKS = [];
        let GH_SHA = '';

        // 注转 专转 专 砖 驻驻
        window.onload = () => {
            const config = JSON.parse(localStorage.getItem('gh_config') || '{}');
            if(config.token) document.getElementById('ghToken').value = config.token;
            if(config.repo) document.getElementById('ghRepo').value = config.repo;
            if(config.path) document.getElementById('ghPath').value = config.path;
            
            // 转 专砖 
            ALL_TASKS = [
                {id: "1", phase: "Start", name: "专 驻专拽 -Git", owner: "Michelle", startOffset: 0, duration: 5}
            ];
            render();
        };

        function saveSettings() {
            const config = {
                token: document.getElementById('ghToken').value,
                repo: document.getElementById('ghRepo').value,
                path: document.getElementById('ghPath').value
            };
            localStorage.setItem('gh_config', JSON.stringify(config));
            setStatus("专转 砖专 拽转", "blue");
        }

        async function fetchFromGitHub() {
            const token = document.getElementById('ghToken').value;
            const repo = document.getElementById('ghRepo').value;
            const path = document.getElementById('ghPath').value;

            if(!token || !repo) return alert("  Token -Repo");

            setStatus("注 转...", "blue");
            try {
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                if(!res.ok) throw new Error("拽抓  爪  拽 砖");
                
                const data = await res.json();
                GH_SHA = data.sha;
                // 驻注 转 -CSV (转 注专转)
                const content = decodeURIComponent(escape(atob(data.content)));
                parseCSV(content);
                render();
                setStatus("转 注 爪", "green");
            } catch (err) {
                setStatus("砖: " + err.message, "red");
            }
        }

        async function saveToGitHub() {
            const token = document.getElementById('ghToken').value;
            const repo = document.getElementById('ghRepo').value;
            const path = document.getElementById('ghPath').value;

            if(!GH_SHA) return alert("注 注 转 (Fetch) 驻 砖专");

            setStatus("注 -GitHub...", "blue");
            const csvText = generateCSV();
            // 拽 住 64 转拽 注专转
            const b64Content = btoa(unescape(encodeURIComponent(csvText)));

            try {
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: "Gantt Update: " + new Date().toLocaleString(),
                        content: b64Content,
                        sha: GH_SHA
                    })
                });
                const result = await res.json();
                if(res.ok) {
                    GH_SHA = result.content.sha;
                    setStatus("拽抓 注 -Git!", "green");
                } else {
                    throw new Error(result.message);
                }
            } catch (err) {
                setStatus("砖 砖专: " + err.message, "red");
            }
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            ALL_TASKS = lines.slice(1).map(line => {
                const cols = line.split(',');
                return {
                    id: cols[0],
                    phase: cols[1],
                    name: cols[2],
                    owner: cols[3],
                    startOffset: parseInt(cols[9]) || 0,
                    duration: parseInt(cols[6]) || 1
                };
            });
        }

        function generateCSV() {
            const header = ",拽专/砖,砖 砖,专,转专 转,转专 住,砖 (),转转,注专转,startOffset,milestone";
            const body = ALL_TASKS.map(t => 
                `${t.id},${t.phase},${t.name},${t.owner},,,${t.duration},,,${t.startOffset},`
            ).join('\n');
            return header + '\n' + body;
        }

        function render() {
            const listEl = document.getElementById('taskList');
            const barsEl = document.getElementById('barsContainer');
