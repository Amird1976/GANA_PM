<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gantt CERT Professional - אינטגרציית GitHub מלאה</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary-color: #2563eb;
    --secondary-color: #7c3aed;
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --danger-color: #ef4444;
    --dark-color: #111827;
    --light-color: #f9fafb;
    --border-color: #e5e7eb;
    --card-bg: #ffffff;
    --sidebar-width: 320px;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: linear-gradient(135deg, #f6f7fb 0%, #f0f4ff 100%);
    color: var(--dark-color);
    line-height: 1.6;
    min-height: 100vh;
  }

  /* Header */
  .app-header {
    background: linear-gradient(to right, var(--dark-color), #1f2937);
    color: white;
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo i {
    font-size: 1.8rem;
    color: var(--primary-color);
  }

  .logo h1 {
    font-size: 1.4rem;
    font-weight: 700;
  }

  .logo-subtitle {
    font-size: 0.85rem;
    opacity: 0.8;
    margin-top: 2px;
  }

  .header-actions {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  /* Main Layout */
  .app-container {
    display: flex;
    min-height: calc(100vh - 70px);
  }

  .sidebar {
    width: var(--sidebar-width);
    background: var(--card-bg);
    border-left: 1px solid var(--border-color);
    padding: 1.5rem;
    overflow-y: auto;
    box-shadow: -2px 0 8px rgba(0,0,0,0.05);
    transition: transform 0.3s ease;
  }

  .main-content {
    flex: 1;
    padding: 1.5rem;
    overflow-x: auto;
  }

  /* Cards */
  .card {
    background: var(--card-bg);
    border-radius: 12px;
    border: 1px solid var(--border-color);
    padding: 1.25rem;
    margin-bottom: 1.25rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    transition: box-shadow 0.2s;
  }

  .card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }

  .card-title {
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 1rem;
    color: var(--dark-color);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* Buttons */
  .btn {
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
  }

  .btn-primary {
    background: var(--primary-color);
    color: white;
  }

  .btn-primary:hover {
    background: #1d4ed8;
    transform: translateY(-1px);
  }

  .btn-success {
    background: var(--success-color);
    color: white;
  }

  .btn-success:hover {
    background: #0da271;
  }

  .btn-warning {
    background: var(--warning-color);
    color: white;
  }

  .btn-warning:hover {
    background: #d97706;
  }

  .btn-danger {
    background: var(--danger-color);
    color: white;
  }

  .btn-danger:hover {
    background: #dc2626;
  }

  .btn-outline {
    background: transparent;
    color: var(--dark-color);
    border: 1px solid var(--border-color);
  }

  .btn-outline:hover {
    background: var(--light-color);
  }

  .btn-sm {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
  }

  .btn-group {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  /* Form Controls */
  .form-group {
    margin-bottom: 1rem;
  }

  .form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    font-size: 0.9rem;
  }

  .form-control {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 0.95rem;
    transition: border-color 0.2s;
  }

  .form-control:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .form-control-sm {
    padding: 0.5rem;
    font-size: 0.85rem;
  }

  /* Search and Filter */
  .search-box {
    position: relative;
  }

  .search-box i {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
  }

  .search-box input {
    padding-right: 40px;
  }

  .filter-section {
    display: flex;
    gap: 12px;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  /* Timeline */
  .timeline-container {
    background: white;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    overflow: hidden;
    margin-top: 1rem;
  }

  .timeline-header {
    background: #f8fafc;
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .timeline-scroll {
    overflow-x: auto;
    padding: 1rem;
  }

  /* Task Bars */
  .task-bar {
    height: 36px;
    margin: 4px 0;
    border-radius: 6px;
    position: relative;
    cursor: grab;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    padding: 0 12px;
    color: white;
    font-size: 0.85rem;
    font-weight: 500;
    overflow: hidden;
  }

  .task-bar:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }

  .task-bar.milestone {
    width: 8px !important;
    border-radius: 50%;
    transform: translateX(-50%);
  }

  .task-bar.dragging {
    cursor: grabbing;
    opacity: 0.9;
    z-index: 10;
  }

  .task-bar .task-label {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
  }

  .task-bar .task-id {
    background: rgba(0,0,0,0.2);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.75rem;
    margin-left: 8px;
  }

  /* Task List */
  .task-list {
    max-height: 600px;
    overflow-y: auto;
  }

  .task-item {
    padding: 12px;
    border-bottom: 1px solid #f1f5f9;
    cursor: pointer;
    transition: background 0.2s;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .task-item:hover {
    background: #f8fafc;
  }

  .task-item.selected {
    background: #eff6ff;
    border-right: 3px solid var(--primary-color);
  }

  .task-item .task-info h4 {
    font-size: 0.95rem;
    margin-bottom: 4px;
  }

  .task-item .task-meta {
    font-size: 0.8rem;
    color: #6b7280;
    display: flex;
    gap: 12px;
  }

  .task-item .task-actions {
    opacity: 0;
    transition: opacity 0.2s;
  }

  .task-item:hover .task-actions {
    opacity: 1;
  }

  /* Charts */
  .charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.25rem;
    margin-bottom: 1.5rem;
  }

  .chart-container {
    height: 240px;
    position: relative;
  }

  /* Status Messages */
  .alert {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .alert-success {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #a7f3d0;
  }

  .alert-warning {
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fde68a;
  }

  .alert-error {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fecaca;
  }

  .alert-info {
    background: #dbeafe;
    color: #1e40af;
    border: 1px solid #bfdbfe;
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal.active {
    display: flex;
  }

  .modal-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    animation: modalSlideIn 0.3s ease;
  }

  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-body {
    padding: 1.5rem;
  }

  .modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
  }

  .close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #6b7280;
  }

  /* GitHub Integration */
  .github-status {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: #f3f4f6;
    border-radius: 8px;
    font-size: 0.85rem;
  }

  .github-status.connected {
    background: #d1fae5;
    color: #065f46;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .app-container {
      flex-direction: column;
    }
    
    .sidebar {
      width: 100%;
      border-left: none;
      border-bottom: 1px solid var(--border-color);
    }
    
    .charts-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Loading Animation */
  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Toast Notifications */
  .toast-container {
    position: fixed;
    bottom: 20px;
    left: 20px;
    z-index: 1001;
  }

  .toast {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    animation: toastSlideIn 0.3s ease;
    max-width: 400px;
  }

  @keyframes toastSlideIn {
    from {
      opacity: 0;
      transform: translateX(-100%);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  /* Progress Bar */
  .progress-bar {
    height: 6px;
    background: #e5e7eb;
    border-radius: 3px;
    overflow: hidden;
    margin: 1rem 0;
  }

  .progress-fill {
    height: 100%;
    background: var(--primary-color);
    transition: width 0.3s ease;
  }
</style>
</head>
<body>
  <!-- Header -->
  <header class="app-header">
    <div class="logo">
      <i class="fas fa-project-diagram"></i>
      <div>
        <h1>Gantt CERT Professional</h1>
        <div class="logo-subtitle">ניהול פרויקטים עם אינטגרציית GitHub מלאה</div>
      </div>
    </div>
    <div class="header-actions">
      <div class="github-status" id="githubStatus">
        <i class="fab fa-github"></i>
        <span>לא מחובר ל-GitHub</span>
      </div>
      <button class="btn btn-outline" id="settingsBtn">
        <i class="fas fa-cog"></i> הגדרות
      </button>
    </div>
  </header>

  <!-- Main Container -->
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <!-- Search -->
      <div class="card">
        <div class="form-group">
          <label class="form-label">חיפוש משימות</label>
          <div class="search-box">
            <input type="text" id="searchInput" class="form-control" placeholder="חפש לפי שם, אחראי או קטגוריה...">
            <i class="fas fa-search"></i>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="card">
        <h3 class="card-title"><i class="fas fa-filter"></i> סינון מתקדם</h3>
        <div class="form-group">
          <label class="form-label">קטגוריה</label>
          <select id="categoryFilter" class="form-control">
            <option value="">כל הקטגוריות</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">אחראי</label>
          <select id="ownerFilter" class="form-control">
            <option value="">כל האחראים</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">תאריך התחלה</label>
          <input type="date" id="startDateFilter" class="form-control">
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card">
        <h3 class="card-title"><i class="fas fa-bolt"></i> פעולות מהירות</h3>
        <div class="btn-group">
          <button class="btn btn-success btn-sm" id="addTaskBtn">
            <i class="fas fa-plus"></i> משימה חדשה
          </button>
          <button class="btn btn-primary btn-sm" id="saveToGitHub">
            <i class="fab fa-github"></i> שמור ל-GitHub
          </button>
          <button class="btn btn-outline btn-sm" id="exportBtn">
            <i class="fas fa-download"></i> יצא CSV
          </button>
        </div>
      </div>

      <!-- Task List -->
      <div class="card">
        <h3 class="card-title"><i class="fas fa-tasks"></i> רשימת משימות</h3>
        <div class="task-list" id="taskList">
          <!-- Tasks will be populated here -->
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Charts Dashboard -->
      <div class="charts-grid">
        <div class="card">
          <h3 class="card-title"><i class="fas fa-chart-pie"></i> משימות לפי קטגוריה</h3>
          <div class="chart-container">
            <canvas id="categoryChart"></canvas>
          </div>
        </div>
        <div class="card">
          <h3 class="card-title"><i class="fas fa-chart-bar"></i> משימות לפי אחראי</h3>
          <div class="chart-container">
            <canvas id="ownerChart"></canvas>
          </div>
        </div>
        <div class="card">
          <h3 class="card-title"><i class="fas fa-chart-line"></i> סטטוס פרויקט</h3>
          <div class="chart-container">
            <canvas id="timelineChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Timeline -->
      <div class="card">
        <div class="timeline-header">
          <h3 class="card-title"><i class="fas fa-calendar-alt"></i> ציר זמן אינטראקטיבי</h3>
          <div class="btn-group">
            <button class="btn btn-outline btn-sm" id="zoomInBtn">
              <i class="fas fa-search-plus"></i>
            </button>
            <button class="btn btn-outline btn-sm" id="zoomOutBtn">
              <i class="fas fa-search-minus"></i>
            </button>
            <select id="timelineView" class="form-control form-control-sm">
              <option value="week">שבועי</option>
              <option value="month" selected>חודשי</option>
              <option value="quarter">רבעוני</option>
            </select>
          </div>
        </div>
        <div class="timeline-scroll">
          <div id="timeline"></div>
        </div>
      </div>

      <!-- Project Stats -->
      <div class="card">
        <h3 class="card-title"><i class="fas fa-chart-area"></i> מדדים וסטטיסטיקות</h3>
        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
          <div class="stat-card">
            <div class="stat-value" id="totalTasks">0</div>
            <div class="stat-label">סה"כ משימות</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="completedTasks">0</div>
            <div class="stat-label">הושלמו</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="inProgressTasks">0</div>
            <div class="stat-label">בתהליך</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="milestonesCount">0</div>
            <div class="stat-label">אבני דרך</div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modals -->
  <!-- GitHub Settings Modal -->
  <div class="modal" id="githubModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fab fa-github"></i> הגדרות GitHub</h2>
        <button class="close-btn" onclick="closeModal('githubModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          <div>
            <strong>הערה חשובה:</strong> Token עם הרשאות repo נדרש לעדכון הקובץ ב-GitHub.
            ניתן ליצור token ב-GitHub > Settings > Developer settings > Personal access tokens
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">GitHub Token</label>
          <input type="password" id="githubToken" class="form-control" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
        </div>
        <div class="form-group">
          <label class="form-label">Repository Owner</label>
          <input type="text" id="repoOwner" class="form-control" placeholder="username">
        </div>
        <div class="form-group">
          <label class="form-label">Repository Name</label>
          <input type="text" id="repoName" class="form-control" placeholder="repository-name">
        </div>
        <div class="form-group">
          <label class="form-label">Branch</label>
          <input type="text" id="repoBranch" class="form-control" value="main" placeholder="main">
        </div>
        <div class="form-group">
          <label class="form-label">נתיב לקובץ CSV</label>
          <input type="text" id="filePath" class="form-control" value="tasks.csv" placeholder="tasks.csv">
        </div>
        <div class="form-group">
          <div class="progress-bar">
            <div class="progress-fill" id="uploadProgress" style="width: 0%"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('githubModal')">ביטול</button>
        <button class="btn btn-success" onclick="testGitHubConnection()">
          <i class="fas fa-plug"></i> בדוק חיבור
        </button>
        <button class="btn btn-primary" onclick="saveGitHubSettings()">
          <i class="fas fa-save"></i> שמור הגדרות
        </button>
      </div>
    </div>
  </div>

  <!-- Task Editor Modal -->
  <div class="modal" id="taskModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-edit"></i> עריכת משימה</h2>
        <button class="close-btn" onclick="closeModal('taskModal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="taskForm">
          <div class="form-group">
            <label class="form-label">מספר משימה *</label>
            <input type="text" id="taskId" class="form-control" required>
          </div>
          <div class="form-group">
            <label class="form-label">שם משימה *</label>
            <input type="text" id="taskName" class="form-control" required>
          </div>
          <div class="form-group">
            <label class="form-label">קטגוריה/שלב</label>
            <input type="text" id="taskPhase" class="form-control">
          </div>
          <div class="form-group">
            <label class="form-label">אחראי</label>
            <input type="text" id="taskOwner" class="form-control">
          </div>
          <div class="form-group">
            <label class="form-label">תאריך התחלה</label>
            <input type="date" id="taskStart" class="form-control">
          </div>
          <div class="form-group">
            <label class="form-label">תאריך סיום</label>
            <input type="date" id="taskEnd" class="form-control">
          </div>
          <div class="form-group">
            <label class="form-label">משך (ימים)</label>
            <input type="number" id="taskDuration" class="form-control" min="1" value="1">
          </div>
          <div class="form-group">
            <label class="form-label">תלויות (מסיפים מופרדים בפסיק)</label>
            <input type="text" id="taskDeps" class="form-control" placeholder="1,2,3">
          </div>
          <div class="form-group">
            <label class="form-label">הערות</label>
            <textarea id="taskNotes" class="form-control" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="taskMilestone"> אבן דרך
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="deleteTask()" id="deleteTaskBtn">
          <i class="fas fa-trash"></i> מחק
        </button>
        <button class="btn btn-outline" onclick="closeModal('taskModal')">ביטול</button>
        <button class="btn btn-primary" onclick="saveTask()">
          <i class="fas fa-save"></i> שמור משימה
        </button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script>
    // Constants
    const STORAGE_KEYS = {
      TASKS: 'gantt_tasks_v2',
      GITHUB_SETTINGS: 'github_settings',
      EDIT_HISTORY: 'edit_history'
    };

    const COLORS = {
      phases: ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#06b6d4', '#84cc16', '#f97316'],
      status: {
        completed: '#10b981',
        inProgress: '#3b82f6',
        notStarted: '#6b7280',
        blocked: '#ef4444'
      }
    };

    // State
    let tasks = [];
    let filteredTasks = [];
    let currentZoom = 1;
    let selectedTaskId = null;
    let githubSettings = null;
    let chartInstances = {};

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      loadTasks();
      loadGitHubSettings();
      initEventListeners();
      renderDashboard();
      updateGitHubStatus();
    });

    // Task Management
    function loadTasks() {
      const saved = localStorage.getItem(STORAGE_KEYS.TASKS);
      if (saved) {
        tasks = JSON.parse(saved);
      } else {
        // Load from default CSV if available
        loadDefaultTasks();
      }
      filteredTasks = [...tasks];
    }

    function saveTasks() {
      localStorage.setItem(STORAGE_KEYS.TASKS, JSON.stringify(tasks));
      updateDashboard();
    }

    function loadDefaultTasks() {
      // You can load from your CSV file here
      // For now, we'll create some sample tasks
      tasks = [
        {
          id: '1',
          name: 'פתיחת פרויקט וניהול',
          phase: '1. Management',
          owner: 'צוות יעוץ',
          start: '2026-01-05',
          end: '2026-02-04',
          duration: 30,
          deps: '',
          notes: '',
          milestone: false,
          status: 'completed'
        }
      ];
    }

    // GitHub Integration
    function loadGitHubSettings() {
      const saved = localStorage.getItem(STORAGE_KEYS.GITHUB_SETTINGS);
      if (saved) {
        githubSettings = JSON.parse(saved);
      }
    }

    function saveGitHubSettings() {
      const settings = {
        token: document.getElementById('githubToken').value,
        owner: document.getElementById('repoOwner').value,
        repo: document.getElementById('repoName').value,
        branch: document.getElementById('repoBranch').value || 'main',
        filePath: document.getElementById('filePath').value || 'tasks.csv'
      };
      
      if (!settings.token || !settings.owner || !settings.repo) {
        showToast('נא למלא את כל שדות החובה', 'error');
        return;
      }

      localStorage.setItem(STORAGE_KEYS.GITHUB_SETTINGS, JSON.stringify(settings));
      githubSettings = settings;
      closeModal('githubModal');
      updateGitHubStatus();
      showToast('הגדרות GitHub נשמרו בהצלחה', 'success');
    }

    async function saveToGitHub() {
      if (!githubSettings) {
        showToast('נא להגדיר את פרטי GitHub תחילה', 'warning');
        document.getElementById('settingsBtn').click();
        return;
      }

      try {
        showToast('מתחבר ל-GitHub...', 'info');
        
        // Convert tasks to CSV
        const csvContent = convertToCSV(tasks);
        
        // Check if file exists
        const fileExists = await checkFileExists();
        
        // Upload to GitHub
        const result = await uploadToGitHub(csvContent, fileExists);
        
        if (result) {
          showToast('המשימות נשמרו בהצלחה ב-GitHub!', 'success');
          updateGitHubStatus('connected', 'מחובר ומסנכרן');
        }
      } catch (error) {
        showToast(`שגיאה בשמירה ל-GitHub: ${error.message}`, 'error');
        console.error('GitHub save error:', error);
      }
    }

    async function uploadToGitHub(content, fileExists) {
      const { token, owner, repo, branch, filePath } = githubSettings;
      
      // Get current SHA if file exists
      let sha = null;
      if (fileExists) {
        sha = await getFileSHA();
      }

      const url = `https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`;
      
      const body = {
        message: `Update tasks from Gantt tool - ${new Date().toLocaleString()}`,
        content: btoa(unescape(encodeURIComponent(content))),
        branch: branch
      };

      if (sha) {
        body.sha = sha;
      }

      const response = await fetch(url, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });

      if (!response.ok) {
        throw new Error(`GitHub API error: ${response.status}`);
      }

      return await response.json();
    }

    async function checkFileExists() {
      const { token, owner, repo, branch, filePath } = githubSettings;
      const url = `https://api.github.com/repos/${owner}/${repo}/contents/${filePath}?ref=${branch}`;

      try {
        const response = await fetch(url, {
          headers: {
            'Authorization': `token ${token}`
          }
        });
        return response.ok;
      } catch (error) {
        return false;
      }
    }

    async function getFileSHA() {
      const { token, owner, repo, branch, filePath } = githubSettings;
      const url = `https://api.github.com/repos/${owner}/${repo}/contents/${filePath}?ref=${branch}`;

      const response = await fetch(url, {
        headers: {
          'Authorization': `token ${token}`
        }
      });

      if (response.ok) {
        const data = await response.json();
        return data.sha;
      }

      return null;
    }

    // UI Functions
    function updateGitHubStatus(status = 'disconnected', message = '') {
      const statusEl = document.getElementById('githubStatus');
      statusEl.className = 'github-status';
      
      if (githubSettings) {
        statusEl.classList.add('connected');
        statusEl.innerHTML = `
          <i class="fab fa-github"></i>
          <span>${message || `מחובר ל-${githubSettings.owner}/${githubSettings.repo}`}</span>
        `;
      } else {
        statusEl.innerHTML = `
          <i class="fab fa-github"></i>
          <span>לא מחובר ל-GitHub</span>
        `;
      }
    }

    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast alert-${type}`;
      
      const icon = type === 'success' ? 'check-circle' :
                   type === 'error' ? 'exclamation-circle' :
                   type === 'warning' ? 'exclamation-triangle' : 'info-circle';
      
      toast.innerHTML = `
        <i class="fas fa-${icon}"></i>
        <div>${message}</div>
        <button class="close-btn" onclick="this.parentElement.remove()">&times;</button>
      `;
      
      toastContainer.appendChild(toast);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        if (toast.parentElement) {
          toast.remove();
        }
      }, 5000);
    }

    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // Event Listeners
    function initEventListeners() {
      // GitHub buttons
      document.getElementById('settingsBtn').addEventListener('click', () => {
        if (githubSettings) {
          document.getElementById('githubToken').value = githubSettings.token || '';
          document.getElementById('repoOwner').value = githubSettings.owner || '';
          document.getElementById('repoName').value = githubSettings.repo || '';
          document.getElementById('repoBranch').value = githubSettings.branch || 'main';
          document.getElementById('filePath').value = githubSettings.filePath || 'tasks.csv';
        }
        openModal('githubModal');
      });

      document.getElementById('saveToGitHub').addEventListener('click', saveToGitHub);

      // Search and filter
      document.getElementById('searchInput').addEventListener('input', filterTasks);
      document.getElementById('categoryFilter').addEventListener('change', filterTasks);
      document.getElementById('ownerFilter').addEventListener('change', filterTasks);
      document.getElementById('startDateFilter').addEventListener('change', filterTasks);

      // Task actions
      document.getElementById('addTaskBtn').addEventListener('click', addNewTask);
      document.getElementById('exportBtn').addEventListener('click', exportToCSV);

      // Timeline controls
      document.getElementById('zoomInBtn').addEventListener('click', () => changeZoom(0.1));
      document.getElementById('zoomOutBtn').addEventListener('click', () => changeZoom(-0.1));
      document.getElementById('timelineView').addEventListener('change', renderTimeline);
    }

    // Task filtering
    function filterTasks() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const category = document.getElementById('categoryFilter').value;
      const owner = document.getElementById('ownerFilter').value;
      const startDate = document.getElementById('startDateFilter').value;

      filteredTasks = tasks.filter(task => {
        // Search term
        if (searchTerm && !(
          task.name.toLowerCase().includes(searchTerm) ||
          task.phase.toLowerCase().includes(searchTerm) ||
          task.owner.toLowerCase().includes(searchTerm) ||
          task.id.includes(searchTerm)
        )) {
          return false;
        }

        // Category filter
        if (category && task.phase !== category) {
          return false;
        }

        // Owner filter
        if (owner && task.owner !== owner) {
          return false;
        }

        // Start date filter
        if (startDate && task.start < startDate) {
          return false;
        }

        return true;
      });

      renderTaskList();
      renderTimeline();
    }

    // Task CRUD operations
    function addNewTask() {
      selectedTaskId = null;
      document.getElementById('taskForm').reset();
      document.getElementById('deleteTaskBtn').style.display = 'none';
      openModal('taskModal');
    }

    function editTask(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;

      selectedTaskId = taskId;
      
      // Fill form
      document.getElementById('taskId').value = task.id;
      document.getElementById('taskName').value = task.name;
      document.getElementById('taskPhase').value = task.phase;
      document.getElementById('taskOwner').value = task.owner;
      document.getElementById('taskStart').value = task.start;
      document.getElementById('taskEnd').value = task.end;
      document.getElementById('taskDuration').value = task.duration;
      document.getElementById('taskDeps').value = task.deps;
      document.getElementById('taskNotes').value = task.notes;
      document.getElementById('taskMilestone').checked = task.milestone;
      
      document.getElementById('deleteTaskBtn').style.display = 'block';
      openModal('taskModal');
    }

    function saveTask() {
      const form = document.getElementById('taskForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const taskData = {
        id: document.getElementById('taskId').value,
        name: document.getElementById('taskName').value,
        phase: document.getElementById('taskPhase').value,
        owner: document.getElementById('taskOwner').value,
        start: document.getElementById('taskStart').value,
        end: document.getElementById('taskEnd').value,
        duration: parseInt(document.getElementById('taskDuration').value),
        deps: document.getElementById('taskDeps').value,
        notes: document.getElementById('taskNotes').value,
        milestone: document.getElementById('taskMilestone').checked,
        status: 'notStarted'
      };

      if (selectedTaskId) {
        // Update existing task
        const index = tasks.findIndex(t => t.id === selectedTaskId);
        tasks[index] = { ...tasks[index], ...taskData };
      } else {
        // Add new task
        tasks.push(taskData);
      }

      saveTasks();
      closeModal('taskModal');
      showToast('המשימה נשמרה בהצלחה', 'success');
    }

    function deleteTask() {
      if (!selectedTaskId || !confirm('האם אתה בטוח שברצונך למחוק משימה זו?')) {
        return;
      }

      tasks = tasks.filter(t => t.id !== selectedTaskId);
      saveTasks();
      closeModal('taskModal');
      showToast('המשימה נמחקה בהצלחה', 'success');
    }

    // Rendering functions
    function renderTaskList() {
      const taskList = document.getElementById('taskList');
      taskList.innerHTML = '';

      filteredTasks.forEach(task => {
        const taskItem = document.createElement('div');
        taskItem.className = `task-item ${selectedTaskId === task.id ? 'selected' : ''}`;
        taskItem.onclick = () => editTask(task.id);
        
        taskItem.innerHTML = `
          <div class="task-info">
            <h4>${task.name}</h4>
            <div class="task-meta">
              <span><i class="fas fa-user"></i> ${task.owner}</span>
              <span><i class="fas fa-layer-group"></i> ${task.phase}</span>
              <span><i class="fas fa-calendar"></i> ${formatDate(task.start)}</span>
            </div>
          </div>
          <div class="task-actions">
            <span class="task-status ${task.status}"></span>
            ${task.milestone ? '<i class="fas fa-gem" style="color: #8b5cf6;"></i>' : ''}
          </div>
        `;
        
        taskList.appendChild(taskItem);
      });

      // Update filter dropdowns
      updateFilterOptions();
    }

    function renderTimeline() {
      const timeline = document.getElementById('timeline');
      timeline.innerHTML = '';
      
      // Create timeline visualization
      // This is a simplified version - you can expand this
      filteredTasks.forEach(task => {
        const taskBar = document.createElement('div');
        taskBar.className = `task-bar ${task.milestone ? 'milestone' : ''}`;
        taskBar.style.backgroundColor = getPhaseColor(task.phase);
        taskBar.style.width = `${task.duration * 10 * currentZoom}px`;
        taskBar.style.marginLeft = `${calculatePosition(task.start)}px`;
        
        taskBar.innerHTML = `
          <div class="task-label">${task.name}</div>
          <div class="task-id">#${task.id}</div>
        `;
        
        taskBar.addEventListener('mousedown', startDrag);
        timeline.appendChild(taskBar);
      });
    }

    function renderCharts() {
      // Category chart
      const categoryCtx = document.getElementById('categoryChart').getContext('2d');
      const categoryData = groupByPhase();
      
      if (chartInstances.categoryChart) {
        chartInstances.categoryChart.destroy();
      }
      
      chartInstances.categoryChart = new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
          labels: categoryData.labels,
          datasets: [{
            data: categoryData.values,
            backgroundColor: COLORS.phases
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });

      // Owner chart
      const ownerCtx = document.getElementById('ownerChart').getContext('2d');
      const ownerData = groupByOwner();
      
      if (chartInstances.ownerChart) {
        chartInstances.ownerChart.destroy();
      }
      
      chartInstances.ownerChart = new Chart(ownerCtx, {
        type: 'bar',
        data: {
          labels: ownerData.labels,
          datasets: [{
            label: 'מספר משימות',
            data: ownerData.values,
            backgroundColor: COLORS.phases[0]
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    // Utility functions
    function groupByPhase() {
      const groups = {};
      tasks.forEach(task => {
        groups[task.phase] = (groups[task.phase] || 0) + 1;
      });
      
      return {
        labels: Object.keys(groups),
        values: Object.values(groups)
      };
    }

    function groupByOwner() {
      const groups = {};
      tasks.forEach(task => {
        groups[task.owner] = (groups[task.owner] || 0) + 1;
      });
      
      return {
        labels: Object.keys(groups),
        values: Object.values(groups)
      };
    }

    function getPhaseColor(phase) {
      const phases = Array.from(new Set(tasks.map(t => t.phase)));
      const index = phases.indexOf(phase);
      return COLORS.phases[index % COLORS.phases.length];
    }

    function calculatePosition(startDate) {
      const start = new Date('2026-01-05');
      const taskStart = new Date(startDate);
      const diffDays = Math.floor((taskStart - start) / (1000 * 60 * 60 * 24));
      return diffDays * 10 * currentZoom;
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('he-IL');
    }

    function updateFilterOptions() {
      // Update category filter
      const categoryFilter = document.getElementById('categoryFilter');
      const categories = Array.from(new Set(tasks.map(t => t.phase))).sort();
      
      categoryFilter.innerHTML = '<option value="">כל הקטגוריות</option>';
      categories.forEach(cat => {
        categoryFilter.innerHTML += `<option value="${cat}">${cat}</option>`;
      });

      // Update owner filter
      const ownerFilter = document.getElementById('ownerFilter');
      const owners = Array.from(new Set(tasks.map(t => t.owner))).sort();
      
      ownerFilter.innerHTML = '<option value="">כל האחראים</option>';
      owners.forEach(owner => {
        ownerFilter.innerHTML += `<option value="${owner}">${owner}</option>`;
      });
    }

    function changeZoom(delta) {
      currentZoom = Math.max(0.5, Math.min(3, currentZoom + delta));
      renderTimeline();
    }

    function convertToCSV(tasksArray) {
      const headers = ['id', 'name', 'phase', 'owner', 'start', 'end', 'duration', 'deps', 'notes', 'milestone', 'status'];
      const rows = tasksArray.map(task => 
        headers.map(header => `"${(task[header] || '').toString().replace(/"/g, '""')}"`).join(',')
      );
      return [headers.join(','), ...rows].join('\n');
    }

    function exportToCSV() {
      const csvContent = convertToCSV(tasks);
      const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `tasks_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('הקובץ יוצא בהצלחה', 'success');
    }

    function updateDashboard() {
      // Update stats
      document.getElementById('totalTasks').textContent = tasks.length;
      document.getElementById('completedTasks').textContent = tasks.filter(t => t.status === 'completed').length;
      document.getElementById('inProgressTasks').textContent = tasks.filter(t => t.status === 'inProgress').length;
      document.getElementById('milestonesCount').textContent = tasks.filter(t => t.milestone).length;

      // Render everything
      renderTaskList();
      renderTimeline();
      renderCharts();
    }

    // Drag and drop functionality
    function startDrag(e) {
      const taskBar = e.target;
      const startX = e.clientX;
      const startLeft = parseFloat(taskBar.style.marginLeft) || 0;
      
      taskBar.classList.add('dragging');
      
      function onMouseMove(e) {
        const dx = e.clientX - startX;
        taskBar.style.marginLeft = `${startLeft + dx}px`;
      }
      
      function onMouseUp() {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        taskBar.classList.remove('dragging');
        
        // Update task position in data
        // You would need to map pixel position back to date
        saveTasks();
      }
      
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    }

    // Initialize dashboard
    function renderDashboard() {
      updateDashboard();
    }

    // GitHub test connection
    async function testGitHubConnection() {
      const token = document.getElementById('githubToken').value;
      const owner = document.getElementById('repoOwner').value;
      const repo = document.getElementById('repoName').value;
      
      if (!token || !owner || !repo) {
        showToast('נא למלא את כל השדות הדרושים', 'error');
        return;
      }
      
      try {
        showToast('בודק חיבור ל-GitHub...', 'info');
        
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}`, {
          headers: {
            'Authorization': `token ${token}`
          }
        });
        
        if (response.ok) {
          showToast('החיבור ל-GitHub עובד בהצלחה!', 'success');
        } else {
          throw new Error('לא ניתן להתחבר ל-Repository');
        }
      } catch (error) {
        showToast(`שגיאה בחיבור: ${error.message}`, 'error');
      }
    }

    // Add Chart.js library
    const chartScript = document.createElement('script');
    chartScript.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    chartScript.onload = renderCharts;
    document.head.appendChild(chartScript);
  </script>
</body>
</html>
