<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gantt CERT Professional - סינכרון עם GitHub</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root {
    --primary-color: #2563eb;
    --secondary-color: #7c3aed;
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --danger-color: #ef4444;
    --dark-color: #111827;
    --light-color: #f9fafb;
    --border-color: #e5e7eb;
    --card-bg: #ffffff;
    --sidebar-width: 340px;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Segoe UI', 'Microsoft YaHei', system-ui, -apple-system, sans-serif;
    background: linear-gradient(135deg, #f6f7fb 0%, #f0f4ff 100%);
    color: var(--dark-color);
    line-height: 1.6;
    min-height: 100vh;
    direction: rtl;
  }

  /* Header */
  .app-header {
    background: linear-gradient(to right, var(--dark-color), #1f2937);
    color: white;
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo i {
    font-size: 1.8rem;
    color: var(--primary-color);
  }

  .logo h1 {
    font-size: 1.4rem;
    font-weight: 700;
  }

  .logo-subtitle {
    font-size: 0.85rem;
    opacity: 0.8;
    margin-top: 2px;
  }

  .header-actions {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  /* Main Layout */
  .app-container {
    display: flex;
    min-height: calc(100vh - 70px);
  }

  .sidebar {
    width: var(--sidebar-width);
    background: var(--card-bg);
    border-left: 1px solid var(--border-color);
    padding: 1.5rem;
    overflow-y: auto;
    box-shadow: -2px 0 8px rgba(0,0,0,0.05);
    transition: transform 0.3s ease;
  }

  .main-content {
    flex: 1;
    padding: 1.5rem;
    overflow-x: auto;
  }

  /* Cards */
  .card {
    background: var(--card-bg);
    border-radius: 12px;
    border: 1px solid var(--border-color);
    padding: 1.25rem;
    margin-bottom: 1.25rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    transition: box-shadow 0.2s;
  }

  .card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }

  .card-title {
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 1rem;
    color: var(--dark-color);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* Buttons */
  .btn {
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
  }

  .btn-primary {
    background: var(--primary-color);
    color: white;
  }

  .btn-primary:hover {
    background: #1d4ed8;
    transform: translateY(-1px);
  }

  .btn-success {
    background: var(--success-color);
    color: white;
  }

  .btn-success:hover {
    background: #0da271;
  }

  .btn-warning {
    background: var(--warning-color);
    color: white;
  }

  .btn-warning:hover {
    background: #d97706;
  }

  .btn-danger {
    background: var(--danger-color);
    color: white;
  }

  .btn-danger:hover {
    background: #dc2626;
  }

  .btn-outline {
    background: transparent;
    color: var(--dark-color);
    border: 1px solid var(--border-color);
  }

  .btn-outline:hover {
    background: var(--light-color);
  }

  .btn-sm {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
  }

  .btn-group {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  /* Form Controls */
  .form-group {
    margin-bottom: 1rem;
  }

  .form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    font-size: 0.9rem;
  }

  .form-control {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 0.95rem;
    transition: border-color 0.2s;
    font-family: inherit;
  }

  .form-control:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .form-control-sm {
    padding: 0.5rem;
    font-size: 0.85rem;
  }

  /* Search and Filter */
  .search-box {
    position: relative;
  }

  .search-box i {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
  }

  .search-box input {
    padding-right: 40px;
  }

  .filter-section {
    display: flex;
    gap: 12px;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  /* Timeline */
  .timeline-container {
    background: white;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    overflow: hidden;
    margin-top: 1rem;
    position: relative;
  }

  .timeline-header {
    background: #f8fafc;
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .timeline-scroll {
    overflow-x: auto;
    padding: 1rem;
    min-height: 500px;
    position: relative;
  }

  .timeline-grid {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    pointer-events: none;
  }

  .timeline-day {
    border-right: 1px solid #e5e7eb;
    height: 100%;
    position: relative;
  }

  .timeline-day.month-start {
    border-right: 2px solid #94a3b8;
  }

  .timeline-day-label {
    position: absolute;
    top: -25px;
    width: 100%;
    text-align: center;
    font-size: 0.75rem;
    color: #64748b;
    white-space: nowrap;
  }

  /* Task Bars */
  .task-bar {
    height: 32px;
    margin: 4px 0;
    border-radius: 6px;
    position: absolute;
    cursor: grab;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    padding: 0 12px;
    color: white;
    font-size: 0.8rem;
    font-weight: 500;
    overflow: hidden;
    z-index: 5;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .task-bar:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    z-index: 20;
  }

  .task-bar.milestone {
    width: 32px !important;
    height: 32px;
    border-radius: 50%;
    transform: translateX(-50%) rotate(45deg);
    display: flex;
    align-items: center;
    justify-content: center;
    background: #8b5cf6 !important;
  }

  .task-bar.milestone:hover {
    transform: translateX(-50%) rotate(45deg) scale(1.1);
  }

  .task-bar.milestone .task-label {
    transform: rotate(-45deg);
    font-weight: bold;
  }

  .task-bar.dragging {
    cursor: grabbing;
    opacity: 0.9;
    z-index: 100;
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
  }

  .task-bar .task-label {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
    font-size: 0.75rem;
  }

  .task-bar .task-id {
    background: rgba(0,0,0,0.2);
    padding: 1px 6px;
    border-radius: 10px;
    font-size: 0.7rem;
    margin-right: 6px;
    font-weight: bold;
  }

  .task-row {
    height: 40px;
    position: relative;
    border-bottom: 1px solid #f1f5f9;
  }

  .task-row:hover {
    background: #f8fafc;
  }

  .task-handle-left, .task-handle-right {
    position: absolute;
    width: 8px;
    height: 100%;
    top: 0;
    cursor: ew-resize;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 10;
  }

  .task-handle-left {
    left: 0;
    border-radius: 6px 0 0 6px;
  }

  .task-handle-right {
    right: 0;
    border-radius: 0 6px 6px 0;
  }

  .task-bar:hover .task-handle-left,
  .task-bar:hover .task-handle-right {
    opacity: 0.5;
  }

  /* Dependency Lines */
  .dependency-line {
    position: absolute;
    pointer-events: none;
    z-index: 1;
    stroke: #64748b;
    stroke-width: 2;
    fill: none;
    marker-end: url(#arrowhead);
  }

  /* Task List */
  .task-list {
    max-height: 600px;
    overflow-y: auto;
  }

  .task-item {
    padding: 12px;
    border-bottom: 1px solid #f1f5f9;
    cursor: pointer;
    transition: background 0.2s;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .task-item:hover {
    background: #f8fafc;
  }

  .task-item.selected {
    background: #eff6ff;
    border-right: 3px solid var(--primary-color);
  }

  .task-item .task-info h4 {
    font-size: 0.95rem;
    margin-bottom: 4px;
    font-weight: 600;
  }

  .task-item .task-meta {
    font-size: 0.8rem;
    color: #6b7280;
    display: flex;
    gap: 12px;
  }

  .task-item .task-actions {
    opacity: 0;
    transition: opacity 0.2s;
    display: flex;
    gap: 8px;
  }

  .task-item:hover .task-actions {
    opacity: 1;
  }

  /* Charts */
  .charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 1.25rem;
    margin-bottom: 1.5rem;
  }

  .chart-container {
    height: 240px;
    position: relative;
  }

  /* Status Messages */
  .alert {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .alert-success {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #a7f3d0;
  }

  .alert-warning {
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fde68a;
  }

  .alert-error {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fecaca;
  }

  .alert-info {
    background: #dbeafe;
    color: #1e40af;
    border: 1px solid #bfdbfe;
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal.active {
    display: flex;
  }

  .modal-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    animation: modalSlideIn 0.3s ease;
  }

  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-body {
    padding: 1.5rem;
  }

  .modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
  }

  .close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #6b7280;
    line-height: 1;
  }

  /* GitHub Integration */
  .github-status {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: #f3f4f6;
    border-radius: 8px;
    font-size: 0.85rem;
  }

  .github-status.connected {
    background: #d1fae5;
    color: #065f46;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .app-container {
      flex-direction: column;
    }
    
    .sidebar {
      width: 100%;
      border-left: none;
      border-bottom: 1px solid var(--border-color);
      max-height: 50vh;
    }
    
    .charts-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Loading Animation */
  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Toast Notifications */
  .toast-container {
    position: fixed;
    bottom: 20px;
    left: 20px;
    z-index: 1001;
  }

  .toast {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    animation: toastSlideIn 0.3s ease;
    max-width: 400px;
    direction: rtl;
  }

  @keyframes toastSlideIn {
    from {
      opacity: 0;
      transform: translateX(-100%);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  /* Progress Bar */
  .progress-bar {
    height: 6px;
    background: #e5e7eb;
    border-radius: 3px;
    overflow: hidden;
    margin: 1rem 0;
  }

  .progress-fill {
    height: 100%;
    background: var(--primary-color);
    transition: width 0.3s ease;
  }

  /* Stats Cards */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
  }

  .stat-card {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 10px;
    padding: 1rem;
    text-align: center;
    border: 1px solid #e2e8f0;
  }

  .stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 0.5rem;
  }

  .stat-label {
    font-size: 0.9rem;
    color: #64748b;
  }

  /* Color Palette for Phases */
  .phase-1 { background-color: #3b82f6; }
  .phase-2 { background-color: #8b5cf6; }
  .phase-3 { background-color: #10b981; }
  .phase-4 { background-color: #f59e0b; }
  .phase-5 { background-color: #ef4444; }
  .phase-6 { background-color: #06b6d4; }
  .phase-7 { background-color: #84cc16; }
  .phase-8 { background-color: #f97316; }
  .phase-9 { background-color: #8b5cf6; }
  .phase-10 { background-color: #ec4899; }
  .phase-11 { background-color: #14b8a6; }
  .phase-12 { background-color: #f43f5e; }
  .phase-13 { background-color: #6366f1; }

  /* Legend */
  .legend {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin: 1rem 0;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.8rem;
    padding: 4px 8px;
    background: #f8fafc;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
  }

  .legend-color {
    width: 12px;
    height: 12px;
    border-radius: 3px;
  }

  /* Zoom Controls */
  .zoom-controls {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #f8fafc;
    padding: 6px 12px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
  }

  .zoom-controls button {
    background: white;
    border: 1px solid #d1d5db;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
  }

  .zoom-controls button:hover {
    background: #f3f4f6;
    border-color: #9ca3af;
  }

  /* Tooltip */
  .tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
    z-index: 1000;
    pointer-events: none;
    white-space: nowrap;
    max-width: 300px;
  }
</style>
</head>
<body>
  <!-- Header -->
  <header class="app-header">
    <div class="logo">
      <i class="fas fa-project-diagram"></i>
      <div>
        <h1>Gantt CERT Professional</h1>
        <div class="logo-subtitle">ניהול פרויקט Ghana Energy CERT - סינכרון מלא עם GitHub</div>
      </div>
    </div>
    <div class="header-actions">
      <div class="github-status" id="githubStatus">
        <i class="fab fa-github"></i>
        <span>לא מחובר ל-GitHub</span>
      </div>
      <button class="btn btn-outline" id="settingsBtn">
        <i class="fas fa-cog"></i> הגדרות
      </button>
    </div>
  </header>

  <!-- Main Container -->
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <!-- Search -->
      <div class="card">
        <div class="form-group">
          <label class="form-label">חיפוש משימות</label>
          <div class="search-box">
            <input type="text" id="searchInput" class="form-control" placeholder="חפש לפי שם, אחראי או קטגוריה...">
            <i class="fas fa-search"></i>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="card">
        <h3 class="card-title"><i class="fas fa-filter"></i> סינון מתקדם</h3>
        <div class="form-group">
          <label class="form-label">קטגוריה</label>
          <select id="categoryFilter" class="form-control">
            <option value="">כל הקטגוריות</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">אחראי</label>
          <select id="ownerFilter" class="form-control">
            <option value="">כל האחראים</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">סטטוס</label>
          <select id="statusFilter" class="form-control">
            <option value="">כל הסטטוסים</option>
            <option value="not-started">לא התחיל</option>
            <option value="in-progress">בתהליך</option>
            <option value="completed">הושלם</option>
          </select>
        </div>
      </div>

      <!-- GitHub Actions -->
      <div class="card">
        <h3 class="card-title"><i class="fab fa-github"></i> GitHub Actions</h3>
        <div class="btn-group">
          <button class="btn btn-primary btn-sm" id="loadFromGitHubBtn">
            <i class="fas fa-cloud-download-alt"></i> טען מ-GitHub
          </button>
          <button class="btn btn-success btn-sm" id="saveToGitHubBtn">
            <i class="fas fa-cloud-upload-alt"></i> שמור ל-GitHub
          </button>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card">
        <h3 class="card-title"><i class="fas fa-bolt"></i> פעולות מהירות</h3>
        <div class="btn-group">
          <button class="btn btn-success btn-sm" id="addTaskBtn">
            <i class="fas fa-plus"></i> משימה חדשה
          </button>
          <button class="btn btn-outline btn-sm" id="exportBtn">
            <i class="fas fa-download"></i> יצא CSV
          </button>
          <button class="btn btn-outline btn-sm" id="printBtn">
            <i class="fas fa-print"></i> הדפס
          </button>
        </div>
      </div>

      <!-- Legend -->
      <div class="card">
        <h3 class="card-title"><i class="fas fa-palette"></i> מקרא צבעים</h3>
        <div class="legend" id="phaseLegend">
          <!-- Legend will be generated here -->
        </div>
      </div>

      <!-- Task List -->
      <div class="card">
        <h3 class="card-title"><i class="fas fa-tasks"></i> רשימת משימות</h3>
        <div class="task-list" id="taskList">
          <!-- Tasks will be populated here -->
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Charts Dashboard -->
      <div class="charts-grid">
        <div class="card">
          <h3 class="card-title"><i class="fas fa-chart-pie"></i> משימות לפי קטגוריה</h3>
          <div class="chart-container">
            <canvas id="categoryChart"></canvas>
          </div>
        </div>
        <div class="card">
          <h3 class="card-title"><i class="fas fa-chart-bar"></i> משימות לפי אחראי</h3>
          <div class="chart-container">
            <canvas id="ownerChart"></canvas>
          </div>
        </div>
        <div class="card">
          <h3 class="card-title"><i class="fas fa-chart-line"></i> סטטוס פרויקט</h3>
          <div class="chart-container">
            <canvas id="timelineChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Stats -->
      <div class="card">
        <h3 class="card-title"><i class="fas fa-chart-area"></i> מדדים וסטטיסטיקות</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalTasks">0</div>
            <div class="stat-label">סה"כ משימות</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="milestonesCount">0</div>
            <div class="stat-label">אבני דרך</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="activeTasks">0</div>
            <div class="stat-label">משימות פעילות</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="dependenciesCount">0</div>
            <div class="stat-label">קשרי תלות</div>
          </div>
        </div>
      </div>

      <!-- Timeline -->
      <div class="card">
        <div class="timeline-header">
          <h3 class="card-title"><i class="fas fa-calendar-alt"></i> ציר זמן אינטראקטיבי</h3>
          <div class="zoom-controls">
            <button id="zoomOutBtn" title="הקטן">
              <i class="fas fa-search-minus"></i>
            </button>
            <span id="zoomLevel">100%</span>
            <button id="zoomInBtn" title="הגדל">
              <i class="fas fa-search-plus"></i>
            </button>
            <select id="timelineView" class="form-control form-control-sm">
              <option value="week">שבועי</option>
              <option value="month" selected>חודשי</option>
              <option value="quarter">רבעוני</option>
            </select>
          </div>
        </div>
        <div class="timeline-scroll" id="timelineScroll">
          <div id="timelineGrid" class="timeline-grid"></div>
          <svg id="dependencyLayer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
            <defs>
              <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                <polygon points="0 0, 10 3.5, 0 7" fill="#64748b"/>
              </marker>
            </defs>
          </svg>
          <div id="barsContainer" style="position: relative; height: 100%;">
            <!-- Task bars will be rendered here -->
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modals -->
  <!-- GitHub Settings Modal -->
  <div class="modal" id="githubModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fab fa-github"></i> הגדרות GitHub</h2>
        <button class="close-btn" onclick="closeModal('githubModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          <div>
            <strong>הערה חשובה:</strong> יש צורך ב-GitHub Token עם הרשאות repo כדי לעדכן את הקובץ ב-GitHub.
            ניתן ליצור token ב-GitHub > Settings > Developer settings > Personal access tokens
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">GitHub Token</label>
          <input type="password" id="githubToken" class="form-control" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
        </div>
        <div class="form-group">
          <label class="form-label">Repository Owner</label>
          <input type="text" id="repoOwner" class="form-control" placeholder="Amird1976">
        </div>
        <div class="form-group">
          <label class="form-label">Repository Name</label>
          <input type="text" id="repoName" class="form-control" placeholder="GANA_PM">
        </div>
        <div class="form-group">
          <label class="form-label">Branch</label>
          <input type="text" id="repoBranch" class="form-control" value="main" placeholder="main">
        </div>
        <div class="form-group">
          <label class="form-label">נתיב לקובץ CSV</label>
          <input type="text" id="filePath" class="form-control" value="TASK.CSV" placeholder="TASK.CSV">
        </div>
        <div class="form-group">
          <div class="progress-bar">
            <div class="progress-fill" id="uploadProgress" style="width: 0%"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('githubModal')">ביטול</button>
        <button class="btn btn-success" onclick="testGitHubConnection()">
          <i class="fas fa-plug"></i> בדוק חיבור
        </button>
        <button class="btn btn-primary" onclick="saveGitHubSettings()">
          <i class="fas fa-save"></i> שמור הגדרות
        </button>
      </div>
    </div>
  </div>

  <!-- Task Editor Modal -->
  <div class="modal" id="taskModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-edit"></i> עריכת משימה</h2>
        <button class="close-btn" onclick="closeModal('taskModal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="taskForm">
          <div class="form-group">
            <label class="form-label">מספר משימה *</label>
            <input type="text" id="taskId" class="form-control" required>
          </div>
          <div class="form-group">
            <label class="form-label">שם משימה *</label>
            <input type="text" id="taskName" class="form-control" required>
          </div>
          <div class="form-group">
            <label class="form-label">קטגוריה/שלב</label>
            <input type="text" id="taskPhase" class="form-control">
          </div>
          <div class="form-group">
            <label class="form-label">אחראי</label>
            <input type="text" id="taskOwner" class="form-control">
          </div>
          <div class="form-group">
            <label class="form-label">תאריך התחלה</label>
            <input type="date" id="taskStart" class="form-control">
          </div>
          <div class="form-group">
            <label class="form-label">תאריך סיום</label>
            <input type="date" id="taskEnd" class="form-control">
          </div>
          <div class="form-group">
            <label class="form-label">משך (ימים)</label>
            <input type="number" id="taskDuration" class="form-control" min="1" value="1">
          </div>
          <div class="form-group">
            <label class="form-label">תלויות (מסיפים מופרדים בפסיק)</label>
            <input type="text" id="taskDeps" class="form-control" placeholder="1,2,3">
          </div>
          <div class="form-group">
            <label class="form-label">הערות</label>
            <textarea id="taskNotes" class="form-control" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Start Offset (ימים)</label>
            <input type="number" id="taskStartOffset" class="form-control" min="0" value="0">
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="taskMilestone"> אבן דרך
            </label>
          </div>
          <div class="form-group">
            <label class="form-label">סטטוס</label>
            <select id="taskStatus" class="form-control">
              <option value="not-started">לא התחיל</option>
              <option value="in-progress">בתהליך</option>
              <option value="completed">הושלם</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="deleteTask()" id="deleteTaskBtn" style="display: none;">
          <i class="fas fa-trash"></i> מחק
        </button>
        <button class="btn btn-outline" onclick="closeModal('taskModal')">ביטול</button>
        <button class="btn btn-primary" onclick="saveTask()">
          <i class="fas fa-save"></i> שמור משימה
        </button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script>
    // ===== GLOBAL VARIABLES =====
    const STORAGE_KEYS = {
      TASKS: 'gantt_tasks_v3',
      GITHUB_SETTINGS: 'github_settings_v2',
      EDIT_HISTORY: 'edit_history_v2'
    };

    const COLORS = {
      phases: [
        '#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444',
        '#06b6d4', '#84cc16', '#f97316', '#8b5cf6', '#ec4899',
        '#14b8a6', '#f43f5e', '#6366f1'
      ],
      status: {
        'not-started': '#6b7280',
        'in-progress': '#3b82f6',
        'completed': '#10b981'
      }
    };

    let tasks = [];
    let filteredTasks = [];
    let currentZoom = 1.0;
    let selectedTaskId = null;
    let githubSettings = null;
    let chartInstances = {};
    let GH_SHA = null;
    let MIN_DATE = new Date('2026-01-01');
    let MAX_DATE = new Date('2026-12-31');
    let PIXELS_PER_DAY = 20;

    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', function() {
      loadTasks();
      loadGitHubSettings();
      initEventListeners();
      updateDashboard();
      updateGitHubStatus();
      
      // Set up date pickers
      flatpickr('#taskStart', { dateFormat: 'Y-m-d', locale: 'he' });
      flatpickr('#taskEnd', { dateFormat: 'Y-m-d', locale: 'he' });
      
      // Auto-load from GitHub if settings exist
      if (githubSettings && githubSettings.token) {
        setTimeout(() => {
          loadFromGitHub();
        }, 1000);
      }
    });

    // ===== TASK MANAGEMENT =====
    function loadTasks() {
      const saved = localStorage.getItem(STORAGE_KEYS.TASKS);
      if (saved) {
        tasks = JSON.parse(saved);
      } else {
        // Load from default if available
        loadDefaultTasks();
      }
      filteredTasks = [...tasks];
    }

    function saveTasks() {
      localStorage.setItem(STORAGE_KEYS.TASKS, JSON.stringify(tasks));
      updateDashboard();
    }

    function loadDefaultTasks() {
      // Default tasks for initial view
      tasks = [
        {
          id: '1',
          name: 'פתיחת פרויקט וניהול',
          phase: '1. Management',
          owner: 'צוות יעוץ',
          start: '2026-01-05',
          end: '2026-02-04',
          duration: 30,
          deps: '',
          notes: '',
          milestone: false,
          status: 'not-started',
          startOffset: 0
        }
      ];
    }

    // ===== GITHUB INTEGRATION =====
    function loadGitHubSettings() {
      const saved = localStorage.getItem(STORAGE_KEYS.GITHUB_SETTINGS);
      if (saved) {
        githubSettings = JSON.parse(saved);
        // Update modal fields
        document.getElementById('githubToken').value = githubSettings.token || '';
        document.getElementById('repoOwner').value = githubSettings.owner || '';
        document.getElementById('repoName').value = githubSettings.repo || '';
        document.getElementById('repoBranch').value = githubSettings.branch || 'main';
        document.getElementById('filePath').value = githubSettings.filePath || 'TASK.CSV';
      }
    }

    async function saveGitHubSettings() {
      const settings = {
        token: document.getElementById('githubToken').value.trim(),
        owner: document.getElementById('repoOwner').value.trim(),
        repo: document.getElementById('repoName').value.trim(),
        branch: document.getElementById('repoBranch').value.trim() || 'main',
        filePath: document.getElementById('filePath').value.trim() || 'TASK.CSV'
      };
      
      if (!settings.token || !settings.owner || !settings.repo) {
        showToast('נא למלא את כל שדות החובה', 'error');
        return;
      }

      localStorage.setItem(STORAGE_KEYS.GITHUB_SETTINGS, JSON.stringify(settings));
      githubSettings = settings;
      closeModal('githubModal');
      updateGitHubStatus();
      showToast('הגדרות GitHub נשמרו בהצלחה', 'success');
    }

    async function loadFromGitHub() {
      if (!githubSettings) {
        showToast('נא להגדיר את פרטי GitHub תחילה', 'warning');
        document.getElementById('settingsBtn').click();
        return;
      }

      try {
        showToast('טוען נתונים מ-GitHub...', 'info');
        
        const { token, owner, repo, branch, filePath } = githubSettings;
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${filePath}?ref=${branch}`;
        
        const response = await fetch(url, {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });

        if (!response.ok) {
          throw new Error(`שגיאה ${response.status}: לא ניתן לטעון את הקובץ`);
        }

        const data = await response.json();
        GH_SHA = data.sha;
        
        // Decode base64 content with proper Hebrew encoding
        const content = decodeBase64(data.content);
        
        // Parse CSV with Hebrew headers
        const parsedTasks = parseCSVWithHebrewHeaders(content);
        
        if (parsedTasks && parsedTasks.length > 0) {
          tasks = parsedTasks;
          saveTasks();
          showToast(`נטענו ${tasks.length} משימות בהצלחה מ-GitHub!`, 'success');
          updateGitHubStatus('connected', `מחובר - ${tasks.length} משימות`);
        } else {
          showToast('הקובץ ריק או בפורמט לא תקין', 'warning');
        }
        
      } catch (error) {
        console.error('שגיאה בטעינת נתונים:', error);
        showToast(`שגיאה בטעינת נתונים: ${error.message}`, 'error');
      }
    }

    async function saveToGitHub() {
      if (!githubSettings) {
        showToast('נא להגדיר את פרטי GitHub תחילה', 'warning');
        document.getElementById('settingsBtn').click();
        return;
      }

      try {
        showToast('שומר ל-GitHub...', 'info');
        
        // First, get current SHA if we don't have it
        if (!GH_SHA) {
          await getCurrentSHA();
        }
        
        // Convert tasks to CSV format
        const csvContent = convertToCSV();
        const encodedContent = btoa(unescape(encodeURIComponent(csvContent)));
        
        const { token, owner, repo, branch, filePath } = githubSettings;
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`;
        
        const payload = {
          message: `Gantt Update: ${new Date().toLocaleString('he-IL')}`,
          content: encodedContent,
          branch: branch
        };
        
        if (GH_SHA) {
          payload.sha = GH_SHA;
        }
        
        const response = await fetch(url, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          const result = await response.json();
          GH_SHA = result.content.sha;
          showToast('הנתונים נשמרו בהצלחה ל-GitHub!', 'success');
          updateGitHubStatus('connected', 'מחובר ומעודכן');
        } else {
          const errorData = await response.json();
          throw new Error(errorData.message || 'שגיאה בשמירה ל-GitHub');
        }
        
      } catch (error) {
        console.error('שגיאה בשמירה ל-GitHub:', error);
        showToast(`שגיאה בשמירה: ${error.message}`, 'error');
      }
    }

    async function getCurrentSHA() {
      if (!githubSettings) return;
      
      try {
        const { token, owner, repo, branch, filePath } = githubSettings;
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${filePath}?ref=${branch}`;
        
        const response = await fetch(url, {
          headers: {
            'Authorization': `token ${token}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          GH_SHA = data.sha;
        }
      } catch (error) {
        console.log('לא ניתן לקבל SHA נוכחי, יוצר קובץ חדש');
      }
    }

    async function testGitHubConnection() {
      const token = document.getElementById('githubToken').value.trim();
      const owner = document.getElementById('repoOwner').value.trim();
      const repo = document.getElementById('repoName').value.trim();
      
      if (!token || !owner || !repo) {
        showToast('נא למלא את כל השדות הדרושים', 'error');
        return;
      }
      
      try {
        showToast('בודק חיבור ל-GitHub...', 'info');
        
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}`, {
          headers: {
            'Authorization': `token ${token}`
          }
        });
        
        if (response.ok) {
          showToast('החיבור ל-GitHub עובד בהצלחה!', 'success');
        } else {
          throw new Error('לא ניתן להתחבר ל-Repository');
        }
      } catch (error) {
        showToast(`שגיאה בחיבור: ${error.message}`, 'error');
      }
    }

    // ===== CSV PARSING AND GENERATION =====
    function decodeBase64(base64) {
      try {
        // Remove BOM if present
        const binary = atob(base64);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
          bytes[i] = binary.charCodeAt(i);
        }
        return new TextDecoder('utf-8').decode(bytes);
      } catch (e) {
        // Fallback for older browsers
        return decodeURIComponent(escape(atob(base64)));
      }
    }

    function parseCSVWithHebrewHeaders(csvText) {
      // Remove BOM if present
      if (csvText.charCodeAt(0) === 0xFEFF) {
        csvText = csvText.substring(1);
      }
      
      const lines = csvText.split('\n').filter(line => line.trim() !== '');
      if (lines.length < 2) return [];
      
      // Parse headers (first line)
      const headers = parseCSVLine(lines[0]).map(h => h.trim());
      
      // Map Hebrew headers to English field names
      const headerMap = {
        'מזהה': 'id',
        'קטגוריה/שלב': 'phase',
        'שם משימה': 'name',
        'אחראי': 'owner',
        'תאריך התחלה': 'start',
        'תאריך סיום': 'end',
        'משך (ימים)': 'duration',
        'תלויות': 'deps',
        'הערות': 'notes',
        'startOffset': 'startOffset',
        'milestone': 'milestone'
      };
      
      const tasks = [];
      
      for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        if (values.length < 5) continue;
        
        const task = {
          id: '',
          name: '',
          phase: '',
          owner: '',
          start: '',
          end: '',
          duration: 1,
          deps: '',
          notes: '',
          startOffset: 0,
          milestone: false,
          status: 'not-started'
        };
        
        // Map values based on headers
        headers.forEach((header, index) => {
          const fieldName = headerMap[header] || header;
          if (task.hasOwnProperty(fieldName)) {
            const value = values[index] || '';
            task[fieldName] = value.trim();
          }
        });
        
        // Convert numeric fields
        task.duration = parseInt(task.duration) || 1;
        task.startOffset = parseInt(task.startOffset) || 0;
        task.milestone = task.milestone === 'true' || task.milestone === '1' || task.milestone === 'yes';
        
        // Calculate dates if not provided
        if (!task.start && task.startOffset !== undefined) {
          const startDate = new Date('2026-01-05');
          startDate.setDate(startDate.getDate() + task.startOffset);
          task.start = formatDate(startDate);
        }
        
        if (!task.end && task.start && task.duration) {
          const endDate = new Date(task.start);
          endDate.setDate(endDate.getDate() + task.duration - 1);
          task.end = formatDate(endDate);
        }
        
        tasks.push(task);
      }
      
      return tasks;
    }

    function parseCSVLine(line) {
      const values = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          values.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      
      values.push(current);
      return values;
    }

    function convertToCSV() {
      const headers = ['מזהה', 'קטגוריה/שלב', 'שם משימה', 'אחראי', 'תאריך התחלה', 'תאריך סיום', 'משך (ימים)', 'תלויות', 'הערות', 'startOffset', 'milestone'];
      
      const escapeCSV = (value) => {
        if (value === null || value === undefined) return '';
        const stringValue = String(value);
        if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
          return '"' + stringValue.replace(/"/g, '""') + '"';
        }
        return stringValue;
      };
      
      const rows = tasks.map(task => [
        task.id,
        task.phase,
        task.name,
        task.owner,
        task.start,
        task.end,
        task.duration,
        task.deps,
        task.notes || '',
        task.startOffset || 0,
        task.milestone ? 'true' : ''
      ].map(escapeCSV).join(','));
      
      return [headers.join(','), ...rows].join('\n');
    }

    // ===== UI FUNCTIONS =====
    function updateGitHubStatus(status = 'disconnected', message = '') {
      const statusEl = document.getElementById('githubStatus');
      statusEl.className = 'github-status';
      
      if (githubSettings && githubSettings.token) {
        statusEl.classList.add('connected');
        statusEl.innerHTML = `
          <i class="fab fa-github"></i>
          <span>${message || `מחובר ל-${githubSettings.owner}/${githubSettings.repo}`}</span>
        `;
      } else {
        statusEl.innerHTML = `
          <i class="fab fa-github"></i>
          <span>לא מחובר ל-GitHub</span>
        `;
      }
    }

    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast alert-${type}`;
      
      const icon = type === 'success' ? 'check-circle' :
                   type === 'error' ? 'exclamation-circle' :
                   type === 'warning' ? 'exclamation-triangle' : 'info-circle';
      
      toast.innerHTML = `
        <i class="fas fa-${icon}"></i>
        <div>${message}</div>
        <button class="close-btn" onclick="this.parentElement.remove()">&times;</button>
      `;
      
      toastContainer.appendChild(toast);
      
      setTimeout(() => {
        if (toast.parentElement) {
          toast.remove();
        }
      }, 5000);
    }

    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // ===== EVENT LISTENERS =====
    function initEventListeners() {
      // GitHub buttons
      document.getElementById('settingsBtn').addEventListener('click', () => {
        openModal('githubModal');
      });

      document.getElementById('loadFromGitHubBtn').addEventListener('click', loadFromGitHub);
      document.getElementById('saveToGitHubBtn').addEventListener('click', saveToGitHub);

      // Search and filter
      document.getElementById('searchInput').addEventListener('input', filterTasks);
      document.getElementById('categoryFilter').addEventListener('change', filterTasks);
      document.getElementById('ownerFilter').addEventListener('change', filterTasks);
      document.getElementById('statusFilter').addEventListener('change', filterTasks);

      // Task actions
      document.getElementById('addTaskBtn').addEventListener('click', addNewTask);
      document.getElementById('exportBtn').addEventListener('click', exportToCSV);
      document.getElementById('printBtn').addEventListener('click', printView);

      // Timeline controls
      document.getElementById('zoomInBtn').addEventListener('click', () => changeZoom(0.1));
      document.getElementById('zoomOutBtn').addEventListener('click', () => changeZoom(-0.1));
      document.getElementById('timelineView').addEventListener('change', renderTimeline);
    }

    // ===== TASK FILTERING =====
    function filterTasks() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const category = document.getElementById('categoryFilter').value;
      const owner = document.getElementById('ownerFilter').value;
      const status = document.getElementById('statusFilter').value;

      filteredTasks = tasks.filter(task => {
        // Search term
        if (searchTerm && !(
          (task.name || '').toLowerCase().includes(searchTerm) ||
          (task.phase || '').toLowerCase().includes(searchTerm) ||
          (task.owner || '').toLowerCase().includes(searchTerm) ||
          (task.id || '').toLowerCase().includes(searchTerm)
        )) {
          return false;
        }

        // Category filter
        if (category && task.phase !== category) {
          return false;
        }

        // Owner filter
        if (owner && task.owner !== owner) {
          return false;
        }

        // Status filter
        if (status && task.status !== status) {
          return false;
        }

        return true;
      });

      renderTaskList();
      renderTimeline();
      updateCharts();
    }

    // ===== TASK CRUD OPERATIONS =====
    function addNewTask() {
      selectedTaskId = null;
      document.getElementById('taskForm').reset();
      document.getElementById('deleteTaskBtn').style.display = 'none';
      
      // Set default dates
      const today = new Date();
      document.getElementById('taskStart').value = formatDate(today);
      const endDate = new Date(today);
      endDate.setDate(endDate.getDate() + 30);
      document.getElementById('taskEnd').value = formatDate(endDate);
      
      openModal('taskModal');
    }

    function editTask(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;

      selectedTaskId = taskId;
      
      // Fill form
      document.getElementById('taskId').value = task.id;
      document.getElementById('taskName').value = task.name;
      document.getElementById('taskPhase').value = task.phase;
      document.getElementById('taskOwner').value = task.owner;
      document.getElementById('taskStart').value = task.start;
      document.getElementById('taskEnd').value = task.end;
      document.getElementById('taskDuration').value = task.duration;
      document.getElementById('taskDeps').value = task.deps;
      document.getElementById('taskNotes').value = task.notes || '';
      document.getElementById('taskStartOffset').value = task.startOffset || 0;
      document.getElementById('taskMilestone').checked = task.milestone;
      document.getElementById('taskStatus').value = task.status || 'not-started';
      
      document.getElementById('deleteTaskBtn').style.display = 'block';
      openModal('taskModal');
    }

    function saveTask() {
      const form = document.getElementById('taskForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const taskData = {
        id: document.getElementById('taskId').value.trim(),
        name: document.getElementById('taskName').value.trim(),
        phase: document.getElementById('taskPhase').value.trim(),
        owner: document.getElementById('taskOwner').value.trim(),
        start: document.getElementById('taskStart').value,
        end: document.getElementById('taskEnd').value,
        duration: parseInt(document.getElementById('taskDuration').value) || 1,
        deps: document.getElementById('taskDeps').value.trim(),
        notes: document.getElementById('taskNotes').value.trim(),
        startOffset: parseInt(document.getElementById('taskStartOffset').value) || 0,
        milestone: document.getElementById('taskMilestone').checked,
        status: document.getElementById('taskStatus').value
      };

      // Calculate duration from dates if provided
      if (taskData.start && taskData.end) {
        const startDate = new Date(taskData.start);
        const endDate = new Date(taskData.end);
        const diffTime = Math.abs(endDate - startDate);
        taskData.duration = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
      }

      if (selectedTaskId) {
        // Update existing task
        const index = tasks.findIndex(t => t.id === selectedTaskId);
        if (index !== -1) {
          tasks[index] = { ...tasks[index], ...taskData };
        }
      } else {
        // Add new task
        tasks.push(taskData);
      }

      saveTasks();
      closeModal('taskModal');
      showToast('המשימה נשמרה בהצלחה', 'success');
    }

    function deleteTask() {
      if (!selectedTaskId || !confirm('האם אתה בטוח שברצונך למחוק משימה זו?')) {
        return;
      }

      tasks = tasks.filter(t => t.id !== selectedTaskId);
      saveTasks();
      closeModal('taskModal');
      showToast('המשימה נמחקה בהצלחה', 'success');
    }

    // ===== RENDERING FUNCTIONS =====
    function renderTaskList() {
      const taskList = document.getElementById('taskList');
      taskList.innerHTML = '';

      filteredTasks.forEach(task => {
        const taskItem = document.createElement('div');
        taskItem.className = `task-item ${selectedTaskId === task.id ? 'selected' : ''}`;
        taskItem.onclick = () => editTask(task.id);
        
        const statusColor = COLORS.status[task.status] || '#6b7280';
        
        taskItem.innerHTML = `
          <div class="task-info">
            <h4>${task.name}</h4>
            <div class="task-meta">
              <span><i class="fas fa-user"></i> ${task.owner}</span>
              <span><i class="fas fa-layer-group"></i> ${task.phase}</span>
              <span><i class="fas fa-calendar"></i> ${formatDisplayDate(task.start)}</span>
              ${task.milestone ? '<span><i class="fas fa-gem" style="color: #8b5cf6;"></i> אבן דרך</span>' : ''}
            </div>
          </div>
          <div class="task-actions">
            <span style="color: ${statusColor};"><i class="fas fa-circle" style="font-size: 0.7rem;"></i></span>
            <i class="fas fa-edit" style="color: #6b7280;"></i>
          </div>
        `;
        
        taskList.appendChild(taskItem);
      });

      updateFilterOptions();
      updateLegend();
    }

    function renderTimeline() {
      const timelineScroll = document.getElementById('timelineScroll');
      const timelineGrid = document.getElementById('timelineGrid');
      const barsContainer = document.getElementById('barsContainer');
      
      // Clear previous content
      timelineGrid.innerHTML = '';
      barsContainer.innerHTML = '';
      
      // Calculate date range
      const allDates = tasks.flatMap(t => [new Date(t.start), new Date(t.end)]);
      const minDate = new Date(Math.min(...allDates.map(d => d.getTime())));
      const maxDate = new Date(Math.max(...allDates.map(d => d.getTime())));
      
      // Add some padding
      minDate.setDate(minDate.getDate() - 7);
      maxDate.setDate(maxDate.getDate() + 7);
      
      // Calculate total days
      const totalDays = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24));
      
      // Set container width
      const containerWidth = totalDays * PIXELS_PER_DAY * currentZoom;
      timelineScroll.style.minWidth = containerWidth + 'px';
      
      // Create grid
      for (let i = 0; i <= totalDays; i++) {
        const currentDate = new Date(minDate);
        currentDate.setDate(currentDate.getDate() + i);
        
        const dayDiv = document.createElement('div');
        dayDiv.className = 'timeline-day';
        dayDiv.style.width = (PIXELS_PER_DAY * currentZoom) + 'px';
        
        if (currentDate.getDate() === 1) {
          dayDiv.classList.add('month-start');
        }
        
        // Add label for first day of month or every 7 days
        if (currentDate.getDate() === 1 || i % 7 === 0) {
          const label = document.createElement('div');
          label.className = 'timeline-day-label';
          label.textContent = formatDisplayDate(currentDate);
          dayDiv.appendChild(label);
        }
        
        timelineGrid.appendChild(dayDiv);
      }
      
      // Render task bars
      filteredTasks.forEach((task, index) => {
        const taskStart = new Date(task.start);
        const taskEnd = new Date(task.end);
        const daysFromStart = Math.floor((taskStart - minDate) / (1000 * 60 * 60 * 24));
        const taskDuration = Math.max(1, Math.ceil((taskEnd - taskStart) / (1000 * 60 * 60 * 24)) + 1);
        
        const taskBar = document.createElement('div');
        taskBar.className = `task-bar ${task.milestone ? 'milestone' : ''}`;
        taskBar.dataset.id = task.id;
        taskBar.dataset.index = index;
        
        // Get color based on phase
        const phaseColor = getPhaseColor(task.phase);
        taskBar.style.backgroundColor = phaseColor;
        
        // Position and size
        const left = daysFromStart * PIXELS_PER_DAY * currentZoom;
        const width = taskDuration * PIXELS_PER_DAY * currentZoom;
        
        taskBar.style.left = left + 'px';
        taskBar.style.width = width + 'px';
        taskBar.style.top = (index * 40) + 'px';
        
        // Add handles for non-milestone tasks
        if (!task.milestone) {
          const handleLeft = document.createElement('div');
          handleLeft.className = 'task-handle-left';
          handleLeft.style.backgroundColor = phaseColor;
          handleLeft.dataset.handle = 'left';
          
          const handleRight = document.createElement('div');
          handleRight.className = 'task-handle-right';
          handleRight.style.backgroundColor = phaseColor;
          handleRight.dataset.handle = 'right';
          
          taskBar.appendChild(handleLeft);
          taskBar.appendChild(handleRight);
          
          // Add drag listeners
          makeDraggable(taskBar, task);
        }
        
        // Add content
        const label = document.createElement('div');
        label.className = 'task-label';
        label.innerHTML = `<span class="task-id">${task.id}</span> ${task.name}`;
        taskBar.appendChild(label);
        
        // Add click listener
        taskBar.addEventListener('click', (e) => {
          if (!e.target.classList.contains('task-handle-left') && 
              !e.target.classList.contains('task-handle-right')) {
            editTask(task.id);
          }
        });
        
        // Add tooltip
        taskBar.title = `${task.name}\nקטגוריה: ${task.phase}\nאחראי: ${task.owner}\nתאריך: ${task.start} - ${task.end}\nמשך: ${task.duration} ימים`;
        
        barsContainer.appendChild(taskBar);
      });
      
      // Render dependency lines
      renderDependencies(minDate);
    }

    function makeDraggable(taskBar, task) {
      let isDragging = false;
      let dragType = '';
      let startX = 0;
      let startLeft = 0;
      let startWidth = 0;
      
      const handles = taskBar.querySelectorAll('.task-handle-left, .task-handle-right');
      
      handles.forEach(handle => {
        handle.addEventListener('mousedown', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          isDragging = true;
          dragType = e.target.dataset.handle;
          startX = e.clientX;
          startLeft = parseFloat(taskBar.style.left);
          startWidth = parseFloat(taskBar.style.width);
          
          taskBar.classList.add('dragging');
          
          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        });
      });
      
      function onMouseMove(e) {
        if (!isDragging) return;
        
        const deltaX = e.clientX - startX;
        const deltaDays = Math.round(deltaX / (PIXELS_PER_DAY * currentZoom));
        
        const taskIndex = tasks.findIndex(t => t.id === task.id);
        if (taskIndex === -1) return;
        
        if (dragType === 'left') {
          // Resize from left
          const newStartOffset = Math.max(0, task.startOffset + deltaDays);
          const newDuration = Math.max(1, task.duration - deltaDays);
          
          if (newDuration >= 1) {
            tasks[taskIndex].startOffset = newStartOffset;
            tasks[taskIndex].duration = newDuration;
            
            // Update date
            const startDate = new Date('2026-01-05');
            startDate.setDate(startDate.getDate() + newStartOffset);
            tasks[taskIndex].start = formatDate(startDate);
            
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + newDuration - 1);
            tasks[taskIndex].end = formatDate(endDate);
          }
        } else if (dragType === 'right') {
          // Resize from right
          const newDuration = Math.max(1, task.duration + deltaDays);
          tasks[taskIndex].duration = newDuration;
          
          const endDate = new Date(task.start);
          endDate.setDate(endDate.getDate() + newDuration - 1);
          tasks[taskIndex].end = formatDate(endDate);
        }
        
        saveTasks();
        renderTimeline();
      }
      
      function onMouseUp() {
        isDragging = false;
        taskBar.classList.remove('dragging');
        
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
      }
    }

    function renderDependencies(minDate) {
      const svg = document.getElementById('dependencyLayer');
      // Clear previous lines
      svg.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#64748b"/></marker></defs>';
      
      filteredTasks.forEach(task => {
        if (!task.deps) return;
        
        const deps = task.deps.split(',').map(d => d.trim()).filter(d => d !== '');
        
        deps.forEach(depId => {
          const sourceTask = filteredTasks.find(t => t.id === depId);
          const targetTask = task;
          
          if (!sourceTask || !targetTask) return;
          
          // Find indices
          const sourceIndex = filteredTasks.findIndex(t => t.id === depId);
          const targetIndex = filteredTasks.findIndex(t => t.id === task.id);
          
          if (sourceIndex === -1 || targetIndex === -1) return;
          
          // Calculate positions
          const sourceStart = new Date(sourceTask.start);
          const sourceEnd = new Date(sourceTask.end);
          const targetStart = new Date(targetTask.start);
          
          const sourceDaysFromStart = Math.floor((sourceEnd - minDate) / (1000 * 60 * 60 * 24));
          const targetDaysFromStart = Math.floor((targetStart - minDate) / (1000 * 60 * 60 * 24));
          
          const x1 = sourceDaysFromStart * PIXELS_PER_DAY * currentZoom;
          const x2 = targetDaysFromStart * PIXELS_PER_DAY * currentZoom;
          const y1 = sourceIndex * 40 + 20;
          const y2 = targetIndex * 40 + 20;
          
          // Create line
          const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          line.setAttribute('class', 'dependency-line');
          line.setAttribute('x1', x1);
          line.setAttribute('y1', y1);
          line.setAttribute('x2', x2);
          line.setAttribute('y2', y2);
          line.setAttribute('marker-end', 'url(#arrowhead)');
          
          svg.appendChild(line);
        });
      });
    }

    function updateCharts() {
      // Category chart
      const categoryData = groupByPhase();
      const categoryCtx = document.getElementById('categoryChart').getContext('2d');
      
      if (chartInstances.categoryChart) {
        chartInstances.categoryChart.destroy();
      }
      
      chartInstances.categoryChart = new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
          labels: categoryData.labels,
          datasets: [{
            data: categoryData.values,
            backgroundColor: categoryData.colors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              rtl: true
            }
          }
        }
      });
      
      // Owner chart
      const ownerData = groupByOwner();
      const ownerCtx = document.getElementById('ownerChart').getContext('2d');
      
      if (chartInstances.ownerChart) {
        chartInstances.ownerChart.destroy();
      }
      
      chartInstances.ownerChart = new Chart(ownerCtx, {
        type: 'bar',
        data: {
          labels: ownerData.labels,
          datasets: [{
            label: 'מספר משימות',
            data: ownerData.values,
            backgroundColor: '#3b82f6',
            borderColor: '#1d4ed8',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
      
      // Timeline chart
      updateTimelineChart();
    }

    function updateTimelineChart() {
      // This is a simplified timeline chart - you can enhance it
      const timelineCtx = document.getElementById('timelineChart').getContext('2d');
      
      if (chartInstances.timelineChart) {
        chartInstances.timelineChart.destroy();
      }
      
      // Group tasks by month
      const monthlyData = {};
      tasks.forEach(task => {
        if (!task.start) return;
        const month = task.start.substring(0, 7); // YYYY-MM
        monthlyData[month] = (monthlyData[month] || 0) + 1;
      });
      
      const months = Object.keys(monthlyData).sort();
      const counts = months.map(month => monthlyData[month]);
      
      chartInstances.timelineChart = new Chart(timelineCtx, {
        type: 'line',
        data: {
          labels: months,
          datasets: [{
            label: 'משימות לפי חודש',
            data: counts,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }

    // ===== UTILITY FUNCTIONS =====
    function groupByPhase() {
      const groups = {};
      tasks.forEach(task => {
        const phase = task.phase || 'ללא קטגוריה';
        groups[phase] = (groups[phase] || 0) + 1;
      });
      
      const sorted = Object.entries(groups).sort((a, b) => b[1] - a[1]);
      
      return {
        labels: sorted.map(([phase]) => phase),
        values: sorted.map(([, count]) => count),
        colors: sorted.map(([phase]) => getPhaseColor(phase))
      };
    }

    function groupByOwner() {
      const groups = {};
      tasks.forEach(task => {
        const owner = task.owner || 'ללא אחראי';
        groups[owner] = (groups[owner] || 0) + 1;
      });
      
      const sorted = Object.entries(groups).sort((a, b) => b[1] - a[1]).slice(0, 10);
      
      return {
        labels: sorted.map(([owner]) => owner),
        values: sorted.map(([, count]) => count)
      };
    }

    function getPhaseColor(phase) {
      if (!phase) return '#6b7280';
      
      // Extract phase number
      const match = phase.match(/^(\d+)/);
      if (match) {
        const phaseNum = parseInt(match[1]);
        return COLORS.phases[(phaseNum - 1) % COLORS.phases.length];
      }
      
      // Hash for other phases
      let hash = 0;
      for (let i = 0; i < phase.length; i++) {
        hash = phase.charCodeAt(i) + ((hash << 5) - hash);
      }
      return COLORS.phases[Math.abs(hash) % COLORS.phases.length];
    }

    function updateFilterOptions() {
      // Update category filter
      const categoryFilter = document.getElementById('categoryFilter');
      const categories = Array.from(new Set(tasks.map(t => t.phase).filter(p => p))).sort();
      
      categoryFilter.innerHTML = '<option value="">כל הקטגוריות</option>';
      categories.forEach(cat => {
        categoryFilter.innerHTML += `<option value="${cat}">${cat}</option>`;
      });

      // Update owner filter
      const ownerFilter = document.getElementById('ownerFilter');
      const owners = Array.from(new Set(tasks.map(t => t.owner).filter(o => o))).sort();
      
      ownerFilter.innerHTML = '<option value="">כל האחראים</option>';
      owners.forEach(owner => {
        ownerFilter.innerHTML += `<option value="${owner}">${owner}</option>`;
      });
    }

    function updateLegend() {
      const legend = document.getElementById('phaseLegend');
      const phases = Array.from(new Set(tasks.map(t => t.phase).filter(p => p))).sort();
      
      legend.innerHTML = '';
      phases.forEach((phase, index) => {
        const item = document.createElement('div');
        item.className = 'legend-item';
        item.innerHTML = `
          <div class="legend-color" style="background-color: ${getPhaseColor(phase)}"></div>
          <span>${phase}</span>
        `;
        legend.appendChild(item);
      });
    }

    function changeZoom(delta) {
      currentZoom = Math.max(0.5, Math.min(3, currentZoom + delta));
      document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
      renderTimeline();
    }

    function formatDate(date) {
      if (!date) return '';
      const d = new Date(date);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function formatDisplayDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' });
    }

    function exportToCSV() {
      const csvContent = convertToCSV();
      const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `tasks_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('הקובץ יוצא בהצלחה', 'success');
    }

    function printView() {
      window.print();
    }

    function updateDashboard() {
      // Update stats
      document.getElementById('totalTasks').textContent = tasks.length;
      document.getElementById('milestonesCount').textContent = tasks.filter(t => t.milestone).length;
      document.getElementById('activeTasks').textContent = tasks.filter(t => t.status === 'in-progress').length;
      
      // Count dependencies
      const depsCount = tasks.reduce((acc, task) => {
        if (!task.deps) return acc;
        const deps = task.deps.split(',').filter(d => d.trim() !== '');
        return acc + deps.length;
      }, 0);
      document.getElementById('dependenciesCount').textContent = depsCount;

      // Render everything
      renderTaskList();
      renderTimeline();
      updateCharts();
    }

    // Initial render
    updateDashboard();
  </script>
</body>
</html>
