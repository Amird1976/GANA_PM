<!doctype html>
<html lang="he">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gantt – Ghana Energy CERT (v23)</title>
<style>
  :root{
    --bg:#f6f7fb;
    --fg:#111827;
    --muted:#6b7280;
    --card:#ffffff;
    --bd:#e5e7eb;
    --bd2:#eef2f7;
    --pri:#111827;
    --pri2:#0b1220;
    --ok:#16a34a;
    --warn:#f59e0b;
    --bad:#dc2626;
    --shadow:0 1px 2px rgba(0,0,0,.05);
    --r12:12px;
    --r14:14px;
    --r16:16px;
  }

  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--fg)}
  header{padding:16px 18px;background:var(--pri);color:#fff}
  header h1{margin:0;font-size:16px;font-weight:900;direction:rtl;text-align:right}
  header .meta{margin-top:6px;font-size:12.5px;opacity:.92;direction:rtl;text-align:right;line-height:1.35}
  .wrap{padding:14px 16px;display:flex;flex-direction:column;gap:12px}

  .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;box-shadow:var(--shadow)}
  .toolbar{padding:10px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
  .tb-left,.tb-right{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .field{display:flex;gap:8px;align-items:center}
  .label{font-size:12px;color:var(--muted);direction:rtl;text-align:right;white-space:nowrap}
  input,select,button,textarea{
    font:inherit;
    border:1px solid #d1d5db;
    background:#fff;
    border-radius:12px;
    padding:10px 12px;
    font-size:14px;
    outline:none;
  }
  input:focus,select:focus,textarea:focus{border-color:#94a3b8;box-shadow:0 0 0 3px rgba(148,163,184,.18)}
  button{cursor:pointer;user-select:none}
  .btn-primary{background:var(--pri);color:#fff;border-color:var(--pri)}
  .btn-primary:hover{background:var(--pri2)}
  .btn{background:#fff;color:var(--fg)}
  .btn:hover{background:#f9fafb}
  .btn-danger{background:#fff;color:var(--bad);border-color:#fecaca}
  .btn-danger:hover{background:#fff5f5}
  .btn-ghost{background:transparent;border-color:transparent}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:7px 10px;border-radius:999px;border:1px solid var(--bd);background:#fff;font-size:12px;color:#374151}
  .dot{width:8px;height:8px;border-radius:999px;background:#9ca3af}
  .dot.ok{background:var(--ok)}
  .dot.warn{background:var(--warn)}
  .dot.bad{background:var(--bad)}
  .sep{width:1px;height:26px;background:var(--bd);margin:0 4px}

  /* Dropdown menus */
  .dd{position:relative}
  .dd > button{display:flex;align-items:center;gap:8px}
  .menu{
    position:absolute;top:44px;right:0;
    width:min(320px, 90vw);
    background:#fff;border:1px solid var(--bd);
    border-radius:14px;box-shadow:0 10px 25px rgba(0,0,0,.12);
    padding:8px;display:none;z-index:50;
  }
  .menu.open{display:block}
  .menu .mi{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 10px;border-radius:12px}
  .menu .mi:hover{background:#f9fafb}
  .menu .mi small{color:var(--muted)}
  .menu hr{border:none;border-top:1px solid var(--bd);margin:6px 0}
  .menu .mi .k{font-weight:800}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:11px;color:#374151;border:1px solid var(--bd);padding:2px 6px;border-radius:8px;background:#fff}

  /* Legend panel (collapsed by default) */
  .legendPanel{padding:10px;display:none}
  .legendPanel.open{display:block}
  .legendHead{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px}
  .legendList{
    display:flex;flex-wrap:wrap;gap:8px;
    max-height:120px;overflow:auto;padding:6px;
    border:1px dashed #cbd5e1;border-radius:12px;background:#fff;
  }
  .lg-item{display:flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--bd);border-radius:999px;background:#fff;font-size:12px}
  .sw{width:12px;height:12px;border-radius:4px}

  /* Dash */
  .dash{display:grid;grid-template-columns:repeat(3,minmax(220px,1fr));gap:12px}
  .chart-card{padding:12px}
  .chart-title{font-weight:900;font-size:13px;margin:0 0 8px 0;direction:rtl;text-align:right}
  canvas{width:100%;height:160px;display:block}
  .chart-legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;direction:ltr}
  .chart-legend .it{display:flex;gap:6px;align-items:center;font-size:12px;color:#374151}
  .chart-legend .dot2{width:10px;height:10px;border-radius:3px;display:inline-block}

  /* Gantt grid */
  .gantt{padding:0}
  .grid{display:grid;grid-template-columns: 540px 1fr;min-height:520px}
  .left{
    border-right:1px solid var(--bd);
    overflow:auto;
  }
  .right{
    overflow:auto;
    position:relative;
  }
  .row{display:flex;gap:10px;align-items:center;padding:8px 10px;border-bottom:1px solid #f1f5f9}
  .row:nth-child(odd){background:#fafafa}
  .row .title{flex:1;direction:rtl;text-align:right;font-size:13px;line-height:1.2}
  .row .meta{font-size:12px;color:#374151;white-space:nowrap}
  .stickyHead{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--bd)}
  .timeline{position:sticky;top:0;z-index:5;min-height:40px;border-bottom:1px solid var(--bd);background:#fff}
  .ticks{display:flex;position:relative}
  .tick{border-right:1px solid var(--bd2);padding:8px 6px;font-size:12px;color:#374151;white-space:nowrap}
  .bar-area{position:relative}
  .bar-row{position:relative;height:34px;border-bottom:1px solid #f1f5f9}
  .bar{position:absolute;top:7px;height:20px;border-radius:10px;background:#2563eb;cursor:grab;box-shadow:0 1px 1px rgba(0,0,0,.08)}
  .bar.dragging{cursor:grabbing;opacity:.9}
  .bar .label{position:absolute;left:10px;right:10px;top:2px;font-size:10px;line-height:1;color:#fff;opacity:.95;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;pointer-events:none}
  .bar .deps{position:absolute;left:10px;right:10px;bottom:2px;font-size:10px;line-height:1;color:#fff;opacity:.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;pointer-events:none}
  .handle{position:absolute;top:0;width:10px;height:20px;opacity:.0;}
  .bar:hover .handle{opacity:.35;}
  .handle.left{left:0;border-top-left-radius:10px;border-bottom-left-radius:10px;background:#0b3ea8;cursor:ew-resize}
  .handle.right{right:0;border-top-right-radius:10px;border-bottom-right-radius:10px;background:#0b3ea8;cursor:ew-resize}
  .dep-layer{position:absolute;left:0;top:0;pointer-events:none;overflow:visible}
  .hint{padding:10px 12px;font-size:12px;color:#374151;direction:rtl;text-align:right}

  /* Footer/version */
  .footer{padding:8px 10px;font-size:12px;color:var(--muted);direction:rtl;text-align:right}

  /* Scrollbar styling (nice but optional) */
  *::-webkit-scrollbar{height:10px;width:10px}
  *::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:999px;border:2px solid #f8fafc}
  *::-webkit-scrollbar-track{background:#f8fafc;border-radius:999px}

  /* Modals */
  .modalBack{
    position:fixed;inset:0;background:rgba(15,23,42,.55);
    display:none;align-items:center;justify-content:center;z-index:100;
    padding:18px;
  }
  .modalBack.open{display:flex}
  .modal{
    width:min(980px, 96vw);
    max-height:92vh;
    overflow:auto;
    background:#fff;border:1px solid var(--bd);border-radius:16px;
    box-shadow:0 25px 60px rgba(0,0,0,.25);
  }
  .modalHead{
    position:sticky;top:0;background:#fff;border-bottom:1px solid var(--bd);
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    padding:12px 14px;z-index:2;
  }
  .modalHead h2{margin:0;font-size:14px;font-weight:900;direction:rtl;text-align:right}
  .modalBody{padding:14px}
  .modalFoot{
    position:sticky;bottom:0;background:#fff;border-top:1px solid var(--bd);
    display:flex;gap:10px;align-items:center;justify-content:space-between;
    padding:12px 14px;
  }
  .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
  .frow{display:flex;flex-direction:column;gap:6px}
  .frow label{font-size:12px;color:var(--muted);direction:rtl;text-align:right}
  textarea{min-height:90px;resize:vertical}

  /* Dependencies checkbox list */
  .depsBox{
    border:1px dashed #cbd5e1;border-radius:12px;padding:10px;background:#fff;
  }
  .depsTop{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between;margin-bottom:10px}
  .depsList{
    max-height:260px;overflow:auto;border:1px solid var(--bd);border-radius:12px;padding:8px;background:#fff;
  }
  .depItem{display:flex;gap:10px;align-items:flex-start;padding:8px;border-bottom:1px solid #f1f5f9}
  .depItem:last-child{border-bottom:none}
  .depItem label{flex:1;direction:rtl;text-align:right;font-size:12.5px;color:#111827}
  .depItem small{display:block;color:var(--muted);direction:rtl;text-align:right;margin-top:2px}
  .depsPreview{margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .codePill{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;background:#0b1220;color:#fff;border-radius:999px;padding:6px 10px}
  .soft{font-size:12px;color:var(--muted);direction:rtl;text-align:right}
  .dangerText{color:var(--bad);font-weight:800}

  /* Responsive */
  @media (max-width: 980px){
    .dash{grid-template-columns:1fr}
    .grid{grid-template-columns:1fr}
    .left{border-right:none;border-bottom:1px solid var(--bd)}
  }
</style>
</head>

<body>
<header>
  <h1>AMIR DAVIDI TECHNOLOGIES – גאנט פרויקט Ghana Energy CERT</h1>
  <div class="meta">
    ✅ Drag & Drop + Resize · ✅ עריכת משימה בקליק · ✅ תלויות עם חצים<br/>
    ✅ GitHub Load/Save + Settings · ✅ PDF ניהולי · ✅ UX מקצועי<br/>
    <span class="pill"><span class="dot ok"></span> Version: <b>23</b></span>
  </div>
</header>

<div class="wrap">

  <!-- Top toolbar (Daily use) -->
  <div class="card toolbar" id="topbar">
    <div class="tb-left">
      <div class="field">
        <span class="label">חיפוש</span>
        <input id="q" placeholder="Task / Owner / Phase / ID..." style="min-width:280px"/>
      </div>

      <div class="field">
        <span class="label">Owner</span>
        <select id="ownerFilter" style="min-width:180px"><option value="">כל ה-Owners</option></select>
      </div>

      <div class="field">
        <span class="label">Zoom</span>
        <select id="zoom" style="min-width:140px">
          <option value="day">יום (Day)</option>
          <option value="week" selected>שבוע (Week)</option>
          <option value="month">חודש (Month)</option>
        </select>
      </div>

      <button class="btn" id="toggleLegend">מקרא צבעים ▾</button>
    </div>

    <div class="tb-right">
      <button class="btn" id="newTask">➕ משימה חדשה</button>

      <!-- File menu -->
      <div class="dd" id="fileDD">
        <button class="btn" id="fileBtn">קובץ ▾</button>
        <div class="menu" id="fileMenu">
          <div class="mi" id="miLoadGit"><div><div class="k">Load from Git</div><small>טען tasks.csv לפי ההגדרות</small></div><div class="kbd">⇩</div></div>
          <div class="mi" id="miSaveGit"><div><div class="k">Save / Publish to Git</div><small>שומר ל-Repo (נדרש Token)</small></div><div class="kbd">⇧</div></div>
          <hr/>
          <div class="mi" id="miPdf"><div><div class="k">Export PDF (ניהולי)</div><small>Print → Save as PDF</small></div><div class="kbd">PDF</div></div>
          <hr/>
          <div class="mi" id="miExportCsv"><div><div class="k">Export CSV</div><small>מוריד קובץ CSV מלא (UTF-8 BOM)</small></div><div class="kbd">CSV</div></div>
          <div class="mi" id="miImportCsv"><div><div class="k">Import CSV</div><small>מעלה CSV ומחליף הכל</small></div><div class="kbd">⤒</div></div>
          <input id="importFile" type="file" accept=".csv,text/csv" style="display:none"/>
        </div>
      </div>

      <button class="btn-primary" id="saveNow">שמור / פרסם</button>

      <!-- Advanced menu -->
      <div class="dd" id="advDD">
        <button class="btn" id="advBtn">⋯ מתקדם</button>
        <div class="menu" id="advMenu">
          <div class="mi" id="miSettings"><div><div class="k">Settings (GitHub)</div><small>owner/repo/branch/path/token</small></div><div class="kbd">⚙</div></div>
          <div class="mi" id="miTemplate"><div><div class="k">Download CSV Template</div><small>תבנית מלאה לייבוא</small></div><div class="kbd">TPL</div></div>
          <div class="mi" id="miClearLocal"><div><div class="k dangerText">Clear Local Cache</div><small>מוחק שינויים מקומיים</small></div><div class="kbd">CLR</div></div>
          <hr/>
          <div class="mi" id="miDebug"><div><div class="k">Debug / Logs</div><small>פותח חלון לוגים</small></div><div class="kbd">LOG</div></div>
          <div class="mi" id="miOnboard"><div><div class="k">הצג הדרכה</div><small>3 צעדים מהירים לשימוש</small></div><div class="kbd">?</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Legend collapsible -->
  <div class="card legendPanel" id="legendPanel">
    <div class="legendHead">
      <div class="soft">המקרא נסגר כברירת מחדל כדי לשמור על מסך נקי. אפשר לחפש קטגוריה.</div>
      <div style="display:flex;gap:10px;align-items:center">
        <input id="legendSearch" placeholder="חיפוש קטגוריה..." style="min-width:220px"/>
        <button class="btn" id="legendClose">סגור</button>
      </div>
    </div>
    <div class="legendList" id="legendList"></div>
  </div>

  <!-- Status bar -->
  <div class="card" style="padding:10px 12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between">
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <span class="pill" id="stSource"><span class="dot"></span><span>מקור: <b>Local</b></span></span>
      <span class="pill" id="stDirty"><span class="dot ok"></span><span>מצב: <b>אין שינויים</b></span></span>
      <span class="pill" id="stLoad"><span class="dot"></span><span>טעינה אחרונה: <b>—</b></span></span>
      <span class="pill" id="stSave"><span class="dot"></span><span>שמירה אחרונה: <b>—</b></span></span>
    </div>
    <div class="soft">טיפ: לוחצים על משימה לעריכה. <span class="kbd">Ctrl+S</span> בחלון העריכה שומר.</div>
  </div>

  <!-- Charts -->
  <div class="dash">
    <div class="card chart-card">
      <p class="chart-title">משימות לפי קטגוריה</p>
      <canvas id="chartCats" width="600" height="220"></canvas>
      <div class="chart-legend" id="lgCats"></div>
    </div>
    <div class="card chart-card">
      <p class="chart-title">משימות לפי Owner</p>
      <canvas id="chartOwners" width="600" height="220"></canvas>
      <div class="chart-legend" id="lgOwners"></div>
    </div>
    <div class="card chart-card">
      <p class="chart-title">מדדים מהירים</p>
      <canvas id="chartKPIs" width="600" height="220"></canvas>
      <div class="hint" style="padding:8px 0 0 0;text-align:right">
        KPI: כמות משימות · כמות Milestones · כמות תלויות · טווח תאריכים (ימים)
      </div>
    </div>
  </div>

  <!-- Gantt -->
  <div class="card gantt">
    <div class="grid" id="grid">
      <div class="left" id="left"></div>
      <div class="right">
        <div class="timeline" id="timeline"></div>
        <div class="bar-area" id="bars"></div>
      </div>
    </div>
    <div class="hint">
      טיפ: לדיוק גבוה העבר ל-Zoom "יום". גרירה מזיזה משימה, גרירת קצוות משנה Duration.
    </div>
    <div class="footer">Gantt v23 · AMIR DAVIDI TECHNOLOGIES</div>
  </div>

</div>

<!-- ===== Modals ===== -->

<!-- Onboarding -->
<div class="modalBack" id="onBack">
  <div class="modal">
    <div class="modalHead">
      <h2>הדרכה קצרה (3 צעדים)</h2>
      <button class="btn" id="onClose">סגור</button>
    </div>
    <div class="modalBody" id="onBody"></div>
    <div class="modalFoot">
      <div style="display:flex;gap:10px;align-items:center">
        <label style="display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted);direction:rtl">
          <input type="checkbox" id="onDont" /> אל תראה שוב
        </label>
      </div>
      <div style="display:flex;gap:10px">
        <button class="btn" id="onPrev">הקודם</button>
        <button class="btn-primary" id="onNext">הבא</button>
      </div>
    </div>
  </div>
</div>

<!-- Settings -->
<div class="modalBack" id="setBack">
  <div class="modal">
    <div class="modalHead">
      <h2>Settings (GitHub)</h2>
      <button class="btn" id="setClose">סגור</button>
    </div>
    <div class="modalBody">
      <div class="soft">
        ⚠️ שים לב: ה-Token נשמר מקומית בדפדפן (LocalStorage). לא להדביק Token במקומות ציבוריים.  
        כדי שמישהו אחר רק “יראה” את הגאנט — מספיק Repo ציבורי + tasks.csv ציבורי (Load עובד בלי Token).
      </div>
      <div class="grid2" style="margin-top:10px">
        <div class="frow">
          <label>Owner (GitHub username / org)</label>
          <input id="gitOwner" placeholder="amird1976"/>
        </div>
        <div class="frow">
          <label>Repo</label>
          <input id="gitRepo" placeholder="GANA_PM"/>
        </div>
        <div class="frow">
          <label>Branch</label>
          <input id="gitBranch" placeholder="main"/>
        </div>
        <div class="frow">
          <label>Path (קובץ)</label>
          <input id="gitPath" placeholder="tasks.csv"/>
        </div>
      </div>
      <div class="frow" style="margin-top:10px">
        <label>Token (נדרש ל-Save בלבד)</label>
        <input id="gitToken" placeholder="github_pat_..." />
        <div class="soft">המלצה: Token עם הרשאות repo:contents (או classic עם repo). לטעינה מ-Repo ציבורי לא צריך Token.</div>
      </div>
    </div>
    <div class="modalFoot">
      <div class="soft">לאחר שמירה, כפתורי Load/Save יעבדו לפי ההגדרות כאן.</div>
      <div style="display:flex;gap:10px">
        <button class="btn" id="setTest">בדיקת טעינה (Load)</button>
        <button class="btn-primary" id="setSave">שמור Settings</button>
      </div>
    </div>
  </div>
</div>

<!-- Debug/Logs -->
<div class="modalBack" id="logBack">
  <div class="modal">
    <div class="modalHead">
      <h2>Debug / Logs</h2>
      <button class="btn" id="logClose">סגור</button>
    </div>
    <div class="modalBody">
      <div class="soft">כאן תראה מה קרה בטעינה/שמירה/ייבוא. זה נועד לניתוח תקלות.</div>
      <textarea id="logArea" style="width:100%;min-height:320px;margin-top:10px" readonly></textarea>
    </div>
    <div class="modalFoot">
      <div class="soft">Tip: אם משהו לא עובד — העתק את הלוג ושלח לי.</div>
      <div style="display:flex;gap:10px">
        <button class="btn" id="logCopy">העתק</button>
        <button class="btn-danger" id="logClear">נקה</button>
      </div>
    </div>
  </div>
</div>

<!-- Task Editor -->
<div class="modalBack" id="edBack">
  <div class="modal">
    <div class="modalHead">
      <h2 id="edTitle">עריכת משימה</h2>
      <button class="btn" id="edClose">סגור</button>
    </div>
    <div class="modalBody">
      <div class="grid3">
        <div class="frow">
          <label>ID</label>
          <input id="edId" readonly/>
        </div>
        <div class="frow" style="grid-column: span 2">
          <label>שם משימה</label>
          <input id="edName" placeholder="שם משימה..."/>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div class="frow">
          <label>Phase / קטגוריה</label>
          <input id="edPhase" placeholder="למשל: 5.1 - 5.17 (סקרי אתרים)"/>
        </div>

        <div class="frow">
          <label>Owner (בחירה עם גלילה / חיפוש)</label>
          <input id="edOwner" list="ownersDL" placeholder="בחר Owner או כתוב חדש..." />
          <datalist id="ownersDL"></datalist>
        </div>

        <div class="frow">
          <label>Start Date</label>
          <input id="edStart" type="date"/>
        </div>
        <div class="frow">
          <label>End Date</label>
          <input id="edEnd" type="date"/>
        </div>

        <div class="frow">
          <label>Start Offset (days)</label>
          <input id="edOffset" type="number" min="0" step="1"/>
        </div>
        <div class="frow">
          <label>Duration (days)</label>
          <input id="edDur" type="number" min="1" step="1"/>
        </div>

        <div class="frow">
          <label>Milestone</label>
          <select id="edMs">
            <option value="0">לא</option>
            <option value="1">כן</option>
          </select>
        </div>
        <div class="frow">
          <label>Deps (IDs) – תלויות</label>
          <input id="edDeps" readonly placeholder="ייבנה אוטומטית מה-checkboxes"/>
        </div>
      </div>

      <div class="frow" style="margin-top:10px">
        <label>Notes / הערות</label>
        <textarea id="edNotes" placeholder="הערות..."></textarea>
      </div>

      <div class="depsBox" style="margin-top:12px">
        <div class="depsTop">
          <div class="soft">
            ✅ בחר תלויות עם <b>Checkbox</b> (אפשר כמה).  
            טיפ: אפשר גם לגרור “➕” משורה משמאל לתוך חלון העריכה (אם תרצה – זה יעבוד כבר כאן).
          </div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="depSearch" placeholder="חיפוש תלות (#ID / שם / Owner / Phase)..." style="min-width:260px"/>
            <button class="btn" id="depAll">בחר הכל</button>
            <button class="btn" id="depNone">נקה הכל</button>
          </div>
        </div>
        <div class="depsList" id="depsList"></div>
        <div class="depsPreview">
          <span class="soft">Deps Preview:</span>
          <span class="codePill" id="depsPreview">—</span>
        </div>
      </div>

    </div>

    <div class="modalFoot">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <button class="btn" id="edDuplicate">שכפל משימה</button>
        <button class="btn-danger" id="edDelete">מחק משימה</button>
        <span class="sep"></span>
        <span class="soft">קיצורים: <span class="kbd">Ctrl+S</span> שמירה · <span class="kbd">Esc</span> סגירה</span>
      </div>

      <div style="display:flex;gap:10px">
        <button class="btn" id="edCancel">ביטול</button>
        <button class="btn-primary" id="edSave">שמור</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =======================
   v23 – Core
======================= */
const VERSION = 23;

const MS_DAY = 86400000;

// Project window (used for offset-to-date)
const MIN_START = new Date("2026-01-05");
const MAX_END   = new Date("2026-06-10");

// Storage keys (versioned)
const STORE_KEY          = "gantt_tasks_v23_edits";
const STORE_KEY_CSV      = "gantt_tasks_v23_csv_snapshot";
const STORE_KEY_GIT      = "gantt_git_settings_v23";
const STORE_KEY_DIRTY    = "gantt_dirty_v23";
const STORE_KEY_ONBOARD  = "gantt_onboard_done_v23";

// Base sample (replace by import/git)
const BASE = [
  {"id":"1","phase":"1. Management","name":"פתיחת פרויקט וניהול (Phase 1)","owner":"צוות יעוץ","start":"2026-01-05","end":"2026-02-04","startOffset":0,"duration":30,"deps":"","milestone":false,"notes":""},
  {"id":"2","phase":"1.1 Admin","name":"פגישת קיק-אוף והתנעת צוות היגוי","owner":"צוות יעוץ","start":"2026-01-05","end":"2026-01-07","startOffset":0,"duration":2,"deps":"","milestone":true,"notes":"דוגמה: milestone=true כדי לקבל יהלום"},
  {"id":"3","phase":"1.1 Admin","name":"הקמת משרד PMO פיזי באקרה (Ghana)","owner":"Local Ops","start":"2026-01-07","end":"2026-01-21","startOffset":2,"duration":14,"deps":"2","milestone":false,"notes":""},
  {"id":"4","phase":"2. Design","name":"CDR - תכנון הנדסי מפורט (Design Phase)","owner":"Engineering","start":"2026-01-05","end":"2026-03-06","startOffset":0,"duration":60,"deps":"","milestone":false,"notes":""}
];

let ALL = BASE.map(t => ({...t}));

let appState = {
  source: "Local",          // Local / Git
  lastLoadAt: null,
  lastSaveAt: null,
  dirty: false,
  openEditorId: null
};

function log(msg){
  const area = document.getElementById('logArea');
  const ts = new Date().toLocaleTimeString();
  area.value += `[${ts}] ${msg}\n`;
  area.scrollTop = area.scrollHeight;
}

function setDirty(v){
  appState.dirty = !!v;
  try{ localStorage.setItem(STORE_KEY_DIRTY, appState.dirty ? "1":"0"); }catch(_){}
  refreshStatus();
}

function refreshStatus(){
  const stSource = document.getElementById('stSource');
  const stDirty  = document.getElementById('stDirty');
  const stLoad   = document.getElementById('stLoad');
  const stSave   = document.getElementById('stSave');

  stSource.innerHTML = `<span class="dot"></span><span>מקור: <b>${escapeHtml(appState.source||"Local")}</b></span>`;
  stSource.querySelector('.dot').className = "dot " + (appState.source==="Git" ? "ok" : "");

  if (appState.dirty){
    stDirty.innerHTML = `<span class="dot warn"></span><span>מצב: <b>יש שינויים לא נשמרו</b></span>`;
  } else {
    stDirty.innerHTML = `<span class="dot ok"></span><span>מצב: <b>אין שינויים</b></span>`;
  }

  stLoad.innerHTML = `<span class="dot"></span><span>טעינה אחרונה: <b>${appState.lastLoadAt || "—"}</b></span>`;
  stSave.innerHTML = `<span class="dot"></span><span>שמירה אחרונה: <b>${appState.lastSaveAt || "—"}</b></span>`;
}

/* =======================
   Helpers
======================= */
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
function daysBetween(a,b){ return Math.round((b-a)/MS_DAY); }
function fmt(d){
  const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}
function parseDateISO(s){
  const m = String(s||"").match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (!m) return null;
  const d = new Date(`${m[1]}-${m[2]}-${m[3]}T00:00:00`);
  return isNaN(d.getTime()) ? null : d;
}
function calcDatesFromOffsets(t){
  const s = new Date(MIN_START.getTime() + (Number(t.startOffset||0))*MS_DAY);
  const e = new Date(s.getTime() + Math.max(1, Number(t.duration||1))*MS_DAY);
  t.start = fmt(s); t.end = fmt(e);
}
function offsetsFromDates(t){
  const s = parseDateISO(t.start);
  const e = parseDateISO(t.end);
  if (!s || !e) return;
  const off = daysBetween(MIN_START, s);
  const dur = Math.max(1, daysBetween(s, e));
  t.startOffset = Math.max(0, off);
  t.duration = dur;
}
function uniqNums(arr){
  const out = Array.from(new Set(arr.map(x=>Number(x)).filter(x=>Number.isFinite(x))));
  out.sort((a,b)=>a-b);
  return out;
}
function nextId(){
  const ids = ALL.map(t=>Number(t.id)).filter(n=>Number.isFinite(n));
  const max = ids.length ? Math.max(...ids) : 0;
  return String(max+1);
}

/* =======================
   Category coloring + labels
======================= */
function categoryOf(t){
  const p = (t.phase||"").trim();
  if (!p) return "Other";
  const low = p.toLowerCase();

  // Preserve meaningful tokens, but keep consistent grouping
  if (low.startsWith("atp")) return "ATP";
  if (low === "closure" || low.includes("סגירה")) return "Closure";

  // If phase is like "5.1 - 5.17 ..." -> group as "Phase 5"
  const m = p.match(/^(\d+)(?:\.\d+)?/);
  if (m) return "Phase " + m[1];

  // If starts with letter group
  const m2 = p.match(/^([A-Z])\./i);
  if (m2) return "Group " + m2[1].toUpperCase();

  return p.split(/\s+/)[0];
}
function categoryLabel(cat){
  // Human friendly labels (for legend/chart)
  if (cat === "Other") return "אחר";
  if (cat === "Closure") return "סגירה";
  if (cat === "ATP") return "ATP";
  if (/^Phase \d+$/.test(cat)) return cat.replace("Phase", "שלב");
  if (/^Group [A-Z]$/.test(cat)) return cat.replace("Group", "קבוצה");
  return cat;
}
function colorForCategory(cat){
  const palette = ["#2563eb","#16a34a","#f59e0b","#dc2626","#9333ea","#0891b2","#7c3aed","#0ea5e9","#22c55e","#ea580c","#be123c","#0f766e","#4f46e5","#a16207","#1d4ed8"];
  let h=0; for (let i=0;i<cat.length;i++) h = (h*31 + cat.charCodeAt(i)) >>> 0;
  return palette[h % palette.length];
}
function depsLabel(t){
  const d = (t.deps||"").trim();
  if (!d) return "";
  return d.length > 30 ? (d.slice(0,30) + "…") : d;
}

/* =======================
   Local edits persistence
======================= */
function loadEdits() {
  try { const raw = localStorage.getItem(STORE_KEY); return raw ? JSON.parse(raw) : null; } catch(e){ return null; }
}
function saveEdits(edits) { try { localStorage.setItem(STORE_KEY, JSON.stringify(edits)); } catch(e){} }
function persistAllToLocal(){
  const edits = {};
  ALL.forEach(t=>{
    edits[String(t.id)] = {
      id:String(t.id),
      phase:t.phase||"",
      name:t.name||"",
      owner:t.owner||"",
      startOffset:Number(t.startOffset||0),
      duration:Number(t.duration||1),
      deps:t.deps||"",
      milestone: !!t.milestone,
      notes: t.notes||"",
      start:t.start, end:t.end
    };
  });
  saveEdits(edits);
}
function persistOne(t){
  const edits = loadEdits() || {};
  edits[String(t.id)] = {
    id:String(t.id),
    phase:t.phase||"",
    name:t.name||"",
    owner:t.owner||"",
    startOffset:Number(t.startOffset||0),
    duration:Number(t.duration||1),
    deps:t.deps||"",
    milestone: !!t.milestone,
    notes: t.notes||"",
    start:t.start, end:t.end
  };
  saveEdits(edits);
}
function findTask(id){ return ALL.find(x=>String(x.id)===String(id)); }

/* Apply local edits at startup */
(function applyLocal(){
  const edits = loadEdits(); if (!edits) return;
  ALL = ALL.map(t => {
    const e = edits[String(t.id)]; if (!e) return t;
    return {...t, ...e};
  });
})();
ALL.forEach(t => calcDatesFromOffsets(t));
(function initDirtyFromStorage(){
  try{ appState.dirty = localStorage.getItem(STORE_KEY_DIRTY)==="1"; }catch(_){}
})();

/* =======================
   Owner list / filters
======================= */
const ownerSel = document.getElementById('ownerFilter');
function getOwnerSet(tasks){
  return Array.from(new Set(tasks.map(t => (t.owner||'').trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
}
function rebuildOwnerOptions(tasks){
  const owners = getOwnerSet(tasks);
  ownerSel.innerHTML = '<option value="">כל ה-Owners</option>';
  owners.forEach(o=>{
    const opt=document.createElement('option'); opt.value=o; opt.textContent=o;
    ownerSel.appendChild(opt);
  });

  // datalist for editor (scrollable suggestions in browser UI)
  const dl = document.getElementById('ownersDL');
  dl.innerHTML = "";
  owners.forEach(o=>{
    const op = document.createElement('option');
    op.value = o;
    dl.appendChild(op);
  });
}
rebuildOwnerOptions(ALL);

/* =======================
   Zoom / ticks
======================= */
function pxPerDayForZoom(){
  const z=document.getElementById('zoom').value;
  return (z==='day')?18:(z==='week'?7:2.5);
}
function buildTicks(pxPerDay){
  const tl=document.getElementById('timeline'); tl.innerHTML='';
  const ticks=document.createElement('div'); ticks.className='ticks';
  const totalDays=daysBetween(MIN_START, MAX_END);
  const zoom=document.getElementById('zoom').value;
  const step = zoom==='day'?1:(zoom==='week'?7:30);

  for (let i=0;i<=totalDays;i++){
    const d=new Date(MIN_START.getTime()+i*MS_DAY);
    const tick=document.createElement('div');
    tick.className='tick'; tick.style.width=pxPerDay+'px';
    tick.textContent = (i%step===0)?fmt(d):'';
    ticks.appendChild(tick);
  }
  ticks.style.width=((totalDays+1)*pxPerDay)+'px';
  tl.appendChild(ticks);
}

/* =======================
   Drag & resize
======================= */
function attachDrag(barEl, pxPerDay){
  let mode="move", startX=0, origOffset=0, origDuration=0;

  function onPointerDown(e){
    const handle=e.target?.dataset?.handle;
    mode = handle==='left'?'resizeL':(handle==='right'?'resizeR':'move');
    barEl.setPointerCapture(e.pointerId);
    barEl.classList.add('dragging');
    startX=e.clientX;
    const t=findTask(barEl.dataset.id);
    origOffset=Number(t.startOffset||0); origDuration=Number(t.duration||1);
    e.preventDefault(); e.stopPropagation();
  }

  function onPointerMove(e){
    if (!barEl.classList.contains('dragging')) return;
    const dx=e.clientX-startX;
    const deltaDays=Math.round(dx/pxPerDay);
    const t=findTask(barEl.dataset.id); if (!t) return;

    if (mode==='move'){
      t.startOffset = clamp(origOffset+deltaDays,0,100000);
    } else if (mode==='resizeR'){
      t.duration = clamp(origDuration+deltaDays,1,100000);
    } else if (mode==='resizeL'){
      const newOffset=origOffset+deltaDays;
      const newDur=origDuration-deltaDays;
      if (newDur>=1){ t.startOffset=clamp(newOffset,0,100000); t.duration=newDur; }
    }

    calcDatesFromOffsets(t);
    barEl.style.left=(t.startOffset*pxPerDay)+'px';
    barEl.style.width=(Math.max(1,t.duration)*pxPerDay)+'px';
    barEl.title=`${t.name} (Start: ${t.start}, End: ${t.end})`;

    setDirty(true);
    updateCharts();
  }

  function onPointerUp(e){
    if (!barEl.classList.contains('dragging')) return;
    barEl.classList.remove('dragging');
    const t=findTask(barEl.dataset.id);
    if (t) persistOne(t);
    try{ barEl.releasePointerCapture(e.pointerId);}catch(_){}
    render(); // refresh deps lines + visuals
  }

  barEl.addEventListener('pointerdown', onPointerDown);
  barEl.addEventListener('pointermove', onPointerMove);
  barEl.addEventListener('pointerup', onPointerUp);
  barEl.addEventListener('pointercancel', onPointerUp);
}

/* Milestones */
function applyMilestoneStyle(barEl, isMilestone){
  if (!isMilestone) {
    barEl.style.borderRadius = "10px";
    barEl.style.transform = "none";
    return;
  }
  barEl.style.borderRadius = "4px";
  barEl.style.transform = "rotate(45deg)";
}

/* =======================
   Render + legend
======================= */
function filteredList(){
  const q=(document.getElementById('q').value||'').toLowerCase().trim();
  const ownerVal=(document.getElementById('ownerFilter').value||'').toLowerCase();
  const baseList = !q ? ALL : ALL.filter(t =>
    (t.name||'').toLowerCase().includes(q) ||
    (t.owner||'').toLowerCase().includes(q) ||
    (t.phase||'').toLowerCase().includes(q) ||
    String(t.id||'').toLowerCase().includes(q)
  );
  return !ownerVal ? baseList : baseList.filter(t => (t.owner||'').toLowerCase()===ownerVal);
}

function rebuildLegend(list){
  const search = (document.getElementById('legendSearch').value||"").toLowerCase().trim();
  const cats = Array.from(new Set(list.map(t=>categoryOf(t)))).sort();
  const out = !search ? cats : cats.filter(c => categoryLabel(c).toLowerCase().includes(search) || c.toLowerCase().includes(search));

  const legendList = document.getElementById('legendList');
  legendList.innerHTML = "";
  out.forEach(cat=>{
    const item=document.createElement('div'); item.className='lg-item';
    const sw=document.createElement('div'); sw.className='sw'; sw.style.background=colorForCategory(cat);
    const tx=document.createElement('div'); tx.textContent=categoryLabel(cat);
    item.appendChild(sw); item.appendChild(tx);
    legendList.appendChild(item);
  });
}

function render(){
  const list = filteredList();
  const pxPerDay=pxPerDayForZoom();

  // Left list
  const left=document.getElementById('left');
  left.innerHTML='';
  const head=document.createElement('div');
  head.className='row stickyHead';
  head.style.fontWeight='900';
  head.innerHTML = `<div class="meta">ID</div><div class="title">משימה (קליק לעריכה)</div><div class="meta">Owner</div>`;
  left.appendChild(head);

  list.forEach(t=>{
    const r=document.createElement('div'); r.className='row';
    r.style.cursor="pointer";
    r.innerHTML = `
      <div class="meta">#${escapeHtml(t.id)}</div>
      <div class="title">${escapeHtml(t.name||"")}</div>
      <div class="meta">${escapeHtml(t.owner||"")}</div>
    `;
    r.addEventListener('click', ()=> openEditor(String(t.id)));
    left.appendChild(r);
  });

  buildTicks(pxPerDay);

  const bars=document.getElementById('bars');
  bars.innerHTML='';

  // Dependency overlay SVG
  const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.classList.add('dep-layer'); svg.setAttribute('aria-hidden','true');
  const defs=document.createElementNS('http://www.w3.org/2000/svg','defs');
  const marker=document.createElementNS('http://www.w3.org/2000/svg','marker');
  marker.setAttribute('id','arrow'); marker.setAttribute('markerWidth','10'); marker.setAttribute('markerHeight','10');
  marker.setAttribute('refX','8'); marker.setAttribute('refY','3'); marker.setAttribute('orient','auto');
  const ap=document.createElementNS('http://www.w3.org/2000/svg','path');
  ap.setAttribute('d','M0,0 L8,3 L0,6 Z'); ap.setAttribute('fill','#64748b');
  marker.appendChild(ap); defs.appendChild(marker); svg.appendChild(defs); bars.appendChild(svg);

  const totalDays=daysBetween(MIN_START, MAX_END);
  const width=((totalDays+1)*pxPerDay);

  list.forEach((t, idx)=>{
    const row=document.createElement('div');
    row.className='bar-row';
    row.style.width=width+'px';

    const bar=document.createElement('div');
    bar.className='bar';
    bar.dataset.id=t.id;

    const isMs = !!t.milestone;
    const durPx = Math.max(1,Number(t.duration||1))*pxPerDay;
    const msSize = Math.max(10, Math.min(18, pxPerDay*2.2));
    bar.style.left=(Number(t.startOffset||0)*pxPerDay)+'px';
    bar.style.width = isMs ? (msSize+'px') : (durPx+'px');

    const col=colorForCategory(categoryOf(t));
    bar.style.background=col;

    bar.title=`${t.name} (Start: ${t.start}, End: ${t.end})`;
    applyMilestoneStyle(bar, isMs);

    const lbl=document.createElement('div');
    lbl.className='label';
    lbl.textContent = isMs ? `#${t.id}` : `#${t.id} · ${t.name}`;

    const dep=depsLabel(t);
    const depEl=document.createElement('div');
    depEl.className='deps';
    depEl.textContent = dep ? `Deps: ${dep}` : '';

    if (isMs) { depEl.textContent=''; lbl.style.transform="rotate(-45deg)"; lbl.style.left="6px"; lbl.style.right="6px"; }

    bar.appendChild(lbl);
    bar.appendChild(depEl);

    const hL=document.createElement('div'); hL.className='handle left'; hL.dataset.handle='left';
    const hR=document.createElement('div'); hR.className='handle right'; hR.dataset.handle='right';
    if (!isMs){ bar.appendChild(hL); bar.appendChild(hR); }

    bar.addEventListener('dblclick', ()=> openEditor(String(t.id)));
    bar.addEventListener('click', ()=> openEditor(String(t.id)));

    attachDrag(bar, pxPerDay);
    row.appendChild(bar);
    bars.appendChild(row);
  });

  // Draw dependency lines among visible
  const rowsCount=list.length;
  const svgHeight=rowsCount*34;
  svg.setAttribute('width', width);
  svg.setAttribute('height', svgHeight);
  svg.setAttribute('viewBox', `0 0 ${width} ${svgHeight}`);
  Array.from(svg.querySelectorAll('path.dep')).forEach(p=>p.remove());

  const centerY = (i)=>(i*34+17);
  const barEndX = (tt)=>((Number(tt.startOffset||0) + Math.max(1,Number(tt.duration||1)))*pxPerDay);
  const barStartX = (tt)=>((Number(tt.startOffset||0))*pxPerDay);
  const visibleById = new Map(list.map((tt,i)=>[String(tt.id), {t:tt,i}]));

  list.forEach((tt,i)=>{
    const deps = String(tt.deps||'').split(/[,\s]+/).map(x=>x.trim()).filter(Boolean);
    deps.forEach(did=>{
      if (!visibleById.has(did)) return;
      const from=visibleById.get(did);
      const x1=barEndX(from.t), y1=centerY(from.i);
      const x2=barStartX(tt), y2=centerY(i);
      const midX=(x1+x2)/2;
      const p=document.createElementNS('http://www.w3.org/2000/svg','path');
      p.classList.add('dep');
      p.setAttribute('d', `M ${x1} ${y1} L ${midX} ${y1} L ${midX} ${y2} L ${x2} ${y2}`);
      p.setAttribute('fill','none');
      p.setAttribute('stroke','#64748b');
      p.setAttribute('stroke-width','1.2');
      p.setAttribute('marker-end','url(#arrow)');
      svg.appendChild(p);
    });
  });

  rebuildLegend(list);
  updateCharts(list);
  refreshStatus();
}

/* =======================
   CSV Export/Import
======================= */
function buildCSVText(withBom){
  const header = ["id","phase","name","owner","startOffset","duration","start","end","deps","milestone","notes"];
  const rows = [header.join(",")];
  const esc = (v)=>{
    const s=String(v ?? "");
    if (s.includes('"')||s.includes(",")||s.includes("\n")||s.includes("\r")) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  };
  ALL.forEach(t=>{
    rows.push([
      esc(t.id),
      esc(t.phase),
      esc(t.name),
      esc(t.owner),
      esc(t.startOffset),
      esc(t.duration),
      esc(t.start),
      esc(t.end),
      esc(t.deps||""),
      esc(t.milestone?1:0),
      esc(t.notes||"")
    ].join(","));
  });
  const text = rows.join("\r\n");
  return (withBom ? "\uFEFF" : "") + text;
}
function exportCSV(){
  const csvText = buildCSVText(true);
  const blob = new Blob([csvText], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url;
  a.download="gantt_full_export.csv";
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 5000);
  try{ localStorage.setItem(STORE_KEY_CSV, csvText);}catch(_){}
  log("Export CSV created.");
}

function parseCSV(text){
  const lines = text.replace(/^\uFEFF/,'').split(/\r\n|\n|\r/);
  const out = [];
  let headers = null;

  function splitLine(line){
    const res=[];
    let cur="", inQ=false;
    for (let i=0;i<line.length;i++){
      const ch=line[i];
      if (inQ){
        if (ch === '"'){
          if (line[i+1] === '"'){ cur+='"'; i++; }
          else inQ=false;
        } else cur+=ch;
      } else {
        if (ch === '"') inQ=true;
        else if (ch === ','){ res.push(cur); cur=""; }
        else cur+=ch;
      }
    }
    res.push(cur);
    return res;
  }

  for (let i=0;i<lines.length;i++){
    const line=lines[i];
    if (!line.trim()) continue;
    const cols=splitLine(line);
    if (!headers){
      headers = cols.map(h=>h.trim());
      continue;
    }
    const obj={};
    headers.forEach((h, idx)=> obj[h]= (cols[idx] ?? "").trim());
    out.push(obj);
  }
  return out;
}

function coerceTask(row){
  const pick = (...keys) => {
    for (const k of keys){
      if (k == null) continue;
      if (Object.prototype.hasOwnProperty.call(row, k)) {
        const v = row[k];
        if (v !== undefined && v !== null && String(v).trim() !== "") return v;
      }
    }
    return undefined;
  };

  const t = {};
  t.id    = String(pick("id","ID","מזהה") ?? "").trim();
  t.phase = String(pick("phase","Phase","Phase/Section","קטגוריה/שלב") ?? "").trim();
  t.name  = String(pick("name","Task","Task Name","שם משימה") ?? "").trim();
  t.owner = String(pick("owner","Owner","אחראי") ?? "").trim();

  const startRaw = pick("start","Start","Start Date","תאריך התחלה");
  const endRaw   = pick("end","End","End Date","תאריך סיום");

  t.deps  = String(pick("deps","Dependencies","תלויות") ?? "").trim();
  t.notes = String(pick("notes","Notes","הערות") ?? "").trim();
  const msRaw = pick("milestone","Milestone","אבן דרך","אבן_דרך");
  t.milestone = (String(msRaw ?? "").toLowerCase()==="true" || String(msRaw ?? "").toLowerCase()==="yes" || String(msRaw ?? "")==="1");

  const so = pick("startOffset","start_offset","Start Offset (days)","Start Offset","StartOffset","Start Offset (Days)");
  const du = pick("duration","Duration","Duration (days)","Duration Days","משך (ימים)");
  t.startOffset = Number(so ?? 0);
  t.duration = Number(du ?? 1);

  if (startRaw) t.start = String(startRaw).trim();
  if (endRaw)   t.end   = String(endRaw).trim();

  // If dates exist, recalc offsets; else compute dates from offsets
  if (t.start && t.end) offsetsFromDates(t);
  calcDatesFromOffsets(t);

  return t;
}

async function importCSVFromFile(file){
  const text = await file.text();
  const rows = parseCSV(text);
  const tasks = rows.map(coerceTask).filter(t=>t && t.id);

  if (!tasks.length){
    alert("לא נמצאו משימות ב-CSV. ודא שיש עמודות id/name/phase/owner/startOffset/duration וכו'.");
    return;
  }

  ALL = tasks.map(t=>({...t}));
  persistAllToLocal();
  rebuildOwnerOptions(ALL);
  document.getElementById('ownerFilter').value = "";
  setDirty(true);
  render();
  alert(`✅ Import הושלם: נטענו ${ALL.length} משימות והגאנט עודכן מיד.`);
  log(`Import CSV: ${ALL.length} tasks loaded.`);
}

/* Template */
function downloadTemplate(){
  const sample = [
    "id,phase,name,owner,startOffset,duration,start,end,deps,milestone,notes",
    "1,5.1 - 5.17,סקר אתר: MoE,Indigo,0,7,2026-01-05,2026-01-12,,0,",
    "2,6. Core Build,הקמת מרכז ה-CERT (Core DC),Engineering,7,14,2026-01-12,2026-01-26,1,0,"
  ].join("\r\n");
  const bom="\uFEFF";
  const blob = new Blob([bom+sample], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download="tasks_template.csv";
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 5000);
  log("Downloaded CSV template.");
}

/* Clear local cache */
function clearLocalCache(){
  if (!confirm("למחוק שינויים מקומיים ולהחזיר למצב האחרון שנשמר מקומית/נטען?")) return;
  localStorage.removeItem(STORE_KEY);
  localStorage.removeItem(STORE_KEY_CSV);
  setDirty(false);
  ALL = BASE.map(t=>({...t}));
  ALL.forEach(t=>calcDatesFromOffsets(t));
  rebuildOwnerOptions(ALL);
  document.getElementById('q').value='';
  document.getElementById('ownerFilter').value='';
  document.getElementById('zoom').value='week';
  appState.source = "Local";
  appState.lastLoadAt = null;
  appState.lastSaveAt = null;
  render();
  log("Local cache cleared. Reset to BASE.");
}

/* =======================
   Mini chart engine
======================= */
function clearCanvas(ctx){ ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height); }

function drawBarChart(canvas, items, colorFn, legendEl){
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  clearCanvas(ctx);

  const top = 16, bottom = 26, left = 8, right = 8;
  const plotW = W - left - right;
  const plotH = H - top - bottom;

  const maxV = Math.max(1, ...items.map(x=>x.v));
  const barCount = items.length || 1;
  const gap = 6;
  const barW = Math.max(10, Math.floor((plotW - gap*(barCount-1))/barCount));

  ctx.globalAlpha = 1;
  ctx.strokeStyle = "#e5e7eb";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(left, top+plotH);
  ctx.lineTo(left+plotW, top+plotH);
  ctx.stroke();

  items.forEach((it, i)=>{
    const h = Math.round((it.v/maxV) * (plotH-2));
    const x = left + i*(barW+gap);
    const y = top + (plotH - h);
    ctx.fillStyle = colorFn(it.k, i);
    ctx.fillRect(x, y, barW, h);

    ctx.fillStyle = "#111827";
    ctx.font = "12px system-ui";
    ctx.textAlign = "center";
    ctx.fillText(String(it.v), x+barW/2, y-4);

    const lab = it.k.length > 12 ? (it.k.slice(0,12)+"…") : it.k;
    ctx.fillStyle = "#374151";
    ctx.font = "11px system-ui";
    ctx.fillText(lab, x+barW/2, top+plotH+16);
  });

  if (legendEl){
    legendEl.innerHTML = "";
    items.slice(0,12).forEach((it, i)=>{
      const div = document.createElement('div');
      div.className="it";
      const dot = document.createElement('span');
      dot.className="dot2";
      dot.style.background = colorFn(it.k, i);
      const tx = document.createElement('span');
      tx.textContent = `${it.k}: ${it.v}`;
      div.appendChild(dot); div.appendChild(tx);
      legendEl.appendChild(div);
    });
  }
}

function drawKPI(canvas, kpis){
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  clearCanvas(ctx);

  const pad = 12;
  const cellW = (W - pad*3)/2;
  const cellH = (H - pad*3)/2;

  ctx.font="12px system-ui";
  for (let i=0;i<kpis.length;i++){
    const r = Math.floor(i/2), c = i%2;
    const x = pad + c*(cellW+pad);
    const y = pad + r*(cellH+pad);

    ctx.fillStyle="#ffffff";
    ctx.strokeStyle="#e5e7eb";
    ctx.lineWidth=1;
    ctx.beginPath();
    ctx.roundRect(x,y,cellW,cellH,10);
    ctx.fill(); ctx.stroke();

    ctx.fillStyle="#374151";
    ctx.font="12px system-ui";
    ctx.textAlign="right";
    ctx.fillText(kpis[i].t, x+cellW-10, y+18);

    ctx.fillStyle="#111827";
    ctx.font="22px system-ui";
    ctx.textAlign="right";
    ctx.fillText(String(kpis[i].v), x+cellW-10, y+50);

    ctx.fillStyle="#6b7280";
    ctx.font="11px system-ui";
    ctx.textAlign="right";
    ctx.fillText(kpis[i].s||"", x+cellW-10, y+70);
  }
}
if (!CanvasRenderingContext2D.prototype.roundRect){
  CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
    r = Math.min(r, w/2, h/2);
    this.beginPath();
    this.moveTo(x+r,y);
    this.arcTo(x+w,y,x+w,y+h,r);
    this.arcTo(x+w,y+h,x,y+h,r);
    this.arcTo(x,y+h,x,y,r);
    this.arcTo(x,y,x+w,y,r);
    this.closePath();
    return this;
  };
}
function getCounts(list, keyFn){
  const m = new Map();
  list.forEach(t=>{
    const k = keyFn(t);
    m.set(k, (m.get(k)||0)+1);
  });
  return Array.from(m.entries()).map(([k,v])=>({k,v})).sort((a,b)=>b.v-a.v);
}
function updateCharts(listOverride){
  const list = listOverride || filteredList();
  const cats = getCounts(list, t=>categoryLabel(categoryOf(t))).slice(0,10);
  const owners = getCounts(list, t=>(t.owner||"—")).slice(0,10);

  drawBarChart(
    document.getElementById('chartCats'),
    cats,
    (k)=>colorForCategory(k),
    document.getElementById('lgCats')
  );

  drawBarChart(
    document.getElementById('chartOwners'),
    owners,
    (k)=>{
      let h=0; for (let i=0;i<k.length;i++) h=(h*31+k.charCodeAt(i))>>>0;
      const pal=["#2563eb","#16a34a","#f59e0b","#dc2626","#9333ea","#0891b2","#7c3aed","#0ea5e9","#22c55e","#ea580c"];
      return pal[h%pal.length];
    },
    document.getElementById('lgOwners')
  );

  const milestones = list.filter(t=>!!t.milestone).length;
  const depsCount = list.reduce((acc,t)=> acc + (String(t.deps||'').split(/[,\s]+/).filter(Boolean).length), 0);

  const offs = list.map(t=>Number(t.startOffset||0));
  const ends = list.map(t=>Number(t.startOffset||0)+Math.max(1,Number(t.duration||1)));
  const minO = offs.length ? Math.min(...offs) : 0;
  const maxE = ends.length ? Math.max(...ends) : 0;
  const spanDays = Math.max(0, maxE - minO);

  drawKPI(document.getElementById('chartKPIs'), [
    {t:"כמות משימות", v:list.length, s:"בפילטר הנוכחי"},
    {t:"Milestones", v:milestones, s:"diamond"},
    {t:"כמות תלויות", v:depsCount, s:"edges"},
    {t:"טווח (ימים)", v:spanDays, s:"min..max"}
  ]);
}

/* =======================
   PDF export (managerial)
======================= */
function exportManagerPDF(){
  // We generate a printable report page (HTML) and let user Print -> Save as PDF
  const list = filteredList();
  const now = new Date();
  const ts = now.toLocaleString();

  const cats = getCounts(list, t=>categoryLabel(categoryOf(t))).slice(0,12);
  const owners = getCounts(list, t=>(t.owner||"—")).slice(0,12);

  const c1 = document.getElementById('chartCats').toDataURL("image/png");
  const c2 = document.getElementById('chartOwners').toDataURL("image/png");
  const c3 = document.getElementById('chartKPIs').toDataURL("image/png");

  const win = window.open("", "_blank");
  const html = `
  <!doctype html><html><head><meta charset="utf-8"/>
  <title>Executive PDF – Gantt v${VERSION}</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;color:#111827}
    h1{margin:0 0 6px 0;font-size:20px}
    .muted{color:#6b7280;font-size:12px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;margin:16px 0}
    .card{border:1px solid #e5e7eb;border-radius:14px;padding:12px}
    img{width:100%;height:auto;display:block}
    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:12px}
    th,td{border:1px solid #e5e7eb;padding:8px;vertical-align:top}
    th{background:#f8fafc;text-align:left}
    .rtl{direction:rtl;text-align:right}
  </style></head><body>
    <h1 class="rtl">Executive Summary – Ghana Energy CERT (Gantt)</h1>
    <div class="muted rtl">הופק: ${escapeHtml(ts)} · מקור: ${escapeHtml(appState.source)} · גרסה: ${VERSION}</div>

    <div class="grid">
      <div class="card">
        <div class="rtl" style="font-weight:900;margin-bottom:6px">משימות לפי קטגוריה</div>
        <img src="${c1}"/>
      </div>
      <div class="card">
        <div class="rtl" style="font-weight:900;margin-bottom:6px">משימות לפי Owner</div>
        <img src="${c2}"/>
      </div>
      <div class="card" style="grid-column: span 2">
        <div class="rtl" style="font-weight:900;margin-bottom:6px">KPIs</div>
        <img src="${c3}"/>
      </div>
    </div>

    <div class="card">
      <div class="rtl" style="font-weight:900;margin-bottom:6px">טבלת משימות (לפי הפילטר הנוכחי)</div>
      <table>
        <thead><tr>
          <th>#</th><th>Task</th><th>Owner</th><th>Phase</th><th>Start</th><th>End</th><th>Deps</th><th>Milestone</th>
        </tr></thead>
        <tbody>
          ${list.map(t=>`
            <tr>
              <td>${escapeHtml(t.id)}</td>
              <td class="rtl">${escapeHtml(t.name||"")}</td>
              <td>${escapeHtml(t.owner||"")}</td>
              <td>${escapeHtml(t.phase||"")}</td>
              <td>${escapeHtml(t.start||"")}</td>
              <td>${escapeHtml(t.end||"")}</td>
              <td>${escapeHtml(t.deps||"")}</td>
              <td>${t.milestone?"YES":"NO"}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
      <div class="muted rtl" style="margin-top:10px">הפקת PDF: File → Print → Save as PDF</div>
    </div>

    <script>window.onload=()=>setTimeout(()=>window.print(),250);<\/script>
  </body></html>`;
  win.document.open(); win.document.write(html); win.document.close();
  log("Opened PDF export window (print to PDF).");
}

/* =======================
   GitHub Settings + API
======================= */
function getGitCfg(){
  try{
    const raw = localStorage.getItem(STORE_KEY_GIT);
    if (!raw) return {owner:"", repo:"", branch:"main", path:"tasks.csv", token:""};
    const j = JSON.parse(raw);
    return {
      owner: String(j.owner||"").trim(),
      repo: String(j.repo||"").trim(),
      branch: String(j.branch||"main").trim() || "main",
      path: String(j.path||"tasks.csv").trim() || "tasks.csv",
      token: String(j.token||"").trim()
    };
  }catch(_){
    return {owner:"", repo:"", branch:"main", path:"tasks.csv", token:""};
  }
}
function setGitCfg(cfg){
  localStorage.setItem(STORE_KEY_GIT, JSON.stringify(cfg));
}
function openSettings(){
  const cfg = getGitCfg();
  document.getElementById('gitOwner').value = cfg.owner;
  document.getElementById('gitRepo').value = cfg.repo;
  document.getElementById('gitBranch').value = cfg.branch;
  document.getElementById('gitPath').value = cfg.path;
  document.getElementById('gitToken').value = cfg.token;
  document.getElementById('setBack').classList.add('open');
}
function closeSettings(){
  document.getElementById('setBack').classList.remove('open');
}
function utf8ToB64(str){
  // handle unicode safely
  return btoa(unescape(encodeURIComponent(str)));
}
function b64ToUtf8(b64){
  return decodeURIComponent(escape(atob(b64)));
}

async function loadFromGit(){
  const cfg = getGitCfg();
  if (!cfg.owner || !cfg.repo){
    alert("חסרים owner/repo. פתח Settings והגדר.");
    openSettings();
    return;
  }
  const rawUrl = `https://raw.githubusercontent.com/${cfg.owner}/${cfg.repo}/${cfg.branch}/${cfg.path}`;
  log(`Load from Git: trying RAW ${rawUrl}`);

  try{
    const res = await fetch(rawUrl, {cache:"no-store"});
    if (!res.ok) throw new Error(`RAW fetch failed: ${res.status}`);
    const text = await res.text();
    await loadCSVTextIntoApp(text, "Git");
    log(`Loaded from RAW successfully (${text.length} chars).`);
    return;
  }catch(err){
    log(`RAW failed: ${err?.message || err}`);
  }

  // Fallback to API if token exists
  if (!cfg.token){
    alert("טעינה RAW נכשלה ואין Token לטעינת API. אם ה-Repo פרטי — הוסף Token ב-Settings.");
    return;
  }

  const apiUrl = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.path}?ref=${encodeURIComponent(cfg.branch)}`;
  log(`Load from Git: trying API ${apiUrl}`);

  const res = await fetch(apiUrl, {
    headers: {
      "Accept": "application/vnd.github+json",
      "Authorization": `token ${cfg.token}`
    }
  });

  if (!res.ok){
    const t = await res.text().catch(()=> "");
    log(`API load failed: ${res.status} ${t}`);
    alert("טעינה מה-API נכשלה. פתח Debug/Logs לפרטים.");
    return;
  }
  const js = await res.json();
  if (!js.content){
    log("API load missing content field.");
    alert("API החזיר תשובה בלי content.");
    return;
  }
  const text = b64ToUtf8(js.content.replace(/\n/g,""));
  await loadCSVTextIntoApp(text, "Git");
  log(`Loaded from API successfully (${text.length} chars).`);
}

async function saveToGit(){
  const cfg = getGitCfg();
  if (!cfg.owner || !cfg.repo){
    alert("חסרים owner/repo. פתח Settings והגדר.");
    openSettings();
    return;
  }
  if (!cfg.token){
    alert("כדי לשמור ל-Git צריך Token. פתח Settings והדבק Token.");
    openSettings();
    return;
  }

  const apiGet = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.path}?ref=${encodeURIComponent(cfg.branch)}`;
  log(`Save to Git: GET current file for SHA ${apiGet}`);

  let sha = null;
  try{
    const resGet = await fetch(apiGet, {
      headers:{
        "Accept":"application/vnd.github+json",
        "Authorization":`token ${cfg.token}`
      }
    });
    if (resGet.ok){
      const js = await resGet.json();
      sha = js.sha || null;
      log(`Found existing file SHA: ${sha || "none"}`);
    } else {
      log(`GET for SHA returned ${resGet.status} (file may not exist yet)`);
    }
  }catch(e){
    log(`GET SHA error: ${e?.message || e}`);
  }

  const csvNoBom = buildCSVText(false);
  const contentB64 = utf8ToB64(csvNoBom);

  const apiPut = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.path}`;
  log(`Save to Git: PUT ${apiPut}`);

  const body = {
    message: `Update tasks.csv via Gantt v${VERSION} (${new Date().toISOString()})`,
    content: contentB64,
    branch: cfg.branch
  };
  if (sha) body.sha = sha;

  const resPut = await fetch(apiPut, {
    method:"PUT",
    headers:{
      "Accept":"application/vnd.github+json",
      "Authorization":`token ${cfg.token}`,
      "Content-Type":"application/json"
    },
    body: JSON.stringify(body)
  });

  if (!resPut.ok){
    const t = await resPut.text().catch(()=> "");
    log(`PUT failed: ${resPut.status} ${t}`);
    alert("שמירה ל-Git נכשלה. פתח Debug/Logs לפרטים.");
    return;
  }

  const jsPut = await resPut.json();
  log(`PUT success. Commit: ${jsPut?.commit?.sha || "n/a"}`);

  appState.source = "Git";
  appState.lastSaveAt = new Date().toLocaleString();
  setDirty(false);
  refreshStatus();
  alert("✅ נשמר בהצלחה ל-GitHub.");
}

async function loadCSVTextIntoApp(text, sourceName){
  const rows = parseCSV(text);
  const tasks = rows.map(coerceTask).filter(t=>t && t.id);
  if (!tasks.length){
    alert("הקובץ נטען אבל לא נמצאו משימות. ודא שה-CSV כולל כותרות ונתונים.");
    log("LoadCSV: 0 tasks after parsing.");
    return;
  }
  ALL = tasks.map(t=>({...t}));
  persistAllToLocal();
  rebuildOwnerOptions(ALL);

  appState.source = sourceName || "Git";
  appState.lastLoadAt = new Date().toLocaleString();
  setDirty(false);
  render();
}

/* =======================
   Task editor (modal)
======================= */
function openEditor(id){
  const t = findTask(id);
  if (!t) return;

  appState.openEditorId = String(id);

  document.getElementById('edTitle').textContent = `עריכת משימה #${t.id}`;
  document.getElementById('edId').value = String(t.id);
  document.getElementById('edName').value = t.name || "";
  document.getElementById('edPhase').value = t.phase || "";
  document.getElementById('edOwner').value = t.owner || "";
  document.getElementById('edStart').value = t.start || "";
  document.getElementById('edEnd').value = t.end || "";
  document.getElementById('edOffset').value = Number(t.startOffset||0);
  document.getElementById('edDur').value = Number(t.duration||1);
  document.getElementById('edMs').value = t.milestone ? "1":"0";
  document.getElementById('edNotes').value = t.notes || "";

  // Build dependencies list with checkboxes
  buildDepsCheckboxes(String(t.id), String(t.deps||""));

  // Show modal
  document.getElementById('edBack').classList.add('open');
  document.getElementById('depSearch').value = "";
  document.getElementById('edName').focus();
}

function closeEditor(){
  document.getElementById('edBack').classList.remove('open');
  appState.openEditorId = null;
}

function buildDepsCheckboxes(currentId, depsStr){
  const depsSelected = uniqNums(String(depsStr||"").split(/[,\s]+/).map(x=>Number(x)).filter(Boolean));
  const setSel = new Set(depsSelected.map(String));

  const wrap = document.getElementById('depsList');
  wrap.innerHTML = "";

  const list = ALL
    .filter(x=>String(x.id)!==String(currentId))
    .sort((a,b)=>Number(a.id)-Number(b.id));

  list.forEach(task=>{
    const row = document.createElement('div');
    row.className = "depItem";

    const cb = document.createElement('input');
    cb.type = "checkbox";
    cb.value = String(task.id);
    cb.checked = setSel.has(String(task.id));

    const lab = document.createElement('label');
    lab.innerHTML = `
      <div><b>#${escapeHtml(task.id)}</b> · ${escapeHtml(task.name||"")}</div>
      <small>${escapeHtml(task.owner||"—")} · ${escapeHtml(task.phase||"—")}</small>
    `;

    cb.addEventListener('change', ()=> syncDepsFromCheckboxes());
    row.appendChild(cb);
    row.appendChild(lab);
    wrap.appendChild(row);
  });

  syncDepsFromCheckboxes();
}

function syncDepsFromCheckboxes(){
  const wrap = document.getElementById('depsList');
  const cbs = Array.from(wrap.querySelectorAll('input[type=checkbox]'));
  const selected = uniqNums(cbs.filter(cb=>cb.checked).map(cb=>Number(cb.value)));
  const str = selected.length ? selected.join(",") : "";
  document.getElementById('edDeps').value = str;
  document.getElementById('depsPreview').textContent = str || "—";
}

function filterDepsList(){
  const q = (document.getElementById('depSearch').value||"").toLowerCase().trim();
  const items = Array.from(document.querySelectorAll('#depsList .depItem'));
  items.forEach(it=>{
    const txt = it.textContent.toLowerCase();
    it.style.display = (!q || txt.includes(q)) ? "" : "none";
  });
}

function saveEditor(){
  const id = document.getElementById('edId').value;
  const t = findTask(id);
  if (!t) return;

  t.name  = document.getElementById('edName').value.trim();
  t.phase = document.getElementById('edPhase').value.trim();
  t.owner = document.getElementById('edOwner').value.trim();
  t.notes = document.getElementById('edNotes').value.trim();
  t.milestone = document.getElementById('edMs').value === "1";

  // Dates and offsets syncing (simple and correct)
  const start = document.getElementById('edStart').value;
  const end   = document.getElementById('edEnd').value;
  const off   = Number(document.getElementById('edOffset').value || 0);
  const dur   = Number(document.getElementById('edDur').value || 1);

  // Priority: if user picked dates, use them; else offsets
  if (start && end){
    t.start = start; t.end = end;
    offsetsFromDates(t);
  } else {
    t.startOffset = clamp(off,0,100000);
    t.duration = clamp(dur,1,100000);
    calcDatesFromOffsets(t);
  }

  // Deps from checkboxes
  t.deps = document.getElementById('edDeps').value.trim();

  persistOne(t);
  persistAllToLocal();
  rebuildOwnerOptions(ALL);

  setDirty(true);
  closeEditor();
  render();
  log(`Saved task #${t.id} from editor.`);
}

function duplicateTask(){
  const id = appState.openEditorId;
  const t = findTask(id);
  if (!t) return;

  const nid = nextId();
  const copy = {...t};
  copy.id = nid;
  copy.name = (copy.name||"").trim() ? (copy.name + " (Copy)") : `Task ${nid}`;
  // Keep offsets/duration; deps blank by default
  copy.deps = "";
  ALL.push(copy);
  persistAllToLocal();
  rebuildOwnerOptions(ALL);
  setDirty(true);
  closeEditor();
  render();
  openEditor(nid);
  log(`Duplicated task #${id} -> #${nid}`);
}

function deleteTask(){
  const id = appState.openEditorId;
  const t = findTask(id);
  if (!t) return;

  if (!confirm(`למחוק משימה #${t.id}?`)) return;

  ALL = ALL.filter(x=>String(x.id)!==String(id));

  // Remove this id from other deps
  ALL.forEach(x=>{
    const deps = String(x.deps||"").split(/[,\s]+/).map(s=>s.trim()).filter(Boolean);
    const filtered = deps.filter(d=>String(d)!==String(id));
    x.deps = filtered.join(",");
    persistOne(x);
  });

  persistAllToLocal();
  rebuildOwnerOptions(ALL);
  setDirty(true);
  closeEditor();
  render();
  log(`Deleted task #${id}`);
}

/* =======================
   Create new task
======================= */
function createNewTask(){
  const id = nextId();
  const t = {
    id,
    phase:"",
    name:"משימה חדשה",
    owner:"",
    startOffset:0,
    duration:7,
    deps:"",
    milestone:false,
    notes:""
  };
  calcDatesFromOffsets(t);
  ALL.push(t);
  persistOne(t);
  rebuildOwnerOptions(ALL);
  setDirty(true);
  render();
  openEditor(id);
  log(`Created new task #${id}`);
}

/* =======================
   Menus + UI wiring
======================= */
function closeAllMenus(){
  document.getElementById('fileMenu').classList.remove('open');
  document.getElementById('advMenu').classList.remove('open');
}
document.addEventListener('click', (e)=>{
  const fileDD = document.getElementById('fileDD');
  const advDD  = document.getElementById('advDD');
  if (!fileDD.contains(e.target)) document.getElementById('fileMenu').classList.remove('open');
  if (!advDD.contains(e.target))  document.getElementById('advMenu').classList.remove('open');
});

document.getElementById('fileBtn').addEventListener('click', ()=>{
  const m = document.getElementById('fileMenu');
  m.classList.toggle('open');
  document.getElementById('advMenu').classList.remove('open');
});
document.getElementById('advBtn').addEventListener('click', ()=>{
  const m = document.getElementById('advMenu');
  m.classList.toggle('open');
  document.getElementById('fileMenu').classList.remove('open');
});

document.getElementById('miLoadGit').addEventListener('click', ()=>{ closeAllMenus(); loadFromGit(); });
document.getElementById('miSaveGit').addEventListener('click', ()=>{ closeAllMenus(); saveToGit(); });
document.getElementById('miPdf').addEventListener('click', ()=>{ closeAllMenus(); exportManagerPDF(); });
document.getElementById('miExportCsv').addEventListener('click', ()=>{ closeAllMenus(); exportCSV(); });
document.getElementById('miImportCsv').addEventListener('click', ()=>{ closeAllMenus(); document.getElementById('importFile').click(); });

document.getElementById('importFile').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0];
  if (!f) return;
  await importCSVFromFile(f);
  e.target.value = "";
});

document.getElementById('saveNow').addEventListener('click', ()=> saveToGit());
document.getElementById('newTask').addEventListener('click', ()=> createNewTask());

document.getElementById('miSettings').addEventListener('click', ()=>{ closeAllMenus(); openSettings(); });
document.getElementById('miTemplate').addEventListener('click', ()=>{ closeAllMenus(); downloadTemplate(); });
document.getElementById('miClearLocal').addEventListener('click', ()=>{ closeAllMenus(); clearLocalCache(); });
document.getElementById('miDebug').addEventListener('click', ()=>{ closeAllMenus(); document.getElementById('logBack').classList.add('open'); });
document.getElementById('miOnboard').addEventListener('click', ()=>{ closeAllMenus(); showOnboarding(true); });

document.getElementById('logClose').addEventListener('click', ()=> document.getElementById('logBack').classList.remove('open'));
document.getElementById('logCopy').addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText(document.getElementById('logArea').value); alert("הועתק."); }catch(_){ alert("לא ניתן להעתיק בדפדפן זה."); }
});
document.getElementById('logClear').addEventListener('click', ()=>{ document.getElementById('logArea').value=""; });

document.getElementById('setClose').addEventListener('click', closeSettings);
document.getElementById('setSave').addEventListener('click', ()=>{
  const cfg = {
    owner: document.getElementById('gitOwner').value.trim(),
    repo: document.getElementById('gitRepo').value.trim(),
    branch: document.getElementById('gitBranch').value.trim() || "main",
    path: document.getElementById('gitPath').value.trim() || "tasks.csv",
    token: document.getElementById('gitToken').value.trim()
  };
  setGitCfg(cfg);
  closeSettings();
  log("Saved GitHub settings.");
  alert("✅ Settings נשמרו.");
});
document.getElementById('setTest').addEventListener('click', ()=> loadFromGit());

/* Legend toggle */
document.getElementById('toggleLegend').addEventListener('click', ()=>{
  const p = document.getElementById('legendPanel');
  p.classList.toggle('open');
  document.getElementById('toggleLegend').textContent = p.classList.contains('open') ? "מקרא צבעים ▴" : "מקרא צבעים ▾";
});
document.getElementById('legendClose').addEventListener('click', ()=>{
  document.getElementById('legendPanel').classList.remove('open');
  document.getElementById('toggleLegend').textContent = "מקרא צבעים ▾";
});
document.getElementById('legendSearch').addEventListener('input', ()=> rebuildLegend(filteredList()));

/* Filters */
document.getElementById('q').addEventListener('input', ()=> render());
document.getElementById('ownerFilter').addEventListener('change', ()=> render());
document.getElementById('zoom').addEventListener('change', ()=> render());

/* Editor wiring */
document.getElementById('edClose').addEventListener('click', closeEditor);
document.getElementById('edCancel').addEventListener('click', closeEditor);
document.getElementById('edSave').addEventListener('click', saveEditor);
document.getElementById('edDuplicate').addEventListener('click', duplicateTask);
document.getElementById('edDelete').addEventListener('click', deleteTask);

document.getElementById('depSearch').addEventListener('input', filterDepsList);
document.getElementById('depAll').addEventListener('click', ()=>{
  Array.from(document.querySelectorAll('#depsList input[type=checkbox]')).forEach(cb=> cb.checked=true);
  syncDepsFromCheckboxes();
});
document.getElementById('depNone').addEventListener('click', ()=>{
  Array.from(document.querySelectorAll('#depsList input[type=checkbox]')).forEach(cb=> cb.checked=false);
  syncDepsFromCheckboxes();
});

/* Date/offset sync in editor (simple, correct) */
document.getElementById('edStart').addEventListener('change', ()=>{
  // If both dates set, update offsets/duration
  const start = document.getElementById('edStart').value;
  const end = document.getElementById('edEnd').value;
  if (start && end){
    const tmp = {start, end};
    offsetsFromDates(tmp);
    document.getElementById('edOffset').value = tmp.startOffset;
    document.getElementById('edDur').value = tmp.duration;
  }
});
document.getElementById('edEnd').addEventListener('change', ()=>{
  const start = document.getElementById('edStart').value;
  const end = document.getElementById('edEnd').value;
  if (start && end){
    const tmp = {start, end};
    offsetsFromDates(tmp);
    document.getElementById('edOffset').value = tmp.startOffset;
    document.getElementById('edDur').value = tmp.duration;
  }
});
document.getElementById('edOffset').addEventListener('change', ()=>{
  const off = Number(document.getElementById('edOffset').value || 0);
  const dur = Number(document.getElementById('edDur').value || 1);
  const tmp = {startOffset:off, duration:dur};
  calcDatesFromOffsets(tmp);
  document.getElementById('edStart').value = tmp.start;
  document.getElementById('edEnd').value = tmp.end;
});
document.getElementById('edDur').addEventListener('change', ()=>{
  const off = Number(document.getElementById('edOffset').value || 0);
  const dur = Number(document.getElementById('edDur').value || 1);
  const tmp = {startOffset:off, duration:dur};
  calcDatesFromOffsets(tmp);
  document.getElementById('edStart').value = tmp.start;
  document.getElementById('edEnd').value = tmp.end;
});

/* Keyboard shortcuts */
document.addEventListener('keydown', (e)=>{
  const editorOpen = document.getElementById('edBack').classList.contains('open');
  if (e.key === "Escape"){
    if (editorOpen) closeEditor();
    if (document.getElementById('logBack').classList.contains('open')) document.getElementById('logBack').classList.remove('open');
    if (document.getElementById('setBack').classList.contains('open')) closeSettings();
    if (document.getElementById('onBack').classList.contains('open')) hideOnboarding();
    closeAllMenus();
  }
  if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="s"){
    if (editorOpen){
      e.preventDefault();
      saveEditor();
    }
  }
});

/* =======================
   Onboarding (3 steps)
======================= */
let onboardStep = 0;
const onboardSteps = [
  {
    title:"1) חיפוש וסינון",
    body:`השתמש בשורת החיפוש, Owner ו-Zoom כדי להגיע מהר למידע. המסך הראשי נשאר נקי ומקצועי.`
  },
  {
    title:"2) עריכת משימה",
    body:`לחץ על משימה (בר/שורה) כדי לפתוח חלון עריכה מקצועי. בתלויות יש Checkbox נוח לסימון כמה תלויות.`
  },
  {
    title:"3) פרסום ל-GitHub",
    body:`בחר <b>קובץ ▾</b> → Load/Save. טעינה מ-Repo ציבורי תעבוד לכולם גם בלי Token. שמירה דורשת Token (למורשים בלבד).`
  }
];
function showOnboarding(force){
  const done = localStorage.getItem(STORE_KEY_ONBOARD)==="1";
  if (done && !force) return;
  onboardStep = 0;
  renderOnboarding();
  document.getElementById('onBack').classList.add('open');
}
function hideOnboarding(){
  document.getElementById('onBack').classList.remove('open');
}
function renderOnboarding(){
  const s = onboardSteps[onboardStep];
  document.getElementById('onBody').innerHTML = `
    <div style="font-weight:900;margin-bottom:8px;direction:rtl;text-align:right">${s.title}</div>
    <div style="direction:rtl;text-align:right;color:#374151;line-height:1.5">${s.body}</div>
  `;
  document.getElementById('onPrev').disabled = onboardStep===0;
  document.getElementById('onNext').textContent = onboardStep===onboardSteps.length-1 ? "סיים" : "הבא";
}
document.getElementById('onClose').addEventListener('click', hideOnboarding);
document.getElementById('onPrev').addEventListener('click', ()=>{ onboardStep=Math.max(0,onboardStep-1); renderOnboarding(); });
document.getElementById('onNext').addEventListener('click', ()=>{
  if (onboardStep===onboardSteps.length-1){
    if (document.getElementById('onDont').checked){
      localStorage.setItem(STORE_KEY_ONBOARD,"1");
    }
    hideOnboarding();
  } else {
    onboardStep++;
    renderOnboarding();
  }
});

/* =======================
   Init
======================= */
refreshStatus();
render();
showOnboarding(false);
log(`App started. Version ${VERSION}.`);
</script>
</body>
</html>
