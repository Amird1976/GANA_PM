<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gantt CERT Professional - סינכרון עם GitHub</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/he.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root {
    --primary-color: #2563eb;
    --secondary-color: #7c3aed;
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --danger-color: #ef4444;
    --dark-color: #111827;
    --light-color: #f9fafb;
    --border-color: #e5e7eb;
    --card-bg: #ffffff;
    --sidebar-width: 380px;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Segoe UI', 'Microsoft YaHei', system-ui, -apple-system, sans-serif;
    background: linear-gradient(135deg, #f6f7fb 0%, #f0f4ff 100%);
    color: var(--dark-color);
    line-height: 1.6;
    min-height: 100vh;
    direction: rtl;
    overflow-x: hidden;
  }

  /* Header */
  .app-header {
    background: linear-gradient(to right, var(--dark-color), #1f2937);
    color: white;
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    position: sticky;
    top: 0;
    z-index: 1000;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo i {
    font-size: 1.8rem;
    color: var(--primary-color);
  }

  .logo h1 {
    font-size: 1.4rem;
    font-weight: 700;
  }

  .logo-subtitle {
    font-size: 0.85rem;
    opacity: 0.8;
    margin-top: 2px;
  }

  .header-actions {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  /* Main Layout */
  .app-container {
    display: flex;
    min-height: calc(100vh - 70px);
    overflow: hidden;
  }

  .sidebar {
    width: var(--sidebar-width);
    background: var(--card-bg);
    border-left: 1px solid var(--border-color);
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
  }

  .sidebar-content {
    flex: 1;
    overflow-y: auto;
    padding-right: 5px;
  }

  /* Scrollbar Styling */
  .sidebar-content::-webkit-scrollbar,
  .task-list::-webkit-scrollbar,
  .timeline-scroll::-webkit-scrollbar,
  .modal-body::-webkit-scrollbar {
    width: 8px;
  }

  .sidebar-content::-webkit-scrollbar-track,
  .task-list::-webkit-scrollbar-track,
  .timeline-scroll::-webkit-scrollbar-track,
  .modal-body::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
  }

  .sidebar-content::-webkit-scrollbar-thumb,
  .task-list::-webkit-scrollbar-thumb,
  .timeline-scroll::-webkit-scrollbar-thumb,
  .modal-body::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
  }

  .sidebar-content::-webkit-scrollbar-thumb:hover,
  .task-list::-webkit-scrollbar-thumb:hover,
  .timeline-scroll::-webkit-scrollbar-thumb:hover,
  .modal-body::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }

  .main-content {
    flex: 1;
    padding: 1.5rem;
    overflow: auto;
    min-width: 0;
  }

  /* Cards */
  .card {
    background: var(--card-bg);
    border-radius: 12px;
    border: 1px solid var(--border-color);
    padding: 1.25rem;
    margin-bottom: 1.25rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    transition: box-shadow 0.2s;
  }

  .card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }

  .card-title {
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 1rem;
    color: var(--dark-color);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* Buttons */
  .btn {
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
    white-space: nowrap;
  }

  .btn-primary {
    background: var(--primary-color);
    color: white;
  }

  .btn-primary:hover {
    background: #1d4ed8;
    transform: translateY(-1px);
  }

  .btn-success {
    background: var(--success-color);
    color: white;
  }

  .btn-success:hover {
    background: #0da271;
  }

  .btn-warning {
    background: var(--warning-color);
    color: white;
  }

  .btn-warning:hover {
    background: #d97706;
  }

  .btn-danger {
    background: var(--danger-color);
    color: white;
  }

  .btn-danger:hover {
    background: #dc2626;
  }

  .btn-outline {
    background: transparent;
    color: var(--dark-color);
    border: 1px solid var(--border-color);
  }

  .btn-outline:hover {
    background: var(--light-color);
  }

  .btn-sm {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
  }

  .btn-group {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  /* Form Controls */
  .form-group {
    margin-bottom: 1rem;
  }

  .form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    font-size: 0.9rem;
  }

  .form-control {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 0.95rem;
    transition: border-color 0.2s;
    font-family: inherit;
  }

  .form-control:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .form-control-sm {
    padding: 0.5rem;
    font-size: 0.85rem;
  }

  /* Search and Filter */
  .search-box {
    position: relative;
  }

  .search-box i {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
  }

  .search-box input {
    padding-right: 40px;
  }

  .filter-section {
    display: flex;
    gap: 12px;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  /* Timeline */
  .timeline-container {
    background: white;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    overflow: hidden;
    margin-top: 1rem;
    position: relative;
  }

  .timeline-header {
    background: #f8fafc;
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .timeline-scroll {
    overflow-x: auto;
    overflow-y: auto;
    padding: 1rem;
    position: relative;
    min-height: 600px;
    max-height: 70vh;
  }

  .timeline-grid {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    pointer-events: none;
    z-index: 1;
  }

  .timeline-day {
    border-right: 1px solid #e5e7eb;
    height: 100%;
    position: relative;
    flex-shrink: 0;
  }

  .timeline-day.month-start {
    border-right: 2px solid #94a3b8;
  }

  .timeline-day-label {
    position: absolute;
    top: -25px;
    width: 100%;
    text-align: center;
    font-size: 0.75rem;
    color: #64748b;
    white-space: nowrap;
  }

  /* Task Bars */
  .task-bar {
    height: 32px;
    margin: 4px 0;
    border-radius: 6px;
    position: absolute;
    cursor: grab;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    padding: 0 12px;
    color: white;
    font-size: 0.8rem;
    font-weight: 500;
    overflow: hidden;
    z-index: 5;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    min-width: 20px;
  }

  .task-bar:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    z-index: 20;
  }

  .task-bar.milestone {
    width: 32px !important;
    height: 32px;
    border-radius: 50%;
    transform: translateX(-50%) rotate(45deg);
    display: flex;
    align-items: center;
    justify-content: center;
    background: #8b5cf6 !important;
  }

  .task-bar.milestone:hover {
    transform: translateX(-50%) rotate(45deg) scale(1.1);
  }

  .task-bar.milestone .task-label {
    transform: rotate(-45deg);
    font-weight: bold;
  }

  .task-bar.dragging {
    cursor: grabbing;
    opacity: 0.9;
    z-index: 100;
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
  }

  .task-bar .task-label {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
    font-size: 0.75rem;
  }

  .task-bar .task-id {
    background: rgba(0,0,0,0.2);
    padding: 1px 6px;
    border-radius: 10px;
    font-size: 0.7rem;
    margin-right: 6px;
    font-weight: bold;
  }

  .task-row {
    height: 40px;
    position: relative;
    border-bottom: 1px solid #f1f5f9;
  }

  .task-row:hover {
    background: #f8fafc;
  }

  /* Dependency Lines */
  .dependency-line {
    position: absolute;
    pointer-events: none;
    z-index: 1;
    stroke: #64748b;
    stroke-width: 2;
    fill: none;
    marker-end: url(#arrowhead);
  }

  /* Task List */
  .task-list {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-top: 1rem;
  }

  .task-item {
    padding: 12px;
    border-bottom: 1px solid #f1f5f9;
    cursor: pointer;
    transition: background 0.2s;
    display: flex;
    justify-content: space-between;
    align-items: center;
    min-height: 60px;
  }

  .task-item:hover {
    background: #f8fafc;
  }

  .task-item.selected {
    background: #eff6ff;
    border-right: 3px solid var(--primary-color);
  }

  .task-item .task-info h4 {
    font-size: 0.95rem;
    margin-bottom: 4px;
    font-weight: 600;
    line-height: 1.3;
  }

  .task-item .task-meta {
    font-size: 0.8rem;
    color: #6b7280;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .task-item .task-actions {
    opacity: 0;
    transition: opacity 0.2s;
    display: flex;
    gap: 8px;
  }

  .task-item:hover .task-actions {
    opacity: 1;
  }

  /* Charts */
  .charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 1.25rem;
    margin-bottom: 1.5rem;
  }

  @media (max-width: 1200px) {
    .charts-grid {
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }
  }

  .chart-container {
    height: 240px;
    position: relative;
  }

  /* Status Messages */
  .alert {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .alert-success {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #a7f3d0;
  }

  .alert-warning {
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fde68a;
  }

  .alert-error {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fecaca;
  }

  .alert-info {
    background: #dbeafe;
    color: #1e40af;
    border: 1px solid #bfdbfe;
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(2px);
    z-index: 2000;
    align-items: center;
    justify-content: center;
  }

  .modal.active {
    display: flex;
  }

  .modal-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 700px;
    max-height: 90vh;
    overflow-y: auto;
    animation: modalSlideIn 0.3s ease;
    box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
  }

  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    background: white;
    z-index: 10;
    border-radius: 12px 12px 0 0;
  }

  .modal-body {
    padding: 1.5rem;
    max-height: 60vh;
    overflow-y: auto;
  }

  .modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    position: sticky;
    bottom: 0;
    background: white;
    border-radius: 0 0 12px 12px;
  }

  .close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #6b7280;
    line-height: 1;
    padding: 4px;
    border-radius: 4px;
  }

  .close-btn:hover {
    background: #f3f4f6;
  }

  /* GitHub Integration */
  .github-status {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: #f3f4f6;
    border-radius: 8px;
    font-size: 0.85rem;
    white-space: nowrap;
  }

  .github-status.connected {
    background: #d1fae5;
    color: #065f46;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .app-container {
      flex-direction: column;
    }
    
    .sidebar {
      width: 100%;
      border-left: none;
      border-bottom: 1px solid var(--border-color);
      max-height: 50vh;
    }
    
    .sidebar-content {
      max-height: calc(50vh - 3rem);
    }
    
    .charts-grid {
      grid-template-columns: 1fr;
    }
    
    .timeline-scroll {
      min-height: 400px;
    }
  }

  @media (max-width: 768px) {
    .app-header {
      flex-direction: column;
      gap: 1rem;
      text-align: center;
    }
    
    .header-actions {
      width: 100%;
      justify-content: center;
    }
    
    .btn-group {
      justify-content: center;
    }
    
    .modal-content {
      width: 95%;
      max-width: 95%;
    }
  }

  /* Loading Animation */
  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Toast Notifications */
  .toast-container {
    position: fixed;
    bottom: 20px;
    left: 20px;
    z-index: 3000;
  }

  .toast {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    animation: toastSlideIn 0.3s ease;
    max-width: 400px;
    direction: rtl;
  }

  @keyframes toastSlideIn {
    from {
      opacity: 0;
      transform: translateX(-100%);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  /* Progress Bar */
  .progress-bar {
    height: 6px;
    background: #e5e7eb;
    border-radius: 3px;
    overflow: hidden;
    margin: 1rem 0;
  }

  .progress-fill {
    height: 100%;
    background: var(--primary-color);
    transition: width 0.3s ease;
  }

  /* Stats Cards */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
  }

  .stat-card {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 10px;
    padding: 1rem;
    text-align: center;
    border: 1px solid #e2e8f0;
    min-width: 0;
  }

  .stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 0.5rem;
  }

  .stat-label {
    font-size: 0.9rem;
    color: #64748b;
  }

  /* Color Palette for Phases */
  .phase-1 { background-color: #3b82f6; }
  .phase-2 { background-color: #8b5cf6; }
  .phase-3 { background-color: #10b981; }
  .phase-4 { background-color: #f59e0b; }
  .phase-5 { background-color: #ef4444; }
  .phase-6 { background-color: #06b6d4; }
  .phase-7 { background-color: #84cc16; }
  .phase-8 { background-color: #f97316; }
  .phase-9 { background-color: #8b5cf6; }
  .phase-10 { background-color: #ec4899; }
  .phase-11 { background-color: #14b8a6; }
  .phase-12 { background-color: #f43f5e; }
  .phase-13 { background-color: #6366f1; }

  /* Legend */
  .legend {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin: 1rem 0;
    max-height: 150px;
    overflow-y: auto;
    padding: 10px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: #f8fafc;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.8rem;
    padding: 4px 8px;
    background: #ffffff;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
    min-width: 120px;
  }

  .legend-color {
    width: 12px;
    height: 12px;
    border-radius: 3px;
    flex-shrink: 0;
  }

  /* Zoom Controls */
  .zoom-controls {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #f8fafc;
    padding: 6px 12px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    flex-wrap: wrap;
  }

  .zoom-controls button {
    background: white;
    border: 1px solid #d1d5db;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
  }

  .zoom-controls button:hover {
    background: #f3f4f6;
    border-color: #9ca3af;
  }

  /* Tooltip */
  .tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
    z-index: 1000;
    pointer-events: none;
    white-space: nowrap;
    max-width: 300px;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: #6b7280;
  }

  .empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: #d1d5db;
  }

  /* Timeline Container Scrollbar */
  .timeline-scroll::-webkit-scrollbar {
    height: 10px;
  }

  .timeline-scroll::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 5px;
  }

  .timeline-scroll::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 5px;
  }

  .timeline-scroll::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }

  /* Task Row Container */
  .tasks-container {
    position: relative;
    min-height: 40px;
  }

  /* Dependency SVG Layer */
  #dependencyLayer {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 2;
  }

  /* View Controls */
  .view-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
    padding: 10px;
    background: #f8fafc;
    border-radius: 8px;
    margin-bottom: 1rem;
  }

  /* Debug Panel */
  .debug-panel {
    background: #1f2937;
    color: white;
    padding: 10px;
    border-radius: 6px;
    font-family: monospace;
    font-size: 12px;
    max-height: 200px;
    overflow-y: auto;
    margin-top: 10px;
  }

  .debug-panel.hidden {
    display: none;
  }

  /* Loading Overlay */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(2px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 5000;
    flex-direction: column;
    gap: 20px;
  }

  .loading-overlay.hidden {
    display: none;
  }

  /* Task Editor Grid */
  .task-editor-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
  }

  /* Compact View */
  .compact .task-item {
    padding: 8px 12px;
    min-height: 50px;
  }

  .compact .task-item .task-info h4 {
    font-size: 0.85rem;
  }

  .compact .task-item .task-meta {
    font-size: 0.75rem;
  }

  .task-group { border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 10px; overflow: hidden; background:#fff; }
  .task-group-header { width:100%; border:0; background:#f8fafc; padding:10px 12px; display:flex; align-items:center; justify-content:space-between; cursor:pointer; font-weight:700; }
  .task-group-header:hover { background:#f1f5f9; }
  .task-group-body { padding: 8px; }
  .task-group-caret { font-size: 0.9rem; width: 18px; text-align:center; color:#334155; }

</style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay hidden" id="loadingOverlay">
    <div class="loading"></div>
    <div id="loadingMessage">טוען נתונים</div>
  </div>

  <!-- Header -->
  <header class="app-header">
    <div class="logo">
      <i class="fas fa-project-diagram"></i>
      <div>
        <h1>Gantt CERT Professional</h1>
        <div class="logo-subtitle">גרסה 15 | ניהול פרויקט Ghana Energy CERT - Amir Davidi Technologies</div>
      </div>
    </div>
    <div class="header-actions">
      <div class="github-status" id="githubStatus">
        <i class="fab fa-github"></i>
        <span>לא מחובר ל-GitHub</span>
      </div>
      <button class="btn btn-outline" id="settingsBtn">
        <i class="fas fa-cog"></i> הגדרות
      </button>
      <button class="btn btn-warning btn-sm" id="debugBtn">
        <i class="fas fa-bug"></i> דיבאג
      </button>
    </div>
  </header>

  <!-- Main Container -->
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-content">
        <!-- Search -->
        <div class="card">
          <div class="form-group">
            <label class="form-label">חיפוש משימות</label>
            <div class="search-box">
              <input type="text" id="searchInput" class="form-control" placeholder="חפש לפי שם, אחראי או קטגוריה">
              <i class="fas fa-search"></i>
            </div>
          </div>
        </div>

        <!-- Filters -->
        <div class="card">
          <div class="card-header" style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <h3 class="card-title" style="margin:0;"><i class="fas fa-tasks"></i> רשימת משימות <small>(<span id="taskListCount">0</span>)</small></h3>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn btn-outline btn-sm" id="expandAllTasksBtn" title="הצג את כל הקבוצות"><i class="fas fa-plus-square"></i> הצג הכל</button>
            <button class="btn btn-outline btn-sm" id="collapseAllTasksBtn" title="כווץ את כל הקבוצות"><i class="fas fa-minus-square"></i> כווץ הכל</button>
          </div>
        </div>
        <div class="task-list" id="taskList">
          <!-- Tasks will be populated here -->
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- View Controls -->
      <div class="view-controls">
        <div class="zoom-controls">
          <button id="zoomOutBtn" title="הקטן">
            <i class="fas fa-search-minus"></i>
          </button>
          <span id="zoomLevel">100%</span>
          <button id="zoomInBtn" title="הגדל">
            <i class="fas fa-search-plus"></i>
          </button>
          <select id="timelineView" class="form-control form-control-sm">
            <option value="week">שבועי</option>
            <option value="month" selected>חודשי</option>
            <option value="quarter">רבעוני</option>
            <option value="year">שנתי</option>
          </select>
          <select id="pixelsPerDay" class="form-control form-control-sm">
            <option value="5">5px ליום</option>
            <option value="10">10px ליום</option>
            <option value="20" selected>20px ליום</option>
            <option value="30">30px ליום</option>
            <option value="40">40px ליום</option>
          </select>
        </div>
        <button class="btn btn-outline btn-sm" id="fitToScreenBtn">
          <i class="fas fa-expand"></i> התאם למסך
        </button>
        <button class="btn btn-outline btn-sm" id="showTodayBtn">
          <i class="fas fa-calendar-day"></i> הצג היום
        </button>
      </div>

      <!-- Charts Dashboard -->
      <div class="charts-grid">
        <div class="card">
          <h3 class="card-title"><i class="fas fa-chart-pie"></i> משימות לפי קטגוריה</h3>
          <div class="chart-container">
            <canvas id="categoryChart"></canvas>
          </div>
        </div>
        <div class="card">
          <h3 class="card-title"><i class="fas fa-chart-bar"></i> משימות לפי אחראי</h3>
          <div class="chart-container">
            <canvas id="ownerChart"></canvas>
          </div>
        </div>
        <div class="card">
          <h3 class="card-title"><i class="fas fa-chart-line"></i> סטטוס פרויקט</h3>
          <div class="chart-container">
            <canvas id="timelineChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Stats -->
      <div class="card">
        <h3 class="card-title"><i class="fas fa-chart-area"></i> מדדים וסטטיסטיקות</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalTasks">0</div>
            <div class="stat-label">סה"כ משימות</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="milestonesCount">0</div>
            <div class="stat-label">אבני דרך</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="activeTasks">0</div>
            <div class="stat-label">משימות פעילות</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="dependenciesCount">0</div>
            <div class="stat-label">קשרי תלות</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="tasksWithDeps">0</div>
            <div class="stat-label">משימות עם תלות</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="avgDuration">0</div>
            <div class="stat-label">ממוצע ימים</div>
          </div>
        </div>
      </div>

      <!-- Timeline -->
      <div class="card timeline-container">
        <div class="timeline-header">
          <h3 class="card-title"><i class="fas fa-calendar-alt"></i> ציר זמן אינטראקטיבי</h3>
          <div style="display: flex; align-items: center; gap: 10px;">
            <span id="timelineRange" style="font-size: 0.85rem; color: #64748b;">טווח תאריכים: טוען</span>
            <button class="btn btn-outline btn-sm" id="exportTimelineBtn">
              <i class="fas fa-image"></i> שמור כתמונה
            </button>
          </div>
        </div>
        <div class="timeline-scroll" id="timelineScroll">
          <div id="timelineGrid" class="timeline-grid"></div>
          <svg id="dependencyLayer"></svg>
          <div id="barsContainer" class="tasks-container">
            <!-- Task bars will be rendered here -->
          </div>
        </div>
        <div style="padding: 10px; border-top: 1px solid var(--border-color); background: #f8fafc; font-size: 0.8rem; color: #64748b;">
          <i class="fas fa-info-circle"></i> גרור משימות לשינוי תאריכים | לחץ פעמיים לעריכה | השתמש בגלגלת העכבר לגלילה
        </div>
      </div>
    </main>
  </div>

  <!-- Modals -->
  <!-- GitHub Settings Modal -->
  <div class="modal" id="githubModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fab fa-github"></i> הגדרות GitHub</h2>
        <button class="close-btn" onclick="closeModal('githubModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          <div>
            <strong>הערה חשובה:</strong> יש צורך ב-GitHub Token עם הרשאות repo כדי לעדכן את הקובץ ב-GitHub.
            ניתן ליצור token ב-GitHub > Settings > Developer settings > Personal access tokens
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">GitHub Token</label>
          <input type="password" id="githubToken" class="form-control" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
          <small style="color: #6b7280; display: block; margin-top: 4px;">Token עם הרשאות repo נדרש</small>
        </div>
        <div class="task-editor-grid">
          <div class="form-group">
            <label class="form-label">Repository Owner</label>
            <input type="text" id="repoOwner" class="form-control" placeholder="Amird1976" value="Amird1976">
          </div>
          <div class="form-group">
            <label class="form-label">Repository Name</label>
            <input type="text" id="repoName" class="form-control" placeholder="GANA_PM" value="GANA_PM">
          </div>
          <div class="form-group">
            <label class="form-label">Branch</label>
            <input type="text" id="repoBranch" class="form-control" value="main" placeholder="main">
          </div>
          <div class="form-group">
            <label class="form-label">נתיב לקובץ CSV</label>
            <input type="text" id="filePath" class="form-control" value="tasks.csv" placeholder="tasks.csv">
          </div>
        </div>
        <div class="alert alert-warning" id="githubTestResult" style="display: none;">
          <i class="fas fa-exclamation-triangle"></i>
          <div id="githubTestMessage"></div>
        </div>
        <div class="form-group">
          <div class="progress-bar">
            <div class="progress-fill" id="uploadProgress" style="width: 0%"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('githubModal')">ביטול</button>
        <button class="btn btn-success" onclick="testGitHubConnection()">
          <i class="fas fa-plug"></i> בדוק חיבור
        </button>
        <button class="btn btn-primary" onclick="saveGitHubSettings()">
          <i class="fas fa-save"></i> שמור הגדרות
        </button>
      </div>
    </div>
  </div>

  <!-- Task Editor Modal -->
  <div class="modal" id="taskModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-edit"></i> עריכת משימה</h2>
        <button class="close-btn" onclick="closeModal('taskModal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="taskForm">
          <div class="task-editor-grid">
            <div class="form-group">
              <label class="form-label">מספר משימה *</label>
              <input type="text" id="taskId" class="form-control" required>
            </div>
            <div class="form-group">
              <label class="form-label">שם משימה *</label>
              <input type="text" id="taskName" class="form-control" required>
            </div>
            <div class="form-group">
              <label class="form-label">קטגוריה/שלב</label>
              <input type="text" id="taskPhase" class="form-control">
            </div>
            <div class="form-group">
              <label class="form-label">אחראי</label>
              <input type="text" id="taskOwner" class="form-control">
            </div>
            <div class="form-group">
              <label class="form-label">תאריך התחלה</label>
              <input type="date" id="taskStart" class="form-control">
            </div>
            <div class="form-group">
              <label class="form-label">תאריך סיום</label>
              <input type="date" id="taskEnd" class="form-control">
            </div>
            <div class="form-group">
              <label class="form-label">משך (ימים)</label>
              <input type="number" id="taskDuration" class="form-control" min="1" value="1">
            </div>
            <div class="form-group">
              <label class="form-label">Start Offset (ימים)</label>
              <input type="number" id="taskStartOffset" class="form-control" min="0" value="0">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">תלויות (מסיפים מופרדים בפסיק)</label>
            <input type="text" id="taskDeps" class="form-control" placeholder="1,2,3">
          </div>
          <div class="form-group">
            <label class="form-label">הערות</label>
            <textarea id="taskNotes" class="form-control" rows="3"></textarea>
          </div>
          <div class="task-editor-grid">
            <div class="form-group">
              <label class="form-label">סטטוס</label>
              <select id="taskStatus" class="form-control">
                <option value="not-started">לא התחיל</option>
                <option value="in-progress">בתהליך</option>
                <option value="completed">הושלם</option>
              </select>
            </div>
            <div class="form-group" style="display: flex; align-items: center; gap: 10px; padding-top: 20px;">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="taskMilestone" style="width: 18px; height: 18px;">
                <span>אבן דרך</span>
              </label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="deleteTask()" id="deleteTaskBtn" style="display: none;">
          <i class="fas fa-trash"></i> מחק
        </button>
        <button class="btn btn-outline" onclick="closeModal('taskModal')">ביטול</button>
        <button class="btn btn-primary" onclick="saveTask()">
          <i class="fas fa-save"></i> שמור משימה
        </button>
      </div>
    </div>
  </div>

  <!-- Debug Modal -->
  <div class="modal" id="debugModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-bug"></i> פאנל דיבאג</h2>
        <button class="close-btn" onclick="closeModal('debugModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="debug-panel" id="debugPanel">
          <div>=== מערכת Gantt Debug ===</div>
          <div id="debugContent"></div>
        </div>
        <div class="btn-group" style="margin-top: 1rem;">
          <button class="btn btn-outline btn-sm" onclick="clearDebug()">
            <i class="fas fa-trash"></i> נקה
          </button>
          <button class="btn btn-outline btn-sm" onclick="exportDebug()">
            <i class="fas fa-download"></i> ייצא
          </button>
          <button class="btn btn-outline btn-sm" onclick="testCSVParsing()">
            <i class="fas fa-file-csv"></i> בדוק CSV
          </button>
          <button class="btn btn-outline btn-sm" onclick="forceReload()">
            <i class="fas fa-redo"></i> טען מחדש
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script>
    // ===== GLOBAL VARIABLES =====
    const STORAGE_KEYS = {
      TASKS: 'gantt_tasks_v5',
      GITHUB_SETTINGS: 'github_settings_v4',
      UI_SETTINGS: 'ui_settings_v2'
    };

    // ===== UTF-8 safe Base64 decode (GitHub content) =====
    function base64ToUtf8(base64) {
      const clean = (base64 || '').replace(/\s/g, '');
      const binStr = atob(clean);
      const bytes = new Uint8Array(binStr.length);
      for (let i = 0; i < binStr.length; i++) bytes[i] = binStr.charCodeAt(i);
      return new TextDecoder('utf-8').decode(bytes);
    }


    const COLORS = {
      phases: [
        '#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444',
        '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#14b8a6',
        '#f43f5e', '#6366f1', '#8b5cf6', '#10b981', '#f59e0b'
      ],
      status: {
        'not-started': '#6b7280',
        'in-progress': '#3b82f6',
        'completed': '#10b981'
      }
    };

    let tasks = [];
    let filteredTasks = [];
    let currentZoom = 1.0;
    let selectedTaskId = null;
    let githubSettings = null;
    let chartInstances = {};
    let GH_SHA = null;
    let PIXELS_PER_DAY = 20;
    let MIN_DATE = null;
    let MAX_DATE = null;
    let isCompactView = false;
    let debugLogs = [];
    let flatpickrInstances = {};
    let isInitialized = false;
    let collapsedPhases = {}; // phase -> boolean


    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', function() {
      // המתן מעט לטעינת כל הספריות
      setTimeout(initApp, 100);
    });

    async function initApp() {
      if (isInitialized) return;
      
      showLoading('מאתחל מערכת');
      
      try {
        // המתן לספריות חיצוניות
        await waitForLibraries();
        
        // טען נתונים
        loadTasks();
        loadGitHubSettings();
        loadUISettings();
        
        // אתחול UI
        initDatePickers();
        initEventListeners();
        updateDashboard();
        updateGitHubStatus();
        
        // הגדר את zoom מינימום ל-10%
        currentZoom = Math.max(0.1, currentZoom);
        document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
        
        // טען אוטומטית מ-GitHub אם יש הגדרות
        if (githubSettings && githubSettings.token) {
          setTimeout(async () => {
            try {
              await loadFromGitHub();
            } catch (error) {
              console.log('טעינה אוטומטית מ-GitHub נכשלה, המשך עם נתונים מקומיים');
              logDebug(`טעינה אוטומטית נכשלה: ${error.message}`);
            }
          }, 1500);
        } else {
          // הצג הודעת ברוך הבא
          setTimeout(() => {
            if (tasks.length === 0) {
              showToast('ברוך הבא! הגדר את חיבור ה-GitHub כדי לטעון משימות קיימות.', 'info');
            }
          }, 1000);
        }
        
        isInitialized = true;
        logDebug('המערכת אותחלה בהצלחה');
        
      } catch (error) {
        console.error('שגיאה קריטית באתחול:', error);
        showToast('שגיאה באתחול המערכת. נסה לרענן את הדף.', 'error');
        logDebug(`שגיאת אתחול: ${error.message}`);
      } finally {
        setTimeout(() => {
          hideLoading();
        }, 500);
      }
    }

    // ===== LOADING FUNCTIONS =====
    function showLoading(message = 'טוען') {
      const overlay = document.getElementById('loadingOverlay');
      const messageEl = document.getElementById('loadingMessage');
      messageEl.textContent = message;
      overlay.classList.remove('hidden');
    }

    function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      overlay.classList.add('hidden');
    }

    // ===== LIBRARY WAIT FUNCTIONS =====
    function waitForLibraries() {
      return new Promise((resolve) => {
        const checkLibraries = () => {
          const hasFlatpickr = window.flatpickr !== undefined;
          const hasChartJS = window.Chart !== undefined;
          
          if (hasFlatpickr && hasChartJS) {
            logDebug('כל הספריות נטענו');
            resolve();
          } else {
            logDebug(`מחכה לספריות Flatpickr: ${hasFlatpickr}, Chart.js: ${hasChartJS}`);
            setTimeout(checkLibraries, 100);
          }
        };
        checkLibraries();
      });
    }

    function initDatePickers() {
      try {
        if (!window.flatpickr) {
          logDebug('Flatpickr לא זמין, דילוג על אתחול תאריכים');
          return;
        }
        
        // הגדר את השפה העברית
        if (flatpickr.l10ns && flatpickr.l10ns.he) {
          flatpickr.localize(flatpickr.l10ns.he);
        }
        
        const today = new Date();
        const defaultStart = new Date(today);
        defaultStart.setDate(defaultStart.getDate() + 1);
        const defaultEnd = new Date(defaultStart);
        defaultEnd.setDate(defaultEnd.getDate() + 30);
        
        // אתחול datepicker לתאריך התחלה
        const startInput = document.getElementById('taskStart');
        if (startInput) {
          flatpickrInstances.start = flatpickr(startInput, {
            dateFormat: 'Y-m-d',
            locale: 'he',
            defaultDate: formatDate(defaultStart),
            allowInput: true,
            onChange: function(selectedDates, dateStr) {
              // עדכון אוטומטי של תאריך הסיום
              const endPicker = flatpickrInstances.end;
              if (endPicker && selectedDates[0]) {
                const endDate = new Date(selectedDates[0]);
                const duration = parseInt(document.getElementById('taskDuration').value) || 1;
                endDate.setDate(endDate.getDate() + duration);
                endPicker.setDate(endDate);
              }
            }
          });
        }
        
        // אתחול datepicker לתאריך סיום
        const endInput = document.getElementById('taskEnd');
        if (endInput) {
          flatpickrInstances.end = flatpickr(endInput, {
            dateFormat: 'Y-m-d',
            locale: 'he',
            defaultDate: formatDate(defaultEnd),
            allowInput: true
          });
        }
        
        logDebug('Datepickers אותחלו בהצלחה');
      } catch (error) {
        console.error('שגיאה באתחול datepickers:', error);
        logDebug(`שגיאת datepicker: ${error.message}`);
      }
    }

    // ===== TASK MANAGEMENT =====
    function loadTasks() {
      try {
        const saved = localStorage.getItem(STORAGE_KEYS.TASKS);
        if (saved) {
          tasks = JSON.parse(saved);
          logDebug(`נטענו ${tasks.length} משימות מהזיכרון המקומי`);
        } else {
          // נתוני דוגמה אם אין נתונים שמורים
          tasks = [
            {
              id: '1',
              name: 'פגישת קיק-אוף',
              phase: '1. Management',
              owner: 'צוות יעוץ',
              start: '2026-01-05',
              end: '2026-01-07',
              duration: 2,
              deps: '',
              notes: 'פגישת פתיחה רשמית',
              startOffset: 0,
              milestone: true,
              status: 'not-started'
            },
            {
              id: '2',
              name: 'ניתוח צרכים',
              phase: '1.1 Admin',
              owner: 'צוות טכני',
              start: '2026-01-08',
              end: '2026-01-15',
              duration: 7,
              deps: '1',
              notes: 'ניתוח צרכים טכניים וארגוניים',
              startOffset: 3,
              milestone: false,
              status: 'in-progress'
            }
          ];
          logDebug('יצרנו נתוני דוגמה כי אין משימות שמורות');
        }
        filteredTasks = [tasks];
      } catch (error) {
        console.error('שגיאה בטעינת משימות:', error);
        tasks = [];
        filteredTasks = [];
        logDebug(`שגיאת טעינת משימות: ${error.message}`);
      }
    }

    function saveTasks() {
      try {
        localStorage.setItem(STORAGE_KEYS.TASKS, JSON.stringify(tasks));
        logDebug(`נשמרו ${tasks.length} משימות לזיכרון מקומי`);
      } catch (error) {
        console.error('שגיאה בשמירת משימות:', error);
        showToast('שגיאה בשמירת המשימות', 'error');
      }
    }

    // ===== GITHUB INTEGRATION =====
    function loadGitHubSettings() {
      try {
        const saved = localStorage.getItem(STORAGE_KEYS.GITHUB_SETTINGS);
        if (saved) {
          githubSettings = JSON.parse(saved);
          
          // עדכן שדות במודל
          document.getElementById('githubToken').value = githubSettings.token || '';
          document.getElementById('repoOwner').value = githubSettings.owner || 'Amird1976';
          document.getElementById('repoName').value = githubSettings.repo || 'GANA_PM';
          document.getElementById('repoBranch').value = githubSettings.branch || 'main';
          document.getElementById('filePath').value = githubSettings.filePath || 'tasks.csv';
          
          logDebug('הגדרות GitHub נטענו מהזיכרון');
        } else {
          githubSettings = null;
          logDebug('אין הגדרות GitHub שמורות');
        }
      } catch (error) {
        console.error('שגיאה בטעינת הגדרות GitHub:', error);
        githubSettings = null;
      }
    }

    function loadUISettings() {
      try {
        const saved = localStorage.getItem(STORAGE_KEYS.UI_SETTINGS);
        if (saved) {
          const uiSettings = JSON.parse(saved);
          currentZoom = Math.max(0.1, uiSettings.zoom || 1.0); // מינימום 10%
          PIXELS_PER_DAY = uiSettings.pixelsPerDay || 20;
          isCompactView = uiSettings.compactView || false;
          
          document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
          document.getElementById('pixelsPerDay').value = PIXELS_PER_DAY;
          
          if (isCompactView) {
            document.getElementById('taskList').classList.add('compact');
            document.getElementById('compactViewBtn').innerHTML = '<i class="fas fa-expand"></i> תצוגה מלאה';
          }
        }
      } catch (error) {
        console.error('שגיאה בטעינת הגדרות UI:', error);
      }
    }

    function saveUISettings() {
      try {
        const uiSettings = {
          zoom: currentZoom,
          pixelsPerDay: PIXELS_PER_DAY,
          compactView: isCompactView
        };
        localStorage.setItem(STORAGE_KEYS.UI_SETTINGS, JSON.stringify(uiSettings));
      } catch (error) {
        console.error('שגיאה בשמירת הגדרות UI:', error);
      }
    }

    async function saveGitHubSettings() {
      const settings = {
        token: document.getElementById('githubToken').value.trim(),
        owner: document.getElementById('repoOwner').value.trim(),
        repo: document.getElementById('repoName').value.trim(),
        branch: document.getElementById('repoBranch').value.trim() || 'main',
        filePath: document.getElementById('filePath').value.trim() || 'tasks.csv'
      };
      
      if (!settings.token || !settings.owner || !settings.repo) {
        showToast('נא למלא את כל שדות החובה', 'error');
        return;
      }

      try {
        localStorage.setItem(STORAGE_KEYS.GITHUB_SETTINGS, JSON.stringify(settings));
        githubSettings = settings;
        closeModal('githubModal');
        updateGitHubStatus();
        showToast('הגדרות GitHub נשמרו בהצלחה', 'success');
        
        // נסה לטעון נתונים אוטומטית
        setTimeout(() => {
          loadFromGitHub();
        }, 500);
        
      } catch (error) {
        console.error('שגיאה בשמירת הגדרות GitHub:', error);
        showToast('שגיאה בשמירת ההגדרות', 'error');
      }
    }

    async function loadFromGitHub() {
      if (!githubSettings || !githubSettings.token) {
        showToast('נא להגדיר את פרטי GitHub תחילה', 'warning');
        document.getElementById('settingsBtn').click();
        return;
      }

      showLoading('טוען נתונים מ-GitHub');
      
      try {
        const { token, owner, repo, branch, filePath } = githubSettings;
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(filePath)}?ref=${branch}`;
        
        logDebug(`שולח בקשה ל-GitHub: ${url}`);
        
        const response = await fetch(url, {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });

        logDebug(`תגובת GitHub: ${response.status} ${response.statusText}`);
        
        if (!response.ok) {
          if (response.status === 404) {
            throw new Error(`הקובץ ${filePath} לא נמצא ב-repository`);
          } else if (response.status === 401 || response.status === 403) {
            throw new Error('Token לא תקין או חסר הרשאות');
          } else {
            const errorText = await response.text();
            throw new Error(`שגיאה ${response.status}: ${errorText.substring(0, 100)}`);
          }
        }

        const data = await response.json();
        GH_SHA = data.sha;
        
        // פענוח תוכן (UTF-8 בטוח לעברית)
        const base64Content = (data.content || '').replace(/\s/g, '');
        let content = '';
        try {
          content = base64ToUtf8(base64Content);
        } catch (e) {
          // fallback ASCII (למקרה נדיר)
          try { content = atob(base64Content); } catch (e2) { content = ''; }
        }
// הסר BOM אם קיים
        if (content.charCodeAt(0) === 0xFEFF) {
          content = content.substring(1);
        }
        
        logDebug(`קובץ CSV נטען: ${content.length} תווים`);
        
        // פענוח CSV
        const parsedTasks = parseCSVWithHebrewHeaders(content);
        logDebug(`פענוח CSV: ${parsedTasks.length} משימות נמצאו`);
        
        if (parsedTasks.length > 0) {
          tasks = parsedTasks;
          
          // איפוס פילטרים להצגת כל המשימות
          resetFilters();
          
          // שמירה ועדכון
          saveTasks();
          showToast(`✅ נטענו ${tasks.length} משימות בהצלחה מ-GitHub!`, 'success');
          updateGitHubStatus('connected', `מחובר - ${tasks.length} משימות`);
          
        } else {
          showToast('הקובץ ריק או בפורמט לא תקין', 'warning');
        }
        
      } catch (error) {
        console.error('❌ שגיאה בטעינת נתונים:', error);
        showToast(`שגיאה בטעינת נתונים: ${error.message}`, 'error');
        logDebug(`שגיאה: ${error.message}`);
      } finally {
        hideLoading();
      }
    }

    async function saveToGitHub() {
      if (!githubSettings) {
        showToast('נא להגדיר את פרטי GitHub תחילה', 'warning');
        document.getElementById('settingsBtn').click();
        return;
      }

      showLoading('שומר ל-GitHub');
      
      try {
        // קבל SHA נוכחי אם אין לנו
        if (!GH_SHA) {
          await getCurrentSHA();
        }
        
        // המרת משימות ל-CSV
        const csvContent = convertTasksToCSV();
        const encodedContent = btoa(unescape(encodeURIComponent(csvContent)));
        
        const { token, owner, repo, branch, filePath } = githubSettings;
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(filePath)}`;
        
        const payload = {
          message: `Gantt Update: ${new Date().toLocaleString('he-IL')}`,
          content: encodedContent,
          branch: branch
        };
        
        if (GH_SHA) {
          payload.sha = GH_SHA;
        }
        
        logDebug(`שומר ל-GitHub: ${tasks.length} משימות`);
        
        const response = await fetch(url, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          const result = await response.json();
          GH_SHA = result.content.sha;
          showToast('✅ הנתונים נשמרו בהצלחה ל-GitHub!', 'success');
          updateGitHubStatus('connected', 'מחובר ומעודכן');
          logDebug('שמירה ל-GitHub הצליחה');
        } else {
          const errorData = await response.json();
          throw new Error(errorData.message || 'שגיאה בשמירה ל-GitHub');
        }
        
      } catch (error) {
        console.error('שגיאה בשמירה ל-GitHub:', error);
        showToast(`שגיאה בשמירה: ${error.message}`, 'error');
        logDebug(`שגיאת שמירה: ${error.message}`);
      } finally {
        hideLoading();
      }
    }

    async function getCurrentSHA() {
      if (!githubSettings) return;
      
      try {
        const { token, owner, repo, branch, filePath } = githubSettings;
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(filePath)}?ref=${branch}`;
        
        const response = await fetch(url, {
          headers: {
            'Authorization': `token ${token}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          GH_SHA = data.sha;
          logDebug(`SHA נוכחי: ${GH_SHA}`);
        }
      } catch (error) {
        logDebug('לא ניתן לקבל SHA נוכחי');
      }
    }

    async function testGitHubConnection() {
      const token = document.getElementById('githubToken').value.trim();
      const owner = document.getElementById('repoOwner').value.trim();
      const repo = document.getElementById('repoName').value.trim();
      
      if (!token || !owner || !repo) {
        showToast('נא למלא את כל השדות הדרושים', 'error');
        return;
      }
      
      showLoading('בודק חיבור ל-GitHub');
      
      try {
        const testResult = document.getElementById('githubTestResult');
        const testMessage = document.getElementById('githubTestMessage');
        
        // בדיקת גישה ל-repository
        const repoUrl = `https://api.github.com/repos/${owner}/${repo}`;
        const response = await fetch(repoUrl, {
          headers: {
            'Authorization': `token ${token}`
          }
        });
        
        if (response.ok) {
          // בדיקת גישה לקובץ
          const filePath = document.getElementById('filePath').value.trim() || 'tasks.csv';
          const fileUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(filePath)}`;
          const fileResponse = await fetch(fileUrl, {
            headers: {
              'Authorization': `token ${token}`
            }
          });
          
          if (fileResponse.ok) {
            testResult.className = 'alert alert-success';
            testResult.style.display = 'flex';
            testMessage.innerHTML = `<strong>✅ חיבור תקין!</strong><br>המערכת יכולה לגשת ל-Repository ולקובץ.`;
            showToast('החיבור ל-GitHub תקין!', 'success');
          } else if (fileResponse.status === 404) {
            testResult.className = 'alert alert-warning';
            testResult.style.display = 'flex';
            testMessage.innerHTML = `<strong>⚠️ הקובץ לא נמצא</strong><br>החיבור ל-Repository תקין אבל הקובץ ${filePath} לא נמצא. המערכת תנסה ליצור אותו בעת השמירה הראשונה.`;
            showToast('הקובץ לא נמצא, ייווצר בעת השמירה', 'warning');
          } else {
            throw new Error('לא ניתן לגשת לקובץ');
          }
        } else {
          throw new Error('לא ניתן להתחבר ל-Repository');
        }
        
      } catch (error) {
        const testResult = document.getElementById('githubTestResult');
        const testMessage = document.getElementById('githubTestMessage');
        testResult.className = 'alert alert-error';
        testResult.style.display = 'flex';
        testMessage.innerHTML = `<strong>❌ שגיאה בחיבור</strong><br>${error.message}`;
        showToast(`שגיאה בחיבור: ${error.message}`, 'error');
      } finally {
        hideLoading();
      }
    }

    // ===== CSV PARSING AND GENERATION =====
   function parseCSVWithHebrewHeaders(csvString) {
    if (!csvString || csvString.trim().length === 0) {
        logDebug("שגיאה: מחרוזת ה-CSV ריקה");
        return [];
    }
    
    // ניקוי תווים בלתי נראים ותו ה-BOM של אקסל
    const cleanCsv = csvString.replace(/^\uFEFF/, '').trim();
    const lines = cleanCsv.split(/\r?\n/);
    
    if (lines.length < 2) {
        logDebug("שגיאה: הקובץ מכיל פחות מ-2 שורות");
        return [];
    }

    // פונקציה חכמה לפירוק שורה שתומכת במירכאות ופסיקים בתוך טקסט
    function splitCSVLine(line) {
        const result = [];
        let curVal = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            const nextChar = line[i + 1];
            if (char === '"' && inQuotes && nextChar === '"') {
                curVal += '"'; i++; 
            } else if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(curVal.trim());
                curVal = '';
            } else {
                curVal += char;
            }
        }
        result.push(curVal.trim());
        return result;
    }

    const headers = splitCSVLine(lines[0]);
    logDebug(`כותרות שזוהו: ${headers.join(' | ')}`);

    // מיפוי גמיש יותר - מחפש חלקי מילים כדי לא להיכשל על רווחים
    const findCol = (terms) => headers.findIndex(h => terms.some(t => h.includes(t)));

    const colMap = {
        id: findCol(['מזהה', 'ID']),
        phase: findCol(['קטגוריה', 'שלב', 'Phase']),
        name: findCol(['שם משימה', 'Task', 'Name']),
        owner: findCol(['אחראי', 'Owner']),
        start: findCol(['תאריך התחלה', 'Start']),
        end: findCol(['תאריך סיום', 'End']),
        duration: findCol(['משך', 'Duration']),
        deps: findCol(['תלויות', 'Predecessors']),
        notes: findCol(['הערות', 'Notes']),
        offset: findCol(['startOffset']),
        milestone: findCol(['milestone', 'אבן דרך'])
    };

    // בדיקה אם העמודות הקריטיות נמצאו
    if (colMap.id === -1 || colMap.name === -1) {
        logDebug("שגיאה: לא נמצאו עמודות חובה (מזהה או שם משימה)");
        return [];
    }

    const tasks = [];
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        const cols = splitCSVLine(line);
        if (cols.length < 2) continue;

        const id = cols[colMap.id];
        const name = cols[colMap.name];

        if (!id || !name) continue;

        tasks.push({
            id: id.toString().replace(/['"]/g, ''),
            phase: cols[colMap.phase] || 'כללי',
            name: name.replace(/^"|"$/g, ''), // ניקוי מירכאות עוטפות
            owner: cols[colMap.owner] || '',
            start: cols[colMap.start] || '',
            end: cols[colMap.end] || '',
            duration: parseInt(cols[colMap.duration]) || 1,
            dependencies: cols[colMap.deps] ? cols[colMap.deps].toString().split(/[,;]/).map(d => d.trim()).filter(d => d) : [],
            notes: cols[colMap.notes] || '',
            startOffset: parseInt(cols[colMap.offset]) || 0,
            milestone: String(cols[colMap.milestone]).toLowerCase() === 'true' || cols[colMap.milestone] === '1',
            status: 'not-started'
        });
    }

    logDebug(`פענוח הושלם: ${tasks.length} משימות נוצרו`);
    return tasks;
}
    function parseCSVLine(line) {
      const values = [];
      let current = '';
      let inQuotes = false;
      let quoteChar = '';
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if ((char === '"' || char === "'") && !inQuotes) {
          inQuotes = true;
          quoteChar = char;
        } else if (char === quoteChar && inQuotes) {
          if (i + 1 < line.length && line[i + 1] === quoteChar) {
            current += char;
            i++;
          } else {
            inQuotes = false;
          }
        } else if (char === ',' && !inQuotes) {
          values.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      
      values.push(current);
      return values;
    }

    function convertTasksToCSV() {
      const headers = ['מזהה', 'קטגוריה/שלב', 'שם משימה', 'אחראי', 'תאריך התחלה', 'תאריך סיום', 'משך (ימים)', 'תלויות', 'הערות', 'startOffset', 'milestone'];
      
      const escapeCSV = (value) => {
        if (value === null || value === undefined) return '';
        const stringValue = String(value);
        if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n') || stringValue.includes('\r')) {
          return '"' + stringValue.replace(/"/g, '""') + '"';
        }
        return stringValue;
      };
      
      const rows = tasks.map(task => [
        task.id,
        task.phase,
        task.name,
        task.owner,
        task.start,
        task.end,
        task.duration,
        task.deps,
        task.notes || '',
        task.startOffset || 0,
        task.milestone ? 'true' : ''
      ].map(escapeCSV).join(','));
      
      return [headers.join(','), rows].join('\n');
    }

    // ===== UI FUNCTIONS =====
    function updateGitHubStatus(status = 'disconnected', message = '') {
      const statusEl = document.getElementById('githubStatus');
      statusEl.className = 'github-status';
      
      if (githubSettings && githubSettings.token) {
        statusEl.classList.add('connected');
        statusEl.innerHTML = `
          <i class="fab fa-github"></i>
          <span>${message || `מחובר ל-${githubSettings.owner}/${githubSettings.repo}`}</span>
        `;
      } else {
        statusEl.innerHTML = `
          <i class="fab fa-github"></i>
          <span>לא מחובר ל-GitHub</span>
        `;
      }
    }

    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast alert-${type}`;
      
      const icon = type === 'success' ? 'check-circle' :
                   type === 'error' ? 'exclamation-circle' :
                   type === 'warning' ? 'exclamation-triangle' : 'info-circle';
      
      toast.innerHTML = `
        <i class="fas fa-${icon}"></i>
        <div>${message}</div>
        <button class="close-btn" onclick="this.parentElement.remove()">&times;</button>
      `;
      
      toastContainer.appendChild(toast);
      
      // הסרה אוטומטית
      setTimeout(() => {
        if (toast.parentElement) {
          toast.remove();
        }
      }, 5000);
    }

    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
      document.body.style.overflow = '';
    }

    // ===== EVENT LISTENERS =====
    function initEventListeners() {
      // כפתורי GitHub
      document.getElementById('settingsBtn').addEventListener('click', () => {
        openModal('githubModal');
      });

      document.getElementById('loadFromGitHubBtn').addEventListener('click', loadFromGitHub);
      document.getElementById('saveToGitHubBtn').addEventListener('click', saveToGitHub);
      document.getElementById('syncBtn').addEventListener('click', () => {
        loadFromGitHub();
        setTimeout(saveToGitHub, 1000);
      });

      // חיפוש וסינון
      document.getElementById('searchInput').addEventListener('input', filterTasks);
      document.getElementById('categoryFilter').addEventListener('change', filterTasks);
      document.getElementById('ownerFilter').addEventListener('change', filterTasks);
      document.getElementById('statusFilter').addEventListener('change', filterTasks);
      document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
      document.getElementById('showAllBtn').addEventListener('click', resetFilters);

      // פעולות משימה
      document.getElementById('addTaskBtn').addEventListener('click', addNewTask);
      document.getElementById('exportBtn').addEventListener('click', exportToCSV);
      document.getElementById('printBtn').addEventListener('click', printView);
      document.getElementById('compactViewBtn').addEventListener('click', toggleCompactView);
      document.getElementById('exportTimelineBtn').addEventListener('click', exportTimelineAsImage);

      // פקדי טיימליין
      document.getElementById('zoomInBtn').addEventListener('click', () => changeZoom(0.1));
      document.getElementById('zoomOutBtn').addEventListener('click', () => changeZoom(-0.1));
      document.getElementById('timelineView').addEventListener('change', renderTimeline);
      document.getElementById('pixelsPerDay').addEventListener('change', updatePixelsPerDay);
      document.getElementById('fitToScreenBtn').addEventListener('click', fitToScreen);
      document.getElementById('showTodayBtn').addEventListener('click', showToday);

      // דיבאג
      document.getElementById('debugBtn').addEventListener('click', showDebugPanel);
      document.getElementById('expandAllTasksBtn').addEventListener('click', () => { collapsedPhases = {}; updateTaskList(); });
      document.getElementById('collapseAllTasksBtn').addEventListener('click', () => { const keys = new Set(filteredTasks.map(t => (t.phase||'ללא קטגוריה').trim())); collapsedPhases = {}; keys.forEach(k => collapsedPhases[k]=true); updateTaskList(); });

      // אירועי חלון
      window.addEventListener('resize', debounce(() => {
        renderTimeline();
      }, 250));
      
      // תמיכה בגלגלת עכבר לזום
      document.getElementById('timelineScroll').addEventListener('wheel', function(e) {
        if (e.ctrlKey || e.metaKey) {
          e.preventDefault();
          const zoomDelta = e.deltaY > 0 ? -0.1 : 0.1;
          changeZoom(zoomDelta);
        }
      });
    }

    // ===== TASK FILTERING =====
    function filterTasks() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
      const category = document.getElementById('categoryFilter').value;
      const owner = document.getElementById('ownerFilter').value;
      const status = document.getElementById('statusFilter').value;

      logDebug(`סינון: חיפוש="${searchTerm}", קטגוריה="${category}", אחראי="${owner}", סטטוס="${status}"`);

      filteredTasks = tasks.filter(task => {
        if (!task || !task.id) return false;
        
        let match = true;
        
        // מונח חיפוש
        if (searchTerm) {
          const searchFields = [
            task.name || '',
            task.phase || '',
            task.owner || '',
            task.id || '',
            task.notes || ''
          ];
          
          if (!searchFields.some(field => field.toLowerCase().includes(searchTerm))) {
            match = false;
          }
        }
        
        // סינון קטגוריה
        if (match && category && task.phase !== category) {
          match = false;
        }
        
        // סינון אחראי
        if (match && owner && task.owner !== owner) {
          match = false;
        }
        
        // סינון סטטוס
        if (match && status && task.status !== status) {
          match = false;
        }
        
        return match;
      });

      logDebug(`סינון הושלם: ${filteredTasks.length} מתוך ${tasks.length} משימות`);
      
      // עדכון UI
      updateTaskList();
      renderTimeline();
      updateCharts();
      updateStats();
    }

    function clearFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('categoryFilter').value = '';
      document.getElementById('ownerFilter').value = '';
      document.getElementById('statusFilter').value = '';
      
      filterTasks();
      showToast('סינון נוקה', 'info');
    }

    function resetFilters() {
      filteredTasks = [tasks];
      logDebug(`איפוס סינון: ${filteredTasks.length} משימות זמינות`);
      
      updateTaskList();
      renderTimeline();
      updateCharts();
      updateStats();
      showToast('כל המשימות מוצגות', 'info');
    }

    // ===== TASK CRUD OPERATIONS =====
    function addNewTask() {
      selectedTaskId = null;
      document.getElementById('taskForm').reset();
      document.getElementById('deleteTaskBtn').style.display = 'none';
      
      // הגדר תאריכים ברירת מחדל
      const today = new Date();
      const startDate = new Date(today);
      startDate.setDate(startDate.getDate() + 1);
      const endDate = new Date(startDate);
      endDate.setDate(endDate.getDate() + 30);
      
      // עדכן את ה-datepickers
      if (flatpickrInstances.start) {
        flatpickrInstances.start.setDate(startDate);
      } else {
        document.getElementById('taskStart').value = formatDate(startDate);
      }
      
      if (flatpickrInstances.end) {
        flatpickrInstances.end.setDate(endDate);
      } else {
        document.getElementById('taskEnd').value = formatDate(endDate);
      }
      
      // צור מזהה חדש
      const maxId = tasks.length > 0 ? Math.max(tasks.map(t => parseInt(t.id) || 0)) : 0;
      document.getElementById('taskId').value = (maxId + 1).toString();
      
      openModal('taskModal');
    }

    function editTask(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) {
        showToast('משימה לא נמצאה', 'error');
        return;
      }

      selectedTaskId = taskId;
      
      // מלא טופס
      document.getElementById('taskId').value = task.id;
      document.getElementById('taskName').value = task.name;
      document.getElementById('taskPhase').value = task.phase;
      document.getElementById('taskOwner').value = task.owner;
      document.getElementById('taskStart').value = task.start;
      document.getElementById('taskEnd').value = task.end;
      document.getElementById('taskDuration').value = task.duration;
      document.getElementById('taskDeps').value = task.deps;
      document.getElementById('taskNotes').value = task.notes || '';
      document.getElementById('taskStartOffset').value = task.startOffset || 0;
      document.getElementById('taskMilestone').checked = task.milestone;
      document.getElementById('taskStatus').value = task.status || 'not-started';
      
      // עדכן datepickers
      if (flatpickrInstances.start && task.start) {
        flatpickrInstances.start.setDate(task.start);
      }
      
      if (flatpickrInstances.end && task.end) {
        flatpickrInstances.end.setDate(task.end);
      }
      
      document.getElementById('deleteTaskBtn').style.display = 'block';
      openModal('taskModal');
    }

    function saveTask() {
      const form = document.getElementById('taskForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const taskData = {
        id: document.getElementById('taskId').value.trim(),
        name: document.getElementById('taskName').value.trim(),
        phase: document.getElementById('taskPhase').value.trim(),
        owner: document.getElementById('taskOwner').value.trim(),
        start: document.getElementById('taskStart').value,
        end: document.getElementById('taskEnd').value,
        duration: parseInt(document.getElementById('taskDuration').value) || 1,
        deps: document.getElementById('taskDeps').value.trim(),
        notes: document.getElementById('taskNotes').value.trim(),
        startOffset: parseInt(document.getElementById('taskStartOffset').value) || 0,
        milestone: document.getElementById('taskMilestone').checked,
        status: document.getElementById('taskStatus').value
      };

      // חשב משך מתאריכים אם שניהם מסופקים
      if (taskData.start && taskData.end) {
        const startDate = new Date(taskData.start);
        const endDate = new Date(taskData.end);
        const diffTime = Math.abs(endDate - startDate);
        taskData.duration = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
      }

      if (selectedTaskId) {
        // עדכן משימה קיימת
        const index = tasks.findIndex(t => t.id === selectedTaskId);
        if (index !== -1) {
          tasks[index] = { tasks[index], taskData };
          logDebug(`משימה עודכנה: ${taskData.id} - ${taskData.name}`);
        }
      } else {
        // הוסף משימה חדשה
        tasks.push(taskData);
        logDebug(`משימה נוספה: ${taskData.id} - ${taskData.name}`);
      }

      saveTasks();
      resetFilters();
      closeModal('taskModal');
      showToast('המשימה נשמרה בהצלחה', 'success');
    }

    function deleteTask() {
      if (!selectedTaskId || !confirm('האם אתה בטוח שברצונך למחוק משימה זו?')) {
        return;
      }

      tasks = tasks.filter(t => t.id !== selectedTaskId);
      saveTasks();
      resetFilters();
      closeModal('taskModal');
      showToast('המשימה נמחקה בהצלחה', 'success');
    }

    // ===== RENDERING FUNCTIONS =====
    function updateTaskList() {
      const taskList = document.getElementById('taskList');
      const taskListCount = document.getElementById('taskListCount');

      taskList.innerHTML = '';
      taskListCount.textContent = filteredTasks.length;

      if (filteredTasks.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-state';
        emptyState.innerHTML = `
          <i class="fas fa-tasks"></i>
          <div style="margin-top: 10px;">אין משימות להצגה</div>
          <small style="color: #9ca3af;">נסה לשנות את פרמטרי הסינון</small>
        `;
        taskList.appendChild(emptyState);
        return;
      }

      // קיבוץ לפי קטגוריה/שלב
      const groups = new Map();
      filteredTasks.forEach(t => {
        const key = (t.phase || 'ללא קטגוריה').trim();
        if (!groups.has(key)) groups.set(key, []);
        groups.get(key).push(t);
      });

      // מיון קבוצות: לפי מספר בתחילת השם אם קיים
      const sortedKeys = Array.from(groups.keys()).sort((a, b) => {
        const na = parseFloat((a.match(/^(\d+(?:\.\d+)*)/) || [,''])[1]);
        const nb = parseFloat((b.match(/^(\d+(?:\.\d+)*)/) || [,''])[1]);
        if (!isNaN(na) && !isNaN(nb) && na !== nb) return na - nb;
        return a.localeCompare(b, 'he');
      });

      sortedKeys.forEach(phase => {
        const phaseTasks = groups.get(phase);

        const section = document.createElement('div');
        section.className = 'task-group';

        const header = document.createElement('button');
        header.type = 'button';
        header.className = 'task-group-header';
        const isCollapsed = !!collapsedPhases[phase];
        header.innerHTML = `
          <span style="display:flex; align-items:center; gap:8px;">
            <span class="task-group-caret">${isCollapsed ? '▶' : '▼'}</span>
            <span>${escapeHtml(phase)}</span>
          </span>
          <span style="display:flex; align-items:center; gap:10px; color:#64748b;">
            <span>${phaseTasks.length}</span>
          </span>
        `;
        header.onclick = () => {
          collapsedPhases[phase] = !collapsedPhases[phase];
          updateTaskList();
        };

        const body = document.createElement('div');
        body.className = 'task-group-body';
        body.style.display = isCollapsed ? 'none' : 'block';

        // מיון משימות בתוך קבוצה
        phaseTasks.sort((a, b) => (a.startDateObj?.getTime?.() || 0) - (b.startDateObj?.getTime?.() || 0));

        phaseTasks.forEach(task => {
          const taskItem = document.createElement('div');
          taskItem.className = `task-item ${selectedTaskId === task.id ? 'selected' : ''}`;
          taskItem.onclick = () => editTask(task.id);

          const statusColor = COLORS.status[task.status] || '#6b7280';
          const phaseColor = getPhaseColor(task.phase);

          taskItem.innerHTML = `
            <div class="task-info">
              <h4>${escapeHtml(task.name)}</h4>
              <div class="task-meta">
                <span class="badge" style="background:${phaseColor}20; color:${phaseColor}; border:1px solid ${phaseColor}40;">
                  ${escapeHtml(getPhaseLabel(task.phase))}
                </span>
                ${task.owner ? `<span class="badge" style="background:#eef2ff; color:#4f46e5;"><i class="fas fa-user"></i> ${escapeHtml(task.owner)}</span>` : ''}
                ${task.deps ? `<span class="badge" style="background:#f1f5f9; color:#334155;"><i class="fas fa-link"></i> ${escapeHtml(task.deps)}</span>` : ''}
              </div>
            </div>
            <div class="task-status" style="background:${statusColor}"></div>
          `;
          body.appendChild(taskItem);
        });

        section.appendChild(header);
        section.appendChild(body);
        taskList.appendChild(section);
      });
    }

      filteredTasks.forEach(task => {
        const taskItem = document.createElement('div');
        taskItem.className = `task-item ${selectedTaskId === task.id ? 'selected' : ''}`;
        taskItem.onclick = () => editTask(task.id);
        
        const statusColor = COLORS.status[task.status] || '#6b7280';
        const phaseColor = getPhaseColor(task.phase);
        
        taskItem.innerHTML = `
          <div class="task-info">
            <h4>${task.name}</h4>
            <div class="task-meta">
              <span><i class="fas fa-hashtag"></i> ${task.id}</span>
              <span><i class="fas fa-user"></i> ${task.owner || 'ללא אחראי'}</span>
              <span><i class="fas fa-layer-group"></i> ${task.phase || 'ללא קטגוריה'}</span>
              <span><i class="fas fa-calendar"></i> ${formatDisplayDate(task.start)}</span>
              ${task.milestone ? '<span><i class="fas fa-gem" style="color: #8b5cf6;"></i> אבן דרך</span>' : ''}
            </div>
          </div>
          <div class="task-actions">
            <span style="color: ${statusColor};" title="סטטוס: ${task.status}">
              <i class="fas fa-circle" style="font-size: 0.7rem;"></i>
            </span>
            <span style="background-color: ${phaseColor}; width: 12px; height: 12px; border-radius: 3px;" title="קטגוריה: ${task.phase}"></span>
            <i class="fas fa-edit" style="color: #6b7280;" title="ערוך משימה"></i>
          </div>
        `;
        
        taskList.appendChild(taskItem);
      });

      updateFilterOptions();
      updateLegend();
      updateVisibleStats();
    }

    function renderTimeline() {
      const timelineScroll = document.getElementById('timelineScroll');
      const timelineGrid = document.getElementById('timelineGrid');
      const barsContainer = document.getElementById('barsContainer');
      const timelineRange = document.getElementById('timelineRange');
      
      // נקה תוכן קודם
      timelineGrid.innerHTML = '';
      barsContainer.innerHTML = '';
      
      if (filteredTasks.length === 0) {
        timelineRange.textContent = 'אין משימות להצגה';
        return;
      }

      // חשב טווח תאריכים מהמשימות המסוננות
      const taskDates = filteredTasks.flatMap(task => {
        const dates = [];
        if (task.start) {
          const startDate = new Date(task.start);
          if (!isNaN(startDate.getTime())) dates.push(startDate);
        }
        if (task.end) {
          const endDate = new Date(task.end);
          if (!isNaN(endDate.getTime())) dates.push(endDate);
        }
        return dates;
      });
      
      if (taskDates.length === 0) {
        timelineRange.textContent = 'אין תאריכים זמינים';
        return;
      }
      
      MIN_DATE = new Date(Math.min(taskDates.map(d => d.getTime())));
      MAX_DATE = new Date(Math.max(taskDates.map(d => d.getTime())));
      
      // הוסף מרווח
      MIN_DATE.setDate(MIN_DATE.getDate() - 7);
      MAX_DATE.setDate(MAX_DATE.getDate() + 7);
      
      // חשב סך הכל ימים
      const totalDays = Math.ceil((MAX_DATE - MIN_DATE) / (1000 * 60 * 60 * 24));
      
      // הגדר רוחב מיכל
      const containerWidth = totalDays * PIXELS_PER_DAY * currentZoom;
      timelineScroll.style.minWidth = containerWidth + 'px';
      
      // צור רשת
      for (let i = 0; i <= totalDays; i++) {
        const currentDate = new Date(MIN_DATE);
        currentDate.setDate(currentDate.getDate() + i);
        
        const dayDiv = document.createElement('div');
        dayDiv.className = 'timeline-day';
        dayDiv.style.width = (PIXELS_PER_DAY * currentZoom) + 'px';
        dayDiv.style.flexShrink = '0';
        
        if (currentDate.getDate() === 1) {
          dayDiv.classList.add('month-start');
          
          const label = document.createElement('div');
          label.className = 'timeline-day-label';
          label.textContent = formatMonthYear(currentDate);
          dayDiv.appendChild(label);
        } else if (i % 7 === 0) {
          const label = document.createElement('div');
          label.className = 'timeline-day-label';
          label.textContent = formatDisplayDate(currentDate);
          dayDiv.appendChild(label);
        }
        
        timelineGrid.appendChild(dayDiv);
      }
      
      // הצג סרגלי משימות
      filteredTasks.forEach((task, index) => {
        const taskStart = new Date(task.start);
        const taskEnd = new Date(task.end);
        
        if (isNaN(taskStart.getTime()) || isNaN(taskEnd.getTime())) {
          logDebug(`תאריך לא תקין למשימה ${task.id}: ${task.start} - ${task.end}`);
          return;
        }
        
        const daysFromStart = Math.floor((taskStart - MIN_DATE) / (1000 * 60 * 60 * 24));
        const taskDuration = Math.max(1, Math.ceil((taskEnd - taskStart) / (1000 * 60 * 60 * 24)) + 1);
        
        const taskBar = document.createElement('div');
        taskBar.className = `task-bar ${task.milestone ? 'milestone' : ''}`;
        taskBar.dataset.id = task.id;
        taskBar.dataset.index = index;
        
        // קבל צבע לפי קטגוריה
        const phaseColor = getPhaseColor(task.phase);
        taskBar.style.backgroundColor = phaseColor;
        
        // מיקום וגודל
        const left = daysFromStart * PIXELS_PER_DAY * currentZoom;
        const width = taskDuration * PIXELS_PER_DAY * currentZoom;
        
        taskBar.style.left = left + 'px';
        taskBar.style.width = Math.max(20, width) + 'px';
        taskBar.style.top = (index * 44) + 'px';
        
        // הוסף תוכן
        const label = document.createElement('div');
        label.className = 'task-label';
        label.innerHTML = `<span class="task-id">${task.id}</span> ${task.name}`;
        taskBar.appendChild(label);
        
        // הוסף טולטיפ
        taskBar.title = `${task.name}\nקטגוריה: ${task.phase}\nאחראי: ${task.owner}\nתאריך: ${formatDisplayDate(task.start)} - ${formatDisplayDate(task.end)}\nמשך: ${task.duration} ימים\nסטטוס: ${task.status}`;
        
        // הוסף מאזין ללחיצה
        taskBar.addEventListener('click', (e) => {
          if (!e.target.classList.contains('task-handle')) {
            editTask(task.id);
          }
        });
        
        // הוסף מאזיני גרירה למשימות שאינן אבני דרך
        if (!task.milestone) {
          makeTaskDraggable(taskBar, task);
        }
        
        barsContainer.appendChild(taskBar);
      });
      
      // הצג קווי תלות
      renderDependencies();
      
      // עדכן תצוגת טווח
      timelineRange.textContent = `טווח: ${formatDisplayDate(MIN_DATE)} - ${formatDisplayDate(MAX_DATE)} (${totalDays} ימים)`;
      
      logDebug(`טיימליין: ${filteredTasks.length} משימות, ${totalDays} ימים`);
    }

    function makeTaskDraggable(taskBar, task) {
      let isDragging = false;
      let startX = 0;
      let startLeft = 0;
      
      taskBar.addEventListener('mousedown', (e) => {
        if (e.button !== 0) return; // לחיצה שמאלית בלבד
        
        isDragging = true;
        startX = e.clientX;
        startLeft = parseFloat(taskBar.style.left);
        
        taskBar.classList.add('dragging');
        document.body.style.cursor = 'grabbing';
        
        e.preventDefault();
        
        const onMouseMove = (e) => {
          if (!isDragging) return;
          
          const deltaX = e.clientX - startX;
          const deltaDays = Math.round(deltaX / (PIXELS_PER_DAY * currentZoom));
          
          const taskIndex = tasks.findIndex(t => t.id === task.id);
          if (taskIndex === -1) return;
          
          const newStartOffset = Math.max(0, (task.startOffset || 0) + deltaDays);
          tasks[taskIndex].startOffset = newStartOffset;
          
          // עדכן תאריכים
          const baseDate = new Date('2026-01-05');
          const startDate = new Date(baseDate);
          startDate.setDate(startDate.getDate() + newStartOffset);
          tasks[taskIndex].start = formatDate(startDate);
          
          const endDate = new Date(startDate);
          endDate.setDate(endDate.getDate() + tasks[taskIndex].duration);
          tasks[taskIndex].end = formatDate(endDate);
          
          // עדכן מיקום
          taskBar.style.left = (startLeft + deltaX) + 'px';
          
          // עדכן תלויות
          renderDependencies();
        };
        
        const onMouseUp = () => {
          if (!isDragging) return;
          
          isDragging = false;
          taskBar.classList.remove('dragging');
          document.body.style.cursor = '';
          
          // שמור שינויים
          saveTasks();
          renderTimeline();
          
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
        };
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      });
      
      taskBar.style.cursor = 'grab';
    }

    function renderDependencies() {
      const svg = document.getElementById('dependencyLayer');
      svg.innerHTML = `
        <defs>
          <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
            <polygon points="0 0, 10 3.5, 0 7" fill="#64748b"/>
          </marker>
        </defs>
      `;
      
      if (!MIN_DATE || !MAX_DATE) return;
      
      filteredTasks.forEach(task => {
        if (!task.deps || task.deps.trim() === '') return;
        
        const dependencies = task.deps.split(',').map(d => d.trim()).filter(d => d !== '');
        
        dependencies.forEach(depId => {
          const sourceTask = filteredTasks.find(t => t.id === depId);
          const targetTask = task;
          
          if (!sourceTask || !targetTask) return;
          
          // מצא אינדקסים
          const sourceIndex = filteredTasks.findIndex(t => t.id === depId);
          const targetIndex = filteredTasks.findIndex(t => t.id === task.id);
          
          if (sourceIndex === -1 || targetIndex === -1) return;
          
          // חשב מיקומים
          const sourceStart = new Date(sourceTask.start);
          const sourceEnd = new Date(sourceTask.end);
          const targetStart = new Date(targetTask.start);
          
          if (isNaN(sourceStart.getTime()) || isNaN(sourceEnd.getTime()) || isNaN(targetStart.getTime())) {
            return;
          }
          
          const sourceDaysFromStart = Math.floor((sourceEnd - MIN_DATE) / (1000 * 60 * 60 * 24));
          const targetDaysFromStart = Math.floor((targetStart - MIN_DATE) / (1000 * 60 * 60 * 24));
          
          const x1 = sourceDaysFromStart * PIXELS_PER_DAY * currentZoom;
          const x2 = targetDaysFromStart * PIXELS_PER_DAY * currentZoom;
          const y1 = sourceIndex * 44 + 22;
          const y2 = targetIndex * 44 + 22;
          
          // הצג רק אם היעד אחרי המקור
          if (x2 <= x1) return;
          
          // צור קו
          const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          line.setAttribute('class', 'dependency-line');
          line.setAttribute('x1', x1);
          line.setAttribute('y1', y1);
          line.setAttribute('x2', x2);
          line.setAttribute('y2', y2);
          line.setAttribute('marker-end', 'url(#arrowhead)');
          
          svg.appendChild(line);
        });
      });
    }

    function updateCharts() {
      // תרשים קטגוריות
      const categoryData = getCategoryData();
      const categoryCtx = document.getElementById('categoryChart').getContext('2d');
      
      if (chartInstances.categoryChart) {
        chartInstances.categoryChart.destroy();
      }
      
      chartInstances.categoryChart = new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
          labels: categoryData.labels.slice(0, 10),
          datasets: [{
            data: categoryData.values.slice(0, 10),
            backgroundColor: categoryData.colors.slice(0, 10),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              rtl: true,
              labels: {
                boxWidth: 12,
                padding: 10
              }
            }
          }
        }
      });
      
      // תרשים אחראים
      const ownerData = getOwnerData();
      const ownerCtx = document.getElementById('ownerChart').getContext('2d');
      
      if (chartInstances.ownerChart) {
        chartInstances.ownerChart.destroy();
      }
      
      chartInstances.ownerChart = new Chart(ownerCtx, {
        type: 'bar',
        data: {
          labels: ownerData.labels.slice(0, 8),
          datasets: [{
            label: 'מספר משימות',
            data: ownerData.values.slice(0, 8),
            backgroundColor: '#3b82f6',
            borderColor: '#1d4ed8',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
      
      // תרשים טיימליין
      updateTimelineChart();
    }

    function updateTimelineChart() {
      const timelineCtx = document.getElementById('timelineChart').getContext('2d');
      
      if (chartInstances.timelineChart) {
        chartInstances.timelineChart.destroy();
      }
      
      // קבץ משימות לפי חודש
      const monthlyData = {};
      filteredTasks.forEach(task => {
        if (!task.start) return;
        const month = task.start.substring(0, 7); // YYYY-MM
        monthlyData[month] = (monthlyData[month] || 0) + 1;
      });
      
      const months = Object.keys(monthlyData).sort();
      const counts = months.map(month => monthlyData[month]);
      
      chartInstances.timelineChart = new Chart(timelineCtx, {
        type: 'line',
        data: {
          labels: months.map(m => m.substring(5) + '/' + m.substring(2, 4)),
          datasets: [{
            label: 'משימות לפי חודש',
            data: counts,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }

    // ===== UTILITY FUNCTIONS =====
    function getCategoryData() {
      const groups = {};
      filteredTasks.forEach(task => {
        const phase = task.phase || 'ללא קטגוריה';
        groups[phase] = (groups[phase] || 0) + 1;
      });
      
      const sorted = Object.entries(groups).sort((a, b) => b[1] - a[1]);
      
      return {
        labels: sorted.map(([phase]) => phase),
        values: sorted.map(([, count]) => count),
        colors: sorted.map(([phase]) => getPhaseColor(phase))
      };
    }

    function getOwnerData() {
      const groups = {};
      filteredTasks.forEach(task => {
        const owner = task.owner || 'ללא אחראי';
        groups[owner] = (groups[owner] || 0) + 1;
      });
      
      const sorted = Object.entries(groups).sort((a, b) => b[1] - a[1]);
      
      return {
        labels: sorted.map(([owner]) => owner),
        values: sorted.map(([, count]) => count)
      };
    }

    function getPhaseColor(phase) {
      if (!phase) return '#6b7280';
      
      // חלץ מספר שלב
      const match = phase.match(/^(\d+)/);
      if (match) {
        const phaseNum = parseInt(match[1]);
        return COLORS.phases[(phaseNum - 1) % COLORS.phases.length];
      }

    function getPhaseLabel(phase) {
      if (!phase) return 'ללא קטגוריה';
      const p = String(phase).replace(/\u200f|\u200e|\u202a|\u202b|\u202c/g, '').trim();
      // נסה לפצל "1.1 Admin" -> "1.1 – Admin"
      const mm = p.match(/^((?:\d+(?:\.\d+)*))(?:\s+(.+))?$/);
      if (mm) {
        const code = mm[1];
        const desc = (mm[2] || '').trim();
        return desc ? `${code} – ${desc}` : code;
      }
      return p;
    }

      
      // hash לשלבים אחרים
      let hash = 0;
      for (let i = 0; i < phase.length; i++) {
        hash = phase.charCodeAt(i) + ((hash << 5) - hash);
      }
      return COLORS.phases[Math.abs(hash) % COLORS.phases.length];
    }

    function updateFilterOptions() {
      // עדכן סינון קטגוריות
      const categoryFilter = document.getElementById('categoryFilter');
      const categories = Array.from(new Set(tasks.map(t => t.phase).filter(p => p))).sort();
      
      const currentCategory = categoryFilter.value;
      categoryFilter.innerHTML = '<option value="">כל הקטגוריות</option>';
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        if (cat === currentCategory) option.selected = true;
        categoryFilter.appendChild(option);
      });

      // עדכן סינון אחראים
      const ownerFilter = document.getElementById('ownerFilter');
      const owners = Array.from(new Set(tasks.map(t => t.owner).filter(o => o))).sort();
      
      const currentOwner = ownerFilter.value;
      ownerFilter.innerHTML = '<option value="">כל האחראים</option>';
      owners.forEach(owner => {
        const option = document.createElement('option');
        option.value = owner;
        option.textContent = owner;
        if (owner === currentOwner) option.selected = true;
        ownerFilter.appendChild(option);
      });
    }

    function updateLegend() {
      const legend = document.getElementById('phaseLegend');
      const phases = Array.from(new Set(filteredTasks.map(t => t.phase).filter(p => p))).sort((a,b)=>String(a).localeCompare(String(b),'he'));

      legend.innerHTML = '';
      phases.forEach((phase) => {
        const item = document.createElement('div');
        item.className = 'legend-item';
        item.innerHTML = `
          <div class="legend-color" style="background: ${getPhaseColor(phase)}"></div>
          <span>${escapeHtml(getPhaseLabel(phase))}</span>
        `;
        legend.appendChild(item);
      });
    });
      
      if (phases.length === 0) {
        legend.innerHTML = '<div style="color: #6b7280; text-align: center; width: 100%;">אין קטגוריות להצגה</div>';
      }
    }

    function formatDate(date) {
      if (!date) return '';
      const d = new Date(date);
      if (isNaN(d.getTime())) return '';
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function formatDisplayDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      if (isNaN(date.getTime())) return '';
      return date.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: '2-digit' });
    }

    function formatMonthYear(date) {
      return date.toLocaleDateString('he-IL', { month: 'short', year: 'numeric' });
    }

    function changeZoom(delta) {
      // הגבל zoom ל-10% עד 300%
      currentZoom = Math.max(0.1, Math.min(3, currentZoom + delta));
      document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
      saveUISettings();
      renderTimeline();
      
      // הצג הודעת zoom
      const zoomMessages = {
        0.1: 'זום מינימלי (10%)',
        0.3: 'זום קטן מאוד',
        0.5: 'זום קטן',
        1.0: 'זום רגיל',
        2.0: 'זום גדול',
        3.0: 'זום מקסימלי (300%)'
      };
      
      const closestZoom = Object.keys(zoomMessages).reduce((prev, curr) => {
        return Math.abs(curr - currentZoom) < Math.abs(prev - currentZoom) ? curr : prev;
      });
      
      if (Math.abs(currentZoom - closestZoom) < 0.05) {
        showToast(`זום: ${zoomMessages[closestZoom]}`, 'info');
      }
    }

    function updatePixelsPerDay() {
      PIXELS_PER_DAY = parseInt(document.getElementById('pixelsPerDay').value) || 20;
      saveUISettings();
      renderTimeline();
    }

    function fitToScreen() {
      const timelineScroll = document.getElementById('timelineScroll');
      const containerWidth = timelineScroll.clientWidth;
      
      if (!MIN_DATE || !MAX_DATE || containerWidth === 0) return;
      
      const totalDays = Math.ceil((MAX_DATE - MIN_DATE) / (1000 * 60 * 60 * 24));
      const neededPixelsPerDay = containerWidth / totalDays;
      
      // מצא הקרוב ביותר להגדרות המוגדרות מראש
      const presets = [5, 10, 20, 30, 40];
      let closest = presets[0];
      let minDiff = Math.abs(neededPixelsPerDay - closest);
      
      for (const preset of presets) {
        const diff = Math.abs(neededPixelsPerDay - preset);
        if (diff < minDiff) {
          minDiff = diff;
          closest = preset;
        }
      }
      
      PIXELS_PER_DAY = closest;
      document.getElementById('pixelsPerDay').value = PIXELS_PER_DAY;
      currentZoom = 1.0;
      document.getElementById('zoomLevel').textContent = '100%';
      
      saveUISettings();
      renderTimeline();
      showToast('מותאם למסך', 'info');
    }

    function showToday() {
      const today = new Date();
      if (!MIN_DATE || !MAX_DATE) return;
      
      const daysFromStart = Math.floor((today - MIN_DATE) / (1000 * 60 * 60 * 24));
      const scrollLeft = daysFromStart * PIXELS_PER_DAY * currentZoom;
      
      const timelineScroll = document.getElementById('timelineScroll');
      timelineScroll.scrollLeft = scrollLeft - timelineScroll.clientWidth / 2;
      
      showToast('מוצג היום', 'info');
    }

    function toggleCompactView() {
      const taskList = document.getElementById('taskList');
      const compactBtn = document.getElementById('compactViewBtn');
      
      isCompactView = !isCompactView;
      
      if (isCompactView) {
        taskList.classList.add('compact');
        compactBtn.innerHTML = '<i class="fas fa-expand"></i> תצוגה מלאה';
      } else {
        taskList.classList.remove('compact');
        compactBtn.innerHTML = '<i class="fas fa-compress"></i> תצוגה קומפקטית';
      }
      
      saveUISettings();
      showToast(`תצוגה ${isCompactView ? 'קומפקטית' : 'מלאה'}`, 'info');
    }

    function exportToCSV() {
      const csvContent = convertTasksToCSV();
      const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `tasks_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('הקובץ יוצא בהצלחה', 'success');
    }

    function printView() {
      window.print();
    }

    function exportTimelineAsImage() {
      showToast('פונקציה בהכנה', 'info');
      // TODO: Implement screenshot of timeline
    }

    // ===== STATISTICS =====
    function updateStats() {
      // סך הכל משימות
      document.getElementById('totalTasks').textContent = tasks.length;
      
      // אבני דרך
      const milestones = tasks.filter(t => t.milestone).length;
      document.getElementById('milestonesCount').textContent = milestones;
      
      // משימות פעילות (בתהליך)
      const activeTasks = tasks.filter(t => t.status === 'in-progress').length;
      document.getElementById('activeTasks').textContent = activeTasks;
      
      // ספירת תלויות
      const depsCount = tasks.reduce((acc, task) => {
        if (!task.deps) return acc;
        const deps = task.deps.split(',').filter(d => d.trim() !== '');
        return acc + deps.length;
      }, 0);
      document.getElementById('dependenciesCount').textContent = depsCount;
      
      // משימות עם תלויות
      const tasksWithDeps = tasks.filter(t => t.deps && t.deps.trim() !== '').length;
      document.getElementById('tasksWithDeps').textContent = tasksWithDeps;
      
      // ממוצע משך
      const avgDuration = tasks.length > 0 
        ? Math.round(tasks.reduce((sum, t) => sum + (t.duration || 1), 0) / tasks.length)
        : 0;
      document.getElementById('avgDuration').textContent = avgDuration;
    }

    function updateVisibleStats() {
      document.getElementById('filteredTasksCount').textContent = filteredTasks.length;
      
      const visibleMilestones = filteredTasks.filter(t => t.milestone).length;
      document.getElementById('visibleMilestones').textContent = visibleMilestones;
    }

    function updateDashboard() {
      updateStats();
      updateVisibleStats();
      updateTaskList();
      renderTimeline();
      updateCharts();
    }

    // ===== DEBUG FUNCTIONS =====
    function logDebug(message) {
      const timestamp = new Date().toLocaleTimeString('he-IL');
      const logEntry = `[${timestamp}] ${message}`;
      debugLogs.push(logEntry);
      
      // שמור רק 100 רשומות אחרונות
      if (debugLogs.length > 100) {
        debugLogs.shift();
      }
      
      console.log(logEntry);
    }

    function showDebugPanel() {
      const debugContent = document.getElementById('debugContent');
      debugContent.innerHTML = '';
      
      // מידע מערכת
      debugContent.innerHTML += `<div><strong>מידע מערכת:</strong></div>`;
      debugContent.innerHTML += `<div>משימות: ${tasks.length} (מסוננות: ${filteredTasks.length})</div>`;
      debugContent.innerHTML += `<div>GitHub: ${githubSettings ? 'מחובר' : 'לא מחובר'}</div>`;
      debugContent.innerHTML += `<div>Zoom: ${currentZoom.toFixed(1)}x (${Math.round(currentZoom * 100)}%)</div>`;
      debugContent.innerHTML += `<div>פיקסלים ליום: ${PIXELS_PER_DAY}</div>`;
      debugContent.innerHTML += `<div>טווח תאריכים: ${MIN_DATE ? formatDisplayDate(MIN_DATE) : 'לא מוגדר'} - ${MAX_DATE ? formatDisplayDate(MAX_DATE) : 'לא מוגדר'}</div>`;
      
      // לוגים
      debugContent.innerHTML += `<div style="margin-top: 10px;"><strong>לוגים:</strong></div>`;
      const recentLogs = debugLogs.slice(-20).reverse();
      recentLogs.forEach(log => {
        debugContent.innerHTML += `<div style="font-size: 11px; color: #d1d5db;">${log}</div>`;
      });
      
      openModal('debugModal');
    }

    function clearDebug() {
      debugLogs = [];
      showDebugPanel();
    }

    function exportDebug() {
      const debugText = debugLogs.join('\n');
      const blob = new Blob([debugText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `gantt_debug_${new Date().toISOString().split('T')[0]}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function testCSVParsing() {
      const testCSV = `מזהה,קטגוריה/שלב,שם משימה,אחראי,תאריך התחלה,תאריך סיום,משך (ימים),תלויות,הערות,startOffset,milestone
1,1. Management,פתיחת פרויקט וניהול,צוות יעוץ,2026-01-05,2026-02-04,30,,,0,
2,1.1 Admin,פגישת קיק-אוף,צוות יעוץ,2026-01-05,2026-01-07,2,,,0,true`;
      
      const parsed = parseCSVWithHebrewHeaders(testCSV);
      logDebug(`בדיקת CSV: ${parsed.length} משימות נמצאו`);
      showDebugPanel();
    }

    function forceReload() {
      localStorage.removeItem(STORAGE_KEYS.TASKS);
      localStorage.removeItem(STORAGE_KEYS.GITHUB_SETTINGS);
      localStorage.removeItem(STORAGE_KEYS.UI_SETTINGS);
      location.reload();
    }

    // ===== HELPER FUNCTIONS =====
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(args) {
        const later = () => {
          clearTimeout(timeout);
          func(args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // הפעלה ראשונית
    setTimeout(() => {
      if (!isInitialized) {
        initApp();
      }
    }, 1000);
  </script>
</body>
</html>
