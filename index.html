<!doctype html>
<html lang="he">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gantt – Ghana Energy CERT (Drag & Drop) + Import/Export + GitHub</title>
<style>
  /* ===== Version 18 ===== */
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    margin:0;background:#f6f7fb;color:#111827;
    overflow:auto;
  }

  /* Always show scrollbars when possible */
  *{ scrollbar-gutter: stable both-edges; }
  ::-webkit-scrollbar{ width:12px; height:12px; }
  ::-webkit-scrollbar-thumb{ background:#cbd5e1; border-radius:999px; border:3px solid #f6f7fb; }
  ::-webkit-scrollbar-track{ background:#f6f7fb; }

  header{padding:16px 20px;background:#111827;color:#fff}
  header h1{margin:0;font-size:18px;font-weight:900;direction:rtl;text-align:right}
  header .meta{margin-top:6px;font-size:13px;opacity:.9;direction:rtl;text-align:right;line-height:1.35}
  .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#1f2a6b;font-size:12px}

  .wrap{padding:16px 20px; overflow:auto;}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  .controls input,.controls select,.controls button{
    padding:10px 12px;border-radius:10px;border:1px solid #d1d5db;background:#fff;font-size:14px
  }
  .controls button{cursor:pointer}
  .controls .btn-primary{background:#111827;color:#fff;border-color:#111827}
  .controls .btn-ghost{background:#fff;color:#111827}
  .controls .btn-warn{background:#fff7ed;color:#9a3412;border-color:#fed7aa}
  .controls .btn-ok{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}

  .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.05)}

  /* Fixed work area to force internal scrollbars */
  .workArea{ height: min(62vh, 680px); }

  .grid{display:grid;grid-template-columns: 540px 1fr;}
  .left{border-right:1px solid #e5e7eb; overflow:auto; height:100%;}
  .right{overflow:auto; height:100%;}

  .row{display:flex;gap:10px;align-items:center;padding:8px 10px;border-bottom:1px solid #f1f5f9}
  .row:nth-child(odd){background:#fafafa}
  .row .title{flex:1;direction:rtl;text-align:right;font-size:13px;line-height:1.2}
  .row .meta{font-size:12px;color:#374151;white-space:nowrap}

  .timeline{position:relative;min-height: 40px;border-bottom:1px solid #e5e7eb;background:#fff}
  .ticks{display:flex;position:sticky;top:0;background:#fff;z-index:2}
  .tick{border-right:1px solid #eef2f7;padding:8px 6px;font-size:12px;color:#374151;white-space:nowrap}

  .bar-area{position:relative; overflow:visible;}
  .bar-row{position:relative;height:34px;border-bottom:1px solid #f1f5f9}
  .bar{position:absolute;top:7px;height:20px;border-radius:10px;background:#2563eb;cursor:grab;box-shadow:0 1px 1px rgba(0,0,0,.08)}
  .bar.dragging{cursor:grabbing;opacity:.9}
  .bar .label{position:absolute;left:10px;right:10px;top:2px;font-size:10px;line-height:1;color:#fff;opacity:.95;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;pointer-events:none}
  .bar .deps{position:absolute;left:10px;right:10px;bottom:2px;font-size:10px;line-height:1;color:#fff;opacity:.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;pointer-events:none}
  .handle{position:absolute;top:0;width:10px;height:20px;opacity:.0;}
  .bar:hover .handle{opacity:.35;}
  .handle.left{left:0;border-top-left-radius:10px;border-bottom-left-radius:10px;background:#0b3ea8;cursor:ew-resize}
  .handle.right{right:0;border-top-right-radius:10px;border-bottom-right-radius:10px;background:#0b3ea8;cursor:ew-resize}

  .hint{padding:10px 12px;font-size:12px;color:#374151;direction:rtl;text-align:right}
  #legend .lg-item{display:flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #e5e7eb;border-radius:999px;background:#fff;font-size:12px}
  #legend .sw{width:12px;height:12px;border-radius:4px}
  .dep-layer{position:absolute;left:0;top:0;pointer-events:none;overflow:visible}

  /* Charts */
  .dash{display:grid;grid-template-columns:repeat(3,minmax(220px,1fr));gap:12px;margin:12px 0}
  @media (max-width: 980px){
    .dash{grid-template-columns:1fr}
    .grid{grid-template-columns:1fr}
    .left{border-right:none;border-bottom:1px solid #e5e7eb}
    .workArea{height: min(70vh, 760px);}
  }
  .chart-card{padding:12px}
  .chart-title{font-weight:900;font-size:13px;margin:0 0 8px 0;direction:rtl;text-align:right}
  canvas{width:100%;height:160px;display:block}
  .chart-legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;direction:ltr}
  .chart-legend .it{display:flex;gap:6px;align-items:center;font-size:12px;color:#374151}
  .chart-legend .dot{width:10px;height:10px;border-radius:3px;display:inline-block}

  /* Modal */
  .modal-backdrop{
    position:fixed; inset:0;
    background:rgba(17,24,39,.55);
    display:none; align-items:center; justify-content:center;
    padding:16px; z-index:50;
  }
  .modal{
    width:min(820px, 100%);
    background:#fff; border-radius:16px;
    border:1px solid #e5e7eb;
    box-shadow:0 20px 70px rgba(0,0,0,.25);
    overflow:auto;
    max-height:85vh;
  }
  .modal-hd{
    display:flex; align-items:center; justify-content:space-between;
    padding:14px 16px; border-bottom:1px solid #e5e7eb;
  }
  .modal-hd h2{margin:0;font-size:16px;font-weight:900}
  .modal-bd{padding:14px 16px}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .fg{display:flex;flex-direction:column;gap:6px}
  .fg label{font-size:12px;color:#374151; font-weight:700}
  .fg input, .fg select{
    padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;font-size:14px
  }
  .modal-ft{
    display:flex; gap:10px; flex-wrap:wrap;
    padding:14px 16px; border-top:1px solid #e5e7eb;
    justify-content:flex-end;
  }
  .statusBox{
    margin-top:10px;
    padding:10px 12px;
    border:1px solid #e5e7eb;
    border-radius:12px;
    background:#f8fafc;
    font-size:12px;
    white-space:pre-wrap;
    direction:ltr;
    text-align:left;
    overflow:auto;
    max-height:160px;
  }
</style>
</head>
<body>
<header>
  <h1>
    AMIR DAVIDI TECHNOLOGIES – גאנט פרויקט Ghana Energy CERT (Drag & Drop)
    <span class="pill">Version 18</span>
  </h1>
  <div class="meta">
    ✅ גרירה מזיזה משימה | ✅ גרירת קצוות משנה Duration | ✅ חצים לתלויות<br/>
    ✅ Import/Export CSV | ✅ Load/Save ל-GitHub (tasks.csv) דרך Settings
    <span class="pill">UTF-8 BOM</span>
  </div>
</header>

<div class="wrap">
  <div class="controls">
    <input id="q" placeholder="חיפוש (Task / Owner / Phase / ID)..." style="min-width:320px"/>
    <select id="ownerFilter"><option value="">כל ה-Owners</option></select>
    <select id="zoom">
      <option value="day">יום (Day)</option>
      <option value="week" selected>שבוע (Week)</option>
      <option value="month">חודש (Month)</option>
    </select>

    <div id="legend" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center"></div>

    <button class="btn-primary" id="exportCsv">Export CSV</button>
    <button class="btn-ghost" id="settingsBtn">Settings (GitHub)</button>

    <!-- SINGLE Git/Utility bar (not duplicated) -->
    <button class="btn-ok" id="loadRepo" title="טען tasks.csv מה-GitHub (Public בלי טוקן דרך RAW; Private דרך API)">Load from GIT (tasks.csv)</button>
    <button class="btn-primary" id="saveRepo" title="שמור tasks.csv חזרה ל-GitHub (דורש Token עם הרשאות)">Save to GIT (tasks.csv)</button>
    <button class="btn-ghost" id="downloadTemplate" title="הורד תבנית CSV מלאה לייבוא">Download CSV Template</button>
    <button class="btn-warn" id="clearLocal" title="מוחק שינויים מקומיים ומחזיר למצב טעינה מה-GIT">Clear Local Cache</button>

    <div style="flex:1"></div>

    <div class="importBox" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <input id="importFile" type="file" accept=".csv,text/csv"/>
      <button class="btn-ghost" id="importBtn">Import CSV</button>
    </div>

    <button id="reset">איפוס</button>
  </div>

  <div class="dash">
    <div class="card chart-card">
      <p class="chart-title">משימות לפי קטגוריה</p>
      <canvas id="chartCats" width="600" height="220"></canvas>
      <div class="chart-legend" id="lgCats"></div>
    </div>
    <div class="card chart-card">
      <p class="chart-title">משימות לפי Owner</p>
      <canvas id="chartOwners" width="600" height="220"></canvas>
      <div class="chart-legend" id="lgOwners"></div>
    </div>
    <div class="card chart-card">
      <p class="chart-title">מדדים מהירים</p>
      <canvas id="chartKPIs" width="600" height="220"></canvas>
      <div class="hint" style="padding:8px 0 0 0;text-align:right">
        KPI: כמות משימות · כמות Milestones · כמות תלויות · טווח תאריכים (ימים)
      </div>
    </div>
  </div>

  <div class="card">
    <div class="grid workArea">
      <div class="left" id="left"></div>
      <div class="right" id="rightPane">
        <div class="timeline" id="timeline"></div>
        <div class="bar-area" id="bars"></div>
      </div>
    </div>
    <div class="hint">
      טיפ: לדיוק גבוה העבר ל-Zoom "יום". דאבל-קליק על בר מציג פרטים. Import/Drag נשמר מקומית. Save to GIT כותב ל-tasks.csv לפי Settings.
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-backdrop" id="modalBg" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal">
    <div class="modal-hd">
      <h2>GitHub Settings</h2>
      <button class="btn-ghost" id="closeSettings">סגור</button>
    </div>
    <div class="modal-bd">
      <div class="form-grid">
        <div class="fg">
          <label>Owner / Org</label>
          <input id="ghOwner" placeholder="amird1976"/>
        </div>
        <div class="fg">
          <label>Repository</label>
          <input id="ghRepo" placeholder="GANA_PM"/>
        </div>
        <div class="fg">
          <label>Branch</label>
          <input id="ghBranch" placeholder="main"/>
        </div>
        <div class="fg">
          <label>Path (CSV file)</label>
          <input id="ghPath" placeholder="tasks.csv"/>
        </div>
        <div class="fg" style="grid-column:1 / -1">
          <label>Personal Access Token (classic/fine-grained) – נשמר רק בדפדפן שלך (localStorage)</label>
          <input id="ghToken" placeholder="ghp_... / github_pat_..." autocomplete="off" spellcheck="false"/>
        </div>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <button class="btn-primary" id="saveSettings">שמור Settings</button>
        <button class="btn-ghost" id="testLoadRaw">Test RAW Load (Public)</button>
        <button class="btn-ghost" id="testApi">Test API (requires token)</button>
        <span class="pill" id="cfgHint">—</span>
      </div>

      <div class="statusBox" id="statusBox">Status log…</div>

      <div class="hint" style="margin-top:10px">
        הערה: Load ציבורי עובד גם בלי Token דרך raw.githubusercontent.com. Save תמיד דורש Token עם הרשאות לכתוב לקובץ.
      </div>
    </div>
    <div class="modal-ft">
      <button class="btn-warn" id="forgetToken">מחק Token מהמכשיר</button>
      <button class="btn-ghost" id="closeSettings2">סגור</button>
    </div>
  </div>
</div>

<script>
/* =========================
   Version 18 – GitHub ready
   ========================= */

const MS_DAY = 86400000;
const MIN_START = new Date("2026-01-05");
const MAX_END   = new Date("2026-06-10");

/* Demo base; you replace with full list or load from Git */
const BASE = [
  {"id":"1","phase":"1. Management","name":"פתיחת פרויקט וניהול (Phase 1)","owner":"צוות יעוץ","startOffset":0,"duration":30,"deps":"","milestone":false,"notes":""},
  {"id":"2","phase":"1.1 Admin","name":"פגישת קיק-אוף והתנעת צוות היגוי","owner":"צוות יעוץ","startOffset":0,"duration":2,"deps":"","milestone":true,"notes":"דוגמה: סמן milestone=true כדי לקבל יהלום"},
  {"id":"3","phase":"1.1 Admin","name":"הקמת משרד PMO פיזי באקרה (Ghana)","owner":"Local Ops","startOffset":2,"duration":14,"deps":"2","milestone":false,"notes":""},
  {"id":"4","phase":"2. Design","name":"CDR - תכנון הנדסי מפורט (Design Phase)","owner":"Engineering","startOffset":0,"duration":60,"deps":"","milestone":false,"notes":""}
];

let ALL = BASE.map(t => ({...t}));

/* Local storage keys */
const STORE_KEY      = "gantt_tasks_v18_edits";
const STORE_KEY_CSV  = "gantt_tasks_v18_csv_snapshot";
const STORE_GH_CFG   = "gantt_github_cfg_v18";

/* ---------- Helpers ---------- */
function daysBetween(a,b){ return Math.round((b-a)/MS_DAY); }
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
function fmt(d){
  const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}
function calcDatesFromOffsets(t){
  const s = new Date(MIN_START.getTime() + (Number(t.startOffset||0))*MS_DAY);
  const e = new Date(s.getTime() + Math.max(1,Number(t.duration||1))*MS_DAY);
  t.start = fmt(s); t.end = fmt(e);
}

/* ---------- Category coloring ---------- */
function categoryOf(t){
  const p = (t.phase||"").trim();
  if (!p) return "Other";
  if (p.toLowerCase().startsWith("atp")) return "ATP";
  if (p.toLowerCase() === "closure") return "Closure";
  const first = p.split(/\s+/)[0];
  const m = first.match(/^([0-9]+)(?:\.|$)/);
  if (m) return "Phase " + m[1];
  const m2 = first.match(/^([A-Z])\./i);
  if (m2) return "Group " + m2[1].toUpperCase();
  return first;
}
function colorForCategory(cat){
  const palette = ["#2563eb","#16a34a","#f59e0b","#dc2626","#9333ea","#0891b2","#7c3aed","#0ea5e9","#22c55e","#ea580c","#be123c","#0f766e","#4f46e5","#a16207","#1d4ed8"];
  let h=0; for (let i=0;i<cat.length;i++) h = (h*31 + cat.charCodeAt(i)) >>> 0;
  return palette[h % palette.length];
}
function depsLabel(t){
  const d = (t.deps||"").trim();
  if (!d) return "";
  return d.length > 30 ? (d.slice(0,30) + "…") : d;
}

/* ---------- Local edits ---------- */
function loadEdits() {
  try { const raw = localStorage.getItem(STORE_KEY); return raw ? JSON.parse(raw) : null; } catch(e){ return null; }
}
function saveEdits(edits) { try { localStorage.setItem(STORE_KEY, JSON.stringify(edits)); } catch(e){} }
function persistOne(t){
  const edits = loadEdits() || {};
  edits[t.id] = {
    id:String(t.id),
    phase:t.phase||"",
    name:t.name||"",
    owner:t.owner||"",
    startOffset:Number(t.startOffset||0),
    duration:Number(t.duration||1),
    deps:t.deps||"",
    milestone: !!t.milestone,
    notes: t.notes||"",
    start:t.start, end:t.end
  };
  saveEdits(edits);
}
function findTask(id){ return ALL.find(x=>String(x.id)===String(id)); }

/* Apply stored edits to BASE */
(function applyLocal(){
  const edits = loadEdits(); if (!edits) return;
  ALL = ALL.map(t => edits[t.id] ? ({...t, ...edits[t.id]}) : t);
})();
ALL.forEach(calcDatesFromOffsets);

/* ---------- Owner filter ---------- */
const ownerSel = document.getElementById('ownerFilter');
function rebuildOwnerOptions(tasks){
  ownerSel.innerHTML = '<option value="">כל ה-Owners</option>';
  Array.from(new Set(tasks.map(t => (t.owner||'').trim()).filter(Boolean))).sort().forEach(o=>{
    const opt=document.createElement('option'); opt.value=o; opt.textContent=o; ownerSel.appendChild(opt);
  });
}
rebuildOwnerOptions(ALL);

/* ---------- Zoom / ticks ---------- */
function pxPerDayForZoom(){ const z=document.getElementById('zoom').value; return (z==='day')?18:(z==='week'?7:2.5); }
function buildTicks(pxPerDay){
  const tl=document.getElementById('timeline'); tl.innerHTML='';
  const ticks=document.createElement('div'); ticks.className='ticks';
  const totalDays=daysBetween(MIN_START, MAX_END);
  const zoom=document.getElementById('zoom').value;
  const step = zoom==='day'?1:(zoom==='week'?7:30);

  for (let i=0;i<=totalDays;i++){
    const d=new Date(MIN_START.getTime()+i*MS_DAY);
    const tick=document.createElement('div');
    tick.className='tick'; tick.style.width=pxPerDay+'px';
    tick.textContent = (i%step===0)?fmt(d):'';
    ticks.appendChild(tick);
  }
  ticks.style.width=((totalDays+1)*pxPerDay)+'px';
  tl.appendChild(ticks);
}

/* ---------- Drag ---------- */
function attachDrag(barEl, pxPerDay){
  let mode="move", startX=0, origOffset=0, origDuration=0;

  function onPointerDown(e){
    const handle=e.target?.dataset?.handle;
    mode = handle==='left'?'resizeL':(handle==='right'?'resizeR':'move');
    barEl.setPointerCapture(e.pointerId);
    barEl.classList.add('dragging');
    startX=e.clientX;
    const t=findTask(barEl.dataset.id);
    origOffset=t.startOffset; origDuration=t.duration;
    e.preventDefault(); e.stopPropagation();
  }

  function onPointerMove(e){
    if (!barEl.classList.contains('dragging')) return;
    const dx=e.clientX-startX;
    const deltaDays=Math.round(dx/pxPerDay);
    const t=findTask(barEl.dataset.id); if (!t) return;

    if (mode==='move'){
      t.startOffset = clamp(origOffset+deltaDays,0,100000);
    } else if (mode==='resizeR'){
      t.duration = clamp(origDuration+deltaDays,1,100000);
    } else if (mode==='resizeL'){
      const newOffset=origOffset+deltaDays;
      const newDur=origDuration-deltaDays;
      if (newDur>=1){ t.startOffset=clamp(newOffset,0,100000); t.duration=newDur; }
    }

    calcDatesFromOffsets(t);
    barEl.style.left=(t.startOffset*pxPerDay)+'px';
    barEl.style.width=(Math.max(1,t.duration)*pxPerDay)+'px';
    barEl.title=`${t.name} (Start: ${t.start}, End: ${t.end})`;
    updateCharts(); // live
  }

  function onPointerUp(e){
    if (!barEl.classList.contains('dragging')) return;
    barEl.classList.remove('dragging');
    const t=findTask(barEl.dataset.id);
    if (t) persistOne(t);
    try{ barEl.releasePointerCapture(e.pointerId);}catch(_){}
  }

  barEl.addEventListener('pointerdown', onPointerDown);
  barEl.addEventListener('pointermove', onPointerMove);
  barEl.addEventListener('pointerup', onPointerUp);
  barEl.addEventListener('pointercancel', onPointerUp);
}

/* ---------- Milestone look ---------- */
function applyMilestoneStyle(barEl, isMilestone){
  if (!isMilestone) {
    barEl.style.borderRadius = "10px";
    barEl.style.transform = "none";
    return;
  }
  barEl.style.borderRadius = "4px";
  barEl.style.transform = "rotate(45deg)";
}

/* ---------- Render ---------- */
function render(){
  const q=(document.getElementById('q').value||'').toLowerCase().trim();
  const ownerVal=(document.getElementById('ownerFilter').value||'').toLowerCase();
  const pxPerDay=pxPerDayForZoom();

  const baseList = !q ? ALL : ALL.filter(t =>
    (t.name||'').toLowerCase().includes(q) ||
    (t.owner||'').toLowerCase().includes(q) ||
    (t.phase||'').toLowerCase().includes(q) ||
    String(t.id||'').toLowerCase().includes(q)
  );
  const list = !ownerVal ? baseList : baseList.filter(t => (t.owner||'').toLowerCase()===ownerVal);

  // Legend
  const legend=document.getElementById('legend');
  if (legend){
    const cats=Array.from(new Set(list.map(t=>categoryOf(t)))).sort();
    legend.innerHTML='';
    cats.forEach(cat=>{
      const item=document.createElement('div'); item.className='lg-item';
      const sw=document.createElement('div'); sw.className='sw'; sw.style.background=colorForCategory(cat);
      const tx=document.createElement('div'); tx.textContent=cat;
      item.appendChild(sw); item.appendChild(tx); legend.appendChild(item);
    });
  }

  // Left list
  const left=document.getElementById('left');
  left.innerHTML='';
  const h=document.createElement('div');
  h.className='row'; h.style.fontWeight='900';
  h.innerHTML = `<div class="meta">ID</div><div class="title">משימה</div><div class="meta">Owner</div>`;
  left.appendChild(h);
  list.forEach(t=>{
    const r=document.createElement('div'); r.className='row';
    r.innerHTML = `<div class="meta">#${t.id}</div><div class="title">${escapeHtml(t.name)}</div><div class="meta">${escapeHtml(t.owner||'')}</div>`;
    left.appendChild(r);
  });

  buildTicks(pxPerDay);

  const bars=document.getElementById('bars');
  bars.innerHTML='';

  // Dependency overlay SVG
  const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.classList.add('dep-layer'); svg.setAttribute('aria-hidden','true');
  const defs=document.createElementNS('http://www.w3.org/2000/svg','defs');
  const marker=document.createElementNS('http://www.w3.org/2000/svg','marker');
  marker.setAttribute('id','arrow'); marker.setAttribute('markerWidth','10'); marker.setAttribute('markerHeight','10');
  marker.setAttribute('refX','8'); marker.setAttribute('refY','3'); marker.setAttribute('orient','auto');
  const ap=document.createElementNS('http://www.w3.org/2000/svg','path');
  ap.setAttribute('d','M0,0 L8,3 L0,6 Z'); ap.setAttribute('fill','#64748b');
  marker.appendChild(ap); defs.appendChild(marker); svg.appendChild(defs); bars.appendChild(svg);

  const totalDays=daysBetween(MIN_START, MAX_END);
  const width=((totalDays+1)*pxPerDay);

  list.forEach((t, idx)=>{
    const row=document.createElement('div');
    row.className='bar-row';
    row.style.width=width+'px';

    const bar=document.createElement('div');
    bar.className='bar';
    bar.dataset.id=t.id;

    const isMs = !!t.milestone;
    const durPx = Math.max(1,Number(t.duration||1))*pxPerDay;
    const msSize = Math.max(10, Math.min(18, pxPerDay*2.2));
    bar.style.left=(Number(t.startOffset||0)*pxPerDay)+'px';
    bar.style.width = isMs ? (msSize+'px') : (durPx+'px');

    bar.style.background=colorForCategory(categoryOf(t));
    bar.title=`${t.name} (Start: ${t.start}, End: ${t.end})`;
    applyMilestoneStyle(bar, isMs);

    const lbl=document.createElement('div');
    lbl.className='label';
    lbl.textContent = isMs ? `#${t.id}` : `#${t.id} · ${t.name}`;

    const dep=depsLabel(t);
    const depEl=document.createElement('div');
    depEl.className='deps';
    depEl.textContent = dep ? `Deps: ${dep}` : '';

    if (isMs) { depEl.textContent=''; lbl.style.transform="rotate(-45deg)"; lbl.style.left="6px"; lbl.style.right="6px"; }

    bar.appendChild(lbl);
    bar.appendChild(depEl);

    const hL=document.createElement('div'); hL.className='handle left'; hL.dataset.handle='left';
    const hR=document.createElement('div'); hR.className='handle right'; hR.dataset.handle='right';
    if (!isMs){ bar.appendChild(hL); bar.appendChild(hR); }

    bar.addEventListener('dblclick', ()=>{
      alert(`Task #${t.id}\n${t.name}\nPhase: ${t.phase}\nOwner: ${t.owner}\nStart: ${t.start}\nEnd: ${t.end}\nDuration: ${t.duration}d\nMilestone: ${t.milestone?'YES':'NO'}\nDeps: ${t.deps||'-'}\nNotes: ${t.notes||'-'}`);
    });

    attachDrag(bar, pxPerDay);
    row.appendChild(bar);
    bars.appendChild(row);
  });

  // Draw dependency lines among visible
  const rowsCount=list.length;
  const svgHeight=rowsCount*34;
  svg.setAttribute('width', width);
  svg.setAttribute('height', svgHeight);
  svg.setAttribute('viewBox', `0 0 ${width} ${svgHeight}`);
  Array.from(svg.querySelectorAll('path.dep')).forEach(p=>p.remove());

  const centerY = (i)=>(i*34+17);
  const barEndX = (tt)=>((Number(tt.startOffset||0) + Math.max(1,Number(tt.duration||1)))*pxPerDay);
  const barStartX = (tt)=>((Number(tt.startOffset||0))*pxPerDay);
  const visibleById = new Map(list.map((tt,i)=>[String(tt.id), {t:tt,i}]));

  list.forEach((tt,i)=>{
    const deps = String(tt.deps||'').split(/[,\s]+/).map(x=>x.trim()).filter(Boolean);
    deps.forEach(did=>{
      if (!visibleById.has(did)) return;
      const from=visibleById.get(did);
      const x1=barEndX(from.t), y1=centerY(from.i);
      const x2=barStartX(tt), y2=centerY(i);
      const midX=(x1+x2)/2;
      const p=document.createElementNS('http://www.w3.org/2000/svg','path');
      p.classList.add('dep');
      p.setAttribute('d', `M ${x1} ${y1} L ${midX} ${y1} L ${midX} ${y2} L ${x2} ${y2}`);
      p.setAttribute('fill','none');
      p.setAttribute('stroke','#64748b');
      p.setAttribute('stroke-width','1.2');
      p.setAttribute('marker-end','url(#arrow)');
      svg.appendChild(p);
    });
  });

  updateCharts(list);
}

/* ---------- CSV Export/Import ---------- */
function exportCSVText(tasks){
  const header = ["id","phase","name","owner","startOffset","duration","start","end","deps","milestone","notes"];
  const rows = [header.join(",")];
  const esc = (v)=>{
    const s=String(v ?? "");
    if (s.includes('"')||s.includes(",")||s.includes("\n")||s.includes("\r")) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  };
  tasks.forEach(t=>{
    rows.push([
      esc(t.id),
      esc(t.phase),
      esc(t.name),
      esc(t.owner),
      esc(t.startOffset),
      esc(t.duration),
      esc(t.start||""),
      esc(t.end||""),
      esc(t.deps||""),
      esc(t.milestone?1:0),
      esc(t.notes||"")
    ].join(","));
  });
  const bom="\uFEFF";
  return bom + rows.join("\r\n");
}
function exportCSV(){
  ALL.forEach(calcDatesFromOffsets);
  const csvText = exportCSVText(ALL);
  const blob = new Blob([csvText], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url;
  a.download="gantt_full_export.csv";
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 5000);
  try{ localStorage.setItem(STORE_KEY_CSV, csvText);}catch(_){}
}

function downloadTemplate(){
  const sample = [
    {id:"1", phase:"1. Management", name:"Example task", owner:"Owner", startOffset:0, duration:7, deps:"", milestone:false, notes:""},
    {id:"2", phase:"1.1 Admin", name:"Milestone example", owner:"Owner", startOffset:7, duration:1, deps:"1", milestone:true, notes:""}
  ];
  sample.forEach(calcDatesFromOffsets);
  const csvText = exportCSVText(sample);
  const blob = new Blob([csvText], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url;
  a.download="tasks_template.csv";
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 5000);
}

function parseCSV(text){
  const lines = text.replace(/^\uFEFF/,'').split(/\r\n|\n|\r/);
  const out = [];
  let headers = null;

  function splitLine(line){
    const res=[];
    let cur="", inQ=false;
    for (let i=0;i<line.length;i++){
      const ch=line[i];
      if (inQ){
        if (ch === '"'){
          if (line[i+1] === '"'){ cur+='"'; i++; }
          else inQ=false;
        } else cur+=ch;
      } else {
        if (ch === '"') inQ=true;
        else if (ch === ','){ res.push(cur); cur=""; }
        else cur+=ch;
      }
    }
    res.push(cur);
    return res;
  }

  for (let i=0;i<lines.length;i++){
    const line=lines[i];
    if (!line.trim()) continue;
    const cols=splitLine(line);
    if (!headers){
      headers = cols.map(h=>h.trim());
      continue;
    }
    const obj={};
    headers.forEach((h, idx)=> obj[h]= (cols[idx] ?? "").trim());
    out.push(obj);
  }
  return out;
}

function coerceTask(row){
  const pick = (...keys) => {
    for (const k of keys){
      if (k == null) continue;
      if (Object.prototype.hasOwnProperty.call(row, k)) {
        const v = row[k];
        if (v !== undefined && v !== null && String(v).trim() !== "") return v;
      }
    }
    return undefined;
  };

  const t = {};
  t.id    = String(pick("id","ID","מזהה") ?? "").trim();
  t.phase = String(pick("phase","Phase","Phase/Section","קטגוריה/שלב") ?? "").trim();
  t.name  = String(pick("name","Task","Task Name","שם משימה") ?? "").trim();
  t.owner = String(pick("owner","Owner","אחראי") ?? "").trim();
  t.deps  = String(pick("deps","Dependencies","תלויות") ?? "").trim();
  t.notes = String(pick("notes","Notes","הערות") ?? "").trim();

  const msRaw = pick("milestone","Milestone","אבן דרך","אבן_דרך");
  t.milestone = (String(msRaw ?? "").toLowerCase()==="true" || String(msRaw ?? "").toLowerCase()==="yes" || String(msRaw ?? "")==="1");

  const so = pick("startOffset","start_offset","Start Offset (days)","Start Offset","StartOffset","Start Offset (Days)");
  const du = pick("duration","Duration","Duration (days)","Duration Days","משך (ימים)");
  t.startOffset = Number(so ?? 0);
  t.duration = Number(du ?? 1);
  return t;
}

async function importCSVFromFile(file){
  const text = await file.text();
  const rows = parseCSV(text);
  const tasks = rows.map(coerceTask).filter(t=>t && t.id);

  if (!tasks.length){
    alert("לא נמצאו משימות ב-CSV. ודא שיש עמודות id/name/phase/owner/startOffset/duration וכו'.");
    return;
  }

  ALL = tasks.map(t=>({...t}));
  ALL.forEach(calcDatesFromOffsets);

  const edits = {};
  ALL.forEach(t=>{
    edits[t.id] = {
      id:String(t.id),
      phase:t.phase||"",
      name:t.name||"",
      owner:t.owner||"",
      startOffset:Number(t.startOffset||0),
      duration:Number(t.duration||1),
      deps:t.deps||"",
      milestone: !!t.milestone,
      notes: t.notes||"",
      start:t.start, end:t.end
    };
  });
  saveEdits(edits);
  rebuildOwnerOptions(ALL);
  document.getElementById('ownerFilter').value = "";
  render();
  alert(`✅ Import הושלם: נטענו ${ALL.length} משימות והגאנט עודכן מיד.`);
}

/* ---------- Clear / Reset ---------- */
function clearLocalCache(){
  localStorage.removeItem(STORE_KEY);
  localStorage.removeItem(STORE_KEY_CSV);
  // keep GitHub settings
  ALL = BASE.map(t=>({...t}));
  ALL.forEach(calcDatesFromOffsets);
  rebuildOwnerOptions(ALL);
  document.getElementById('q').value='';
  document.getElementById('ownerFilter').value='';
  render();
  updateCharts();
  alert("✅ נמחק Cache מקומי. חזרת למצב בסיס. עכשיו אפשר Load מה-GIT.");
}
function resetAll(){
  localStorage.removeItem(STORE_KEY);
  localStorage.removeItem(STORE_KEY_CSV);
  localStorage.removeItem(STORE_GH_CFG);
  ALL = BASE.map(t=>({...t}));
  ALL.forEach(calcDatesFromOffsets);
  rebuildOwnerOptions(ALL);
  document.getElementById('q').value='';
  document.getElementById('ownerFilter').value='';
  document.getElementById('zoom').value='week';
  render();
  updateCharts();
  alert("✅ איפוס מלא (כולל Settings).");
}

/* ---------- Mini chart engine ---------- */
function clearCanvas(ctx){ ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height); }

if (!CanvasRenderingContext2D.prototype.roundRect){
  CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
    r = Math.min(r, w/2, h/2);
    this.beginPath();
    this.moveTo(x+r,y);
    this.arcTo(x+w,y,x+w,y+h,r);
    this.arcTo(x+w,y+h,x,y+h,r);
    this.arcTo(x,y+h,x,y,r);
    this.arcTo(x,y,x+w,y,r);
    this.closePath();
    return this;
  };
}

function drawBarChart(canvas, items, colorFn, legendEl){
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  clearCanvas(ctx);

  const top = 16, bottom = 26, left = 8, right = 8;
  const plotW = W - left - right;
  const plotH = H - top - bottom;

  const maxV = Math.max(1, ...items.map(x=>x.v));
  const barCount = items.length || 1;
  const gap = 6;
  const barW = Math.max(10, Math.floor((plotW - gap*(barCount-1))/barCount));

  ctx.strokeStyle = "#e5e7eb";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(left, top+plotH);
  ctx.lineTo(left+plotW, top+plotH);
  ctx.stroke();

  items.forEach((it, i)=>{
    const h = Math.round((it.v/maxV) * (plotH-2));
    const x = left + i*(barW+gap);
    const y = top + (plotH - h);
    ctx.fillStyle = colorFn(it.k, i);
    ctx.fillRect(x, y, barW, h);

    ctx.fillStyle = "#111827";
    ctx.font = "12px system-ui";
    ctx.textAlign = "center";
    ctx.fillText(String(it.v), x+barW/2, y-4);

    const lab = it.k.length > 10 ? (it.k.slice(0,10)+"…") : it.k;
    ctx.fillStyle = "#374151";
    ctx.font = "11px system-ui";
    ctx.fillText(lab, x+barW/2, top+plotH+16);
  });

  if (legendEl){
    legendEl.innerHTML = "";
    items.slice(0,12).forEach((it, i)=>{
      const div = document.createElement('div');
      div.className="it";
      const dot = document.createElement('span');
      dot.className="dot";
      dot.style.background = colorFn(it.k, i);
      const tx = document.createElement('span');
      tx.textContent = `${it.k}: ${it.v}`;
      div.appendChild(dot); div.appendChild(tx);
      legendEl.appendChild(div);
    });
  }
}

function drawKPI(canvas, kpis){
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  clearCanvas(ctx);

  const pad = 12;
  const cellW = (W - pad*3)/2;
  const cellH = (H - pad*3)/2;

  for (let i=0;i<kpis.length;i++){
    const r = Math.floor(i/2), c = i%2;
    const x = pad + c*(cellW+pad);
    const y = pad + r*(cellH+pad);

    ctx.fillStyle="#ffffff";
    ctx.strokeStyle="#e5e7eb";
    ctx.lineWidth=1;
    ctx.beginPath();
    ctx.roundRect(x,y,cellW,cellH,10);
    ctx.fill(); ctx.stroke();

    ctx.fillStyle="#374151";
    ctx.font="12px system-ui";
    ctx.textAlign="right";
    ctx.fillText(kpis[i].t, x+cellW-10, y+18);

    ctx.fillStyle="#111827";
    ctx.font="22px system-ui";
    ctx.textAlign="right";
    ctx.fillText(String(kpis[i].v), x+cellW-10, y+50);

    ctx.fillStyle="#6b7280";
    ctx.font="11px system-ui";
    ctx.textAlign="right";
    ctx.fillText(kpis[i].s||"", x+cellW-10, y+70);
  }
}

function getCounts(list, keyFn){
  const m = new Map();
  list.forEach(t=>{
    const k = keyFn(t);
    m.set(k, (m.get(k)||0)+1);
  });
  return Array.from(m.entries()).map(([k,v])=>({k,v})).sort((a,b)=>b.v-a.v);
}

function updateCharts(listOverride){
  const list = listOverride || (()=>{
    const q=(document.getElementById('q').value||'').toLowerCase().trim();
    const ownerVal=(document.getElementById('ownerFilter').value||'').toLowerCase();
    const baseList = !q ? ALL : ALL.filter(t =>
      (t.name||'').toLowerCase().includes(q) ||
      (t.owner||'').toLowerCase().includes(q) ||
      (t.phase||'').toLowerCase().includes(q) ||
      String(t.id||'').toLowerCase().includes(q)
    );
    return !ownerVal ? baseList : baseList.filter(t => (t.owner||'').toLowerCase()===ownerVal);
  })();

  const cats = getCounts(list, t=>categoryOf(t)).slice(0,10);
  const owners = getCounts(list, t=>(t.owner||"—")).slice(0,10);

  drawBarChart(document.getElementById('chartCats'), cats, (k)=>colorForCategory(k), document.getElementById('lgCats'));
  drawBarChart(document.getElementById('chartOwners'), owners, (k)=>{
    let h=0; for (let i=0;i<k.length;i++) h=(h*31+k.charCodeAt(i))>>>0;
    const pal=["#2563eb","#16a34a","#f59e0b","#dc2626","#9333ea","#0891b2","#7c3aed","#0ea5e9","#22c55e","#ea580c"];
    return pal[h%pal.length];
  }, document.getElementById('lgOwners'));

  const milestones = list.filter(t=>!!t.milestone).length;
  const depsCount = list.reduce((acc,t)=> acc + (String(t.deps||'').split(/[,\s]+/).filter(Boolean).length), 0);

  const offs = list.map(t=>Number(t.startOffset||0));
  const ends = list.map(t=>Number(t.startOffset||0)+Math.max(1,Number(t.duration||1)));
  const minO = offs.length ? Math.min(...offs) : 0;
  const maxE = ends.length ? Math.max(...ends) : 0;
  const spanDays = Math.max(0, maxE - minO);

  drawKPI(document.getElementById('chartKPIs'), [
    {t:"כמות משימות", v:list.length, s:"בפילטר הנוכחי"},
    {t:"Milestones", v:milestones, s:"diamond"},
    {t:"כמות תלויות", v:depsCount, s:"edges"},
    {t:"טווח (ימים)", v:spanDays, s:"min..max"}
  ]);
}

/* ---------- GitHub Settings + API ---------- */
function ghDefaultCfg(){
  return { owner:"", repo:"", branch:"main", path:"tasks.csv", token:"" };
}
function loadGhCfg(){
  try{
    const raw = localStorage.getItem(STORE_GH_CFG);
    return raw ? ({...ghDefaultCfg(), ...JSON.parse(raw)}) : ghDefaultCfg();
  }catch(_){ return ghDefaultCfg(); }
}
function saveGhCfg(cfg){
  try{ localStorage.setItem(STORE_GH_CFG, JSON.stringify(cfg)); }catch(_){}
}
function cfgSummary(cfg){
  const safeTok = cfg.token ? ("YES ("+cfg.token.slice(0,4)+"…"+cfg.token.slice(-4)+")") : "NO";
  return `${cfg.owner}/${cfg.repo} · branch=${cfg.branch} · path=${cfg.path} · token=${safeTok}`;
}
function setCfgHint(){
  const cfg = loadGhCfg();
  document.getElementById('cfgHint').textContent = cfg.owner && cfg.repo ? cfgSummary(cfg) : "⚠ הגדר Owner/Repo ב-Settings";
}
function logStatus(msg){
  const box = document.getElementById('statusBox');
  const ts = new Date().toLocaleTimeString();
  box.textContent = `[${ts}] ${msg}\n` + box.textContent;
}

function buildRawUrl(cfg){
  return `https://raw.githubusercontent.com/${encodeURIComponent(cfg.owner)}/${encodeURIComponent(cfg.repo)}/${encodeURIComponent(cfg.branch)}/${cfg.path.replace(/^\/+/,'')}`;
}
function buildApiUrl(cfg){
  // https://api.github.com/repos/{owner}/{repo}/contents/{path}?ref={branch}
  const p = cfg.path.replace(/^\/+/,'');
  return `https://api.github.com/repos/${encodeURIComponent(cfg.owner)}/${encodeURIComponent(cfg.repo)}/contents/${p}?ref=${encodeURIComponent(cfg.branch)}`;
}

async function ghLoadTasks(){
  const cfg = loadGhCfg();
  if (!cfg.owner || !cfg.repo || !cfg.branch || !cfg.path){
    alert("חסרים פרטים ב-Settings (Owner/Repo/Branch/Path).");
    return;
  }

  // First try RAW (public)
  const rawUrl = buildRawUrl(cfg);
  logStatus(`Load RAW: ${rawUrl}`);
  try{
    const r = await fetch(rawUrl, {cache:"no-store"});
    if (r.ok){
      const text = await r.text();
      await importCSVFromText(text, "RAW");
      return;
    }
    logStatus(`RAW failed: ${r.status}`);
  }catch(e){
    logStatus(`RAW error: ${e}`);
  }

  // Fallback API (token)
  if (!cfg.token){
    alert("טעינה RAW נכשלה (אולי Repo פרטי). הוסף Token ב-Settings ואז נסה שוב.");
    return;
  }

  const apiUrl = buildApiUrl(cfg);
  logStatus(`Load API: ${apiUrl}`);
  const r2 = await fetch(apiUrl, {
    headers: {
      "Accept":"application/vnd.github+json",
      "Authorization": `Bearer ${cfg.token}`
    }
  });
  if (!r2.ok){
    const t = await r2.text().catch(()=> "");
    logStatus(`API load failed: ${r2.status} ${t}`);
    alert(`שגיאת API בטעינה: ${r2.status}. בדוק Token/הרשאות/נתיב קובץ.`);
    return;
  }
  const j = await r2.json();
  const content = j && j.content ? atob(j.content.replace(/\n/g,'')) : "";
  if (!content.trim()){
    alert("הקובץ נטען אבל ריק/לא תקין.");
    return;
  }
  await importCSVFromText(content, "API");
}

async function ghSaveTasks(){
  const cfg = loadGhCfg();
  if (!cfg.owner || !cfg.repo || !cfg.branch || !cfg.path){
    alert("חסרים פרטים ב-Settings (Owner/Repo/Branch/Path).");
    return;
  }
  if (!cfg.token){
    alert("כדי לשמור ל-Git צריך Token. היכנס ל-Settings והדבק Token עם הרשאות כתיבה.");
    return;
  }

  ALL.forEach(calcDatesFromOffsets);
  const csvText = exportCSVText(ALL).replace(/^\uFEFF/, ""); // store without BOM in repo (optional)
  const contentB64 = btoa(unescape(encodeURIComponent(csvText)));

  // Need SHA of current file if exists
  const apiUrl = buildApiUrl(cfg).replace(/(\?ref=).+$/,'') + `?ref=${encodeURIComponent(cfg.branch)}`;
  logStatus(`Fetch SHA: ${apiUrl}`);
  let sha = null;

  const r0 = await fetch(apiUrl, {
    headers: {
      "Accept":"application/vnd.github+json",
      "Authorization": `Bearer ${cfg.token}`
    }
  });

  if (r0.ok){
    const j0 = await r0.json();
    sha = j0.sha || null;
    logStatus(`Found existing SHA: ${sha ? sha.slice(0,7) : "none"}`);
  } else if (r0.status === 404){
    logStatus(`File not found – will create new file at ${cfg.path}`);
  } else {
    const tx = await r0.text().catch(()=> "");
    logStatus(`SHA fetch failed: ${r0.status} ${tx}`);
    alert(`לא הצלחתי לקרוא SHA מה-API (${r0.status}). בדוק Token והרשאות.`);
    return;
  }

  const putUrl = `https://api.github.com/repos/${encodeURIComponent(cfg.owner)}/${encodeURIComponent(cfg.repo)}/contents/${cfg.path.replace(/^\/+/,'')}`;
  const body = {
    message: `Update ${cfg.path} via Gantt v18`,
    content: contentB64,
    branch: cfg.branch
  };
  if (sha) body.sha = sha;

  logStatus(`PUT: ${putUrl}`);
  const r1 = await fetch(putUrl, {
    method:"PUT",
    headers:{
      "Accept":"application/vnd.github+json",
      "Authorization": `Bearer ${cfg.token}`,
      "Content-Type":"application/json"
    },
    body: JSON.stringify(body)
  });

  if (!r1.ok){
    const tx = await r1.text().catch(()=> "");
    logStatus(`PUT failed: ${r1.status} ${tx}`);
    alert(`שגיאה בשמירה ל-GitHub: ${r1.status}. בדוק הרשאות Token/Branch.`);
    return;
  }

  logStatus(`✅ Saved successfully.`);
  alert("✅ נשמר ל-GitHub בהצלחה.");
}

/* Import CSV from text (used by Git load) */
async function importCSVFromText(text, sourceLabel){
  const rows = parseCSV(text);
  const tasks = rows.map(coerceTask).filter(t=>t && t.id);
  if (!tasks.length){
    logStatus(`Import(${sourceLabel}) failed: 0 tasks`);
    alert("טעינה הצליחה אבל לא נמצאו משימות ב-CSV (בדוק כותרות עמודות / פורמט).");
    return;
  }

  ALL = tasks.map(t=>({...t}));
  ALL.forEach(calcDatesFromOffsets);

  // persist all as edits
  const edits = {};
  ALL.forEach(t=>{
    edits[t.id] = {
      id:String(t.id),
      phase:t.phase||"",
      name:t.name||"",
      owner:t.owner||"",
      startOffset:Number(t.startOffset||0),
      duration:Number(t.duration||1),
      deps:t.deps||"",
      milestone: !!t.milestone,
      notes: t.notes||"",
      start:t.start, end:t.end
    };
  });
  saveEdits(edits);
  rebuildOwnerOptions(ALL);
  document.getElementById('ownerFilter').value = "";
  render();
  updateCharts();
  logStatus(`✅ Imported ${ALL.length} tasks from ${sourceLabel}`);
  alert(`✅ נטענו ${ALL.length} משימות (${sourceLabel}).`);
}

/* ---------- Security helper ---------- */
function escapeHtml(s){
  s = String(s ?? "");
  return s.replace(/[&<>"']/g, (ch)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[ch]));
}

/* ---------- Settings modal wiring ---------- */
const modalBg = document.getElementById('modalBg');

function openSettings(){
  const cfg = loadGhCfg();
  document.getElementById('ghOwner').value  = cfg.owner || "";
  document.getElementById('ghRepo').value   = cfg.repo || "";
  document.getElementById('ghBranch').value = cfg.branch || "main";
  document.getElementById('ghPath').value   = cfg.path || "tasks.csv";
  document.getElementById('ghToken').value  = cfg.token || "";
  modalBg.style.display = "flex";
  modalBg.setAttribute("aria-hidden","false");
  setCfgHint();
  logStatus("Opened Settings");
}
function closeSettings(){
  modalBg.style.display = "none";
  modalBg.setAttribute("aria-hidden","true");
}

document.getElementById('settingsBtn').addEventListener('click', openSettings);
document.getElementById('closeSettings').addEventListener('click', closeSettings);
document.getElementById('closeSettings2').addEventListener('click', closeSettings);
modalBg.addEventListener('click', (e)=>{ if (e.target === modalBg) closeSettings(); });

document.getElementById('saveSettings').addEventListener('click', ()=>{
  const cfg = {
    owner:  document.getElementById('ghOwner').value.trim(),
    repo:   document.getElementById('ghRepo').value.trim(),
    branch: document.getElementById('ghBranch').value.trim() || "main",
    path:   document.getElementById('ghPath').value.trim() || "tasks.csv",
    token:  document.getElementById('ghToken').value.trim()
  };
  saveGhCfg(cfg);
  setCfgHint();
  logStatus("Saved Settings: " + cfgSummary(cfg));
  alert("✅ Settings נשמרו בדפדפן.");
});

document.getElementById('forgetToken').addEventListener('click', ()=>{
  const cfg = loadGhCfg();
  cfg.token = "";
  saveGhCfg(cfg);
  document.getElementById('ghToken').value = "";
  setCfgHint();
  logStatus("Token removed from localStorage");
  alert("✅ Token נמחק מהמכשיר.");
});

document.getElementById('testLoadRaw').addEventListener('click', async ()=>{
  const cfg = loadGhCfg();
  if (!cfg.owner || !cfg.repo){ alert("הכנס Owner/Repo קודם."); return; }
  const url = buildRawUrl(cfg);
  logStatus("Test RAW: " + url);
  try{
    const r = await fetch(url, {cache:"no-store"});
    logStatus("RAW status: " + r.status);
    alert("RAW status: " + r.status);
  }catch(e){
    logStatus("RAW error: " + e);
    alert("RAW error");
  }
});

document.getElementById('testApi').addEventListener('click', async ()=>{
  const cfg = loadGhCfg();
  if (!cfg.token){ alert("הכנס Token קודם."); return; }
  const url = buildApiUrl(cfg);
  logStatus("Test API: " + url);
  const r = await fetch(url, {headers:{
    "Accept":"application/vnd.github+json",
    "Authorization": `Bearer ${cfg.token}`
  }});
  logStatus("API status: " + r.status);
  alert("API status: " + r.status);
});

/* ---------- Main buttons wiring ---------- */
document.getElementById('exportCsv').addEventListener('click', exportCSV);
document.getElementById('downloadTemplate').addEventListener('click', downloadTemplate);
document.getElementById('clearLocal').addEventListener('click', clearLocalCache);
document.getElementById('reset').addEventListener('click', resetAll);
document.getElementById('loadRepo').addEventListener('click', ghLoadTasks);
document.getElementById('saveRepo').addEventListener('click', ghSaveTasks);

document.getElementById('importBtn').addEventListener('click', async ()=>{
  const f = document.getElementById('importFile').files?.[0];
  if (!f){ alert("בחר קובץ CSV קודם."); return; }
  await importCSVFromFile(f);
});

document.getElementById('q').addEventListener('input', ()=>{ render(); });
document.getElementById('ownerFilter').addEventListener('change', ()=>{ render(); });
document.getElementById('zoom').addEventListener('change', ()=>{ render(); });

/* ---------- Initial ---------- */
setCfgHint();
render();
updateCharts();
</script>
</body>
</html>
